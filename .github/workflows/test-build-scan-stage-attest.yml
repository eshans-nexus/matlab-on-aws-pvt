name: 'TESTING: Build MATLAB AMI with Packer'

on:
  workflow_dispatch:
    inputs:
      matlab_version:
        description: 'MATLAB Version'
        required: true
        type: string
        default: 'R2025a'
      test_mode:
        description: 'TEST MODE: Skip Packer build and use existing AMI?'
        required: true
        type: boolean
        default: true

permissions:
  id-token: write
  contents: read
  attestations: write
  security-events: write

jobs:
  build-ami:
    name: 'Build AMI'
    runs-on: ubuntu-latest
    outputs:
      ami_id: ${{ steps.export_ami.outputs.ami_id }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # REAL BUILD STEPS (Skipped if test_mode is true)
      # ---------------------------------------------------------
      - name: Configure AWS Credentials
        if: ${{ inputs.test_mode != 'true' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GitHub-Packer-Build

      - name: Setup Packer
        if: ${{ inputs.test_mode != 'true' }}
        uses: hashicorp/setup-packer@main
        with:
          version: '1.10.2'

      - name: Run Packer Build (Real)
        if: ${{ inputs.test_mode != 'true' }}
        id: build
        working-directory: ./packer/v1
        run: |
          packer init .
          packer build -color=false \
            -var-file="release-config/${{ inputs.matlab_version }}.pkrvars.hcl" \
            -var="PRODUCTS=MATLAB" \
            . | tee packer-build.log

      # ---------------------------------------------------------
      # MOCK BUILD STEPS (Run ONLY if test_mode is true)
      # ---------------------------------------------------------
      - name: ðŸ§ª Mock Packer Build (Test Mode)
        if: ${{ inputs.test_mode == 'true' }}
        working-directory: ./packer/v1
        run: |
          echo "âš ï¸ TEST MODE ACTIVE: Skipping Packer Build."
          echo "Simulating successful build for us-east-1 AMI..."
          
          # 1. Create a dummy log file
          echo "Found matching AMI: ami-06554a9c16731eeb8" > packer-build.log
          echo "Build 'amazon-ebs' finished after 1 second." >> packer-build.log
          
          # 2. Create a dummy manifest.json so the parsing logic works
          # We use the AMI ID from your template's us-east-1 map
          cat <<EOF > manifest.json
          {
            "builds": [
              {
                "name": "matlab-ami",
                "builder_type": "amazon-ebs",
                "build_time": 123456789,
                "artifact_id": "us-east-1:ami-06554a9c16731eeb8",
                "packer_run_uuid": "mock-test-uuid"
              }
            ]
          }
          EOF
          
          ls -la

      # ---------------------------------------------------------
      # SHARED STEPS (Run for both)
      # ---------------------------------------------------------
      - name: Process Outputs & Summary
        id: export_ami
        run: |
          # Install jq if missing (Ubuntu usually has it, but good safety)
          sudo apt-get install -y jq

          # Logic works for both Real and Mock because Mock created the files above
          BUILT_AMI_ID=$(jq -r '.builds[-1].artifact_id' ./packer/v1/manifest.json | cut -d':' -f2)
          
          echo "ami_id=$BUILT_AMI_ID" >> "$GITHUB_OUTPUT"
          
          echo "## ðŸ—ï¸ MATLAB AMI Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Build Succeeded (or Mocked)!**" >> $GITHUB_STEP_SUMMARY
          echo "Using AMI: $BUILT_AMI_ID" >> $GITHUB_STEP_SUMMARY

      - name: Upload Packer Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packer-logs-and-manifest
          path: |
            ./packer/v1/packer-build.log
            ./packer/v1/manifest.json

  # ----------------------------------------------------------------
  # JOB 2: SCAN IMAGE (This will now scan the existing AMI)
  # ----------------------------------------------------------------
  scan-image:
    name: 'Scan AMI for CVEs'
    needs: build-ami
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
          # IMPORTANT: Ensure this region matches the Mock AMI's region (us-east-1)
          # If your secrets.AWS_REGION is different, the scan will fail to find the AMI.
          aws-region: us-east-1 
          role-session-name: GitHub-Trivy-Scan

      - name: Install Trivy
        uses: aquasecurity/setup-trivy@v0.2
        with:
          cache: true

      - name: Run Trivy Vulnerability Scanner
        run: |
          echo "Scanning AMI: ${{ needs.build-ami.outputs.ami_id }}"
          
          trivy vm \
            --scanners vuln \
            --format sarif \
            --output trivy-results.sarif \
            --severity HIGH,CRITICAL \
            ami:${{ needs.build-ami.outputs.ami_id }}

      - name: Upload Trivy Scan Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif
          category: trivy-ami-scan

  # ----------------------------------------------------------------
  # JOB 3: STAGE TEMPLATE
  # ----------------------------------------------------------------
  stage-template:
    name: 'Stage CloudFormation Template'
    needs: build-ami
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Inject AMI ID into Template
        run: |
          MATLAB_VER="${{ inputs.matlab_version }}"
          AMI_ID="${{ needs.build-ami.outputs.ami_id }}"
          TEMPLATE_PATH="./releases/$MATLAB_VER/matlab.template.json"
          
          # Create a dummy template if it doesn't exist in the repo for testing
          if [ ! -f "$TEMPLATE_PATH" ]; then
             echo "âš ï¸ Template not found (testing mode?), creating dummy..."
             mkdir -p "./releases/$MATLAB_VER"
             echo '{"Parameters":{"CustomAmiId":{"Default":""}}}' > "$TEMPLATE_PATH"
          fi

          echo "Injecting $AMI_ID into $TEMPLATE_PATH"

          jq --arg ami "$AMI_ID" \
             '.Parameters.CustomAmiId.Default = $ami' \
             "$TEMPLATE_PATH" > "matlab-${MATLAB_VER}-release.json"

      - name: Upload Staged Template
        uses: actions/upload-artifact@v4
        with:
          name: matlab-cfn-template
          path: "matlab-${{ inputs.matlab_version }}-release.json"

  # ----------------------------------------------------------------
  # JOB 4: ATTEST PROVENANCE
  # ----------------------------------------------------------------
  attest-artifacts:
    name: 'Generate SLSA Attestation'
    needs: [build-ami, stage-template]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      attestations: write
      contents: read
    steps:
      - name: Download Staged Template
        uses: actions/download-artifact@v4
        with:
          name: matlab-cfn-template
          path: ./artifacts/template

      - name: Download Packer Manifest
        uses: actions/download-artifact@v4
        with:
          name: packer-logs-and-manifest
          path: ./artifacts/packer

      - name: Attest CloudFormation Template
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: ./artifacts/template/*.json
      
      - name: Attest Packer Manifest
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: ./artifacts/packer/manifest.json
