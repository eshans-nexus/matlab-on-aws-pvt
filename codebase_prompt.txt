PROJECT STRUCTURE:
matlab-on-aws-pvt/
    SECURITY.md
    LICENSE.md
    README.md
    reporoll.py
    releases/
        R2023a/
            aws-matlab-template.json
            README.md
        R2022b/
            aws-matlab-template.json
            README.md
        R2019a_and_older/
            aws-matlab-2018a-existing-vpc-template.json
            aws-matlab-2018a-vpc-template.json
            aws-matlab-2019a-vpc-template.json
            aws-matlab-2018b-vpc-template.json
            license-manager-instructions.md
            aws-matlab-2019a-license-manager-template-eu-west-1.json
            aws-matlab-2019a-vpc-template-eu-west-1.json
            README.md
            online-licensing-instructions.md
            aws-matlab-2019a-license-manager-template.json
        R2020b/
            aws-matlab-template.json
            README.md
        R2024b/
            aws-matlab-template.json
            README.md
        R2019b/
            README.md
            aws-matlab-2019b-template.json
        R2024a/
            aws-matlab-template.json
            README.md
        R2021a/
            aws-matlab-template.json
            README.md
        R2022a/
            aws-matlab-template.json
            README.md
        R2020a/
            aws-matlab-template.json
            README.md
        R2021b/
            aws-matlab-template.json
            README.md
        R2025a/
            aws-matlab-template.json
            README.md
        R2023b/
            aws-matlab-template.json
            README.md
    src/
        aws-matlab-template.json
        codebase_prompt.txt
        README.md
        reporoll.py
        toplevel/
            LICENSE.md
            README.md
            permission.md
        static/
            SECURITY.md
            img/
        internal/
            permissions/
                execution_policy_trust.json
                execution_policy.json
                provisioning_policy.json
                test/
                    parameter_overrides.json
    .github/
        workflows/
            build-stage-test.yml
    packer/
        v1/
            build-matlab-ami.pkr.hcl
            .gitattributes
            README.md
            startup/
                85_warmup-mathworks-service-host.sh
                30_setup-logging.sh
                80_warmup-matlab-pre-R2022a.sh
                60_setup-matlab-proxy.sh
                99_run-optional-user-command.sh
                70_setup-matlab.sh
                .env
                00_check-profile.sh
                50_setup-nicedcv.sh
                20_setup-machine.sh
                80_warmup-matlab.sh
                40_setup-rdp.sh
                10_setup-disks.sh
            release-config/
                R2024b.pkrvars.hcl
                R2020a.pkrvars.hcl
                R2022b.pkrvars.hcl
                R2024a.pkrvars.hcl
                R2021b.pkrvars.hcl
                R2023a.pkrvars.hcl
                R2025a.pkrvars.hcl
                R2022a.pkrvars.hcl
                R2023b.pkrvars.hcl
                R2020b.pkrvars.hcl
                R2021a.pkrvars.hcl
            src/
                metatemplate.json
            runtime/
                generate-certificate.py
                swap-desktop-solution.sh
                launch-matlab-proxy.sh
    img/


==================================================

FILE CONTENTS:

<file path="/home/epatel/code/matlab-on-aws-pvt/SECURITY.md">
Reporting Security Vulnerabilities
==================================
If you believe you have discovered a security vulnerability, please report it to
security@mathworks.com instead of GitHub. Please see
[MathWorks Vulnerability Disclosure Policy for Security Researchers](https://www.mathworks.com/company/aboutus/policies_statements/vulnerability-disclosure-policy.html)
for additional information.
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/LICENSE.md">
MATHWORKS CLOUD REFERENCE ARCHITECTURE LICENSE

The files in this GitHub repository refer to commercial software products and services, virtual machine images, and related materials of The MathWorks, Inc. (“MathWorks Programs”). MathWorks Programs are separately licensed under the MathWorks Software License Agreement, available in the desktop installation of the MathWorks Programs or in the virtual machine image. The files in this GitHub repository may also refer to third-party software licensed under separate terms provided by such third parties.

The following license terms apply only to the files in this GitHub repository, including files in this folder and its subfolders, and do not apply to MathWorks Programs. References to “software” and “code” in the following license terms refer to the files in this GitHub repository.

Copyright 2020 - 2025 The MathWorks, Inc.

All rights reserved.

Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:

1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.
3. In all cases, the software is, and all modifications and derivatives of the software shall be, licensed to you solely for use in conjunction with MathWorks products and service offerings.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/README.md">
# MATLAB on Amazon Web Services

This repository shows how to deploy MATLAB&reg; on an Amazon EC2&reg; instance using your Amazon&reg; Web Services (AWS&reg;) account and connect to it using the Remote Desktop Protocol (RDP), SSH, or NICE DCV. The automation uses an AWS CloudFormation template. 

For information about the architecture of this solution, see [Learn about Architecture](#learn-about-architecture). For information about templates, see [AWS CloudFormation Templates](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-guide.html).

This reference architecture has been reviewed and qualified by AWS.

![AWS Qualified Software badge](img/aws-qualified-software.png)


## Requirements
You need:
* A MATLAB license. For more information, see [License Requirements for MATLAB on Cloud Platforms](https://www.mathworks.com/help/install/license/licensing-for-mathworks-products-running-on-the-cloud.html).
* An [Amazon Web Services (AWS)](https://aws.amazon.com) account.
* A key pair for your AWS account, in the appropriate region. For more information, see [Amazon EC2 Key Pairs](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html).

## Costs
You are responsible for the cost of the AWS services used when you create cloud resources using this guide. Resource settings, such as instance type, affect the cost of deployment. For cost estimates, see the pricing pages for each AWS service you will be using. Prices are subject to change.

# Deployment Steps
By default, the MATLAB reference architectures below launch prebuilt machine images, described in [Learn about Architecture](#learn-about-architecture).
Using a prebuilt machine image is the easiest way to deploy a MATLAB reference architecture.
Prebuilt images are provided for the five most recent MATLAB releases.
Alternatively, to build your own machine image,
see [Build and Deploy Your Own Machine Image](#build-and-deploy-your-own-machine-image).
You can also use this workflow to install an earlier MATLAB release.

## Deploy Prebuilt Machine Image
To view instructions for deploying the MATLAB reference architecture, select a MATLAB release:

| Linux | Windows | Status |
| ----- | ------- | ------- |
| [R2025a](releases/R2025a/README.md) | [R2025a](https://github.com/mathworks-ref-arch/matlab-on-aws-win/tree/master/releases/R2025a/README.md) | ✅ Prebuilt available. |
| [R2024b](releases/R2024b/README.md) | [R2024b](https://github.com/mathworks-ref-arch/matlab-on-aws-win/tree/master/releases/R2024b/README.md) | ✅ Prebuilt available. |
| [R2024a](releases/R2024a/README.md) | [R2024a](https://github.com/mathworks-ref-arch/matlab-on-aws-win/tree/master/releases/R2024a/README.md) | ✅ Prebuilt available. |
| [R2023b](releases/R2023b/README.md) | [R2023b](https://github.com/mathworks-ref-arch/matlab-on-aws-win/tree/master/releases/R2023b/README.md) | ⚠️ Prebuilt will be removed in March 2026. |
| [R2023a](releases/R2023a/README.md) | [R2023a](https://github.com/mathworks-ref-arch/matlab-on-aws-win/tree/master/releases/R2023a/README.md) | ⚠️ Prebuilt will be removed in September 2025. |
| [Earlier/Custom](./packer/v1) | [Earlier/Custom](https://github.com/mathworks-ref-arch/matlab-on-aws-win/tree/master/packer/v1) | For earlier MATLAB releases, you must build your own machine image. |

The above instructions allow you to launch instances based on the latest prebuilt MathWorks&reg; Amazon Machine Images (AMIs).
MathWorks periodically replaces older AMIs with new images.
For more details, see
[When are the MathWorks Amazon Machine Images updated?](#when-are-the-mathWorks-amazon-machine-images-updated)

## Build and Deploy Your Own Machine Image
For details of the scripts which form the basis of the MathWorks Linux AMI build process,
see [Build Your Own Machine Image](./packer/v1).
You can use these scripts to build a custom Linux machine image for running MATLAB on Amazon Web Services.
You can then deploy this custom image with the MathWorks infrastructure as code (IaC) templates.

You can customize the MATLAB release which is installed as part of this custom build.
This includes MATLAB releases supported by the prebuilt images, as well as earlier MATLAB releases.
For more details,
see [Customize MATLAB Release to Install](./packer/v1#customize-matlab-release-to-install).

Platform engineering teams can use these scripts to take advantage of optimizations MathWorks has developed
for running MathWorks products in the cloud.
For more details, see [What are the advantages of building images with MathWorks scripts?](#what-are-the-advantages-of-building-images-with-mathworks-scripts)

## Learn about Architecture

![MATLAB on AWS Reference Architecture](img/aws-matlab-diagram.png)

Deploying this reference architecture sets up a single AWS EC2 instance containing MATLAB, a private VPC with an internet gateway, a private subnet, and a security group that opens the appropriate ports for SSH and RDP access.

The Amazon Machine Image (AMI) contains pre-installed drivers and the following software:
* MATLAB, Simulink, toolboxes, and support for GPUs.
* Add-ons: several pretrained deep neural networks for classification, feature extraction, and transfer learning with Deep Learning Toolbox&trade;, including GoogLeNet, ResNet-50, and NASNet-Large.

### Resources

The following resources will be created as part of the CloudFormation Stack:

1. Security Group for SSH and RDP access
2. EC2 Instance

The following resources might be created, depending on your deployment configuration:

1. IAM role
2. A CloudWatch log group
3. An elastic IP address
4. A SSM document

## FAQ

### When are the MathWorks Amazon Machine Images updated?
The links in [Deployment Steps](#deployment-steps) launch instances based on the latest MathWorks
AMIs for at least the four most recent MATLAB releases. MATLAB releases occur twice each year.

For each MATLAB release, MathWorks periodically replaces the corresponding AMI with a newer AMI
that includes the latest MATLAB updates and important security updates of the base OS image.

When MathWorks replaces an AMI, the older AMI is deleted.
However, any running instances previously launched from the older AMI are not affected.
To continue using an older AMI, copy the AMI into your AWS account.
For more details on how to copy an AMI, see
[How do I copy the AMI?](#how-do-I-copy-the-ami)
For more details on how to customize the reference architectures to
deploy the copied AMI see [How do I customize the AMI?](#how-do-I-customize-the-ami)

### How do I save my changes in the AMI?
All your files and changes are stored locally on the EC2 Instance. They persist until you either terminate the instance or delete the stack. Stopping the instance does not destroy the data on the instance. If you want your changes to persist outside the stack or before you terminate an instance, you need to:
* Copy your files to another location, or
* Create an image of the virtual machine.

### What happens to my data if I shut down the instance?
To minimize costs, you might want to shut down the instance when you are not using it. When the virtual machine is stopped, you are only charged for storage. To shut down an EC2 instance, locate it in the AWS web console, select the instance and choose “Instance State/Stop” from the “Actions” menu. You can restart it from the same menu. Any files or changes you make to the virtual machine will persist when you shut it down and will be present when you restart it. Shutting down the virtual machine and restarting it might change the public IP address and DNS name. Inspecting the EC2 instance in the AWS console will reveal the new IP address and DNS name.

### How do I keep the same public IP address?
To avoid having to change the IP address between restarts, enable the **Keep public IP address the same** option during deployment. For more information, see [Elastic IP addresses](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html).

### How do I manage my EC2 quotas?
See [Amazon EC2 Service Quotas](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-resource-limits.html).

### How do I save or copy an AMI?
To save an AMI, locate the EC2 Instance in the AWS web console and select **Actions** > **Image** > **Create Image.**

To copy the AMI for a certain MATLAB version to a target region of your choice, follow these steps:
* Choose the MATLAB release that you want to copy from the Releases folder of this repository. Download and open the CloudFormation template .json file for that release.
* Locate the Mappings section in the CloudFormation template. Copy the AMI ID for one of the existing regions, for example, us-east-1.
* To copy the AMI to your target region, see [Copy an AMI](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/CopyingAMIs.html) in the AWS documentation.
* In the Mappings section of the CloudFormation template, add a new RegionMap pair corresponding to your target region. Insert the new AMI ID of the AMI in the target region.
* In your AWS Console, change your region to your target region. In the CloudFormation menu, select the **Create Stack > With new resources** option. Provide the modified CloudFormation template.

You can now deploy the AMI in your target region using the AMI that you copied.

### How do I customize the AMI?
You can customize a prebuilt AMI by launching the reference architecture, applying changes you want to the EC2 Instance (such as installing additional software, drivers, and files), then saving an image of that instance using the AWS Console. For more information, see [How do I save or copy an AMI?](#how-do-i-save-or-copy-an-ami). When you create a stack, replace the AMI ID in the CloudFormation template with the AMI ID of your customized image.

You can also create a custom image by building your own using the Packer scripts we provide. See [Build and Deploy Your Own Machine Image](#build-and-deploy-your-own-machine-image).

### How do I use a different license manager?
The AMI uses MathWorks Hosted License Manager by default. For information on how to use other license managers, see [MATLAB Licensing in the Cloud](https://www.mathworks.com/help/install/license/licensing-for-mathworks-products-running-on-the-cloud.html).

### What are the advantages of building images with MathWorks scripts?
Images built with MathWorks scripts are optimized and tested for MathWorks workflows.
The images are deployed by MathWorks CloudFormation templates following AWS best practices.

The warmup scripts found in [startup](./packer/v1/startup) allow you to start MATLAB faster. The CloudFormation template uses these scripts to automatically initialize MathWorks files on the instance. This allows MATLAB to be responsive in as little as a minute after you start it. These scripts are automatically included in both the prebuilt images and the images that you build using the instructions in [Deployment Steps](#deployment-steps).

Without the optimization scripts, starting a large software application, such as MATLAB, for the first time can potentially take tens of minutes. Subsequent starts of the large software application will be faster. This is because AWS initializes the storage for the EC2 instance, as described in [Initialize Amazon EBS volumes](https://docs.aws.amazon.com/ebs/latest/userguide/ebs-initialize.html).



Other scripts in this repo also enable options for connecting to the instance, ensure that all the necessary MATLAB dependencies are installed, and make it easy to build an image with an older MATLAB release.

# Technical Support
To request assistance or additional features, contact [MathWorks Technical Support](https://www.mathworks.com/support/contact_us.html).

----

Copyright 2018-2025 The MathWorks, Inc.

----
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/reporoll.py">
#!/usr/bin/env python3
import os
import fnmatch

# Configuration: Folders and files to always ignore
IGNORE_DIRS = {
    '.git', '__pycache__', 'node_modules', 'venv', '.env', 
    '.idea', '.vscode', 'dist', 'build', 'coverage'
}

IGNORE_FILES = {
    'package-lock.json', 'yarn.lock', '*.lock', '*.pyc', 
    '*.png', '*.jpg', '*.jpeg', '*.gif', '*.ico', '*.svg', 
    '*.exe', '*.dll', '*.so', '*.dylib', '.DS_Store'
}

def should_ignore(name, is_dir=False):
    """Checks if a file or directory should be ignored."""
    if is_dir:
        return name in IGNORE_DIRS
    
    # Check exact matches
    if name in IGNORE_FILES:
        return True
    
    # Check glob patterns (e.g., *.png)
    for pattern in IGNORE_FILES:
        if fnmatch.fnmatch(name, pattern):
            return True
    return False

def is_binary(file_path):
    """Simple heuristic to detect binary files."""
    try:
        with open(file_path, 'tr') as check_file:
            check_file.read()
            return False
    except:
        return True

def generate_tree(start_path):
    """Generates a string representation of the file tree."""
    tree_str = "PROJECT STRUCTURE:\n"
    for root, dirs, files in os.walk(start_path):
        dirs[:] = [d for d in dirs if not should_ignore(d, is_dir=True)]
        level = root.replace(start_path, '').count(os.sep)
        indent = ' ' * 4 * (level)
        tree_str += f"{indent}{os.path.basename(root)}/\n"
        subindent = ' ' * 4 * (level + 1)
        for f in files:
            if not should_ignore(f):
                tree_str += f"{subindent}{f}\n"
    return tree_str

def roll_codebase(start_path):
    """Reads all files and formats them into a prompt."""
    output = []
    
    # 1. Add the file tree
    output.append(generate_tree(start_path))
    output.append("\n" + "="*50 + "\n")
    output.append("FILE CONTENTS:\n")

    # 2. Walk through files
    for root, dirs, files in os.walk(start_path):
        # Modify dirs in-place to skip ignored directories
        dirs[:] = [d for d in dirs if not should_ignore(d, is_dir=True)]

        for file in files:
            if should_ignore(file):
                continue

            file_path = os.path.join(root, file)
            
            # Skip binaries
            if is_binary(file_path):
                print(f"Skipping binary file: {file_path}")
                continue

            # Format the output using XML tags for clarity
            try:
                with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                    content = f.read()
                    
                output.append(f'<file path="{file_path}">\n{content}\n</file>\n')
            except Exception as e:
                print(f"Error reading {file_path}: {e}")

    return "\n".join(output)

if __name__ == "__main__":
    # Get current directory
    cwd = os.getcwd()
    print(f"Rolling codebase from: {cwd} ...")
    
    full_prompt = roll_codebase(cwd)
    
    # Write to file
    output_filename = "codebase_prompt.txt"
    with open(output_filename, "w", encoding="utf-8") as f:
        f.write(full_prompt)
        
    print(f"Done! Prompt saved to: {output_filename}")
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2023a/aws-matlab-template.json">
{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Mappings": {
    "RegionMap": {
      "us-east-1": {
        "AMI": "ami-0bea06cb6d52cda81"
      },
      "us-east-2": {
        "AMI": "ami-0c51020f8479f2131"
      },
      "us-west-1": {
        "AMI": "ami-0c8d56e118aaf0ba4"
      },
      "us-west-2": {
        "AMI": "ami-067bb903c5c53c620"
      },
      "ca-central-1": {
        "AMI": "ami-0df9a48371dc0c16d"
      },
      "eu-central-1": {
        "AMI": "ami-0188286c61b69ea31"
      },
      "eu-west-1": {
        "AMI": "ami-0f25e1cfd17bb6220"
      },
      "eu-west-2": {
        "AMI": "ami-0bdb10bfc42544181"
      },
      "eu-west-3": {
        "AMI": "ami-0840e056ab31930a0"
      },
      "eu-north-1": {
        "AMI": "ami-0aff358d330d1c0ff"
      },
      "sa-east-1": {
        "AMI": "ami-031bcb8f46503d32c"
      },
      "me-south-1": {
        "AMI": "ami-0d3d7a48c40d4a6af"
      },
      "ap-east-1": {
        "AMI": "ami-00bfaed372e9ea585"
      },
      "ap-south-1": {
        "AMI": "ami-0181b74b1f5ffbbc8"
      },
      "ap-northeast-1": {
        "AMI": "ami-0b3e9acd3738dcb6b"
      },
      "ap-northeast-2": {
        "AMI": "ami-0a0ab6a40dfb20991"
      },
      "ap-southeast-1": {
        "AMI": "ami-024315346a2633312"
      },
      "ap-southeast-2": {
        "AMI": "ami-00e17fae9e9312c91"
      }
    }
  },
  "Resources": {
    "PredefinedRole": {
      "Type": "AWS::IAM::Role",
      "Condition": "UsePredefinedRole",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "ec2.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/",
        "ManagedPolicyArns": {
          "Fn::If": [
            "UseAdditionalPolicies",
            {
              "Fn::Split": [
                ";",
                {
                  "Ref": "AdditionalIamPolicies"
                }
              ]
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "Policies": [
          {
            "Fn::If": [
              "UseCloudWatch",
              {
                "PolicyName": "cloudwatch-access-policy",
                "PolicyDocument": {
                  "Version": "2012-10-17",
                  "Statement": [
                    {
                      "Effect": "Allow",
                      "Action": [
                        "logs:CreateLogStream",
                        "logs:DescribeLogStreams",
                        "logs:PutLogEvents"
                      ],
                      "Resource": {
                        "Fn::Sub": [
                          "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:${name}:*",
                          {
                            "name": {
                              "Fn::GetAtt": [
                                "MWLogLocation",
                                "Outputs.LogGroupName"
                              ]
                            }
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          {
            "PolicyName": "dcv-access-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "s3:GetObject",
                  "Resource": {
                    "Fn::Sub": "arn:aws:s3:::dcv-license.${AWS::Region}/*"
                  }
                }
              ]
            }
          },
          {
            "PolicyName": "ssm-access-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "ssm:DescribeAssociation",
                    "ssm:GetDeployablePatchSnapshotForInstance",
                    "ssm:GetDocument",
                    "ssm:DescribeDocument",
                    "ssm:GetManifest",
                    "ssm:GetParameter",
                    "ssm:GetParameters",
                    "ssm:ListAssociations",
                    "ssm:ListInstanceAssociations",
                    "ssm:PutInventory",
                    "ssm:PutComplianceItems",
                    "ssm:PutConfigurePackageResult",
                    "ssm:UpdateAssociationStatus",
                    "ssm:UpdateInstanceAssociationStatus",
                    "ssm:UpdateInstanceInformation"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ssmmessages:CreateControlChannel",
                    "ssmmessages:CreateDataChannel",
                    "ssmmessages:OpenControlChannel",
                    "ssmmessages:OpenDataChannel"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ec2messages:AcknowledgeMessage",
                    "ec2messages:DeleteMessage",
                    "ec2messages:FailMessage",
                    "ec2messages:GetEndpoint",
                    "ec2messages:GetMessages",
                    "ec2messages:SendReply"
                  ],
                  "Resource": "*"
                }
              ]
            }
          },
          {
            "PolicyName": "describe-tags-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "ec2:DescribeTags",
                  "Resource": "*"
                }
              ]
            }
          }
        ]
      }
    },
    "MATLABInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Fn::If": [
              "UsePredefinedRole",
              {
                "Ref": "PredefinedRole"
              },
              {
                "Ref": "CustomIamRole"
              }
            ]
          }
        ]
      }
    },
    "MWSecurityGroup": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": "https://mathworks-reference-architectures-templates.s3.amazonaws.com/security-group/v1/1/0/security-group.yml",
        "Parameters": {
          "VpcId": {
            "Ref": "VPC"
          },
          "CidrIp": {
            "Ref": "ClientIPAddress"
          },
          "SSHAccess": "Yes",
          "RDPAccess": "Yes",
          "NICEDCVAccess": "Yes",
          "MATLABProxyAccess": "Yes"
        }
      }
    },
    "MWLogLocation": {
      "Type": "AWS::CloudFormation::Stack",
      "Condition": "UseCloudWatch",
      "Properties": {
        "TemplateURL": "https://mathworks-reference-architectures-templates.s3.amazonaws.com/log-location/v1/0/0/log-location.yml"
      }
    },
    "MATLABEC2Instance": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "ImageId": {
          "Fn::If": [
            "UseCustomAMI",
            {
              "Ref": "CustomAmiId"
            },
            {
              "Fn::FindInMap": [
                "RegionMap",
                {
                  "Ref": "AWS::Region"
                },
                "AMI"
              ]
            }
          ]
        },
        "KeyName": {
          "Ref": "SSHKeyName"
        },
        "SecurityGroupIds": [
          {
            "Fn::GetAtt": [
              "MWSecurityGroup",
              "Outputs.SecurityGroupId"
            ]
          },
          {
            "Fn::If": [
              "AddSG",
              {
                "Ref": "AdditionalSecurityGroup"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          }
        ],
        "SubnetId": {
          "Ref": "Subnet"
        },
        "InstanceType": {
          "Ref": "InstanceType"
        },
        "IamInstanceProfile": {
          "Ref": "MATLABInstanceProfile"
        },
        "EbsOptimized": "true",
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "VolumeSize": {
                "Ref": "RootVolumeSize"
              }
            }
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Ref": "InstanceName"
            }
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "\n",
              [
                "#!/bin/bash",
                "",
                "# Copyright 2022 The MathWorks, Inc.",
                "",
                "STARTUP_FOLDER=/opt/mathworks/startup",
                "# Load startup variables",
                "if [[ -r ${STARTUP_FOLDER}/.env ]]; then",
                "    set -o allexport",
                "    source ${STARTUP_FOLDER}/.env",
                "    set +o allexport",
                "fi",
                "",
                "# Define startup parameters",
                {
                  "Fn::Sub": [
                    "export PASSWORD=${PasswordBase64}",
                    {
                      "PasswordBase64": {
                        "Fn::Base64": {
                          "Ref": "Password"
                        }
                      }
                    }
                  ]
                },
                {
                  "Fn::Sub": "export MLM_LICENSE_FILE=${LicenseManager}"
                },
                {
                  "Fn::Sub": [
                    "export CLOUD_LOG_NAME=${LogGroupName}",
                    {
                      "LogGroupName": {
                        "Fn::If": [
                          "UseCloudWatch",
                          {
                            "Fn::GetAtt": [
                              "MWLogLocation",
                              "Outputs.LogGroupName"
                            ]
                          },
                          ""
                        ]
                      }
                    }
                  ]
                },
                {
                  "Fn::Sub": "export ACCESS_PROTOCOL='${AccessProtocol}'"
                },
                {
                  "Fn::Sub": "export ENABLE_MATLAB_PROXY='${EnableMATLABProxy}'"
                },
                {
                  "Fn::Sub": "export OPTIONAL_USER_COMMAND='${OptionalUserCommand}'"
                },
                "",
                "# Run startup scripts",
                "mkdir -p /var/log/mathworks",
                "run-parts --exit-on-error --verbose --regex '^[0-9]+_.+$' ${STARTUP_FOLDER} >> /var/log/mathworks/startup.log 2>&1",
                "",
                "# Signal the status from cfn-init",
                {
                  "Fn::Sub": "/opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --region ${AWS::Region} --resource MATLABEC2Instance"
                }
              ]
            ]
          }
        }
      },
      "CreationPolicy": {
        "ResourceSignal": {
          "Timeout": "PT15M"
        }
      }
    },
    "ElasticIP": {
      "Type": "AWS::EC2::EIP",
      "Condition": "UseElasticIPAddress",
      "Properties": {
        "InstanceId": {
          "Ref": "MATLABEC2Instance"
        },
        "Domain": "vpc"
      }
    },
    "document": {
      "Type": "AWS::SSM::Document",
      "Condition": "UsePredefinedRole",
      "Properties": {
        "DocumentType": "Command",
        "Content": {
          "schemaVersion": "2.2",
          "description": "Run a script on Linux instances.",
          "parameters": {
            "commands": {
              "type": "String",
              "description": "Command to run on EC2 instance",
              "default": "echo 'Hello World'"
            }
          },
          "mainSteps": [
            {
              "action": "aws:runShellScript",
              "name": "runCommands",
              "inputs": {
                "timeoutSeconds": "60",
                "runCommand": [
                  "{{ commands }}"
                ]
              }
            }
          ]
        }
      }
    },
    "AutoShutdownLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "ZipFile": "# Copyright 2021-2024 The MathWorks, Inc.\n\nimport boto3,os,re\nfrom datetime import datetime as dt,timedelta\n\nec2=boto3.client(\"ec2\")\nDEFAULT_TIME_INTERVAL=os.environ['DEFAULT_TIME_INTERVAL']\n# Uniquely identify instance using AWS-provided stack-level tags\nres=ec2.describe_instances(Filters=[{'Name':'tag:aws:cloudformation:stack-name','Values':[os.environ['STACK_NAME']]},{'Name':'tag:aws:cloudformation:logical-id','Values':['MATLABEC2Instance']},{'Name': 'instance-state-name','Values': ['running', 'pending']}])\nINSTANCE=res[\"Reservations\"][0][\"Instances\"][0]\nINSTANCE_ID=INSTANCE[\"InstanceId\"]\nLOG_MESSAGES={\"instance-stopped\":\"Instance is stopped.\",\"tag-never\":\"Autoshutdown is not enabled. Change the value of mw-autoshutdown tag of the EC2 instance to enable the autoshutdown feature.\",\"tag-invalid\":\"The value of the mw-autoshutdown tag you have set is not valid. The format of the timestamp must be a valid RFC 1123 UTC timestamp, such as Thu, 16 Dec 2021 12:28:47 GMT.\",\"instance-booted\":\"Instance has just started. Setting mw-autoshutdown value.\",\"stop-instance\":\"Shutdown time has been reached. Shutting instance down.\",\"early-to-shutdown\":\"Shutdown time has not been reached yet. Too early to shutdown instance.\"}\nRET_VAL={\"statusCode\": 200}\n\ndef log_to_cloudwatch(id):\n    print(LOG_MESSAGES[id])\n\ndef get_start_time():\n    launch_time=INSTANCE[\"LaunchTime\"]\n    return re.sub(r\"\\+00:00\",\"\",str(launch_time))\n\ndef get_shutdown_tag():\n    tags=INSTANCE[\"Tags\"]\n    shutdown_tag=next((tag for tag in tags if tag[\"Key\"]==\"mw-autoshutdown\"), None)\n    return shutdown_tag\n\ndef set_shutdown_tag(shutdown_time):\n    ec2.create_tags(Resources=[INSTANCE_ID], Tags=[{\"Key\": \"mw-autoshutdown\",\"Value\": str(shutdown_time)}])\n\ndef set_shutdown_time():\n    time_interval=int(re.findall(\"[0-9]+\",DEFAULT_TIME_INTERVAL)[0])\n    launch_time=dt.fromisoformat(get_start_time())\n    shutdown_time=launch_time+timedelta(hours=int(time_interval))\n    shutdown_time_gmt=dt.strftime(shutdown_time,'%a, %d %b %Y %H:%M:%S GMT')\n    set_shutdown_tag(shutdown_time_gmt)\n\ndef lambda_handler(event, context):\n    # No action while the instance is stopped.\n    if INSTANCE[\"State\"][\"Name\"]==\"stopped\":\n        log_to_cloudwatch(id=\"instance-stopped\")\n        return RET_VAL\n    shutdown_tag=get_shutdown_tag()\n    # In the first function run, use DEFAULT_TIME_INTERVAL to determine what to do.\n    if shutdown_tag is None:\n        if DEFAULT_TIME_INTERVAL==\"Never\":\n            # Set the tag to \"never\".\n            set_shutdown_tag(\"never\")\n            # No action when tag is \"never\"\n            log_to_cloudwatch(id=\"tag-never\")\n            return RET_VAL\n        else:\n            # Set the tag to start time + user chosen time interval.\n            set_shutdown_time()\n            log_to_cloudwatch(id=\"instance-booted\")\n            return RET_VAL\n    # If the tag exists, use it to determine what to do.\n    if shutdown_tag[\"Value\"]==\"change_me_on_boot\":\n        set_shutdown_time()\n        log_to_cloudwatch(id=\"instance-booted\")\n        return RET_VAL\n    elif shutdown_tag[\"Value\"]==\"never\":\n        # No action when tag is \"never\"\n        log_to_cloudwatch(id=\"tag-never\")\n        return RET_VAL\n    else:\n        # Check the tag value to determine whether instance needs to be shutdown.\n        try:\n            shutdown_time=dt.strptime(shutdown_tag[\"Value\"],'%a, %d %b %Y %H:%M:%S GMT')\n        except ValueError:\n            log_to_cloudwatch(id=\"tag-invalid\")\n            return RET_VAL\n        curr_time=dt.now(shutdown_time.tzinfo)\n        if curr_time>shutdown_time:\n            ec2.stop_instances(InstanceIds=[INSTANCE_ID])\n            # Set the shutdown time as mw-last-autoshutdown-event tag\n            curr_time_gmt=dt.strftime(curr_time, '%a, %d %b %Y %H:%M:%S GMT')\n            ec2.create_tags(Resources=[INSTANCE_ID], Tags=[{\"Key\": \"mw-last-autoshutdown-event\",\"Value\": str(curr_time_gmt)}])\n            log_to_cloudwatch(id=\"stop-instance\")\n            if DEFAULT_TIME_INTERVAL==\"Never\":\n                set_shutdown_tag(\"never\")\n            else:\n                set_shutdown_tag(\"change_me_on_boot\")\n            return RET_VAL\n        else:\n            log_to_cloudwatch(id=\"early-to-shutdown\")\n            return RET_VAL"
        },
        "Environment": {
          "Variables": {
            "DEFAULT_TIME_INTERVAL": {
              "Ref": "AutoShutdown"
            },
            "STACK_NAME": {
              "Ref": "AWS::StackName"
            }
          }
        },
        "Handler": "index.lambda_handler",
        "Runtime": "python3.12",
        "Timeout": "60",
        "Role": {
          "Fn::GetAtt": [
            "AutoShutdownLambdaRole",
            "Arn"
          ]
        }
      }
    },
    "AutoShutdownLambdaRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/",
        "Policies": [
          {
            "PolicyName": "autoshutdown-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "ec2:DescribeInstances",
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": "ec2:DescribeTags",
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": "ec2:Stopinstances",
                  "Resource": {
                    "Fn::Sub": "arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:instance/*"
                  },
                  "Condition": {
                    "StringEquals": {
                      "aws:ResourceTag/aws:cloudformation:stack-name": {
                        "Ref": "AWS::StackName"
                      },
                      "aws:ResourceTag/aws:cloudformation:logical-id": "MATLABEC2Instance"
                    }
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": "ec2:CreateTags",
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": "ec2:DeleteTags",
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": {
                    "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*"
                  }
                }
              ]
            }
          }
        ]
      }
    },
    "AutoShutdownScheduledRule": {
      "Type": "AWS::Events::Rule",
      "Properties": {
        "Description": "AutoShutdownScheduledRule",
        "ScheduleExpression": "rate(15 minutes)",
        "State": "ENABLED",
        "Targets": [
          {
            "Arn": {
              "Fn::GetAtt": [
                "AutoShutdownLambda",
                "Arn"
              ]
            },
            "Id": "TargetFunctionV1"
          }
        ]
      }
    },
    "PermissionForEventsToInvokeLambda": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": {
          "Ref": "AutoShutdownLambda"
        },
        "Action": "lambda:InvokeFunction",
        "Principal": "events.amazonaws.com",
        "SourceArn": {
          "Fn::GetAtt": [
            "AutoShutdownScheduledRule",
            "Arn"
          ]
        }
      }
    },
    "AutoShutdownLambdaLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": {
          "Fn::Join": [
            "",
            [
              "/aws/lambda/",
              {
                "Ref": "AutoShutdownLambda"
              }
            ]
          ]
        }
      }
    }
  },
  "Parameters": {
    "InstanceType": {
      "Description": "AWS instance type to use for MATLAB. See https://aws.amazon.com/ec2/instance-types for a list of instance types.",
      "Default": "m5.xlarge",
      "Type": "String"
    },
    "InstanceName": {
      "Description": "Name for the MATLAB virtual machine",
      "Default": "MATLAB Desktop",
      "Type": "String"
    },
    "AccessProtocol": {
      "Description": "Access protocol to connect to this instance",
      "Default": "RDP",
      "Type": "String",
      "AllowedValues": [
        "NICE DCV",
        "RDP"
      ]
    },
    "EnableMATLABProxy": {
      "Description": "Option that enables access to MATLAB on your cloud instance within a browser. Opening MATLAB in a browser opens a separate MATLAB session to your Remote Desktop Protocol (RDP) session or NICE DCV session.",
      "Default": "Yes",
      "Type": "String",
      "AllowedValues": [
        "Yes",
        "No"
      ]
    },
    "UseElasticIpAddress": {
      "Description": "Flag indicating whether you want to keep the same public IP address for the instance",
      "Default": "No",
      "Type": "String",
      "AllowedValues": [
        "Yes",
        "No"
      ]
    },
    "RootVolumeSize": {
      "Description": "Size in GB of the root volume",
      "Default": "128",
      "Type": "Number",
      "MinValue": "128",
      "MaxValue": "1024",
      "ConstraintDescription": "Size must be between 128 and 1024GB"
    },
    "CustomIamRole": {
      "Description": "Name of a custom IAM Role to associate with this instance. If not specified, a predefined role is used. If specified, features requiring special permissions will be unavailable (NICE DCV, CloudWatch, IAM Policies).",
      "Default": "",
      "Type": "String"
    },
    "AdditionalIamPolicies": {
      "Description": "Semicolon-delimited list of IAM Policy ARNs to add to the predefined role. This option cannot be used with a custom IAM Role.",
      "Default": "",
      "Type": "String",
      "AllowedPattern": "^(arn:[^:;]+:iam::[^:;]+:policy/[^:;]+(;arn:[^:;]+:iam::[^:;]+:policy/[^:;]+)*)?$",
      "ConstraintDescription": "If specified, must be a semicolon (;) delimited list of ARNs (arn:<partition>:iam::<account-id>:policy/<resource-id>)."
    },
    "VPC": {
      "Description": "ID of an existing VPC in which to deploy this stack",
      "Type": "AWS::EC2::VPC::Id",
      "ConstraintDescription": "Must be the ID of an existing VPC.",
      "AllowedPattern": ".+"
    },
    "Subnet": {
      "Description": "ID of an existing subnet. To access the instance from anywhere, ensure that your subnet auto-assigns public IP addresses and is connected to the internet.",
      "Type": "AWS::EC2::Subnet::Id",
      "ConstraintDescription": "Must be the ID of an existing Subnet within the chosen VPC.",
      "AllowedPattern": ".+"
    },
    "SSHKeyName": {
      "Description": "Name of an existing EC2 KeyPair to allow SSH access to all the instances. See https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html for details on creating these.",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "ConstraintDescription": "Must be the name of an existing EC2 KeyPair.",
      "AllowedPattern": ".+"
    },
    "ClientIPAddress": {
      "Description": "IP address range that will be allowed to connect to this instance from outside of the VPC. This field should be formatted as <ip_address>/<mask>. E.g. 10.0.0.1/32. This is the public IP address which can be found by searching for 'what is my ip address' on the web. The mask determines the number of IP addresses to include. A mask of 32 is a single IP address. This calculator can be used to build a specific range: https://www.ipaddressguide.com/cidr. You may need to contact your IT administrator to determine which address is appropriate.",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription": "Must be a valid IP CIDR range of the form x.x.x.x/x."
    },
    "Password": {
      "NoEcho": "true",
      "Description": "Password for the \"ubuntu\" user. You also need to enter this as an authentication token to access MATLAB on your cloud instance within a browser.",
      "Type": "String",
      "ConstraintDescription": "Must have a minimum of 14 characters, 1 uppercase letter, 1 lowercase letter, 1 number, and 1 special character",
      "AllowedPattern": "^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[^a-zA-Z0-9]).{14,}$"
    },
    "ConfirmPassword": {
      "NoEcho": "true",
      "Description": "Confirm Password",
      "Type": "String"
    },
    "LicenseManager": {
      "Description": "Optional License Manager for MATLAB, specified as a string in the form <port>@<hostname>. If not specified, use online licensing. If specified, the network license manager (NLM) must be accessible from the specified VPC and subnets. To use the private hostname of the NLM hub instead of the public hostname, specify the security group ID of the NLM hub in the AdditionalSecurityGroup parameter. For more information, see https://github.com/mathworks-ref-arch/license-manager-for-matlab-on-aws.",
      "Type": "String",
      "Default": "",
      "AllowedPattern": "([0-9]+@[a-zA-Z0-9.\\-]+)?",
      "ConstraintDescription": "If specified, must be in the form <port>@<hostname>"
    },
    "EnableCloudWatch": {
      "Description": "Flag indicating whether cloudwatch logging for the MATLAB instance is enabled.",
      "Type": "String",
      "AllowedValues": [
        "Yes",
        "No"
      ],
      "Default": "No"
    },
    "AutoShutdown": {
      "Description": "Choose whether you want to enable autoshutdown for your instance after a certain number of hours",
      "Type": "String",
      "AllowedValues": [
        "Never",
        "After 1 hour",
        "After 2 hours",
        "After 3 hours",
        "After 4 hours",
        "After 5 hours",
        "After 6 hours",
        "After 7 hours",
        "After 8 hours",
        "After 9 hours",
        "After 10 hours",
        "After 11 hours",
        "After 12 hours",
        "After 13 hours",
        "After 14 hours",
        "After 15 hours",
        "After 16 hours",
        "After 17 hours",
        "After 18 hours",
        "After 19 hours",
        "After 20 hours",
        "After 21 hours",
        "After 22 hours",
        "After 23 hours",
        "After 24 hours"
      ],
      "Default": "Never"
    },
    "AdditionalSecurityGroup": {
      "Description": "ID of an additional (optional) Security Group for the instances to be placed in. Often the License Manager for MATLAB's Security Group.",
      "Type": "String",
      "Default": ""
    },
    "CustomAmiId": {
      "Default": "",
      "Description": "ID of a custom Amazon Machine Image (AMI) in the target region (optional). If the build has been customized then the resulting machine image may no longer be compatible with the provided CloudFormation template. Compatability can in some cases be restored by making corresponding modifications to the CloudFormation template. The ID should start with 'ami-'.",
      "Type": "String"
    },
    "OptionalUserCommand": {
      "Description": "Provide an optional inline shell command to run on machine launch. For example, to set an environment variable CLOUD=AWS, use this command excluding the angle brackets: <echo -e \"export CLOUD=AWS\" | tee -a /etc/profile.d/setenvvar.sh && source /etc/profile>. To run an external script, use this command excluding the angle brackets: <wget -O /tmp/my-script.sh \"https://www.example.com/script.sh\" && bash /tmp/my-script.sh>. Find the logs at '/var/log/mathworks/startup.log'.",
      "Type": "String",
      "Default": ""
    }
  },
  "Rules": {
    "matchPasswords": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "Password"
              },
              {
                "Ref": "ConfirmPassword"
              }
            ]
          },
          "AssertDescription": "Passwords do not match"
        }
      ]
    },
    "SubnetInVPC": {
      "Assertions": [
        {
          "Assert": {
            "Fn::EachMemberEquals": [
              {
                "Fn::ValueOfAll": [
                  "AWS::EC2::Subnet::Id",
                  "VpcId"
                ]
              },
              {
                "Ref": "VPC"
              }
            ]
          },
          "AssertDescription": "Subnet must exist in the VPC you have selected"
        }
      ]
    },
    "NoAdditionalPoliciesOnCustomRole": {
      "RuleCondition": {
        "Fn::Not": [
          {
            "Fn::Equals": [
              {
                "Ref": "CustomIamRole"
              },
              ""
            ]
          }
        ]
      },
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "AdditionalIamPolicies"
              },
              ""
            ]
          },
          "AssertDescription": "You cannot add IAM Policies when using a custom IAM Role."
        }
      ]
    },
    "MultipleRolesMustNotExist": {
      "RuleCondition": {
        "Fn::Not": [
          {
            "Fn::Equals": [
              {
                "Ref": "CustomIamRole"
              },
              ""
            ]
          }
        ]
      },
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "EnableCloudWatch"
              },
              "No"
            ]
          },
          "AssertDescription": "You cannot use CloudWatch when using a custom IAM role. The deployment will create an IAM role which you can later modify with additional policies if needed."
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "AccessProtocol"
                  },
                  "NICE DCV"
                ]
              }
            ]
          },
          "AssertDescription": "You cannot use NICE DCV when using a custom IAM role. The deployment will create an IAM role which you can later modify with additional policies if needed."
        }
      ]
    }
  },
  "Conditions": {
    "UsePredefinedRole": {
      "Fn::Equals": [
        {
          "Ref": "CustomIamRole"
        },
        ""
      ]
    },
    "UseCustomIamRole": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "CustomIamRole"
            },
            ""
          ]
        }
      ]
    },
    "UseAdditionalPolicies": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalIamPolicies"
            },
            ""
          ]
        }
      ]
    },
    "UseCloudWatch": {
      "Fn::Equals": [
        {
          "Ref": "EnableCloudWatch"
        },
        "Yes"
      ]
    },
    "UseNICEDCV": {
      "Fn::Equals": [
        {
          "Ref": "AccessProtocol"
        },
        "NICE DCV"
      ]
    },
    "UseXRDP": {
      "Fn::Equals": [
        {
          "Ref": "AccessProtocol"
        },
        "RDP"
      ]
    },
    "UseMATLABProxy": {
      "Fn::Equals": [
        {
          "Ref": "EnableMATLABProxy"
        },
        "Yes"
      ]
    },
    "UseElasticIPAddress": {
      "Fn::Equals": [
        {
          "Ref": "UseElasticIpAddress"
        },
        "Yes"
      ]
    },
    "UseCustomAMI": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "CustomAmiId"
            },
            ""
          ]
        }
      ]
    },
    "AddSG": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalSecurityGroup"
            },
            ""
          ]
        }
      ]
    }
  },
  "Outputs": {
    "CloudWatchLogs": {
      "Condition": "UseCloudWatch",
      "Description": "The cloudwatch logs containing logging information about the MATLAB instance",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://console.aws.amazon.com/cloudwatch/home?region=",
            {
              "Ref": "AWS::Region"
            },
            "#logsV2:log-groups/log-group/",
            {
              "Fn::GetAtt": [
                "MWLogLocation",
                "Outputs.LogGroupName"
              ]
            }
          ]
        ]
      }
    },
    "NiceDCVConnection": {
      "Condition": "UseNICEDCV",
      "Description": "Public url of the newly created EC2 instance to connect to the session via NICE DCV",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://",
            {
              "Fn::GetAtt": [
                "MATLABEC2Instance",
                "PublicDnsName"
              ]
            },
            ":8443/#console"
          ]
        ]
      }
    },
    "RDPConnection": {
      "Condition": "UseXRDP",
      "Description": "Public DNSName of the newly created EC2 instance",
      "Value": {
        "Fn::GetAtt": [
          "MATLABEC2Instance",
          "PublicDnsName"
        ]
      }
    },
    "BrowserConnection": {
      "Condition": "UseMATLABProxy",
      "Description": "URL to connect to and open MATLAB in a browser.",
      "Value": {
        "Fn::Sub": "https://${MATLABEC2Instance.PublicDnsName}:8123"
      }
    }
  },
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "EC2 Instance"
          },
          "Parameters": [
            "InstanceName",
            "InstanceType",
            "RootVolumeSize",
            "CustomIamRole",
            "AdditionalIamPolicies"
          ]
        },
        {
          "Label": {
            "default": "Remote Access"
          },
          "Parameters": [
            "AccessProtocol",
            "EnableMATLABProxy",
            "UseElasticIpAddress",
            "ClientIPAddress",
            "SSHKeyName",
            "Password",
            "ConfirmPassword"
          ]
        },
        {
          "Label": {
            "default": "Network Configuration"
          },
          "Parameters": [
            "VPC",
            "Subnet",
            "AdditionalSecurityGroup"
          ]
        },
        {
          "Label": {
            "default": "License Configuration"
          },
          "Parameters": [
            "LicenseManager"
          ]
        },
        {
          "Label": {
            "default": "Logging Configuration"
          },
          "Parameters": [
            "EnableCloudWatch"
          ]
        },
        {
          "Label": {
            "default": "Autoshutdown Configuration"
          },
          "Parameters": [
            "AutoShutdown"
          ]
        },
        {
          "Label": {
            "default": "Custom AMI"
          },
          "Parameters": [
            "CustomAmiId"
          ]
        },
        {
          "Label": {
            "default": "Optional User Command"
          },
          "Parameters": [
            "OptionalUserCommand"
          ]
        }
      ],
      "ParameterLabels": {
        "ClientIPAddress": {
          "default": "Allow connections from"
        },
        "UseElasticIpAddress": {
          "default": "Keep public ip the same"
        },
        "InstanceType": {
          "default": "AWS EC2 Instance type"
        },
        "InstanceName": {
          "default": "Instance Name"
        },
        "RootVolumeSize": {
          "default": "Storage Size (GiB)"
        },
        "CustomIamRole": {
          "default": "Custom IAM Role (Optional)"
        },
        "AdditionalIamPolicies": {
          "default": "Additional IAM Policies (Optional)"
        },
        "VPC": {
          "default": "VPC to deploy this stack to"
        },
        "Subnet": {
          "default": "Subnet"
        },
        "Password": {
          "default": "Remote password"
        },
        "ConfirmPassword": {
          "default": "Confirm remote password"
        },
        "SSHKeyName": {
          "default": "SSH Key Pair"
        },
        "EnableMATLABProxy": {
          "default": "Enable browser access for MATLAB"
        },
        "LicenseManager": {
          "default": "License Manager for MATLAB connection string"
        },
        "AdditionalSecurityGroup": {
          "default": "Additional security group to place instances in"
        },
        "EnableCloudWatch": {
          "default": "Configure cloudwatch logging for the MATLAB instance"
        },
        "AccessProtocol": {
          "default": "Remote access protocol"
        },
        "CustomAmiId": {
          "default": "Custom AMI ID (Optional)"
        },
        "OptionalUserCommand": {
          "default": "Optional user inline command"
        }
      }
    }
  }
}
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2023a/README.md">
# MATLAB on Amazon Web Services (Linux VM)

## Step 1. Launch the Template

Click the **Launch Stack** button to deploy a standalone MATLAB&reg; desktop client on AWS&reg;. This opens the CloudFormation Create Stack screen in your web browser.

| Region | Launch Link |
| --------------- | ----------- |
| **us-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-east-1.console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023a/aws-matlab-template.json) |
| **us-east-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-east-2.console.aws.amazon.com/cloudformation/home?region=us-east-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023a/aws-matlab-template.json) |
| **us-west-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-west-1.console.aws.amazon.com/cloudformation/home?region=us-west-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023a/aws-matlab-template.json) |
| **us-west-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-west-2.console.aws.amazon.com/cloudformation/home?region=us-west-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023a/aws-matlab-template.json) |
| **ca-central-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ca-central-1.console.aws.amazon.com/cloudformation/home?region=ca-central-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023a/aws-matlab-template.json) |
| **eu-central-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-central-1.console.aws.amazon.com/cloudformation/home?region=eu-central-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023a/aws-matlab-template.json) |
| **eu-west-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-1.console.aws.amazon.com/cloudformation/home?region=eu-west-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023a/aws-matlab-template.json) |
| **eu-west-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-2.console.aws.amazon.com/cloudformation/home?region=eu-west-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023a/aws-matlab-template.json) |
| **eu-west-3** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-3.console.aws.amazon.com/cloudformation/home?region=eu-west-3#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023a/aws-matlab-template.json) |
| **eu-north-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-north-1.console.aws.amazon.com/cloudformation/home?region=eu-north-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023a/aws-matlab-template.json) |
| **sa-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://sa-east-1.console.aws.amazon.com/cloudformation/home?region=sa-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023a/aws-matlab-template.json) |
| **me-south-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://me-south-1.console.aws.amazon.com/cloudformation/home?region=me-south-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023a/aws-matlab-template.json) |
| **ap-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-east-1.console.aws.amazon.com/cloudformation/home?region=ap-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023a/aws-matlab-template.json) |
| **ap-south-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-south-1.console.aws.amazon.com/cloudformation/home?region=ap-south-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023a/aws-matlab-template.json) |
| **ap-northeast-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-northeast-1.console.aws.amazon.com/cloudformation/home?region=ap-northeast-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023a/aws-matlab-template.json) |
| **ap-northeast-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-northeast-2.console.aws.amazon.com/cloudformation/home?region=ap-northeast-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023a/aws-matlab-template.json) |
| **ap-southeast-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-southeast-1.console.aws.amazon.com/cloudformation/home?region=ap-southeast-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023a/aws-matlab-template.json) |
| **ap-southeast-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-southeast-2.console.aws.amazon.com/cloudformation/home?region=ap-southeast-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023a/aws-matlab-template.json) |


**Note**: Creating a stack on AWS can take a few minutes.

## Step 2. Configure the Cloud Resources
After you click the Launch Stack button above, the “Create stack” page will open in your browser where you can configure the parameters. It is easier to complete the steps if you position these instructions and the AWS console window side by side.

1. Specify a stack name. This will be shown in the AWS CloudFormation console and must be unique within the AWS account.


2. Specify and check the defaults for these resource parameters:

| Parameter label | Description |
| --------------- | ----------- |
| **AWS EC2 Instance type** | AWS instance type to use for MATLAB. See https://aws.amazon.com/ec2/instance-types for a list of instance types. |
| **Instance Name** | Name for the MATLAB virtual machine |
| **Remote access protocol** | Access protocol to connect to this instance |
| **Enable browser access for MATLAB** | Option that enables access to MATLAB on your cloud instance within a browser. Opening MATLAB in a browser opens a separate MATLAB session to your Remote Desktop Protocol (RDP) session or NICE DCV session. |
| **Keep public ip the same** | Flag indicating whether you want to keep the same public IP address for the instance |
| **Storage Size (GiB)** | Size in GB of the root volume |
| **Custom IAM Role (Optional)** | Name of a custom IAM Role to associate with this instance. If not specified, a predefined role is used. If specified, features requiring special permissions will be unavailable (NICE DCV, CloudWatch, IAM Policies). |
| **Additional IAM Policies (Optional)** | Semicolon-delimited list of IAM Policy ARNs to add to the predefined role. This option cannot be used with a custom IAM Role. |
| **VPC to deploy this stack to** | ID of an existing VPC in which to deploy this stack |
| **Subnet** | ID of an existing subnet. To access the instance from anywhere, ensure that your subnet auto-assigns public IP addresses and is connected to the internet. |
| **SSH Key Pair** | Name of an existing EC2 KeyPair to allow SSH access to all the instances. See https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html for details on creating these. |
| **Allow connections from** | IP address range that will be allowed to connect to this instance from outside of the VPC. This field should be formatted as \<ip_address>/\<mask>. E.g. 10.0.0.1/32. This is the public IP address which can be found by searching for 'what is my ip address' on the web. The mask determines the number of IP addresses to include. A mask of 32 is a single IP address. This calculator can be used to build a specific range: https://www.ipaddressguide.com/cidr. You may need to contact your IT administrator to determine which address is appropriate. |
| **Remote password** | Password for the "ubuntu" user. You also need to enter this as an authentication token to access MATLAB on your cloud instance within a browser. |
| **Confirm remote password** | Confirm Password |
| **License Manager for MATLAB connection string** | Optional License Manager for MATLAB, specified as a string in the form \<port>@\<hostname>. If not specified, use online licensing. If specified, the network license manager (NLM) must be accessible from the specified VPC and subnets. To use the private hostname of the NLM hub instead of the public hostname, specify the security group ID of the NLM hub in the AdditionalSecurityGroup parameter. For more information, see https://github.com/mathworks-ref-arch/license-manager-for-matlab-on-aws. |
| **Configure cloudwatch logging for the MATLAB instance** | Flag indicating whether cloudwatch logging for the MATLAB instance is enabled. |
| **AutoShutdown** | Choose whether you want to enable autoshutdown for your instance after a certain number of hours |
| **Additional security group to place instances in** | ID of an additional (optional) Security Group for the instances to be placed in. Often the License Manager for MATLAB's Security Group. |
| **Custom AMI ID (Optional)** | ID of a custom Amazon Machine Image (AMI) in the target region (optional). If the build has been customized then the resulting machine image may no longer be compatible with the provided CloudFormation template. Compatability can in some cases be restored by making corresponding modifications to the CloudFormation template. The ID should start with 'ami-'. |
| **Optional user inline command** | Provide an optional inline shell command to run on machine launch. For example, to set an environment variable CLOUD=AWS, use this command excluding the angle brackets: \<echo -e "export CLOUD=AWS" \| tee -a /etc/profile.d/setenvvar.sh && source /etc/profile>. To run an external script, use this command excluding the angle brackets: \<wget -O /tmp/my-script.sh "https://www.example.com/script.sh" && bash /tmp/my-script.sh>. Find the logs at '/var/log/mathworks/startup.log'. |


>**Note**: In the capabilities section, you must acknowledge that AWS Cloudformation might create IAM resources and autoexpand nested templates when creating the stack.

3. Click the **Create Stack** button.  The CloudFormation service will start creating the resources for the stack. <p>After clicking **Create** you will be taken to the *Stack Detail* page for your stack. Wait for the Status to reach **CREATE\_COMPLETE**. This may take up to 10 minutes.</p>

## Step 3. Connect to the Virtual Machine in the Cloud

If you chose RDP, then:
1. Expand the **Outputs** section in the the *Stack Detail* page.
1. Look for the key named `RDPConnection` and copy the corresponding public DNS name listed under value. *For example*: ec2-11-222-33-44.compute-1.amazonaws.com
1. Launch any remote desktop client, paste the public DNS name in the appropriate field, and connect. On the Windows Remote Desktop Client you need to paste the public DNS name in the **Computer** field and click **Connect**.
1. In the login screen that's displayed, use the username `ubuntu` and the password you specified while setting up the stack in [Step 2](#step-2-configure-the-stack).

If you chose NICE DCV, then:
1. Expand the **Outputs** section in the the *Stack Detail* page.
1. Look for the key named `NiceDCVConnection` and click on it
1. In the login screen that's displayed, use the username `ubuntu` and the password you specified while setting up the stack in [Step 2](#step-2-configure-the-stack).

If you chose to enable browser access for MATLAB, then:
1. Expand the **Outputs** section in the *Stack Details* page.
1. Look for the key named `BrowserConnection` and click on it
1. On the login screen, use the password you specified while deploying the stack in [Step 2](#step-2-configure-the-stack) as the 'auth token' to authenticate.
1. Browser access for MATLAB is enabled using `matlab-proxy`, a MathWorks&reg; developed Python&reg; package. For more information on `matlab-proxy`, refer to [matlab-proxy GitHub repository](https://github.com/mathworks/matlab-proxy).

## Step 4. Start MATLAB
Double-click the MATLAB icon on the virtual machine desktop to start MATLAB. The first time you start MATLAB, you need to enter your MathWorks Account credentials to license MATLAB. For other ways to license MATLAB, see [MATLAB Licensing in the Cloud](https://www.mathworks.com/help/install/license/licensing-for-mathworks-products-running-on-the-cloud.html).

>**Note**: It may take up to a minute for MATLAB to start the first time.


# Additional Information

## Delete Your Cloud Resources

Once you have finished using your stack, it is recommended that you delete all resources to avoid incurring further cost. To delete the stack, do the following:
1. Log in to the AWS Console.
1. Go to the AWS CloudFormation page and select the stack you created.
1. Click the **Actions** button and click **Delete Stack** from the menu that appears.

## Nested Stacks

This CloudFormation template uses nested stacks to reference templates used by multiple reference architectures. For details, see the [MathWorks Infrastructure as Code Building Blocks](https://github.com/mathworks-ref-arch/iac-building-blocks) repository.

## CloudWatch Logs
CloudWatch logs enables you to access logs from all the resources in your stack in a single place. To use CloudWatch logs, launch the stack with the feature "Configure cloudwatch logging for the MATLAB instance" enabled. Once the stack deployment is complete, you can access your logs in the "Outputs" of the stack by clicking the link next to "CloudWatchLogs". Note that if you delete the stack, the CloudWatch log group is also deleted. For more information, see [What is Amazon CloudWatch Logs?](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/WhatIsCloudWatchLogs.html).

----

Copyright 2018-2024 The MathWorks, Inc.

----
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2022b/aws-matlab-template.json">
{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Mappings": {
    "RegionMap": {
      "us-east-1": {
        "AMI": "ami-0418da007bbfbccea"
      },
      "us-east-2": {
        "AMI": "ami-005f8c4229c0c7f45"
      },
      "us-west-1": {
        "AMI": "ami-01d7232aaf2cdcfa4"
      },
      "us-west-2": {
        "AMI": "ami-0f49fd51f1dc313a4"
      },
      "ca-central-1": {
        "AMI": "ami-0f91537aeef2b6705"
      },
      "eu-central-1": {
        "AMI": "ami-04a0b7653266cc278"
      },
      "eu-west-1": {
        "AMI": "ami-0ae7e68b27b5270ad"
      },
      "eu-west-2": {
        "AMI": "ami-05023dfae5548c838"
      },
      "eu-west-3": {
        "AMI": "ami-0869d29d6777ae303"
      },
      "eu-north-1": {
        "AMI": "ami-05769699ca7f8ebd9"
      },
      "sa-east-1": {
        "AMI": "ami-08a57547fe18501b7"
      },
      "me-south-1": {
        "AMI": "ami-09c7ee56993e430b6"
      },
      "ap-east-1": {
        "AMI": "ami-00bb6322d01e266ea"
      },
      "ap-south-1": {
        "AMI": "ami-0773e5186b9e000c8"
      },
      "ap-northeast-1": {
        "AMI": "ami-0c5b346a07903de82"
      },
      "ap-northeast-2": {
        "AMI": "ami-06109bb0fd8b5708c"
      },
      "ap-southeast-1": {
        "AMI": "ami-0e62eadcad5a5dd83"
      },
      "ap-southeast-2": {
        "AMI": "ami-01e24b5923f95be10"
      }
    }
  },
  "Resources": {
    "PredefinedRole": {
      "Type": "AWS::IAM::Role",
      "Condition": "UsePredefinedRole",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "ec2.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/MW/",
        "ManagedPolicyArns": {
          "Fn::If": [
            "UseAdditionalPolicies",
            {
              "Fn::Split": [
                ";",
                {
                  "Ref": "AdditionalIamPolicies"
                }
              ]
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "Policies": [
          {
            "Fn::If": [
              "UseCloudWatch",
              {
                "PolicyName": "cloudwatch-access-policy",
                "PolicyDocument": {
                  "Version": "2012-10-17",
                  "Statement": [
                    {
                      "Effect": "Allow",
                      "Action": [
                        "logs:CreateLogStream",
                        "logs:DescribeLogStreams",
                        "logs:PutLogEvents"
                      ],
                      "Resource": {
                        "Fn::Sub": [
                          "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:${LogGroupName}:*",
                          {
                            "LogGroupName": {
                              "Fn::GetAtt": [
                                "MWLogLocation",
                                "Outputs.LogGroupName"
                              ]
                            }
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          {
            "PolicyName": "dcv-access-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "s3:GetObject",
                  "Resource": {
                    "Fn::Sub": "arn:${AWS::Partition}:s3:::dcv-license.${AWS::Region}/*"
                  }
                }
              ]
            }
          },
          {
            "PolicyName": "ssm-access-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "ssm:DescribeAssociation",
                    "ssm:GetDeployablePatchSnapshotForInstance",
                    "ssm:GetDocument",
                    "ssm:DescribeDocument",
                    "ssm:GetManifest",
                    "ssm:GetParameter",
                    "ssm:GetParameters",
                    "ssm:ListAssociations",
                    "ssm:ListInstanceAssociations",
                    "ssm:PutInventory",
                    "ssm:PutComplianceItems",
                    "ssm:PutConfigurePackageResult",
                    "ssm:UpdateAssociationStatus",
                    "ssm:UpdateInstanceAssociationStatus",
                    "ssm:UpdateInstanceInformation"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ssmmessages:CreateControlChannel",
                    "ssmmessages:CreateDataChannel",
                    "ssmmessages:OpenControlChannel",
                    "ssmmessages:OpenDataChannel"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ec2messages:AcknowledgeMessage",
                    "ec2messages:DeleteMessage",
                    "ec2messages:FailMessage",
                    "ec2messages:GetEndpoint",
                    "ec2messages:GetMessages",
                    "ec2messages:SendReply"
                  ],
                  "Resource": "*"
                }
              ]
            }
          },
          {
            "PolicyName": "describe-tags-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "ec2:DescribeTags",
                  "Resource": {
                    "Fn::Sub": "arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:instance/*"
                  },
                  "Condition": {
                    "StringEquals": {
                      "aws:ResourceTag/mw-ProductID": [
                        "MathWorks-MATLAB-Linux"
                      ],
                      "aws:ResourceTag/mw-StackName": [
                        {
                          "Ref": "AWS::StackName"
                        }
                      ]
                    }
                  }
                }
              ]
            }
          }
        ]
      }
    },
    "MATLABInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/MW/",
        "Roles": [
          {
            "Fn::If": [
              "UsePredefinedRole",
              {
                "Ref": "PredefinedRole"
              },
              {
                "Ref": "CustomIamRole"
              }
            ]
          }
        ]
      }
    },
    "MWSecurityGroup": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": "https://mathworks-reference-architectures-templates.s3.amazonaws.com/security-group/v1/1/0/security-group.yml",
        "Parameters": {
          "VpcId": {
            "Ref": "VPC"
          },
          "CidrIp": {
            "Ref": "ClientIPAddress"
          },
          "SSHAccess": "Yes",
          "RDPAccess": "Yes",
          "NICEDCVAccess": "Yes",
          "MATLABProxyAccess": "Yes"
        }
      }
    },
    "MWLogLocation": {
      "Type": "AWS::CloudFormation::Stack",
      "Condition": "UseCloudWatch",
      "Properties": {
        "TemplateURL": "https://mathworks-reference-architectures-templates.s3.amazonaws.com/log-location/v1/0/0/log-location.yml"
      }
    },
    "MATLABEC2Instance": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "ImageId": {
          "Fn::If": [
            "UseCustomAMI",
            {
              "Ref": "CustomAmiId"
            },
            {
              "Fn::FindInMap": [
                "RegionMap",
                {
                  "Ref": "AWS::Region"
                },
                "AMI"
              ]
            }
          ]
        },
        "KeyName": {
          "Ref": "SSHKeyName"
        },
        "SecurityGroupIds": [
          {
            "Fn::GetAtt": [
              "MWSecurityGroup",
              "Outputs.SecurityGroupId"
            ]
          },
          {
            "Fn::If": [
              "AddSG",
              {
                "Ref": "AdditionalSecurityGroup"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          }
        ],
        "SubnetId": {
          "Ref": "Subnet"
        },
        "InstanceType": {
          "Ref": "InstanceType"
        },
        "IamInstanceProfile": {
          "Ref": "MATLABInstanceProfile"
        },
        "EbsOptimized": "true",
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "VolumeSize": {
                "Ref": "RootVolumeSize"
              }
            }
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Ref": "InstanceName"
            }
          },
          {
            "Key": "mw-ProductID",
            "Value": "MathWorks-MATLAB-Linux"
          },
          {
            "Key": "mw-StackName",
            "Value": {
              "Ref": "AWS::StackName"
            }
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "\n",
              [
                "#!/bin/bash",
                "",
                "# Copyright 2022 The MathWorks, Inc.",
                "",
                "STARTUP_FOLDER=/opt/mathworks/startup",
                "# Load startup variables",
                "if [[ -r ${STARTUP_FOLDER}/.env ]]; then",
                "    set -o allexport",
                "    source ${STARTUP_FOLDER}/.env",
                "    set +o allexport",
                "fi",
                "",
                "# Define startup parameters",
                {
                  "Fn::Sub": [
                    "export PASSWORD=${PasswordBase64}",
                    {
                      "PasswordBase64": {
                        "Fn::Base64": {
                          "Ref": "Password"
                        }
                      }
                    }
                  ]
                },
                {
                  "Fn::Sub": "export MLM_LICENSE_FILE=${LicenseManager}"
                },
                {
                  "Fn::Sub": [
                    "export CLOUD_LOG_NAME=${LogGroupName}",
                    {
                      "LogGroupName": {
                        "Fn::If": [
                          "UseCloudWatch",
                          {
                            "Fn::GetAtt": [
                              "MWLogLocation",
                              "Outputs.LogGroupName"
                            ]
                          },
                          ""
                        ]
                      }
                    }
                  ]
                },
                {
                  "Fn::Sub": "export ACCESS_PROTOCOL='${AccessProtocol}'"
                },
                {
                  "Fn::Sub": "export ENABLE_MATLAB_PROXY='${EnableMATLABProxy}'"
                },
                {
                  "Fn::Sub": "export OPTIONAL_USER_COMMAND='${OptionalUserCommand}'"
                },
                "",
                "# Run startup scripts",
                "mkdir -p /var/log/mathworks",
                "run-parts --exit-on-error --verbose --regex '^[0-9]+_.+$' ${STARTUP_FOLDER} >> /var/log/mathworks/startup.log 2>&1",
                "",
                "# Signal the status from cfn-init",
                {
                  "Fn::Sub": "/opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --region ${AWS::Region} --resource MATLABEC2Instance"
                }
              ]
            ]
          }
        }
      },
      "CreationPolicy": {
        "ResourceSignal": {
          "Timeout": "PT15M"
        }
      }
    },
    "ElasticIP": {
      "Type": "AWS::EC2::EIP",
      "Condition": "UseElasticIPAddress",
      "Properties": {
        "InstanceId": {
          "Ref": "MATLABEC2Instance"
        },
        "Domain": "vpc"
      }
    },
    "document": {
      "Type": "AWS::SSM::Document",
      "Condition": "UsePredefinedRole",
      "Properties": {
        "DocumentType": "Command",
        "Content": {
          "schemaVersion": "2.2",
          "description": "Run a script on Linux instances.",
          "parameters": {
            "commands": {
              "type": "String",
              "description": "Command to run on EC2 instance",
              "default": "echo 'Hello World'"
            }
          },
          "mainSteps": [
            {
              "action": "aws:runShellScript",
              "name": "runCommands",
              "inputs": {
                "timeoutSeconds": "60",
                "runCommand": [
                  "{{ commands }}"
                ]
              }
            }
          ]
        }
      }
    },
    "AutoShutdownLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "ZipFile": "# Copyright 2021-2024 The MathWorks, Inc.\n\nimport boto3,os,re\nfrom datetime import datetime as dt,timedelta\n\nec2=boto3.client(\"ec2\")\nDEFAULT_TIME_INTERVAL=os.environ['DEFAULT_TIME_INTERVAL']\n# Uniquely identify instance using AWS-provided stack-level tags\nres=ec2.describe_instances(Filters=[{'Name':'tag:aws:cloudformation:stack-name','Values':[os.environ['STACK_NAME']]},{'Name':'tag:aws:cloudformation:logical-id','Values':['MATLABEC2Instance']},{'Name': 'instance-state-name','Values': ['running', 'pending']}])\nINSTANCE=res[\"Reservations\"][0][\"Instances\"][0]\nINSTANCE_ID=INSTANCE[\"InstanceId\"]\nLOG_MESSAGES={\"instance-stopped\":\"Instance is stopped.\",\"tag-never\":\"Autoshutdown is not enabled. Change the value of mw-autoshutdown tag of the EC2 instance to enable the autoshutdown feature.\",\"tag-invalid\":\"The value of the mw-autoshutdown tag you have set is not valid. The format of the timestamp must be a valid RFC 1123 UTC timestamp, such as Thu, 16 Dec 2021 12:28:47 GMT.\",\"instance-booted\":\"Instance has just started. Setting mw-autoshutdown value.\",\"stop-instance\":\"Shutdown time has been reached. Shutting instance down.\",\"early-to-shutdown\":\"Shutdown time has not been reached yet. Too early to shutdown instance.\"}\nRET_VAL={\"statusCode\": 200}\n\ndef log_to_cloudwatch(id):\n    print(LOG_MESSAGES[id])\n\ndef get_start_time():\n    launch_time=INSTANCE[\"LaunchTime\"]\n    return re.sub(r\"\\+00:00\",\"\",str(launch_time))\n\ndef get_shutdown_tag():\n    tags=INSTANCE[\"Tags\"]\n    shutdown_tag=next((tag for tag in tags if tag[\"Key\"]==\"mw-autoshutdown\"), None)\n    return shutdown_tag\n\ndef set_shutdown_tag(shutdown_time):\n    ec2.create_tags(Resources=[INSTANCE_ID], Tags=[{\"Key\": \"mw-autoshutdown\",\"Value\": str(shutdown_time)}])\n\ndef set_shutdown_time():\n    time_interval=int(re.findall(\"[0-9]+\",DEFAULT_TIME_INTERVAL)[0])\n    launch_time=dt.fromisoformat(get_start_time())\n    shutdown_time=launch_time+timedelta(hours=int(time_interval))\n    shutdown_time_gmt=dt.strftime(shutdown_time,'%a, %d %b %Y %H:%M:%S GMT')\n    set_shutdown_tag(shutdown_time_gmt)\n\ndef lambda_handler(event, context):\n    # No action while the instance is stopped.\n    if INSTANCE[\"State\"][\"Name\"]==\"stopped\":\n        log_to_cloudwatch(id=\"instance-stopped\")\n        return RET_VAL\n    shutdown_tag=get_shutdown_tag()\n    # In the first function run, use DEFAULT_TIME_INTERVAL to determine what to do.\n    if shutdown_tag is None:\n        if DEFAULT_TIME_INTERVAL==\"Never\":\n            # Set the tag to \"never\".\n            set_shutdown_tag(\"never\")\n            # No action when tag is \"never\"\n            log_to_cloudwatch(id=\"tag-never\")\n            return RET_VAL\n        else:\n            # Set the tag to start time + user chosen time interval.\n            set_shutdown_time()\n            log_to_cloudwatch(id=\"instance-booted\")\n            return RET_VAL\n    # If the tag exists, use it to determine what to do.\n    if shutdown_tag[\"Value\"]==\"change_me_on_boot\":\n        set_shutdown_time()\n        log_to_cloudwatch(id=\"instance-booted\")\n        return RET_VAL\n    elif shutdown_tag[\"Value\"]==\"never\":\n        # No action when tag is \"never\"\n        log_to_cloudwatch(id=\"tag-never\")\n        return RET_VAL\n    else:\n        # Check the tag value to determine whether instance needs to be shutdown.\n        try:\n            shutdown_time=dt.strptime(shutdown_tag[\"Value\"],'%a, %d %b %Y %H:%M:%S GMT')\n        except ValueError:\n            log_to_cloudwatch(id=\"tag-invalid\")\n            return RET_VAL\n        curr_time=dt.now(shutdown_time.tzinfo)\n        if curr_time>shutdown_time:\n            ec2.stop_instances(InstanceIds=[INSTANCE_ID])\n            # Set the shutdown time as mw-last-autoshutdown-event tag\n            curr_time_gmt=dt.strftime(curr_time, '%a, %d %b %Y %H:%M:%S GMT')\n            ec2.create_tags(Resources=[INSTANCE_ID], Tags=[{\"Key\": \"mw-last-autoshutdown-event\",\"Value\": str(curr_time_gmt)}])\n            log_to_cloudwatch(id=\"stop-instance\")\n            if DEFAULT_TIME_INTERVAL==\"Never\":\n                set_shutdown_tag(\"never\")\n            else:\n                set_shutdown_tag(\"change_me_on_boot\")\n            return RET_VAL\n        else:\n            log_to_cloudwatch(id=\"early-to-shutdown\")\n            return RET_VAL"
        },
        "Environment": {
          "Variables": {
            "DEFAULT_TIME_INTERVAL": {
              "Ref": "AutoShutdown"
            },
            "STACK_NAME": {
              "Ref": "AWS::StackName"
            }
          }
        },
        "Handler": "index.lambda_handler",
        "Runtime": "python3.12",
        "Timeout": "60",
        "Role": {
          "Fn::GetAtt": [
            "AutoShutdownLambdaRole",
            "Arn"
          ]
        }
      }
    },
    "AutoShutdownLambdaRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/MW/",
        "Policies": [
          {
            "PolicyName": "autoshutdown-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "ec2:DescribeInstances",
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ec2:DescribeTags",
                    "ec2:Stopinstances",
                    "ec2:CreateTags",
                    "ec2:DeleteTags"
                  ],
                  "Resource": {
                    "Fn::Sub": "arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:instance/*"
                  },
                  "Condition": {
                    "StringEquals": {
                      "aws:ResourceTag/mw-ProductID": [
                        "MathWorks-MATLAB-Linux"
                      ],
                      "aws:ResourceTag/mw-StackName": [
                        {
                          "Ref": "AWS::StackName"
                        }
                      ]
                    }
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": {
                    "Fn::Sub": "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*AutoShutdownLambda*"
                  }
                }
              ]
            }
          }
        ]
      }
    },
    "AutoShutdownScheduledRule": {
      "Type": "AWS::Events::Rule",
      "Properties": {
        "Description": "AutoShutdownScheduledRule",
        "ScheduleExpression": "rate(15 minutes)",
        "State": "ENABLED",
        "Targets": [
          {
            "Arn": {
              "Fn::GetAtt": [
                "AutoShutdownLambda",
                "Arn"
              ]
            },
            "Id": "TargetFunctionV1"
          }
        ]
      }
    },
    "PermissionForEventsToInvokeLambda": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": {
          "Ref": "AutoShutdownLambda"
        },
        "Action": "lambda:InvokeFunction",
        "Principal": "events.amazonaws.com",
        "SourceArn": {
          "Fn::GetAtt": [
            "AutoShutdownScheduledRule",
            "Arn"
          ]
        }
      }
    },
    "AutoShutdownLambdaLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": {
          "Fn::Join": [
            "",
            [
              "/aws/lambda/",
              {
                "Ref": "AutoShutdownLambda"
              }
            ]
          ]
        }
      }
    }
  },
  "Parameters": {
    "InstanceType": {
      "Description": "AWS instance type to use for MATLAB. See https://aws.amazon.com/ec2/instance-types for a list of instance types.",
      "Default": "m5.xlarge",
      "Type": "String"
    },
    "InstanceName": {
      "Description": "Name for the MATLAB virtual machine",
      "Default": "MATLAB Desktop",
      "Type": "String"
    },
    "AccessProtocol": {
      "Description": "Access protocol to connect to this instance",
      "Default": "RDP",
      "Type": "String",
      "AllowedValues": [
        "NICE DCV",
        "RDP"
      ]
    },
    "EnableMATLABProxy": {
      "Description": "Option that enables access to MATLAB on your cloud instance within a browser. Opening MATLAB in a browser opens a separate MATLAB session to your Remote Desktop Protocol (RDP) session or NICE DCV session.",
      "Default": "Yes",
      "Type": "String",
      "AllowedValues": [
        "Yes",
        "No"
      ]
    },
    "UseElasticIpAddress": {
      "Description": "Flag indicating whether you want to keep the same public IP address for the instance",
      "Default": "No",
      "Type": "String",
      "AllowedValues": [
        "Yes",
        "No"
      ]
    },
    "RootVolumeSize": {
      "Description": "Size in GB of the root volume",
      "Default": "128",
      "Type": "Number",
      "MinValue": "128",
      "MaxValue": "1024",
      "ConstraintDescription": "Size must be between 128 and 1024GB"
    },
    "CustomIamRole": {
      "Description": "Name of a custom IAM Role to associate with this instance. If not specified, a predefined role is used. If specified, features requiring special permissions will be unavailable (NICE DCV, CloudWatch, IAM Policies).",
      "Default": "",
      "Type": "String"
    },
    "AdditionalIamPolicies": {
      "Description": "Semicolon-delimited list of IAM Policy ARNs to add to the predefined role. This option cannot be used with a custom IAM Role.",
      "Default": "",
      "Type": "String",
      "AllowedPattern": "^(arn:[^:;]+:iam::[^:;]+:policy/[^:;]+(;arn:[^:;]+:iam::[^:;]+:policy/[^:;]+)*)?$",
      "ConstraintDescription": "If specified, must be a semicolon (;) delimited list of ARNs (arn:<partition>:iam::<account-id>:policy/<resource-id>)."
    },
    "VPC": {
      "Description": "ID of an existing VPC in which to deploy this stack",
      "Type": "AWS::EC2::VPC::Id",
      "ConstraintDescription": "Must be the ID of an existing VPC.",
      "AllowedPattern": ".+"
    },
    "Subnet": {
      "Description": "ID of an existing subnet. To access the instance from anywhere, ensure that your subnet auto-assigns public IP addresses and is connected to the internet.",
      "Type": "AWS::EC2::Subnet::Id",
      "ConstraintDescription": "Must be the ID of an existing Subnet within the chosen VPC.",
      "AllowedPattern": ".+"
    },
    "SSHKeyName": {
      "Description": "Name of an existing EC2 KeyPair to allow SSH access to all the instances. See https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html for details on creating these.",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "ConstraintDescription": "Must be the name of an existing EC2 KeyPair.",
      "AllowedPattern": ".+"
    },
    "ClientIPAddress": {
      "Description": "IP address range that will be allowed to connect to this instance from outside of the VPC. This field should be formatted as <ip_address>/<mask>. E.g. 10.0.0.1/32. This is the public IP address which can be found by searching for 'what is my ip address' on the web. The mask determines the number of IP addresses to include. A mask of 32 is a single IP address. This calculator can be used to build a specific range: https://www.ipaddressguide.com/cidr. You may need to contact your IT administrator to determine which address is appropriate.",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription": "Must be a valid IP CIDR range of the form x.x.x.x/x."
    },
    "Password": {
      "NoEcho": "true",
      "Description": "Password for the \"ubuntu\" user. You also need to enter this as an authentication token to access MATLAB on your cloud instance within a browser.",
      "Type": "String",
      "ConstraintDescription": "Must have a minimum of 14 characters, 1 uppercase letter, 1 lowercase letter, 1 number, and 1 special character",
      "AllowedPattern": "^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[^a-zA-Z0-9]).{14,}$"
    },
    "ConfirmPassword": {
      "NoEcho": "true",
      "Description": "Confirm Password",
      "Type": "String"
    },
    "LicenseManager": {
      "Description": "Optional License Manager for MATLAB, specified as a string in the form <port>@<hostname>. If not specified, use online licensing. If specified, the network license manager (NLM) must be accessible from the specified VPC and subnets. To use the private hostname of the NLM hub instead of the public hostname, specify the security group ID of the NLM hub in the AdditionalSecurityGroup parameter. For more information, see https://github.com/mathworks-ref-arch/license-manager-for-matlab-on-aws.",
      "Type": "String",
      "Default": "",
      "AllowedPattern": "([0-9]+@[a-zA-Z0-9.\\-]+)?",
      "ConstraintDescription": "If specified, must be in the form <port>@<hostname>"
    },
    "EnableCloudWatch": {
      "Description": "Flag indicating whether cloudwatch logging for the MATLAB instance is enabled.",
      "Type": "String",
      "AllowedValues": [
        "Yes",
        "No"
      ],
      "Default": "No"
    },
    "AutoShutdown": {
      "Description": "Choose whether you want to enable autoshutdown for your instance after a certain number of hours",
      "Type": "String",
      "AllowedValues": [
        "Never",
        "After 1 hour",
        "After 2 hours",
        "After 3 hours",
        "After 4 hours",
        "After 5 hours",
        "After 6 hours",
        "After 7 hours",
        "After 8 hours",
        "After 9 hours",
        "After 10 hours",
        "After 11 hours",
        "After 12 hours",
        "After 13 hours",
        "After 14 hours",
        "After 15 hours",
        "After 16 hours",
        "After 17 hours",
        "After 18 hours",
        "After 19 hours",
        "After 20 hours",
        "After 21 hours",
        "After 22 hours",
        "After 23 hours",
        "After 24 hours"
      ],
      "Default": "Never"
    },
    "AdditionalSecurityGroup": {
      "Description": "ID of an additional (optional) Security Group for the instances to be placed in. Often the License Manager for MATLAB's Security Group.",
      "Type": "String",
      "Default": ""
    },
    "CustomAmiId": {
      "Default": "",
      "Description": "ID of a custom Amazon Machine Image (AMI) in the target region (optional). If the build has been customized then the resulting machine image may no longer be compatible with the provided CloudFormation template. Compatability can in some cases be restored by making corresponding modifications to the CloudFormation template. The ID should start with 'ami-'.",
      "Type": "String"
    },
    "OptionalUserCommand": {
      "Description": "Provide an optional inline shell command to run on machine launch. For example, to set an environment variable CLOUD=AWS, use this command excluding the angle brackets: <echo -e \"export CLOUD=AWS\" | tee -a /etc/profile.d/setenvvar.sh && source /etc/profile>. To run an external script, use this command excluding the angle brackets: <wget -O /tmp/my-script.sh \"https://www.example.com/script.sh\" && bash /tmp/my-script.sh>. Find the logs at '/var/log/mathworks/startup.log'.",
      "Type": "String",
      "Default": ""
    }
  },
  "Rules": {
    "matchPasswords": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "Password"
              },
              {
                "Ref": "ConfirmPassword"
              }
            ]
          },
          "AssertDescription": "Passwords do not match"
        }
      ]
    },
    "SubnetInVPC": {
      "Assertions": [
        {
          "Assert": {
            "Fn::EachMemberEquals": [
              {
                "Fn::ValueOfAll": [
                  "AWS::EC2::Subnet::Id",
                  "VpcId"
                ]
              },
              {
                "Ref": "VPC"
              }
            ]
          },
          "AssertDescription": "Subnet must exist in the VPC you have selected"
        }
      ]
    },
    "NoAdditionalPoliciesOnCustomRole": {
      "RuleCondition": {
        "Fn::Not": [
          {
            "Fn::Equals": [
              {
                "Ref": "CustomIamRole"
              },
              ""
            ]
          }
        ]
      },
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "AdditionalIamPolicies"
              },
              ""
            ]
          },
          "AssertDescription": "You cannot add IAM Policies when using a custom IAM Role."
        }
      ]
    },
    "MultipleRolesMustNotExist": {
      "RuleCondition": {
        "Fn::Not": [
          {
            "Fn::Equals": [
              {
                "Ref": "CustomIamRole"
              },
              ""
            ]
          }
        ]
      },
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "EnableCloudWatch"
              },
              "No"
            ]
          },
          "AssertDescription": "You cannot use CloudWatch when using a custom IAM role. The deployment will create an IAM role which you can later modify with additional policies if needed."
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "AccessProtocol"
                  },
                  "NICE DCV"
                ]
              }
            ]
          },
          "AssertDescription": "You cannot use NICE DCV when using a custom IAM role. The deployment will create an IAM role which you can later modify with additional policies if needed."
        }
      ]
    }
  },
  "Conditions": {
    "UsePredefinedRole": {
      "Fn::Equals": [
        {
          "Ref": "CustomIamRole"
        },
        ""
      ]
    },
    "UseAdditionalPolicies": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalIamPolicies"
            },
            ""
          ]
        }
      ]
    },
    "UseCloudWatch": {
      "Fn::Equals": [
        {
          "Ref": "EnableCloudWatch"
        },
        "Yes"
      ]
    },
    "UseNICEDCV": {
      "Fn::Equals": [
        {
          "Ref": "AccessProtocol"
        },
        "NICE DCV"
      ]
    },
    "UseXRDP": {
      "Fn::Equals": [
        {
          "Ref": "AccessProtocol"
        },
        "RDP"
      ]
    },
    "UseMATLABProxy": {
      "Fn::Equals": [
        {
          "Ref": "EnableMATLABProxy"
        },
        "Yes"
      ]
    },
    "UseElasticIPAddress": {
      "Fn::Equals": [
        {
          "Ref": "UseElasticIpAddress"
        },
        "Yes"
      ]
    },
    "UseCustomAMI": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "CustomAmiId"
            },
            ""
          ]
        }
      ]
    },
    "AddSG": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalSecurityGroup"
            },
            ""
          ]
        }
      ]
    }
  },
  "Outputs": {
    "CloudWatchLogs": {
      "Condition": "UseCloudWatch",
      "Description": "The cloudwatch logs containing logging information about the MATLAB instance",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://console.aws.amazon.com/cloudwatch/home?region=",
            {
              "Ref": "AWS::Region"
            },
            "#logsV2:log-groups/log-group/",
            {
              "Fn::GetAtt": [
                "MWLogLocation",
                "Outputs.LogGroupName"
              ]
            }
          ]
        ]
      }
    },
    "NiceDCVConnection": {
      "Condition": "UseNICEDCV",
      "Description": "Public url of the newly created EC2 instance to connect to the session via NICE DCV",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://",
            {
              "Fn::GetAtt": [
                "MATLABEC2Instance",
                "PublicDnsName"
              ]
            },
            ":8443/#console"
          ]
        ]
      }
    },
    "RDPConnection": {
      "Condition": "UseXRDP",
      "Description": "Public DNSName of the newly created EC2 instance",
      "Value": {
        "Fn::GetAtt": [
          "MATLABEC2Instance",
          "PublicDnsName"
        ]
      }
    },
    "BrowserConnection": {
      "Condition": "UseMATLABProxy",
      "Description": "URL to connect to and open MATLAB in a browser.",
      "Value": {
        "Fn::Sub": "https://${MATLABEC2Instance.PublicDnsName}:8123"
      }
    }
  },
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "EC2 Instance"
          },
          "Parameters": [
            "InstanceName",
            "InstanceType",
            "RootVolumeSize",
            "CustomIamRole",
            "AdditionalIamPolicies"
          ]
        },
        {
          "Label": {
            "default": "Remote Access"
          },
          "Parameters": [
            "AccessProtocol",
            "EnableMATLABProxy",
            "UseElasticIpAddress",
            "ClientIPAddress",
            "SSHKeyName",
            "Password",
            "ConfirmPassword"
          ]
        },
        {
          "Label": {
            "default": "Network Configuration"
          },
          "Parameters": [
            "VPC",
            "Subnet",
            "AdditionalSecurityGroup"
          ]
        },
        {
          "Label": {
            "default": "License Configuration"
          },
          "Parameters": [
            "LicenseManager"
          ]
        },
        {
          "Label": {
            "default": "Logging Configuration"
          },
          "Parameters": [
            "EnableCloudWatch"
          ]
        },
        {
          "Label": {
            "default": "Autoshutdown Configuration"
          },
          "Parameters": [
            "AutoShutdown"
          ]
        },
        {
          "Label": {
            "default": "Custom AMI"
          },
          "Parameters": [
            "CustomAmiId"
          ]
        },
        {
          "Label": {
            "default": "Optional User Command"
          },
          "Parameters": [
            "OptionalUserCommand"
          ]
        }
      ],
      "ParameterLabels": {
        "ClientIPAddress": {
          "default": "Allow connections from"
        },
        "UseElasticIpAddress": {
          "default": "Keep public ip the same"
        },
        "InstanceType": {
          "default": "AWS EC2 Instance type"
        },
        "InstanceName": {
          "default": "Instance Name"
        },
        "RootVolumeSize": {
          "default": "Storage Size (GiB)"
        },
        "CustomIamRole": {
          "default": "Custom IAM Role (Optional)"
        },
        "AdditionalIamPolicies": {
          "default": "Additional IAM Policies (Optional)"
        },
        "VPC": {
          "default": "VPC to deploy this stack to"
        },
        "Subnet": {
          "default": "Subnet"
        },
        "Password": {
          "default": "Remote password"
        },
        "ConfirmPassword": {
          "default": "Confirm remote password"
        },
        "SSHKeyName": {
          "default": "SSH Key Pair"
        },
        "EnableMATLABProxy": {
          "default": "Enable browser access for MATLAB"
        },
        "LicenseManager": {
          "default": "License Manager for MATLAB connection string"
        },
        "AdditionalSecurityGroup": {
          "default": "Additional security group to place instances in"
        },
        "EnableCloudWatch": {
          "default": "Configure cloudwatch logging for the MATLAB instance"
        },
        "AccessProtocol": {
          "default": "Remote access protocol"
        },
        "CustomAmiId": {
          "default": "Custom AMI ID (Optional)"
        },
        "OptionalUserCommand": {
          "default": "Optional user inline command"
        }
      }
    }
  }
}
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2022b/README.md">
# MATLAB on Amazon Web Services (Linux VM)

## Step 1. Launch the Template

Click the **Launch Stack** button to deploy a standalone MATLAB&reg; desktop client on AWS&reg;. This opens the CloudFormation Create Stack screen in your web browser.

| Region | Launch Link |
| --------------- | ----------- |
| **us-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-east-1.console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022b/aws-matlab-template.json) |
| **us-east-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-east-2.console.aws.amazon.com/cloudformation/home?region=us-east-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022b/aws-matlab-template.json) |
| **us-west-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-west-1.console.aws.amazon.com/cloudformation/home?region=us-west-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022b/aws-matlab-template.json) |
| **us-west-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-west-2.console.aws.amazon.com/cloudformation/home?region=us-west-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022b/aws-matlab-template.json) |
| **ca-central-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ca-central-1.console.aws.amazon.com/cloudformation/home?region=ca-central-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022b/aws-matlab-template.json) |
| **eu-central-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-central-1.console.aws.amazon.com/cloudformation/home?region=eu-central-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022b/aws-matlab-template.json) |
| **eu-west-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-1.console.aws.amazon.com/cloudformation/home?region=eu-west-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022b/aws-matlab-template.json) |
| **eu-west-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-2.console.aws.amazon.com/cloudformation/home?region=eu-west-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022b/aws-matlab-template.json) |
| **eu-west-3** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-3.console.aws.amazon.com/cloudformation/home?region=eu-west-3#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022b/aws-matlab-template.json) |
| **eu-north-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-north-1.console.aws.amazon.com/cloudformation/home?region=eu-north-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022b/aws-matlab-template.json) |
| **sa-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://sa-east-1.console.aws.amazon.com/cloudformation/home?region=sa-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022b/aws-matlab-template.json) |
| **me-south-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://me-south-1.console.aws.amazon.com/cloudformation/home?region=me-south-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022b/aws-matlab-template.json) |
| **ap-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-east-1.console.aws.amazon.com/cloudformation/home?region=ap-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022b/aws-matlab-template.json) |
| **ap-south-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-south-1.console.aws.amazon.com/cloudformation/home?region=ap-south-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022b/aws-matlab-template.json) |
| **ap-northeast-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-northeast-1.console.aws.amazon.com/cloudformation/home?region=ap-northeast-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022b/aws-matlab-template.json) |
| **ap-northeast-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-northeast-2.console.aws.amazon.com/cloudformation/home?region=ap-northeast-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022b/aws-matlab-template.json) |
| **ap-southeast-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-southeast-1.console.aws.amazon.com/cloudformation/home?region=ap-southeast-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022b/aws-matlab-template.json) |
| **ap-southeast-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-southeast-2.console.aws.amazon.com/cloudformation/home?region=ap-southeast-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022b/aws-matlab-template.json) |


**Note**: Creating a stack on AWS can take a few minutes.

## Step 2. Configure the Cloud Resources
After you click the Launch Stack button above, the “Create stack” page will open in your browser where you can configure the parameters. It is easier to complete the steps if you position these instructions and the AWS console window side by side.

1. Specify a stack name. This will be shown in the AWS CloudFormation console and must be unique within the AWS account.


2. Specify and check the defaults for these resource parameters:

| Parameter label | Description |
| --------------- | ----------- |
| **AWS EC2 Instance type** | AWS instance type to use for MATLAB. See https://aws.amazon.com/ec2/instance-types for a list of instance types. |
| **Instance Name** | Name for the MATLAB virtual machine |
| **Remote access protocol** | Access protocol to connect to this instance |
| **Enable browser access for MATLAB** | Option that enables access to MATLAB on your cloud instance within a browser. Opening MATLAB in a browser opens a separate MATLAB session to your Remote Desktop Protocol (RDP) session or NICE DCV session. |
| **Keep public ip the same** | Flag indicating whether you want to keep the same public IP address for the instance |
| **Storage Size (GiB)** | Size in GB of the root volume |
| **Custom IAM Role (Optional)** | Name of a custom IAM Role to associate with this instance. If not specified, a predefined role is used. If specified, features requiring special permissions will be unavailable (NICE DCV, CloudWatch, IAM Policies). |
| **Additional IAM Policies (Optional)** | Semicolon-delimited list of IAM Policy ARNs to add to the predefined role. This option cannot be used with a custom IAM Role. |
| **VPC to deploy this stack to** | ID of an existing VPC in which to deploy this stack |
| **Subnet** | ID of an existing subnet. To access the instance from anywhere, ensure that your subnet auto-assigns public IP addresses and is connected to the internet. |
| **SSH Key Pair** | Name of an existing EC2 KeyPair to allow SSH access to all the instances. See https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html for details on creating these. |
| **Allow connections from** | IP address range that will be allowed to connect to this instance from outside of the VPC. This field should be formatted as \<ip_address>/\<mask>. E.g. 10.0.0.1/32. This is the public IP address which can be found by searching for 'what is my ip address' on the web. The mask determines the number of IP addresses to include. A mask of 32 is a single IP address. This calculator can be used to build a specific range: https://www.ipaddressguide.com/cidr. You may need to contact your IT administrator to determine which address is appropriate. |
| **Remote password** | Password for the "ubuntu" user. You also need to enter this as an authentication token to access MATLAB on your cloud instance within a browser. |
| **Confirm remote password** | Confirm Password |
| **License Manager for MATLAB connection string** | Optional License Manager for MATLAB, specified as a string in the form \<port>@\<hostname>. If not specified, use online licensing. If specified, the network license manager (NLM) must be accessible from the specified VPC and subnets. To use the private hostname of the NLM hub instead of the public hostname, specify the security group ID of the NLM hub in the AdditionalSecurityGroup parameter. For more information, see https://github.com/mathworks-ref-arch/license-manager-for-matlab-on-aws. |
| **Configure cloudwatch logging for the MATLAB instance** | Flag indicating whether cloudwatch logging for the MATLAB instance is enabled. |
| **AutoShutdown** | Choose whether you want to enable autoshutdown for your instance after a certain number of hours |
| **Additional security group to place instances in** | ID of an additional (optional) Security Group for the instances to be placed in. Often the License Manager for MATLAB's Security Group. |
| **Custom AMI ID (Optional)** | ID of a custom Amazon Machine Image (AMI) in the target region (optional). If the build has been customized then the resulting machine image may no longer be compatible with the provided CloudFormation template. Compatability can in some cases be restored by making corresponding modifications to the CloudFormation template. The ID should start with 'ami-'. |
| **Optional user inline command** | Provide an optional inline shell command to run on machine launch. For example, to set an environment variable CLOUD=AWS, use this command excluding the angle brackets: \<echo -e "export CLOUD=AWS" \| tee -a /etc/profile.d/setenvvar.sh && source /etc/profile>. To run an external script, use this command excluding the angle brackets: \<wget -O /tmp/my-script.sh "https://www.example.com/script.sh" && bash /tmp/my-script.sh>. Find the logs at '/var/log/mathworks/startup.log'. |


>**Note**: In the capabilities section, you must acknowledge that AWS Cloudformation might create IAM resources and autoexpand nested templates when creating the stack.

3. Click the **Create Stack** button.  The CloudFormation service will start creating the resources for the stack. <p>After clicking **Create** you will be taken to the *Stack Detail* page for your stack. Wait for the Status to reach **CREATE\_COMPLETE**. This may take up to 10 minutes.</p>

## Step 3. Connect to the Virtual Machine in the Cloud

If you chose RDP, then:
1. Expand the **Outputs** section in the the *Stack Detail* page.
1. Look for the key named `RDPConnection` and copy the corresponding public DNS name listed under value. *For example*: ec2-11-222-33-44.compute-1.amazonaws.com
1. Launch any remote desktop client, paste the public DNS name in the appropriate field, and connect. On the Windows Remote Desktop Client you need to paste the public DNS name in the **Computer** field and click **Connect**.
1. In the login screen that's displayed, use the username `ubuntu` and the password you specified while setting up the stack in [Step 2](#step-2-configure-the-stack).

If you chose NICE DCV, then:
1. Expand the **Outputs** section in the the *Stack Detail* page.
1. Look for the key named `NiceDCVConnection` and click on it
1. In the login screen that's displayed, use the username `ubuntu` and the password you specified while setting up the stack in [Step 2](#step-2-configure-the-stack).

If you chose to enable browser access for MATLAB, then:
1. Expand the **Outputs** section in the *Stack Details* page.
1. Look for the key named `BrowserConnection` and click on it
1. On the login screen, use the password you specified while deploying the stack in [Step 2](#step-2-configure-the-stack) as the 'auth token' to authenticate.
1. Browser access for MATLAB is enabled using `matlab-proxy`, a MathWorks&reg; developed Python&reg; package. For more information on `matlab-proxy`, refer to [matlab-proxy GitHub repository](https://github.com/mathworks/matlab-proxy).

## Step 4. Start MATLAB
Double-click the MATLAB icon on the virtual machine desktop to start MATLAB. The first time you start MATLAB, you need to enter your MathWorks Account credentials to license MATLAB. For other ways to license MATLAB, see [MATLAB Licensing in the Cloud](https://www.mathworks.com/help/install/license/licensing-for-mathworks-products-running-on-the-cloud.html).

>**Note**: It may take up to a minute for MATLAB to start the first time.


# Additional Information

## Delete Your Cloud Resources

Once you have finished using your stack, it is recommended that you delete all resources to avoid incurring further cost. To delete the stack, do the following:
1. Log in to the AWS Console.
1. Go to the AWS CloudFormation page and select the stack you created.
1. Click the **Actions** button and click **Delete Stack** from the menu that appears.

## Nested Stacks

This CloudFormation template uses nested stacks to reference templates used by multiple reference architectures. For details, see the [MathWorks Infrastructure as Code Building Blocks](https://github.com/mathworks-ref-arch/iac-building-blocks) repository.

## CloudWatch Logs
CloudWatch logs enables you to access logs from all the resources in your stack in a single place. To use CloudWatch logs, launch the stack with the feature "Configure cloudwatch logging for the MATLAB instance" enabled. Once the stack deployment is complete, you can access your logs in the "Outputs" of the stack by clicking the link next to "CloudWatchLogs". Note that if you delete the stack, the CloudWatch log group is also deleted. For more information, see [What is Amazon CloudWatch Logs?](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/WhatIsCloudWatchLogs.html).

----

Copyright 2018-2024 The MathWorks, Inc.

----
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2019a_and_older/aws-matlab-2018a-existing-vpc-template.json">
{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "MATLAB 2018a on AWS Reference Architecture",
    "Metadata": {
      "AWS::CloudFormation::Interface": {
        "ParameterGroups": [
          {
            "Label": {
              "default": "EC2 Instance"
            },
            "Parameters": ["InstanceType"]
          },
          {
            "Label": {
              "default": "MATLAB Image"
            },
            "Parameters": ["NodeAMI"]
          },
          {
            "Label": {
              "default": "Networking"
            },
            "Parameters": ["VPC", "SubnetA"]
          },
          {
            "Label": {
              "default": "Remote Access"
            },
            "Parameters": ["ClientIPAddress", "SSHKeyName", "Username", "Password", "ConfirmPassword"]
          }
        ],
        "ParameterLabels": {
          "ClientIPAddress": {
            "default": "Allow RDP connections from"
          },
          "InstanceType": {
            "default": "AWS EC2 Instance type"
          },
          "NodeAMI": {
            "default": "MATLAB AMI"
          },
          "user": {
            "default": "Username"
          },
          "password": {
            "default": "password"
          }
        }
      }
    },
    "Parameters": {
      "NodeAMI": {
        "Description": "MATLAB 2018a Desktop AMI",
        "Default": "ami-00ae68c7df9e0cecf",
        "Type": "String"
      },
      "InstanceType": {
        "Description": "Amazon instance type",
        "Default": "m4.xlarge",
        "Type": "String"
      },
      "VPC": {
        "Description": "Existing VPC ID",
        "Type": "AWS::EC2::VPC::Id",
        "ConstraintDescription": "must be the Id of an existing VPC.",
        "Default": ""
      },
      "SubnetA": {
        "Description": "Existing Subnet ID",
        "Type": "AWS::EC2::Subnet::Id",
        "ConstraintDescription": "must be the Id of an existing Subnet.",
        "Default": ""
      },
      "SSHKeyName": {
        "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instance",
        "Type": "AWS::EC2::KeyPair::KeyName",
        "ConstraintDescription": "must be the name of an existing EC2 KeyPair.",
        "Default": ""
      },
      "ClientIPAddress": {
        "Description": "IP address range allowed external RDP connections.",
        "Type": "String",
        "MinLength": "9",
        "MaxLength": "18",
        "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
        "ConstraintDescription": "Must be a valid IP CIDR range of the form x.x.x.x/x."
      },
      "Username": {
        "Description": "Username to access instance",
        "Type": "String",
        "ConstraintDescription": "must be a valid user name",
        "Default": ""
      },
      "Password": {
        "NoEcho": "true",
        "Description": "password",
        "Type": "String",
        "ConstraintDescription": "",
        "Default": ""
      },
      "ConfirmPassword": {
        "NoEcho": "true",
        "Description": "Confirm Password",
        "Type": "String",
        "ConstraintDescription": "",
        "Default": ""
      }
    },
    "Rules" : {
      "matchPasswords" : {
          "Assertions" : [
          {
              "Assert" : {"Fn::Equals":[{"Ref":"Password"},{"Ref":"ConfirmPassword"}]},
              "AssertDescription" : "Passwords do not match"
          }
          ]
      }},
    "Conditions": {},
    "Resources": {
  
      "SSHSecurityGroup": {
        "Type": "AWS::EC2::SecurityGroup",
        "Properties": {
          "VpcId": {
            "Ref": "VPC"
          },
          "GroupDescription": "Enable SSH access via port 22",
          "SecurityGroupIngress": [
            {
              "IpProtocol": "tcp",
              "FromPort": "22",
              "ToPort": "22",
              "CidrIp": {
                  "Ref": "ClientIPAddress"
                }
            },
            {
              "IpProtocol": "tcp",
              "FromPort": "3389",
              "ToPort": "3389",
              "CidrIp":{
                  "Ref": "ClientIPAddress"
                }
            }
          ],
          "SecurityGroupEgress": [
              {
                  "IpProtocol": -1,
                  "CidrIp": "0.0.0.0/0"
              }
          ]
        }
      },
  
      "EC2Instance": {
        "Type": "AWS::EC2::Instance",
        "Properties": {
          "ImageId": { "Ref": "NodeAMI"  },
          "KeyName": {
            "Ref": "SSHKeyName"
          },
          "SecurityGroupIds": [
            {
              "Ref": "SSHSecurityGroup"
            }
          ],
          "SubnetId": {
            "Ref": "SubnetA"
          },
          "InstanceType": {
            "Ref": "InstanceType"
          },
          "EbsOptimized" : "true",
          "UserData": {
            "Fn::Base64": {
              "Fn::Join": [
                "",
                [
                  "#!/bin/bash\n",
                  "# Copyright 2011-2017 The MathWorks, Inc.\n",
                  "cd /usr/local/matlab\n",
                  "nohup /usr/local/matlab/bin/glnxa64/MATLABStartupAccelerator &>/dev/null &\n",
                  "sudo useradd -m -p `echo ",
                  { "Ref" : "Password" },
                  " | mkpasswd --method=sha-512 -s` ",
                  { "Ref" : "Username" }
                ]
              ]
            }
          }
        }
      }
    },
    "Outputs": {
      "RDPConnection": {
          "Description": "Public DNSName of the newly created EC2 instance",
          "Value": {
              "Fn::GetAtt": ["EC2Instance", "PublicDnsName"]
          }
      }
    }
  }
  
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2019a_and_older/aws-matlab-2018a-vpc-template.json">
{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "MATLAB 2018a on AWS Reference Architecture",
    "Metadata": {
      "AWS::CloudFormation::Interface": {
        "ParameterGroups": [
          {
            "Label": {
              "default": "EC2 Instance"
            },
            "Parameters": ["InstanceType"]
          },
          {
            "Label": {
              "default": "MATLAB Image"
            },
            "Parameters": ["NodeAMI"]
          },
          {
            "Label": {
              "default": "Remote Access"
            },
            "Parameters": ["ClientIPAddress", "SSHKeyName", "Username", "Password", "ConfirmPassword"]
          }
        ],
        "ParameterLabels": {
          "ClientIPAddress": {
            "default": "Allow RDP connections from"
          },
          "InstanceType": {
            "default": "AWS EC2 Instance type"
          },
          "NodeAMI": {
            "default": "MATLAB AMI"
          },
          "user": {
            "default": "Username"
          },
          "password": {
            "default": "Password"
          },
          "ConfirmPassword": {
            "default": "Confirm Password"
          }
        }
      }
    },
    "Parameters": {
      "NodeAMI": {
        "Description": "MATLAB 2018a Desktop AMI",
        "Default": "ami-00ae68c7df9e0cecf",
        "Type": "String"
      },
      "InstanceType": {
        "Description": "Amazon instance type",
        "Default": "m5.xlarge",
        "Type": "String"
      },
      "SSHKeyName": {
        "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instance",
        "Type": "AWS::EC2::KeyPair::KeyName",
        "ConstraintDescription": "must be the name of an existing EC2 KeyPair.",
        "Default": ""
      },
      "ClientIPAddress": {
        "Description": "IP address range allowed external RDP connections.",
        "Type": "String",
        "MinLength": "9",
        "MaxLength": "18",
        "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
        "ConstraintDescription": "Must be a valid IP CIDR range of the form x.x.x.x/x."
      },
      "Username": {
        "Description": "Username to access instance",
        "Type": "String",
        "ConstraintDescription": "must be a valid user name",
        "Default": ""
      },
      "Password": {
        "NoEcho": "true",
        "Description": "Password",
        "Type": "String",
        "ConstraintDescription": "",
        "Default": ""
      },
      "ConfirmPassword": {
        "NoEcho": "true",
        "Description": "Confirm Password",
        "Type": "String",
        "ConstraintDescription": "",
        "Default": ""
      }
    },
    "Rules" : {
      "matchPasswords" : {
          "Assertions" : [
          {
              "Assert" : {"Fn::Equals":[{"Ref":"Password"},{"Ref":"ConfirmPassword"}]},
              "AssertDescription" : "Passwords do not match"
          }
          ]
      }
    },
    "Conditions": {},
    "Resources": {
      "VPC" : {
          "Type" : "AWS::EC2::VPC",
          "Properties" : {
              "CidrBlock" : "10.0.0.0/16",
              "EnableDnsSupport" : "true",
              "EnableDnsHostnames" : "true"
          }
      },
  
      "InternetGateway": {
          "Type": "AWS::EC2::InternetGateway"
      },
  
      "VCPGatewayAttachment": {
          "Type": "AWS::EC2::VPCGatewayAttachment",
          "Properties" : {
              "VpcId" : { "Ref": "VPC" },
              "InternetGatewayId" : {"Ref": "InternetGateway"}
          }
      },
  
      "SubnetA": {
          "Type": "AWS::EC2::Subnet",
          "Properties": {
              "VpcId": {"Ref": "VPC"},
              "CidrBlock": "10.0.0.0/16",
              "MapPublicIpOnLaunch": "true"
          }
      },
  
      "RouteTable": {
          "Type": "AWS::EC2::RouteTable",
          "Properties" : {
              "VpcId" : { "Ref": "VPC" }
          }
      },
  
      "InternetRoute": {
          "Type": "AWS::EC2::Route",
          "DependsOn": "InternetGateway",
          "Properties" : {
              "DestinationCidrBlock": "0.0.0.0/0",
              "GatewayId": {"Ref": "InternetGateway"},
              "RouteTableId": {"Ref": "RouteTable"}
          }
      },
  
      "SubnetARouteTableAssociation": {
          "Type": "AWS::EC2::SubnetRouteTableAssociation",
          "Properties" : {
              "RouteTableId": {"Ref": "RouteTable"},
              "SubnetId": {"Ref": "SubnetA"}
          }
      },
  
      "SSHSecurityGroup": {
        "Type": "AWS::EC2::SecurityGroup",
        "Properties": {
          "VpcId": {
            "Ref": "VPC"
          },
          "GroupDescription": "Enable SSH access via port 22",
          "SecurityGroupIngress": [
            {
              "IpProtocol": "tcp",
              "FromPort": "22",
              "ToPort": "22",
              "CidrIp": {
                  "Ref": "ClientIPAddress"
                }
            },
            {
              "IpProtocol": "tcp",
              "FromPort": "3389",
              "ToPort": "3389",
              "CidrIp":{
                  "Ref": "ClientIPAddress"
                }
            }
          ],
          "SecurityGroupEgress": [
              {
                  "IpProtocol": -1,
                  "CidrIp": "0.0.0.0/0"
              }
          ]
        }
      },
  
      "EC2Instance": {
        "Type": "AWS::EC2::Instance",
        "Properties": {
          "ImageId": { "Ref": "NodeAMI"  },
          "KeyName": {
            "Ref": "SSHKeyName"
          },
          "SecurityGroupIds": [
            {
              "Ref": "SSHSecurityGroup"
            }
          ],
          "SubnetId": {
            "Ref": "SubnetA"
          },
          "InstanceType": {
            "Ref": "InstanceType"
          },
          "EbsOptimized" : "true",
          "UserData": {
            "Fn::Base64": {
              "Fn::Join": [
                "",
                [
                  "#!/bin/bash\n",
                  "# Copyright 2011-2017 The MathWorks, Inc.\n",
                  "cd /usr/local/matlab\n",
                  "nohup /usr/local/matlab/bin/glnxa64/MATLABStartupAccelerator &>/dev/null &\n",
                  "sudo useradd -m -p `echo ",
                  { "Ref" : "Password" },
                  " | mkpasswd --method=sha-512 -s` ",
                  { "Ref" : "Username" }
                ]
              ]
            }
          }
        }
      }
    },
    "Outputs": {
      "RDPConnection": {
          "Description": "Public DNSName of the newly created EC2 instance",
          "Value": {
              "Fn::GetAtt": ["EC2Instance", "PublicDnsName"]
          }
      }
    }
  }
  
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2019a_and_older/aws-matlab-2019a-vpc-template.json">
{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "MATLAB 2019a on AWS Reference Architecture",
    "Metadata": {
      "AWS::CloudFormation::Interface": {
        "ParameterGroups": [
          {
            "Label": {
              "default": "EC2 Instance"
            },
            "Parameters": ["InstanceType"]
          },
          {
            "Label": {
              "default": "MATLAB Image"
            },
            "Parameters": ["NodeAMI"]
          },
          {
            "Label": {
              "default": "Remote Access"
            },
            "Parameters": ["ClientIPAddress", "SSHKeyName", "Username", "Password", "ConfirmPassword"]
          },
          {
            "Label": {
              "default": "Un-attended Security Updates"
            },
            "Parameters": [
              "SuppressSecurityUpdates"
            ]
          }
        ],
        "ParameterLabels": {
          "ClientIPAddress": {
            "default": "Allow RDP connections from"
          },
          "InstanceType": {
            "default": "AWS EC2 Instance type"
          },
          "NodeAMI": {
            "default": "MATLAB AMI"
          },
          "user": {
            "default": "Username"
          },
          "password": {
            "default": "Password"
          },
          "ConfirmPassword": {
            "default": "Confirm Password"
          },
          "SuppressSecurityUpdates": {
            "default": "Suppress critical security updates"
          }
        }
      }
    },
    "Parameters": {
      "NodeAMI": {
        "Description": "MATLAB 2019a Desktop AMI",
        "Default": "ami-0daef523dbffc12d0",
        "Type": "String"
      },
      "InstanceType": {
        "Description": "Amazon instance type",
        "Default": "m5.xlarge",
        "Type": "String"
      },
      "SSHKeyName": {
        "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instance",
        "Type": "AWS::EC2::KeyPair::KeyName",
        "ConstraintDescription": "must be the name of an existing EC2 KeyPair.",
        "Default": ""
      },
      "ClientIPAddress": {
        "Description": "IP address range allowed external RDP connections.",
        "Type": "String",
        "MinLength": "9",
        "MaxLength": "18",
        "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
        "ConstraintDescription": "Must be a valid IP CIDR range of the form x.x.x.x/x."
      },
      "Username": {
        "Description": "Username to access instance",
        "Type": "String",
        "ConstraintDescription": "must be a valid user name",
        "Default": ""
      },
      "Password": {
        "NoEcho": "true",
        "Description": "Password",
        "Type": "String",
        "ConstraintDescription": "",
        "Default": ""
      },
      "ConfirmPassword": {
        "NoEcho": "true",
        "Description": "Confirm Password",
        "Type": "String",
        "ConstraintDescription": "",
        "Default": ""
      },
      "SuppressSecurityUpdates": {
        "Description": "By default, the un-attended critical security upgrades are enabled, a user can explicitly suppress the security upgrades at their own risk. Specify either 'No' or 'Yes'",
        "Type": "String",
        "Default": "No",
        "AllowedPattern": "(\bYes\b|\bNo\b)",
        "ConstraintDescription": "Must be either 'No' or 'Yes'"
      }
    },
    "Rules" : {
      "matchPasswords" : {
          "Assertions" : [
          {
              "Assert" : {"Fn::Equals":[{"Ref":"Password"},{"Ref":"ConfirmPassword"}]},
              "AssertDescription" : "Passwords do not match"
          }
          ]
      }
    },
    "Conditions": {},
    "Resources": {
      "VPC" : {
          "Type" : "AWS::EC2::VPC",
          "Properties" : {
              "CidrBlock" : "10.0.0.0/16",
              "EnableDnsSupport" : "true",
              "EnableDnsHostnames" : "true"
          }
      },
  
      "InternetGateway": {
          "Type": "AWS::EC2::InternetGateway"
      },
  
      "VCPGatewayAttachment": {
          "Type": "AWS::EC2::VPCGatewayAttachment",
          "Properties" : {
              "VpcId" : { "Ref": "VPC" },
              "InternetGatewayId" : {"Ref": "InternetGateway"}
          }
      },
  
      "SubnetA": {
          "Type": "AWS::EC2::Subnet",
          "Properties": {
              "VpcId": {"Ref": "VPC"},
              "CidrBlock": "10.0.0.0/16",
              "MapPublicIpOnLaunch": "true"
          }
      },
  
      "RouteTable": {
          "Type": "AWS::EC2::RouteTable",
          "Properties" : {
              "VpcId" : { "Ref": "VPC" }
          }
      },
  
      "InternetRoute": {
          "Type": "AWS::EC2::Route",
          "DependsOn": "InternetGateway",
          "Properties" : {
              "DestinationCidrBlock": "0.0.0.0/0",
              "GatewayId": {"Ref": "InternetGateway"},
              "RouteTableId": {"Ref": "RouteTable"}
          }
      },
  
      "SubnetARouteTableAssociation": {
          "Type": "AWS::EC2::SubnetRouteTableAssociation",
          "Properties" : {
              "RouteTableId": {"Ref": "RouteTable"},
              "SubnetId": {"Ref": "SubnetA"}
          }
      },
  
      "SSHSecurityGroup": {
        "Type": "AWS::EC2::SecurityGroup",
        "Properties": {
          "VpcId": {
            "Ref": "VPC"
          },
          "GroupDescription": "Enable SSH access via port 22",
          "SecurityGroupIngress": [
            {
              "IpProtocol": "tcp",
              "FromPort": "22",
              "ToPort": "22",
              "CidrIp": {
                  "Ref": "ClientIPAddress"
                }
            },
            {
              "IpProtocol": "tcp",
              "FromPort": "3389",
              "ToPort": "3389",
              "CidrIp":{
                  "Ref": "ClientIPAddress"
                }
            }
          ],
          "SecurityGroupEgress": [
              {
                  "IpProtocol": -1,
                  "CidrIp": "0.0.0.0/0"
              }
          ]
        }
      },
  
      "EC2Instance": {
        "Type": "AWS::EC2::Instance",
        "Properties": {
          "ImageId": { "Ref": "NodeAMI"  },
          "KeyName": {
            "Ref": "SSHKeyName"
          },
          "SecurityGroupIds": [
            {
              "Ref": "SSHSecurityGroup"
            }
          ],
          "SubnetId": {
            "Ref": "SubnetA"
          },
          "InstanceType": {
            "Ref": "InstanceType"
          },
          "EbsOptimized" : "true",
          "UserData": {
            "Fn::Base64": {
              "Fn::Join": [
                "",
                [
                  "#!/bin/bash\n",
                  "# Copyright 2011-2017 The MathWorks, Inc.\n",
                  "cd /usr/local/matlab\n",
                  "nohup /usr/local/matlab/bin/glnxa64/MATLABStartupAccelerator &>/dev/null &\n",
                  "sudo useradd -m -p `echo ",
                  { "Ref" : "Password" },
                  " | mkpasswd --method=sha-512 -s` ",
                  { "Ref" : "Username" },
                  "\n",
                  "sudo usermod -aG sudo ",
                  { "Ref" : "Username" },
                  "\n",
                  "if [ 'No' == '",
                  { "Ref": "SuppressSecurityUpdates" },
                  "' ]\n",
                  " then \n",
                  "#install unattended-upgrades\n",
                  "sudo apt-get update --fix-missing\n",
                  "sudo apt-get install unattended-upgrades\n",
                  "\n",
                  "fi\n"
                ]
              ]
            }
          }
        }
      }
    },
    "Outputs": {
      "RDPConnection": {
          "Description": "Public DNSName of the newly created EC2 instance",
          "Value": {
              "Fn::GetAtt": ["EC2Instance", "PublicDnsName"]
          }
      }
    }
}
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2019a_and_older/aws-matlab-2018b-vpc-template.json">
{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "MATLAB 2018b on AWS Reference Architecture",
    "Metadata": {
      "AWS::CloudFormation::Interface": {
        "ParameterGroups": [
          {
            "Label": {
              "default": "EC2 Instance"
            },
            "Parameters": ["InstanceType"]
          },
          {
            "Label": {
              "default": "MATLAB Image"
            },
            "Parameters": ["NodeAMI"]
          },
          {
            "Label": {
              "default": "Remote Access"
            },
            "Parameters": ["ClientIPAddress", "SSHKeyName", "Username", "Password", "ConfirmPassword"]
          }
        ],
        "ParameterLabels": {
          "ClientIPAddress": {
            "default": "Allow RDP connections from"
          },
          "InstanceType": {
            "default": "AWS EC2 Instance type"
          },
          "NodeAMI": {
            "default": "MATLAB AMI"
          },
          "user": {
            "default": "Username"
          },
          "password": {
            "default": "Password"
          },
          "ConfirmPassword": {
            "default": "Confirm Password"
          }
        }
      }
    },
    "Parameters": {
      "NodeAMI": {
        "Description": "MATLAB 2018b Desktop AMI",
        "Default": "ami-04adfc90a4d01decc",
        "Type": "String"
      },
      "InstanceType": {
        "Description": "Amazon instance type",
        "Default": "m5.xlarge",
        "Type": "String"
      },
      "SSHKeyName": {
        "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instance",
        "Type": "AWS::EC2::KeyPair::KeyName",
        "ConstraintDescription": "must be the name of an existing EC2 KeyPair.",
        "Default": ""
      },
      "ClientIPAddress": {
        "Description": "IP address range allowed external RDP connections.",
        "Type": "String",
        "MinLength": "9",
        "MaxLength": "18",
        "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
        "ConstraintDescription": "Must be a valid IP CIDR range of the form x.x.x.x/x."
      },
      "Username": {
        "Description": "Username to access instance",
        "Type": "String",
        "ConstraintDescription": "must be a valid user name",
        "Default": ""
      },
      "Password": {
        "NoEcho": "true",
        "Description": "Password",
        "Type": "String",
        "ConstraintDescription": "",
        "Default": ""
      },
      "ConfirmPassword": {
        "NoEcho": "true",
        "Description": "Confirm Password",
        "Type": "String",
        "ConstraintDescription": "",
        "Default": ""
      }
    },
    "Rules" : {
      "matchPasswords" : {
          "Assertions" : [
          {
              "Assert" : {"Fn::Equals":[{"Ref":"Password"},{"Ref":"ConfirmPassword"}]},
              "AssertDescription" : "Passwords do not match"
          }
          ]
      }
    },
    "Conditions": {},
    "Resources": {
      "VPC" : {
          "Type" : "AWS::EC2::VPC",
          "Properties" : {
              "CidrBlock" : "10.0.0.0/16",
              "EnableDnsSupport" : "true",
              "EnableDnsHostnames" : "true"
          }
      },
  
      "InternetGateway": {
          "Type": "AWS::EC2::InternetGateway"
      },
  
      "VCPGatewayAttachment": {
          "Type": "AWS::EC2::VPCGatewayAttachment",
          "Properties" : {
              "VpcId" : { "Ref": "VPC" },
              "InternetGatewayId" : {"Ref": "InternetGateway"}
          }
      },
  
      "SubnetA": {
          "Type": "AWS::EC2::Subnet",
          "Properties": {
              "VpcId": {"Ref": "VPC"},
              "CidrBlock": "10.0.0.0/16",
              "MapPublicIpOnLaunch": "true"
          }
      },
  
      "RouteTable": {
          "Type": "AWS::EC2::RouteTable",
          "Properties" : {
              "VpcId" : { "Ref": "VPC" }
          }
      },
  
      "InternetRoute": {
          "Type": "AWS::EC2::Route",
          "DependsOn": "InternetGateway",
          "Properties" : {
              "DestinationCidrBlock": "0.0.0.0/0",
              "GatewayId": {"Ref": "InternetGateway"},
              "RouteTableId": {"Ref": "RouteTable"}
          }
      },
  
      "SubnetARouteTableAssociation": {
          "Type": "AWS::EC2::SubnetRouteTableAssociation",
          "Properties" : {
              "RouteTableId": {"Ref": "RouteTable"},
              "SubnetId": {"Ref": "SubnetA"}
          }
      },
  
      "SSHSecurityGroup": {
        "Type": "AWS::EC2::SecurityGroup",
        "Properties": {
          "VpcId": {
            "Ref": "VPC"
          },
          "GroupDescription": "Enable SSH access via port 22",
          "SecurityGroupIngress": [
            {
              "IpProtocol": "tcp",
              "FromPort": "22",
              "ToPort": "22",
              "CidrIp": {
                  "Ref": "ClientIPAddress"
                }
            },
            {
              "IpProtocol": "tcp",
              "FromPort": "3389",
              "ToPort": "3389",
              "CidrIp":{
                  "Ref": "ClientIPAddress"
                }
            }
          ],
          "SecurityGroupEgress": [
              {
                  "IpProtocol": -1,
                  "CidrIp": "0.0.0.0/0"
              }
          ]
        }
      },
  
      "EC2Instance": {
        "Type": "AWS::EC2::Instance",
        "Properties": {
          "ImageId": { "Ref": "NodeAMI"  },
          "KeyName": {
            "Ref": "SSHKeyName"
          },
          "SecurityGroupIds": [
            {
              "Ref": "SSHSecurityGroup"
            }
          ],
          "SubnetId": {
            "Ref": "SubnetA"
          },
          "InstanceType": {
            "Ref": "InstanceType"
          },
          "EbsOptimized" : "true",
          "UserData": {
            "Fn::Base64": {
              "Fn::Join": [
                "",
                [
                  "#!/bin/bash\n",
                  "# Copyright 2011-2017 The MathWorks, Inc.\n",
                  "cd /usr/local/matlab\n",
                  "nohup /usr/local/matlab/bin/glnxa64/MATLABStartupAccelerator &>/dev/null &\n",
                  "sudo useradd -m -p `echo ",
                  { "Ref" : "Password" },
                  " | mkpasswd --method=sha-512 -s` ",
                  { "Ref" : "Username" }
                ]
              ]
            }
          }
        }
      }
    },
    "Outputs": {
      "RDPConnection": {
          "Description": "Public DNSName of the newly created EC2 instance",
          "Value": {
              "Fn::GetAtt": ["EC2Instance", "PublicDnsName"]
          }
      }
    }
  }
  
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2019a_and_older/license-manager-instructions.md">
# MATLAB on Amazon Web Services using Network Licensing

## Requirements
Before starting, you will need the following:
-   A network license manager. <p>You can use the MathWorks provided reference architecture to deploy a network license manager on the cloud. For more information, see [Network License Manager for MATLAB on AWS](https://github.com/mathworks-ref-arch/license-manager-for-matlab-on-aws).</p>
-   An Amazon Web Services™ (AWS) account.
-   An SSH Key Pair for your AWS account in the US East (N. Virginia) region. For more information, see [Amazon EC2 Key Pairs](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html).

# Deployment Steps

## Step 1. Launch the Template

Click the **Launch Stack** button to deploy a standalone MATLAB desktop client on AWS. This will open the CloudFormation Create Stack screen in your web browser.


| Release | Region | Ubuntu 16.04 VM |
|---------------|-----------------|-----------------|
| MATLAB R2019a | us-east-1 | <a href="https://us-east-1.console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://s3.amazonaws.com/matlab-on-aws/aws-matlab-2019a-license-manager-template.json" target="_blank">     <img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png"/> </a>  |
| MATLAB R2019a | eu-west-1 |  <a href="https://eu-west-1.console.aws.amazon.com/cloudformation/home?region=eu-west-1#/stacks/create/review?templateURL=https://s3.amazonaws.com/matlab-on-aws/aws-matlab-2019a-license-manager-template-eu-west-1.json" target="_blank">     <img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png"/> </a>  |


For other releases, see [How do I launch a template that uses a previous MATLAB release?](#how-do-i-launch-a-template-that-uses-a-previous-matlab-release)

**Note**: Creating a stack on AWS can take a few minutes.

## Step 2. Configure the Stack
1. Provide values for parameters in the Create Stack page:

    | Name                           | Value                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
    |--------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
    | **Stack name**                 | Choose a name for the stack. This will be shown in the AWS console. This must be unique within an AWS account. <p><em>Example</em>: Boston</p>                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
    | **AWS EC2 Instance type**      | Choose the AWS instance type to use for running MATLAB. Check to ensure the instance type is available as not all types are available in all regions. For more information, see [Amazon EC2 Instance Types](https://aws.amazon.com/ec2/instance-types/) and [Pricing](https://aws.amazon.com/ec2/pricing/on-demand/). <p><em>Example</em>: m5.xlarge</p>                                                                                                                                                                                                                                                             |
    | **MATLAB AMI**                 | This is the image prepared by MathWorks which contains MATLAB 2018a pre-installed running on Ubuntu 16.04 and pre-configured drivers. If you've created your own custom image you can enter your AMI ID here. <p><em>Example</em>: my-matlab-ami</p>     |
     | **VPC** (required) | The ID of an existing Virtual Private Cloud to deploy this stack in |
    | **Subnet** (required) | The ID of an existing subnet for the head node and worker nodes. Choose a subnet in an Availability Zone that supports the instance types you have specified.		|	
    | **Network license manager hostname** (required)        | The hostname or IP address of the instance hosting your network license manager. |
    | **Network license manager port** (required)            | The port to use when connecting to your network license manager.			|                                                                                                                                                                                                                                                                                                                                      |
    | **Allow RDP connections from** | This is the IP address range that will be allowed to connect to this instance using the Remote Desktop Protocol. The format for this field is IP Address/Mask. <p><em>Example</em>: </p>10.0.0.1/32 <ul><li>This is the public IP address which can be found by searching for "what is my ip address" on the web. The mask determines the number of IP addresses to include.</li><li>A mask of 32 is a single IP address.</li><li>Use a [CIDR calculator](https://www.ipaddressguide.com/cidr) if you need a range of more than one IP addresses.</li><li>You may need to contact your IT administrator to determine which address is appropriate.</li></ul></p> |
    | **SSHKeyName**                 | A valid SSH key pair from AWS used to SSH into the instance. This is the only way to perform sudo operations on the instance itself. <p><em>Example</em>: my-keypair</p>                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
	| **Username**					 | Enter a username you would like to use to connect to the virtual machine in the cloud using remote desktop.																																																																																																																																						|
	| **Password**					 | Enter a password you would like to use to connect to the virtual machine in the cloud using remote desktop.																																																																																																																																							|
	| **Confirm Password**			 | Retype the password to confirm. | 							



    >**Note**: Make sure you select US East (N.Virginia) as your region from the nagivation panel on top. Currently, this is the only supported region. 
    
2. Click the **Create** button.  The CloudFormation service will start creating the resources for the stack. <p>After clicking **Create** you will be taken to the *Stack Detail* page for your stack. Wait for the Status to reach **CREATE\_COMPLETE**. This may take up to 10 minutes.</p>  

## Step 3. Connect to the Virtual Machine in the Cloud

1. Expand the **Outputs** section in the the *Stack Detail* page.
1. Look for the key named `RDPConnection` and copy the corresponding public DNS name listed under value. *For example*: ec2-11-222-33-44.compute-1.amazonaws.com
1. Launch any remote desktop client, paste the public DNS name in the appropriate field, and connect. On the Windows Remote Desktop Client you need to paste the public DNS name in the **Computer** field and click **Connect**.
1. In the login screen that's displayed, use the username and password you specified while setting up the stack in [Step 2](#step-2-configure-the-stack).

## Step 4. Launch MATLAB
Double-click the MATLAB icon on the virtual machine desktop to launch MATLAB. 

>**Note**:It may take a few minutes for MATLAB to start. You will experience this delay only the first time you start MATLAB. 


# Additional Information

## Delete Your Stack

Once you have finished using your stack, it is recommended that you delete all resources to avoid incurring further cost. To delete the stack, do the following:
1. Log in to the AWS Console.
1. Go to the AWS CloudFormation page and select the stack you created.
1. Click the **Actions** button and click **Delete Stack** from the menu that appears.

## FAQ
### How do I launch a template that uses a previous MATLAB release?





### How do I save my changes in the VM?
All your files and changes are stored locally on the virtual machine.  They will persist until you either terminate the virtual machine instance or delete the stack.  Stopping the instance does not destroy the data on the instance.  If you want your changes to persist  outside the stack or before you terminate an instance you’ll need to:
* copy your files to another location (*Example*: S3 or Mount an Amazon EBS volume and create a snapshot), or  
* create an image of the virtual machine. 

### What happens to my data if I shutdown the instance?
You may want to shutdown the instance when you aren’t using it to save some money (you only pay for the storage used by the virtual machine when it is stopped).  To shutdown an EC2 instance, locate it in the AWS web console, select the instance and choose “Instance State/Stop” from the “Actions” menu.  You can restart it from the same menu.  Any files or changes made to the virtual machine will persist when shutting down and will be there when you restart.  A side-effect of shutting down the virtual machine and restarting is that the public IP address and DNS name may change.  Inspecting the EC2 instance in the AWS console will reveal the new IP address and DNS name.
### How do I keep the same public IP address?
To avoid having to change the IP address between restarts you can establish a static IP using AWS Elastic IP Address. For more information, see https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html.
### How do I save a VM image?
To save a VM image, locate the EC2 Instance in the AWS web console and from the "Actions" menu select the instance and choose “Image/Create Image”.  
### How do I customize the VM image?
You can customize a VM image by launching the reference architecture, applying any changes you want to the EC2 Instance such as installing additional software, drivers and files and then saving an image of that instance using the AWS Console. For more information, see [How Do I save a VM image?](#how-do-i-save-a-vm-image). When creating a stack, replace the AMI ID in the CloudFormation template with the AMI ID of your custom image.
### How do I use a different license manager? 
The VM image uses MathWorks Hosted License Manager by default.  For information on using other license managers, see [Configure MATLAB Licensing on the Cloud](http://www.mathworks.com/support/cloud/configure-matlab-licensing-on-the-cloud.html). 
### How do I deploy this reference architecture to an existing VPC?
In the `templates` folder of this repository you will find an example template for launching the reference architecture within an existing VPC and subnet. Edit the template to deploy this reference architecure to an existing VPC. 

# Enhancement Request
Provide suggestions for additional features or capabilities using the following link: https://www.mathworks.com/cloud/enhancement-request.html

# Technical Support
Email: `cloud-support@mathworks.com`
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2019a_and_older/aws-matlab-2019a-license-manager-template-eu-west-1.json">
{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "MATLAB 2019a on AWS Reference Architecture with License Manager",
    "Metadata": {
      "AWS::CloudFormation::Interface": {
        "ParameterGroups": [
          {
            "Label": {
              "default": "EC2 Instance"
            },
            "Parameters": ["InstanceType"]
          },
          {
            "Label": {
              "default": "MATLAB Image"
            },
            "Parameters": ["NodeAMI"]
          },
          {
            "Label": {
              "default": "Networking"
            },
            "Parameters": ["VPC", "SubnetA"]
          },          {
          "Label": {
              "default": "License Manager"
            },
            "Parameters": ["LicenseManagerHostname", "LicenseManagerPort"]
          },
          {
            "Label": {
              "default": "Remote Access"
            },
            "Parameters": ["ClientIPAddress", "SSHKeyName", "Username", "Password", "ConfirmPassword"]
          },
          {
            "Label": {
              "default": "Un-attended Security Updates"
            },
            "Parameters": [
              "SuppressSecurityUpdates"
            ]
          }
        ],
        "ParameterLabels": {
          "ClientIPAddress": {
            "default": "Allow RDP connections from"
          },
          "InstanceType": {
            "default": "AWS EC2 Instance type"
          },
          "NodeAMI": {
            "default": "MATLAB AMI"
          },
          "user": {
            "default": "Username"
          },
          "password": {
            "default": "password"
          },
          "SuppressSecurityUpdates": {
            "default": "Suppress critical security updates"
          }
        }
      }
    },
    "Parameters": {
      "NodeAMI": {
        "Description": "MATLAB 2019a Desktop AMI",
        "Default": "ami-0ce820a20ef19bf23",
        "Type": "String"
      },
      "InstanceType": {
        "Description": "Amazon instance type",
        "Default": "m5.xlarge",
        "Type": "String"
      },
      "VPC": {
        "Description": "Existing VPC ID",
        "Type": "AWS::EC2::VPC::Id",
        "ConstraintDescription": "must be the Id of an existing VPC.",
        "Default": ""
      },
      "SubnetA": {
        "Description": "Existing Subnet ID",
        "Type": "AWS::EC2::Subnet::Id",
        "ConstraintDescription": "must be the Id of an existing Subnet.",
        "Default": ""
      },
      "SSHKeyName": {
        "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instance",
        "Type": "AWS::EC2::KeyPair::KeyName",
        "ConstraintDescription": "must be the name of an existing EC2 KeyPair.",
        "Default": ""
      },
      "ClientIPAddress": {
        "Description": "IP address range allowed external RDP connections.",
        "Type": "String",
        "MinLength": "9",
        "MaxLength": "18",
        "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
        "ConstraintDescription": "Must be a valid IP CIDR range of the form x.x.x.x/x."
      },
      "Username": {
        "Description": "Username to access instance",
        "Type": "String",
        "ConstraintDescription": "must be a valid user name",
        "Default": ""
      },
      "Password": {
        "NoEcho": "true",
        "Description": "password",
        "Type": "String",
        "ConstraintDescription": "",
        "Default": ""
      },
      "ConfirmPassword": {
        "NoEcho": "true",
        "Description": "Confirm Password",
        "Type": "String",
        "ConstraintDescription": "",
        "Default": ""
      },
      "LicenseManagerHostname": {
        "Description": "The hostname of the network license manager for MATLAB to use with this cluster.",
        "Type": "String"
      },
      "LicenseManagerPort": {
        "Description": "The port of the network license manager for MATLAB to use with this cluster.",
        "Type": "Number",
        "Default": "27000",
        "MinValue": "0",
        "MaxValue": "65535"
      },
      "SuppressSecurityUpdates": {
        "Description": "By default, the un-attended critical security upgrades are enabled, a user can explicitly suppress the security upgrades at their own risk. Specify either 'No' or 'Yes'",
        "Type": "String",
        "Default": "No",
        "AllowedPattern": "(\bYes\b|\bNo\b)",
        "ConstraintDescription": "Must be either 'No' or 'Yes'"
      }
    },
    "Rules" : {
      "matchPasswords" : {
          "Assertions" : [
          {
              "Assert" : {"Fn::Equals":[{"Ref":"Password"},{"Ref":"ConfirmPassword"}]},
              "AssertDescription" : "Passwords do not match"
          }
          ]
      }},
    "Conditions": {},
    "Resources": {
  
      "SSHSecurityGroup": {
        "Type": "AWS::EC2::SecurityGroup",
        "Properties": {
          "VpcId": {
            "Ref": "VPC"
          },
          "GroupDescription": "Enable SSH access via port 22",
          "SecurityGroupIngress": [
            {
              "IpProtocol": "tcp",
              "FromPort": "22",
              "ToPort": "22",
              "CidrIp": {
                  "Ref": "ClientIPAddress"
                }
            },
            {
              "IpProtocol": "tcp",
              "FromPort": "3389",
              "ToPort": "3389",
              "CidrIp":{
                  "Ref": "ClientIPAddress"
                }
            }
          ],
          "SecurityGroupEgress": [
              {
                  "IpProtocol": -1,
                  "CidrIp": "0.0.0.0/0"
              }
          ]
        }
      },
  
      "EC2Instance": {
        "Type": "AWS::EC2::Instance",
        "Properties": {
          
          "ImageId": { "Ref": "NodeAMI"  },
          "KeyName": {
            "Ref": "SSHKeyName"
          },
          "SecurityGroupIds": [
            {
              "Ref": "SSHSecurityGroup"
            }
          ],
          "SubnetId": {
            "Ref": "SubnetA"
          },
          "InstanceType": {
            "Ref": "InstanceType"
          },
          "EbsOptimized" : "true",
          "UserData": {
            "Fn::Base64": {
              "Fn::Join": [
                "",
                [
                  "#!/bin/bash\n",
                  "# Copyright 2011-2017 The MathWorks, Inc.\n",
                  "cd /usr/local/matlab\n",
                  "nohup /usr/local/matlab/bin/glnxa64/MATLABStartupAccelerator &>/dev/null &\n",
                  "sudo useradd -m -p `echo ",
                  { "Ref" : "Password" },
                  " | mkpasswd --method=sha-512 -s` ",
                  { "Ref" : "Username" },
                  "\n",
                  "#disable online licensing and enable a license server\n",
                  "sudo rm /usr/local/matlab/licenses/license_info.xml\n",
                  "echo 'export MLM_LICENSE_FILE=",
                  {"Ref": "LicenseManagerPort"},
                  "@",
                  {"Ref": "LicenseManagerHostname"},
                  "' | sudo tee -a /etc/profile.d/mlmlicensefile.sh\n",
                  "\n",
                  "sudo usermod -aG sudo ",
                  { "Ref" : "Username" },
                  "\n",
                  "if [ 'No' == '",
                  { "Ref": "SuppressSecurityUpdates" },
                  "' ]\n",
                  " then \n",
                  "#install unattended-upgrades\n",
                  "sudo apt-get update --fix-missing\n",
                  "sudo apt-get install unattended-upgrades\n",
                  "\n",
                  "fi\n"
                ]
              ]
            }
          }
        }
      }
    },
    "Outputs": {
      "RDPConnection": {
          "Description": "Public DNSName of the newly created EC2 instance",
          "Value": {
              "Fn::GetAtt": ["EC2Instance", "PublicDnsName"]
          }
      }
    }
}
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2019a_and_older/aws-matlab-2019a-vpc-template-eu-west-1.json">
{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "MATLAB 2019a on AWS Reference Architecture",
    "Metadata": {
      "AWS::CloudFormation::Interface": {
        "ParameterGroups": [
          {
            "Label": {
              "default": "EC2 Instance"
            },
            "Parameters": ["InstanceType"]
          },
          {
            "Label": {
              "default": "MATLAB Image"
            },
            "Parameters": ["NodeAMI"]
          },
          {
            "Label": {
              "default": "Remote Access"
            },
            "Parameters": ["ClientIPAddress", "SSHKeyName", "Username", "Password", "ConfirmPassword"]
          },
          {
            "Label": {
              "default": "Un-attended Security Updates"
            },
            "Parameters": [
              "SuppressSecurityUpdates"
            ]
          }
        ],
        "ParameterLabels": {
          "ClientIPAddress": {
            "default": "Allow RDP connections from"
          },
          "InstanceType": {
            "default": "AWS EC2 Instance type"
          },
          "NodeAMI": {
            "default": "MATLAB AMI"
          },
          "user": {
            "default": "Username"
          },
          "password": {
            "default": "Password"
          },
          "ConfirmPassword": {
            "default": "Confirm Password"
          },
          "SuppressSecurityUpdates": {
            "default": "Suppress critical security updates"
          }
        }
      }
    },
    "Parameters": {
      "NodeAMI": {
        "Description": "MATLAB 2019a Desktop AMI",
        "Default": "ami-0ce820a20ef19bf23",
        "Type": "String"
      },
      "InstanceType": {
        "Description": "Amazon instance type",
        "Default": "m5.xlarge",
        "Type": "String"
      },
      "SSHKeyName": {
        "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instance",
        "Type": "AWS::EC2::KeyPair::KeyName",
        "ConstraintDescription": "must be the name of an existing EC2 KeyPair.",
        "Default": ""
      },
      "ClientIPAddress": {
        "Description": "IP address range allowed external RDP connections.",
        "Type": "String",
        "MinLength": "9",
        "MaxLength": "18",
        "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
        "ConstraintDescription": "Must be a valid IP CIDR range of the form x.x.x.x/x."
      },
      "Username": {
        "Description": "Username to access instance",
        "Type": "String",
        "ConstraintDescription": "must be a valid user name",
        "Default": ""
      },
      "Password": {
        "NoEcho": "true",
        "Description": "Password",
        "Type": "String",
        "ConstraintDescription": "",
        "Default": ""
      },
      "ConfirmPassword": {
        "NoEcho": "true",
        "Description": "Confirm Password",
        "Type": "String",
        "ConstraintDescription": "",
        "Default": ""
      },
      "SuppressSecurityUpdates": {
        "Description": "By default, the un-attended critical security upgrades are enabled, a user can explicitly suppress the security upgrades at their own risk. Specify either 'No' or 'Yes'",
        "Type": "String",
        "Default": "No",
        "AllowedPattern": "(\bYes\b|\bNo\b)",
        "ConstraintDescription": "Must be either 'No' or 'Yes'"
      }
    },
    "Rules" : {
      "matchPasswords" : {
          "Assertions" : [
          {
              "Assert" : {"Fn::Equals":[{"Ref":"Password"},{"Ref":"ConfirmPassword"}]},
              "AssertDescription" : "Passwords do not match"
          }
          ]
      }
    },
    "Conditions": {},
    "Resources": {
      "VPC" : {
          "Type" : "AWS::EC2::VPC",
          "Properties" : {
              "CidrBlock" : "10.0.0.0/16",
              "EnableDnsSupport" : "true",
              "EnableDnsHostnames" : "true"
          }
      },
  
      "InternetGateway": {
          "Type": "AWS::EC2::InternetGateway"
      },
  
      "VCPGatewayAttachment": {
          "Type": "AWS::EC2::VPCGatewayAttachment",
          "Properties" : {
              "VpcId" : { "Ref": "VPC" },
              "InternetGatewayId" : {"Ref": "InternetGateway"}
          }
      },
  
      "SubnetA": {
          "Type": "AWS::EC2::Subnet",
          "Properties": {
              "VpcId": {"Ref": "VPC"},
              "CidrBlock": "10.0.0.0/16",
              "MapPublicIpOnLaunch": "true"
          }
      },
  
      "RouteTable": {
          "Type": "AWS::EC2::RouteTable",
          "Properties" : {
              "VpcId" : { "Ref": "VPC" }
          }
      },
  
      "InternetRoute": {
          "Type": "AWS::EC2::Route",
          "DependsOn": "InternetGateway",
          "Properties" : {
              "DestinationCidrBlock": "0.0.0.0/0",
              "GatewayId": {"Ref": "InternetGateway"},
              "RouteTableId": {"Ref": "RouteTable"}
          }
      },
  
      "SubnetARouteTableAssociation": {
          "Type": "AWS::EC2::SubnetRouteTableAssociation",
          "Properties" : {
              "RouteTableId": {"Ref": "RouteTable"},
              "SubnetId": {"Ref": "SubnetA"}
          }
      },
  
      "SSHSecurityGroup": {
        "Type": "AWS::EC2::SecurityGroup",
        "Properties": {
          "VpcId": {
            "Ref": "VPC"
          },
          "GroupDescription": "Enable SSH access via port 22",
          "SecurityGroupIngress": [
            {
              "IpProtocol": "tcp",
              "FromPort": "22",
              "ToPort": "22",
              "CidrIp": {
                  "Ref": "ClientIPAddress"
                }
            },
            {
              "IpProtocol": "tcp",
              "FromPort": "3389",
              "ToPort": "3389",
              "CidrIp":{
                  "Ref": "ClientIPAddress"
                }
            }
          ],
          "SecurityGroupEgress": [
              {
                  "IpProtocol": -1,
                  "CidrIp": "0.0.0.0/0"
              }
          ]
        }
      },
  
      "EC2Instance": {
        "Type": "AWS::EC2::Instance",
        "Properties": {
          "ImageId": { "Ref": "NodeAMI"  },
          "KeyName": {
            "Ref": "SSHKeyName"
          },
          "SecurityGroupIds": [
            {
              "Ref": "SSHSecurityGroup"
            }
          ],
          "SubnetId": {
            "Ref": "SubnetA"
          },
          "InstanceType": {
            "Ref": "InstanceType"
          },
          "EbsOptimized" : "true",
          "UserData": {
            "Fn::Base64": {
              "Fn::Join": [
                "",
                [
                  "#!/bin/bash\n",
                  "# Copyright 2011-2017 The MathWorks, Inc.\n",
                  "cd /usr/local/matlab\n",
                  "nohup /usr/local/matlab/bin/glnxa64/MATLABStartupAccelerator &>/dev/null &\n",
                  "sudo useradd -m -p `echo ",
                  { "Ref" : "Password" },
                  " | mkpasswd --method=sha-512 -s` ",
                  { "Ref" : "Username" },
                  "\n",
                  "sudo usermod -aG sudo ",
                  { "Ref" : "Username" },
                  "\n",
                  "if [ 'No' == '",
                  { "Ref": "SuppressSecurityUpdates" },
                  "' ]\n",
                  " then \n",
                  "#install unattended-upgrades\n",
                  "sudo apt-get update --fix-missing\n",
                  "sudo apt-get install unattended-upgrades\n",
                  "\n",
                  "fi\n"
                ]
              ]
            }
          }
        }
      }
    },
    "Outputs": {
      "RDPConnection": {
          "Description": "Public DNSName of the newly created EC2 instance",
          "Value": {
              "Fn::GetAtt": ["EC2Instance", "PublicDnsName"]
          }
      }
    }
}
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2019a_and_older/README.md">
# MATLAB on Amazon Web Services

## Requirements
Before starting, you will need the following:
-   A MATLAB® license that is current on Software
    Maintenance Service (SMS). For more information, see [Configure MATLAB Licensing on the Cloud](https://www.mathworks.com/help/licensingoncloud/matlab-on-the-cloud.html.).
-   An Amazon Web Services™ (AWS) account.
-   An SSH Key Pair for your AWS account in the appropriate region. For more information, see [Amazon EC2 Key Pairs](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html).

## Costs
You are responsible for the cost of the AWS services used when you create a cluster using this guide. Resource settings, such as instance type, will affect the cost of deployment. For cost estimates, see the pricing pages for each AWS service you will be using. Prices are subject to change.

## Introduction

The following guide will help you automate the process of running the MATLAB desktop on Amazon Web Services and connect to it using the Remote Desktop Protocol (RDP). The automation is accomplished using an AWS CloudFormation template. The template is a JSON file that defines the resources needed to run MATLAB on AWS. For information about the architecture of this solution, see [Architecture and Resources](#architecture-and-resources). For information about templates, see [AWS CloudFormation Templates](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-guide.html).


## Prepare your AWS Account

1. If you don't have an AWS account, create one at https://aws.amazon.com by following the on-screen instructions.
2. Use the regions selector in the navigation bar to choose the **US East (N. Virginia)** or **EU (Ireland)** region where you want to deploy MATLAB.
3. Create a [key pair](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html) in that region.  The key pair is necessary as it is the only way to connect to the instance as an administrator.
4. If necessary, [request a service limit increase](https://console.aws.amazon.com/support/home#/case/create?issueType=service-limit-increase&limitType=service-code-) for the Amazon EC2 instance type or VPCs.  You might need to do this if you already have existing deployments that use that instance type or you think you might exceed the [default limit](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-resource-limits.html) with this deployment.

# Choose a Deployment Option

- [Deploy MATLAB on AWS using Online Licensing](online-licensing-instructions.md)
- [Deploy MATLAB on AWS using Network Licensing](license-manager-instructions.md)

## Architecture and Resources

![MATLAB on AWS Reference Architecture](../../img/aws-matlab-diagram.png)

Deploying this reference architecture sets up a single AWS EC2 instance containing Linux and MATLAB, a private VPC with an internet gateway, a private subnet and a security group that opens the appropriate ports for SSH and RDP access.

To make deployment easy we have prepared an Amazon Machine Image (AMI) running Ubuntu 16.04 with pre-installed drivers. The AMI contains the following software:
* MATLAB, Simulink, Toolboxes, and support for GPUs.
* Add-Ons: Neural Network Toolbox Model for AlexNet Network, Neural Network Toolbox Model for GoogLeNet Network, and Neural Network Toolbox(TM) Model for ResNet-50 Network

The AMI is currently available in the US East (N. Virginia) and EU West (Ireland) regions only.

### Resources

The following resources will be created as part of the CloudFormation Stack.

1. VPC w/Internet Gateway
1. Subnet
1. Security Group for SSH and RDP access
1. EC2 Instance
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2019a_and_older/online-licensing-instructions.md">
# MATLAB on Amazon Web Services using Online Licensing

## Requirements
Before starting, you will need the following:
-   A MATLAB® license that is current on Software
    Maintenance Service (SMS). For more information, see [Configure MATLAB Licensing on the Cloud](http://www.mathworks.com/support/cloud/configure-matlab-licensing-on-the-cloud.html).
-   An Amazon Web Services™ (AWS) account.
-   An SSH Key Pair for your AWS account in the US East (N. Virginia) region. For more information, see [Amazon EC2 Key Pairs](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html).

# Deployment Steps

## Step 1. Launch the Template

Click the **Launch Stack** button to deploy a standalone MATLAB desktop client on AWS. This will open the CloudFormation Create Stack screen in your web browser.


| Release | Region | Ubuntu 16.04 VM |
|-|-|-|
| MATLAB R2019a | us-east-1 | <a href="https://us-east-1.console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://s3.amazonaws.com/matlab-on-aws/aws-matlab-2019a-vpc-template.json" target="_blank">     <img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png"/> </a> |
| MATLAB R2019a | eu-west-1 | <a href="https://eu-west-1.console.aws.amazon.com/cloudformation/home?region=eu-west-1#/stacks/create/review?templateURL=https://s3.amazonaws.com/matlab-on-aws/aws-matlab-2019a-vpc-template-eu-west-1.json" target="_blank">     <img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png"/> </a> |



For other releases, see [How do I launch a template that uses a previous MATLAB release?](#how-do-i-launch-a-template-that-uses-a-previous-matlab-release)

**Note**: Creating a stack on AWS can take a few minutes.

## Step 2. Configure the Stack
1. Provide values for parameters in the Create Stack page:

    | Name                           | Value                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
    |--------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
    | **Stack name**                 | Choose a name for the stack. This will be shown in the AWS console. This must be unique within an AWS account. <p><em>Example</em>: Boston</p>                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
    | **AWS EC2 Instance type**      | Choose the AWS instance type to use for running MATLAB. Check to ensure the instance type is available as not all types are available in all regions. For more information, see [Amazon EC2 Instance Types](https://aws.amazon.com/ec2/instance-types/) and [Pricing](https://aws.amazon.com/ec2/pricing/on-demand/). <p><em>Example</em>: m5.xlarge</p>                                                                                                                                                                                                                                                             |
    | **MATLAB AMI**                 | This is the image prepared by MathWorks which contains MATLAB 2018a pre-installed running on Ubuntu 16.04 and pre-configured drivers. If you've created your own custom image you can enter your AMI ID here. <p><em>Example</em>: my-matlab-ami</p>                                                                                                                                                                                                                                                                                                                                                                |
    | **Allow RDP connections from** | This is the IP address range that will be allowed to connect to this instance using the Remote Desktop Protocol. The format for this field is IP Address/Mask. <p><em>Example</em>: </p>10.0.0.1/32 <ul><li>This is the public IP address which can be found by searching for "what is my ip address" on the web. The mask determines the number of IP addresses to include.</li><li>A mask of 32 is a single IP address.</li><li>Use a [CIDR calculator](https://www.ipaddressguide.com/cidr) if you need a range of more than one IP addresses.</li><li>You may need to contact your IT administrator to determine which address is appropriate.</li></ul></p> |
    | **SSHKeyName**                 | A valid SSH key pair from AWS used to SSH into the instance. This is the only way to perform sudo operations on the instance itself. <p><em>Example</em>: my-keypair</p>                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
	| **Username**					 | Enter a username you would like to use to connect to the virtual machine in the cloud using remote desktop.																																																																																																																																						|
	| **Password**					 | Enter a password you would like to use to connect to the virtual machine in the cloud using remote desktop.																																																																																																																																							|
	| **Confirm Password**			 | Retype the password to confirm. 																																																																																																																																					|


    >**Note**: Make sure you select US East (N.Virginia) as your region from the nagivation panel on top. Currently, this is the only supported region. 
    
2. Click the **Create** button.  The CloudFormation service will start creating the resources for the stack. <p>After clicking **Create** you will be taken to the *Stack Detail* page for your stack. Wait for the Status to reach **CREATE\_COMPLETE**. This may take up to 10 minutes.</p>  

## Step 3. Connect to the Virtual Machine in the Cloud

1. Expand the **Outputs** section in the the *Stack Detail* page.
1. Look for the key named `RDPConnection` and copy the corresponding public DNS name listed under value. *For example*: ec2-11-222-33-44.compute-1.amazonaws.com
1. Launch any remote desktop client, paste the public DNS name in the appropriate field, and connect. On the Windows Remote Desktop Client you need to paste the public DNS name in the **Computer** field and click **Connect**.
1. In the login screen that's displayed, use the username and password you specified while setting up the stack in [Step 2](#step-2-configure-the-stack).

## Step 4. Launch MATLAB
Double-click the MATLAB icon on the virtual machine desktop to launch MATLAB. The first time you start MATLAB you will need to activate it. By default you will be asked to use your MathWorks Account to activate MATLAB. For other ways to activate MATLAB, see [Configure MATLAB Licensing on the Cloud](http://www.mathworks.com/support/cloud/configure-matlab-licensing-on-the-cloud.html).

>**Note**:It may take a few minutes for activation to complete and MATLAB to start. You will experience this delay only the first time you start MATLAB. 


# Additional Information

## Delete Your Stack

Once you have finished using your stack, it is recommended that you delete all resources to avoid incurring further cost. To delete the stack, do the following:
1. Log in to the AWS Console.
1. Go to the AWS CloudFormation page and select the stack you created.
1. Click the **Actions** button and click **Delete Stack** from the menu that appears.

## FAQ
### How do I launch a template that uses a previous MATLAB release?

| Release | Region | Ubuntu 16.04 VM |
|---------------|-----------------|-----------------|
| MATLAB R2018b | us-east-1 | <a href="https://us-east-1.console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://s3.amazonaws.com/matlab-on-aws/aws-matlab-2018b-vpc-template.json" target="_blank">     <img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png"/> </a>  
| MATLAB R2018a | us-east-1 | <a href="https://us-east-1.console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://s3.amazonaws.com/matlab-on-aws/aws-matlab-2018a-vpc-template.json" target="_blank">     <img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png"/> </a> |


### How do I save my changes in the VM?
All your files and changes are stored locally on the virtual machine.  They will persist until you either terminate the virtual machine instance or delete the stack.  Stopping the instance does not destroy the data on the instance.  If you want your changes to persist  outside the stack or before you terminate an instance you’ll need to:
* copy your files to another location (*Example*: S3 or Mount an Amazon EBS volume and create a snapshot), or  
* create an image of the virtual machine. 

### What happens to my data if I shutdown the instance?
You may want to shutdown the instance when you aren’t using it to save some money (you only pay for the storage used by the virtual machine when it is stopped).  To shutdown an EC2 instance, locate it in the AWS web console, select the instance and choose “Instance State/Stop” from the “Actions” menu.  You can restart it from the same menu.  Any files or changes made to the virtual machine will persist when shutting down and will be there when you restart.  A side-effect of shutting down the virtual machine and restarting is that the public IP address and DNS name may change.  Inspecting the EC2 instance in the AWS console will reveal the new IP address and DNS name.
### How do I keep the same public IP address?
To avoid having to change the IP address between restarts you can establish a static IP using AWS Elastic IP Address. For more information, see https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html.
### How do I save a VM image?
To save a VM image, locate the EC2 Instance in the AWS web console and from the "Actions" menu select the instance and choose “Image/Create Image”.  
### How do I customize the VM image?
You can customize a VM image by launching the reference architecture, applying any changes you want to the EC2 Instance such as installing additional software, drivers and files and then saving an image of that instance using the AWS Console. For more information, see [How Do I save a VM image?](#how-do-i-save-a-vm-image). When creating a stack, replace the AMI ID in the CloudFormation template with the AMI ID of your custom image.
### How do I use a different license manager? 
The VM image uses MathWorks Hosted License Manager by default.  For information on using other license managers, see [Configure MATLAB Licensing on the Cloud](http://www.mathworks.com/support/cloud/configure-matlab-licensing-on-the-cloud.html). 
### How do I deploy this reference architecture to an existing VPC?
In the `templates` folder of this repository you will find an example template for launching the reference architecture within an existing VPC and subnet. Edit the template to deploy this reference architecure to an existing VPC. 

# Enhancement Request
Provide suggestions for additional features or capabilities using the following link: https://www.mathworks.com/cloud/enhancement-request.html

# Technical Support
Email: `cloud-support@mathworks.com`
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2019a_and_older/aws-matlab-2019a-license-manager-template.json">
{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "MATLAB 2019a on AWS Reference Architecture with License Manager",
    "Metadata": {
      "AWS::CloudFormation::Interface": {
        "ParameterGroups": [
          {
            "Label": {
              "default": "EC2 Instance"
            },
            "Parameters": ["InstanceType"]
          },
          {
            "Label": {
              "default": "MATLAB Image"
            },
            "Parameters": ["NodeAMI"]
          },
          {
            "Label": {
              "default": "Networking"
            },
            "Parameters": ["VPC", "SubnetA"]
          },          {
          "Label": {
              "default": "License Manager"
            },
            "Parameters": ["LicenseManagerHostname", "LicenseManagerPort"]
          },
          {
            "Label": {
              "default": "Remote Access"
            },
            "Parameters": ["ClientIPAddress", "SSHKeyName", "Username", "Password", "ConfirmPassword"]
          },
          {
            "Label": {
              "default": "Un-attended Security Updates"
            },
            "Parameters": [
              "SuppressSecurityUpdates"
            ]
          }
        ],
        "ParameterLabels": {
          "ClientIPAddress": {
            "default": "Allow RDP connections from"
          },
          "InstanceType": {
            "default": "AWS EC2 Instance type"
          },
          "NodeAMI": {
            "default": "MATLAB AMI"
          },
          "user": {
            "default": "Username"
          },
          "password": {
            "default": "password"
          },
          "SuppressSecurityUpdates": {
            "default": "Suppress critical security updates"
          }
        }
      }
    },
    "Parameters": {
      "NodeAMI": {
        "Description": "MATLAB 2019a Desktop AMI",
        "Default": "ami-0daef523dbffc12d0",
        "Type": "String"
      },
      "InstanceType": {
        "Description": "Amazon instance type",
        "Default": "m5.xlarge",
        "Type": "String"
      },
      "VPC": {
        "Description": "Existing VPC ID",
        "Type": "AWS::EC2::VPC::Id",
        "ConstraintDescription": "must be the Id of an existing VPC.",
        "Default": ""
      },
      "SubnetA": {
        "Description": "Existing Subnet ID",
        "Type": "AWS::EC2::Subnet::Id",
        "ConstraintDescription": "must be the Id of an existing Subnet.",
        "Default": ""
      },
      "SSHKeyName": {
        "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instance",
        "Type": "AWS::EC2::KeyPair::KeyName",
        "ConstraintDescription": "must be the name of an existing EC2 KeyPair.",
        "Default": ""
      },
      "ClientIPAddress": {
        "Description": "IP address range allowed external RDP connections.",
        "Type": "String",
        "MinLength": "9",
        "MaxLength": "18",
        "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
        "ConstraintDescription": "Must be a valid IP CIDR range of the form x.x.x.x/x."
      },
      "Username": {
        "Description": "Username to access instance",
        "Type": "String",
        "ConstraintDescription": "must be a valid user name",
        "Default": ""
      },
      "Password": {
        "NoEcho": "true",
        "Description": "password",
        "Type": "String",
        "ConstraintDescription": "",
        "Default": ""
      },
      "ConfirmPassword": {
        "NoEcho": "true",
        "Description": "Confirm Password",
        "Type": "String",
        "ConstraintDescription": "",
        "Default": ""
      },
      "LicenseManagerHostname": {
        "Description": "The hostname of the network license manager for MATLAB to use with this cluster.",
        "Type": "String"
      },
      "LicenseManagerPort": {
        "Description": "The port of the network license manager for MATLAB to use with this cluster.",
        "Type": "Number",
        "Default": "27000",
        "MinValue": "0",
        "MaxValue": "65535"
      },
      "SuppressSecurityUpdates": {
        "Description": "By default, the un-attended critical security upgrades are enabled, a user can explicitly suppress the security upgrades at their own risk. Specify either 'No' or 'Yes'",
        "Type": "String",
        "Default": "No",
        "AllowedPattern": "(\bYes\b|\bNo\b)",
        "ConstraintDescription": "Must be either 'No' or 'Yes'"
      }
    },
    "Rules" : {
      "matchPasswords" : {
          "Assertions" : [
          {
              "Assert" : {"Fn::Equals":[{"Ref":"Password"},{"Ref":"ConfirmPassword"}]},
              "AssertDescription" : "Passwords do not match"
          }
          ]
      }},
    "Conditions": {},
    "Resources": {
  
      "SSHSecurityGroup": {
        "Type": "AWS::EC2::SecurityGroup",
        "Properties": {
          "VpcId": {
            "Ref": "VPC"
          },
          "GroupDescription": "Enable SSH access via port 22",
          "SecurityGroupIngress": [
            {
              "IpProtocol": "tcp",
              "FromPort": "22",
              "ToPort": "22",
              "CidrIp": {
                  "Ref": "ClientIPAddress"
                }
            },
            {
              "IpProtocol": "tcp",
              "FromPort": "3389",
              "ToPort": "3389",
              "CidrIp":{
                  "Ref": "ClientIPAddress"
                }
            }
          ],
          "SecurityGroupEgress": [
              {
                  "IpProtocol": -1,
                  "CidrIp": "0.0.0.0/0"
              }
          ]
        }
      },
  
      "EC2Instance": {
        "Type": "AWS::EC2::Instance",
        "Properties": {
          
          "ImageId": { "Ref": "NodeAMI"  },
          "KeyName": {
            "Ref": "SSHKeyName"
          },
          "SecurityGroupIds": [
            {
              "Ref": "SSHSecurityGroup"
            }
          ],
          "SubnetId": {
            "Ref": "SubnetA"
          },
          "InstanceType": {
            "Ref": "InstanceType"
          },
          "EbsOptimized" : "true",
          "UserData": {
            "Fn::Base64": {
              "Fn::Join": [
                "",
                [
                  "#!/bin/bash\n",
                  "# Copyright 2011-2017 The MathWorks, Inc.\n",
                  "cd /usr/local/matlab\n",
                  "nohup /usr/local/matlab/bin/glnxa64/MATLABStartupAccelerator &>/dev/null &\n",
                  "sudo useradd -m -p `echo ",
                  { "Ref" : "Password" },
                  " | mkpasswd --method=sha-512 -s` ",
                  { "Ref" : "Username" },
                  "\n",
                  "#disable online licensing and enable a license server\n",
                  "sudo rm /usr/local/matlab/licenses/license_info.xml\n",
                  "echo 'export MLM_LICENSE_FILE=",
                  {"Ref": "LicenseManagerPort"},
                  "@",
                  {"Ref": "LicenseManagerHostname"},
                  "' | sudo tee -a /etc/profile.d/mlmlicensefile.sh\n",
                  "\n",
                  "sudo usermod -aG sudo ",
                  { "Ref" : "Username" },
                  "\n",
                  "if [ 'No' == '",
                  { "Ref": "SuppressSecurityUpdates" },
                  "' ]\n",
                  " then \n",
                  "#install unattended-upgrades\n",
                  "sudo apt-get update --fix-missing\n",
                  "sudo apt-get install unattended-upgrades\n",
                  "\n",
                  "fi\n"
                ]
              ]
            }
          }
        }
      }
    },
    "Outputs": {
      "RDPConnection": {
          "Description": "Public DNSName of the newly created EC2 instance",
          "Value": {
              "Fn::GetAtt": ["EC2Instance", "PublicDnsName"]
          }
      }
    }
}
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2020b/aws-matlab-template.json">
{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Mappings": {
    "RegionMap": {
      "us-east-1": {
        "AMI": "ami-05a5d36ab36e7311e"
      },
      "us-east-2": {
        "AMI": "ami-0b5d89fbcf058394d"
      },
      "us-west-1": {
        "AMI": "ami-06f31c665fe0333fd"
      },
      "us-west-2": {
        "AMI": "ami-0e14d987dbec8a8fb"
      },
      "ca-central-1": {
        "AMI": "ami-0bda07307101e18fb"
      },
      "eu-central-1": {
        "AMI": "ami-091243bb0d0f501bb"
      },
      "eu-west-1": {
        "AMI": "ami-062c8d5b7e140b2f6"
      },
      "eu-west-2": {
        "AMI": "ami-060858ac377da3b25"
      },
      "eu-west-3": {
        "AMI": "ami-0a8a8f9bb67a37d06"
      },
      "eu-north-1": {
        "AMI": "ami-086799c3a5130f680"
      },
      "sa-east-1": {
        "AMI": "ami-0a857994715610c48"
      },
      "me-south-1": {
        "AMI": "ami-09e1784e3a99d958d"
      },
      "ap-east-1": {
        "AMI": "ami-041d0845d45f8309b"
      },
      "ap-south-1": {
        "AMI": "ami-06f4c88628ace140f"
      },
      "ap-northeast-1": {
        "AMI": "ami-08d4b0da5961721c4"
      },
      "ap-northeast-2": {
        "AMI": "ami-0b8032583f3ec3060"
      },
      "ap-southeast-1": {
        "AMI": "ami-0921b16435f0e59f4"
      },
      "ap-southeast-2": {
        "AMI": "ami-08099614bc2c414e7"
      }
    }
  },
  "Resources": {
    "MATLABSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": {
          "Ref": "VPC"
        },
        "GroupDescription": "Enable SSH and RDP Access",
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "22",
            "ToPort": "22",
            "CidrIp": {
              "Ref": "ClientIPAddress"
            }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "3389",
            "ToPort": "3389",
            "CidrIp": {
              "Ref": "ClientIPAddress"
            }
          }
        ]
      }
    },
    "MATLABInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Condition": "UseIamRole",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "IamRole"
          }
        ]
      }
    },
    "MATLABEC2Instance": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "ImageId": {
          "Fn::FindInMap": [
            "RegionMap",
            {
              "Ref": "AWS::Region"
            },
            "AMI"
          ]
        },
        "KeyName": {
          "Ref": "SSHKeyName"
        },
        "SecurityGroupIds": [
          {
            "Ref": "MATLABSecurityGroup"
          },
          {
            "Fn::If": [
              "AddSG",
              {
                "Ref": "AdditionalSecurityGroup"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          }
        ],
        "SubnetId": {
          "Ref": "Subnet"
        },
        "IamInstanceProfile": {
          "Fn::If": [
            "UseIamRole",
            {
              "Ref": "MATLABInstanceProfile"
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "InstanceType": {
          "Ref": "InstanceType"
        },
        "EbsOptimized": "true",
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "VolumeSize": {
                "Ref": "RootVolumeSize"
              }
            }
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Ref": "InstanceName"
            }
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash\n",
                "# Copyright 2011-2020 The MathWorks, Inc.\n",
                "cd /usr/local/matlab\n",
                "sudo echo $PATH:/usr/local/matlab/bin | sudo tee /etc/environment > /dev/null\n",
                "nohup /usr/local/matlab/bin/glnxa64/MATLABStartupAccelerator &>/dev/null &\n",
                "echo \"",
                {
                  "Fn::Join": [
                    ":",
                    [
                      "ubuntu",
                      {
                        "Fn::Join": [
                          "",
                          [
                            "$(echo \"",
                            {
                              "Fn::Base64": {
                                "Ref": "Password"
                              }
                            },
                            "\" | base64 -d)"
                          ]
                        ]
                      }
                    ]
                  ]
                },
                "\" | sudo chpasswd",
                "\n",
                "if [ -n '",
                {
                  "Ref": "LicenseManager"
                },
                "' ]\n",
                " then \n",
                "#disable online licensing and enable a license server\n",
                "sudo rm /usr/local/matlab/licenses/license_info.xml\n",
                "echo 'export MLM_LICENSE_FILE=",
                {
                  "Ref": "LicenseManager"
                },
                "' | sudo tee -a /etc/profile.d/mlmlicensefile.sh\n",
                "\n",
                "fi\n",
                "sudo apt-get install awscli -y\n"
              ]
            ]
          }
        }
      }
    }
  },
  "Parameters": {
    "InstanceType": {
      "Description": "The AWS instance type to use for MATLAB. See https://aws.amazon.com/ec2/instance-types for a list of instance types.",
      "Default": "m5.xlarge",
      "Type": "String"
    },
    "InstanceName": {
      "Description": "Give your MATLAB virtual machine a name",
      "Default": "MATLAB Desktop",
      "Type": "String"
    },
    "RootVolumeSize": {
      "Description": "Specify the size in GB of the root volume",
      "Default": "128",
      "Type": "Number",
      "MinValue": "128",
      "MaxValue": "1024",
      "ConstraintDescription": "Size must be between 64 and 1024GB"
    },
    "IamRole": {
      "Description": "Specify an IAM Role to associate with this instance.",
      "Default": "",
      "Type": "String"
    },
    "VPC": {
      "Description": "ID of an existing VPC in which to deploy this stack",
      "Type": "AWS::EC2::VPC::Id",
      "ConstraintDescription": "Must be the ID of an existing VPC.",
      "AllowedPattern": ".+"
    },
    "Subnet": {
      "Description": "List of existing subnets IDs",
      "Type": "AWS::EC2::Subnet::Id",
      "ConstraintDescription": "Must be the ID of an existing Subnet within the chosen VPC.",
      "AllowedPattern": ".+"
    },
    "SSHKeyName": {
      "Description": "The name of an existing EC2 KeyPair to allow SSH access to all the instances. See https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html for details on creating these.",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "ConstraintDescription": "Must be the name of an existing EC2 KeyPair.",
      "AllowedPattern": ".+"
    },
    "ClientIPAddress": {
      "Description": "The IP address range that will be allowed to connect to this instance from outside of the VPC. This field should be formatted as <ip_address>/<mask>. E.g. 10.0.0.1/32. This is the public IP address which can be found by searching for 'what is my ip address' on the web. The mask determines the number of IP addresses to include. A mask of 32 is a single IP address. This calculator can be used to build a specific range: https://www.ipaddressguide.com/cidr. You may need to contact your IT administrator to determine which address is appropriate.",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription": "Must be a valid IP CIDR range of the form x.x.x.x/x."
    },
    "Password": {
      "NoEcho": "true",
      "Description": "Enter a password for the \"ubuntu\" user",
      "Type": "String",
      "ConstraintDescription": "",
      "Default": ""
    },
    "ConfirmPassword": {
      "NoEcho": "true",
      "Description": "Confirm Password",
      "Type": "String",
      "ConstraintDescription": "",
      "Default": ""
    },
    "LicenseManager": {
      "Description": "Optional License Manager for MATLAB string in the form <port>@<hostname>. If not specified, online licensing is used. If specified, the license manager must be accessible from the specified VPC and subnets",
      "Type": "String",
      "Default": "",
      "AllowedPattern": "([0-9]+@[a-zA-Z0-9.]+)?",
      "ConstraintDescription": "If specified, must be in the form <port>@<hostname>"
    },
    "AdditionalSecurityGroup": {
      "Description": "The ID of an additional (optional) Security Group for the instances to be placed in. Often the License Manager for MATLAB's Security Group.",
      "Type": "String",
      "Default": ""
    }
  },
  "Rules": {
    "matchPasswords": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "Password"
              },
              {
                "Ref": "ConfirmPassword"
              }
            ]
          },
          "AssertDescription": "Passwords do not match"
        }
      ]
    },
    "SubnetInVPC": {
      "Assertions": [
        {
          "Assert": {
            "Fn::EachMemberEquals": [
              {
                "Fn::ValueOfAll": [
                  "AWS::EC2::Subnet::Id",
                  "VpcId"
                ]
              },
              {
                "Ref": "VPC"
              }
            ]
          },
          "AssertDescription": "Subnet must exist in the VPC you have selected"
        }
      ]
    }
  },
  "Conditions": {
    "UseIamRole": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            "",
            {
              "Ref": "IamRole"
            }
          ]
        }
      ]
    },
    "AddSG": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalSecurityGroup"
            },
            ""
          ]
        }
      ]
    }
  },
  "Outputs": {
    "RDPConnection": {
      "Description": "Public DNSName of the newly created EC2 instance",
      "Value": {
        "Fn::GetAtt": [
          "MATLABEC2Instance",
          "PublicDnsName"
        ]
      }
    }
  },
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "EC2 Instance"
          },
          "Parameters": [
            "InstanceName",
            "InstanceType",
            "RootVolumeSize",
            "IamRole"
          ]
        },
        {
          "Label": {
            "default": "Remote Access"
          },
          "Parameters": [
            "ClientIPAddress",
            "SSHKeyName",
            "Password",
            "ConfirmPassword"
          ]
        },
        {
          "Label": {
            "default": "Network Configuration"
          },
          "Parameters": [
            "VPC",
            "Subnet",
            "AdditionalSecurityGroup"
          ]
        },
        {
          "Label": {
            "default": "License Configuration"
          },
          "Parameters": [
            "LicenseManager"
          ]
        }
      ],
      "ParameterLabels": {
        "ClientIPAddress": {
          "default": "Allow RDP connections from"
        },
        "InstanceType": {
          "default": "AWS EC2 Instance type"
        },
        "InstanceName": {
          "default": "Instance Name"
        },
        "RootVolumeSize": {
          "default": "Storage Size (GiB)"
        },
        "IamRole": {
          "default": "IAM Role (Optional)"
        },
        "VPC": {
          "default": "VPC to deploy this stack to"
        },
        "Subnet": {
          "default": "Subnet"
        },
        "Password": {
          "default": "Remote password"
        },
        "ConfirmPassword": {
          "default": "Confirm remote password"
        },
        "SSHKeyName": {
          "default": "SSH Key Pair"
        },
        "LicenseManager": {
          "default": "License Manager for MATLAB connection string"
        },
        "AdditionalSecurityGroup": {
          "default": "Additional security group to place instances in"
        }
      }
    }
  }
}
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2020b/README.md">
# MATLAB on Amazon Web Services (Linux VM)

## Step 1. Launch the Template

Click the **Launch Stack** button to deploy a standalone MATLAB desktop client on AWS. This will open the CloudFormation Create Stack screen in your web browser.

| Region | Launch Link |
| --------------- | ----------- |
| **us-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-east-1.console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020b/aws-matlab-template.json) |
| **us-east-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-east-2.console.aws.amazon.com/cloudformation/home?region=us-east-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020b/aws-matlab-template.json) |
| **us-west-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-west-1.console.aws.amazon.com/cloudformation/home?region=us-west-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020b/aws-matlab-template.json) |
| **us-west-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-west-2.console.aws.amazon.com/cloudformation/home?region=us-west-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020b/aws-matlab-template.json) |
| **ca-central-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ca-central-1.console.aws.amazon.com/cloudformation/home?region=ca-central-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020b/aws-matlab-template.json) |
| **eu-central-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-central-1.console.aws.amazon.com/cloudformation/home?region=eu-central-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020b/aws-matlab-template.json) |
| **eu-west-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-1.console.aws.amazon.com/cloudformation/home?region=eu-west-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020b/aws-matlab-template.json) |
| **eu-west-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-2.console.aws.amazon.com/cloudformation/home?region=eu-west-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020b/aws-matlab-template.json) |
| **eu-west-3** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-3.console.aws.amazon.com/cloudformation/home?region=eu-west-3#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020b/aws-matlab-template.json) |
| **eu-north-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-north-1.console.aws.amazon.com/cloudformation/home?region=eu-north-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020b/aws-matlab-template.json) |
| **sa-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://sa-east-1.console.aws.amazon.com/cloudformation/home?region=sa-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020b/aws-matlab-template.json) |
| **me-south-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://me-south-1.console.aws.amazon.com/cloudformation/home?region=me-south-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020b/aws-matlab-template.json) |
| **ap-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-east-1.console.aws.amazon.com/cloudformation/home?region=ap-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020b/aws-matlab-template.json) |
| **ap-south-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-south-1.console.aws.amazon.com/cloudformation/home?region=ap-south-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020b/aws-matlab-template.json) |
| **ap-northeast-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-northeast-1.console.aws.amazon.com/cloudformation/home?region=ap-northeast-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020b/aws-matlab-template.json) |
| **ap-northeast-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-northeast-2.console.aws.amazon.com/cloudformation/home?region=ap-northeast-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020b/aws-matlab-template.json) |
| **ap-southeast-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-southeast-1.console.aws.amazon.com/cloudformation/home?region=ap-southeast-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020b/aws-matlab-template.json) |
| **ap-southeast-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-southeast-2.console.aws.amazon.com/cloudformation/home?region=ap-southeast-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020b/aws-matlab-template.json) |


**Note**: Creating a stack on AWS can take a few minutes.

## Step 2. Configure the Cloud Resources
After you click the Launch Stack button above, the “Create stack” page will open in your browser where you can configure the parameters. It is easier to complete the steps if you position these instructions and the AWS console window side by side.

1. Specify a stack name. This will be shown in the AWS CloudFormation console and must be unique within the AWS account.


2. Specify and check the defaults for these resource parameters:

| Parameter label | Description |
| --------------- | ----------- |
| **AWS EC2 Instance type** | The AWS instance type to use for MATLAB. See https://aws.amazon.com/ec2/instance-types for a list of instance types. |
| **Instance Name** | Give your MATLAB virtual machine a name |
| **Storage Size (GiB)** | Specify the size in GB of the root volume |
| **IAM Role (Optional)** | Specify an IAM Role to associate with this instance. |
| **VPC to deploy this stack to** | ID of an existing VPC in which to deploy this stack |
| **Subnet** | List of existing subnets IDs |
| **SSH Key Pair** | The name of an existing EC2 KeyPair to allow SSH access to all the instances. See https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html for details on creating these. |
| **Allow RDP connections from** | The IP address range that will be allowed to connect to this instance from outside of the VPC. This field should be formatted as \<ip_address>/\<mask>. E.g. 10.0.0.1/32. This is the public IP address which can be found by searching for 'what is my ip address' on the web. The mask determines the number of IP addresses to include. A mask of 32 is a single IP address. This calculator can be used to build a specific range: https://www.ipaddressguide.com/cidr. You may need to contact your IT administrator to determine which address is appropriate. |
| **Remote password** | Enter a password for the "ubuntu" user |
| **Confirm remote password** | Confirm Password |
| **License Manager for MATLAB connection string** | Optional License Manager for MATLAB string in the form \<port>@\<hostname>. If not specified, online licensing is used. If specified, the license manager must be accessible from the specified VPC and subnets |
| **Additional security group to place instances in** | The ID of an additional (optional) Security Group for the instances to be placed in. Often the License Manager for MATLAB's Security Group. |


>**Note**: If you chose to associate an IAM role above you'll need to acknowledge that it may create IAM resources in the Capabilities before creating the stack.

3. Click the **Create Stack** button.  The CloudFormation service will start creating the resources for the stack. <p>After clicking **Create** you will be taken to the *Stack Detail* page for your stack. Wait for the Status to reach **CREATE\_COMPLETE**. This may take up to 10 minutes.</p>

## Step 3. Connect to the Virtual Machine in the Cloud

1. Expand the **Outputs** section in the the *Stack Detail* page.
1. Look for the key named `RDPConnection` and copy the corresponding public DNS name listed under value. *For example*: ec2-11-222-33-44.compute-1.amazonaws.com
1. Launch any remote desktop client, paste the public DNS name in the appropriate field, and connect. On the Windows Remote Desktop Client you need to paste the public DNS name in the **Computer** field and click **Connect**.
1. In the login screen that's displayed, use the username `ubuntu` and the password you specified while setting up the stack in [Step 2](#step-2-configure-the-stack).

## Step 4. Launch MATLAB
Double-click the MATLAB icon on the virtual machine desktop to launch MATLAB. The first time you start MATLAB you will need to activate it. By default, you will be asked to use your MathWorks Account to activate MATLAB. For other ways to activate MATLAB, see [Configure MATLAB Licensing on the Cloud](http://www.mathworks.com/support/cloud/configure-matlab-licensing-on-the-cloud.html).

>**Note**: It may take a few minutes for activation to complete and MATLAB to start. You will experience this delay only the first time you start MATLAB.


# Additional Information

## Delete Your Cloud Resources

Once you have finished using your stack, it is recommended that you delete all resources to avoid incurring further cost. To delete the stack, do the following:
1. Log in to the AWS Console.
1. Go to the AWS CloudFormation page and select the stack you created.
1. Click the **Actions** button and click **Delete Stack** from the menu that appears.

### Resources

The following resources will be created as part of the CloudFormation Stack.

1. Security Group for SSH and RDP access
1. EC2 Instance
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2024b/aws-matlab-template.json">
{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Mappings": {
    "RegionMap": {
      "us-east-1": {
        "AMI": "ami-0a7e24f9ce894a52c"
      },
      "us-east-2": {
        "AMI": "ami-0ae5114dc2787b1d4"
      },
      "us-west-1": {
        "AMI": "ami-0901932713e732845"
      },
      "us-west-2": {
        "AMI": "ami-094040f6770aae1e3"
      },
      "ca-central-1": {
        "AMI": "ami-044988f0bdf7634e2"
      },
      "eu-central-1": {
        "AMI": "ami-0d41bc6b9c40e06f1"
      },
      "eu-west-1": {
        "AMI": "ami-035b8d8b55580b4f3"
      },
      "eu-west-2": {
        "AMI": "ami-0c5feb77715f86e36"
      },
      "eu-west-3": {
        "AMI": "ami-0b6de51dd451a444b"
      },
      "eu-north-1": {
        "AMI": "ami-028d1f2dcb3d64075"
      },
      "sa-east-1": {
        "AMI": "ami-05687223ccb72f6db"
      },
      "me-south-1": {
        "AMI": "ami-0c5d2e81f968d137c"
      },
      "ap-east-1": {
        "AMI": "ami-085af4730a31af555"
      },
      "ap-south-1": {
        "AMI": "ami-0784a3a9b9717d600"
      },
      "ap-northeast-1": {
        "AMI": "ami-067bba55c3792a545"
      },
      "ap-northeast-2": {
        "AMI": "ami-04f49812fcb91fc11"
      },
      "ap-southeast-1": {
        "AMI": "ami-0c3e5da7556f857c4"
      },
      "ap-southeast-2": {
        "AMI": "ami-01c443c042b1405ec"
      }
    }
  },
  "Resources": {
    "PredefinedRole": {
      "Type": "AWS::IAM::Role",
      "Condition": "UsePredefinedRole",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "ec2.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/MW/",
        "ManagedPolicyArns": {
          "Fn::If": [
            "UseAdditionalPolicies",
            {
              "Fn::Split": [
                ";",
                {
                  "Ref": "AdditionalIamPolicies"
                }
              ]
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "Policies": [
          {
            "Fn::If": [
              "UseCloudWatch",
              {
                "PolicyName": "cloudwatch-access-policy",
                "PolicyDocument": {
                  "Version": "2012-10-17",
                  "Statement": [
                    {
                      "Effect": "Allow",
                      "Action": [
                        "logs:CreateLogStream",
                        "logs:DescribeLogStreams",
                        "logs:PutLogEvents"
                      ],
                      "Resource": {
                        "Fn::Sub": [
                          "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:${LogGroupName}:*",
                          {
                            "LogGroupName": {
                              "Ref": "MWLogLocation"
                            }
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          {
            "PolicyName": "dcv-access-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "s3:GetObject",
                  "Resource": {
                    "Fn::Sub": "arn:${AWS::Partition}:s3:::dcv-license.${AWS::Region}/*"
                  }
                }
              ]
            }
          },
          {
            "PolicyName": "ssm-access-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "ssm:DescribeAssociation",
                    "ssm:GetDeployablePatchSnapshotForInstance",
                    "ssm:GetDocument",
                    "ssm:DescribeDocument",
                    "ssm:GetManifest",
                    "ssm:GetParameter",
                    "ssm:GetParameters",
                    "ssm:ListAssociations",
                    "ssm:ListInstanceAssociations",
                    "ssm:PutInventory",
                    "ssm:PutComplianceItems",
                    "ssm:PutConfigurePackageResult",
                    "ssm:UpdateAssociationStatus",
                    "ssm:UpdateInstanceAssociationStatus",
                    "ssm:UpdateInstanceInformation"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ssmmessages:CreateControlChannel",
                    "ssmmessages:CreateDataChannel",
                    "ssmmessages:OpenControlChannel",
                    "ssmmessages:OpenDataChannel"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ec2messages:AcknowledgeMessage",
                    "ec2messages:DeleteMessage",
                    "ec2messages:FailMessage",
                    "ec2messages:GetEndpoint",
                    "ec2messages:GetMessages",
                    "ec2messages:SendReply"
                  ],
                  "Resource": "*"
                }
              ]
            }
          },
          {
            "PolicyName": "describe-tags-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "ec2:DescribeTags",
                  "Resource": "*"
                }
              ]
            }
          }
        ]
      }
    },
    "MATLABInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/MW/",
        "Roles": [
          {
            "Fn::If": [
              "UsePredefinedRole",
              {
                "Ref": "PredefinedRole"
              },
              {
                "Ref": "CustomIamRole"
              }
            ]
          }
        ]
      }
    },
    "EC2AutoShutdown": {
      "Type": "AWS::CloudFormation::Stack",
      "DeletionPolicy": "Delete",
      "UpdateReplacePolicy": "Delete",
      "Properties": {
        "TemplateURL": "https://mathworks-reference-architectures-templates.s3.amazonaws.com/ec2-shutdown-lambda/v1/0/1/ec2-shutdown-lambda.yml",
        "Parameters": {
          "EC2InstanceId": {
            "Ref": "MATLABEC2Instance"
          },
          "MathWorksProductId": "MathWorks-MATLAB-Linux",
          "ShutdownBehaviour": {
            "Ref": "AutoShutdown"
          },
          "TagToMonitor": "mw-autoshutdown",
          "AutoShutdownLambdaLogRetentionInDays": 1
        }
      }
    },
    "MWSecurityGroup": {
      "Type": "AWS::CloudFormation::Stack",
      "DeletionPolicy": "Delete",
      "UpdateReplacePolicy": "Delete",
      "Properties": {
        "TemplateURL": "https://mathworks-reference-architectures-templates.s3.amazonaws.com/security-group/v2/0/0/security-group.yml",
        "Parameters": {
          "VpcId": {
            "Ref": "VPC"
          },
          "CidrRanges": {
            "Ref": "ClientIPAddress"
          },
          "SSHAccess": "Yes",
          "RDPAccess": "Yes",
          "NICEDCVAccess": "Yes",
          "MATLABProxyAccess": "Yes"
        }
      }
    },
    "MWLogLocation": {
      "Type": "AWS::Logs::LogGroup",
      "Condition": "UseCloudWatch"
    },
    "MATLABEC2Instance": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "ImageId": {
          "Fn::If": [
            "UseCustomAMI",
            {
              "Ref": "CustomAmiId"
            },
            {
              "Fn::FindInMap": [
                "RegionMap",
                {
                  "Ref": "AWS::Region"
                },
                "AMI"
              ]
            }
          ]
        },
        "KeyName": {
          "Ref": "SSHKeyName"
        },
        "SecurityGroupIds": [
          {
            "Fn::GetAtt": [
              "MWSecurityGroup",
              "Outputs.SecurityGroupId"
            ]
          },
          {
            "Fn::If": [
              "AddSG",
              {
                "Ref": "AdditionalSecurityGroup"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          }
        ],
        "SubnetId": {
          "Ref": "Subnet"
        },
        "InstanceType": {
          "Ref": "InstanceType"
        },
        "IamInstanceProfile": {
          "Ref": "MATLABInstanceProfile"
        },
        "EbsOptimized": "true",
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "VolumeSize": {
                "Ref": "RootVolumeSize"
              }
            }
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Ref": "InstanceName"
            }
          },
          {
            "Key": "mw-ProductID",
            "Value": "MathWorks-MATLAB-Linux"
          },
          {
            "Key": "mw-StackName",
            "Value": {
              "Ref": "AWS::StackName"
            }
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "\n",
              [
                "#!/bin/bash",
                "",
                "# Copyright 2022 The MathWorks, Inc.",
                "",
                "STARTUP_FOLDER=/opt/mathworks/startup",
                "# Load startup variables",
                "if [[ -r ${STARTUP_FOLDER}/.env ]]; then",
                "    set -o allexport",
                "    source ${STARTUP_FOLDER}/.env",
                "    set +o allexport",
                "fi",
                "",
                "# Define startup parameters",
                {
                  "Fn::Sub": [
                    "export PASSWORD=${PasswordBase64}",
                    {
                      "PasswordBase64": {
                        "Fn::Base64": {
                          "Ref": "Password"
                        }
                      }
                    }
                  ]
                },
                {
                  "Fn::Sub": "export MLM_LICENSE_FILE=${LicenseManager}"
                },
                {
                  "Fn::Sub": [
                    "export CLOUD_LOG_NAME=${LogGroupName}",
                    {
                      "LogGroupName": {
                        "Fn::If": [
                          "UseCloudWatch",
                          {
                            "Ref": "MWLogLocation"
                          },
                          ""
                        ]
                      }
                    }
                  ]
                },
                {
                  "Fn::Sub": "export ACCESS_PROTOCOL='${AccessProtocol}'"
                },
                {
                  "Fn::Sub": "export ENABLE_MATLAB_PROXY='${EnableMATLABProxy}'"
                },
                {
                  "Fn::Sub": "export OPTIONAL_USER_COMMAND='${OptionalUserCommand}'"
                },
                "",
                "# Run startup scripts",
                "mkdir -p /var/log/mathworks",
                "run-parts --exit-on-error --verbose --regex '^[0-9]+_.+$' ${STARTUP_FOLDER} >> /var/log/mathworks/startup.log 2>&1",
                "",
                "# Signal the status from cfn-init",
                {
                  "Fn::Sub": "/opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --region ${AWS::Region} --resource MATLABEC2Instance"
                }
              ]
            ]
          }
        }
      },
      "CreationPolicy": {
        "ResourceSignal": {
          "Timeout": "PT15M"
        }
      }
    },
    "ElasticIP": {
      "Type": "AWS::EC2::EIP",
      "Condition": "UseElasticIPAddress",
      "Properties": {
        "InstanceId": {
          "Ref": "MATLABEC2Instance"
        },
        "Domain": "vpc"
      }
    },
    "document": {
      "Type": "AWS::SSM::Document",
      "Condition": "UsePredefinedRole",
      "Properties": {
        "DocumentType": "Command",
        "Content": {
          "schemaVersion": "2.2",
          "description": "Run a script on Linux instances.",
          "parameters": {
            "commands": {
              "type": "String",
              "description": "Command to run on EC2 instance",
              "default": "echo 'Hello World'"
            }
          },
          "mainSteps": [
            {
              "action": "aws:runShellScript",
              "name": "runCommands",
              "inputs": {
                "timeoutSeconds": "60",
                "runCommand": [
                  "{{ commands }}"
                ]
              }
            }
          ]
        }
      }
    }
  },
  "Parameters": {
    "InstanceType": {
      "Description": "AWS instance type to use for MATLAB. See https://aws.amazon.com/ec2/instance-types for a list of instance types.",
      "Default": "m5.xlarge",
      "Type": "String"
    },
    "InstanceName": {
      "Description": "Name for the MATLAB virtual machine",
      "Default": "MATLAB Desktop",
      "Type": "String"
    },
    "AccessProtocol": {
      "Description": "Access protocol to connect to this instance",
      "Default": "RDP",
      "Type": "String",
      "AllowedValues": [
        "NICE DCV",
        "RDP"
      ]
    },
    "EnableMATLABProxy": {
      "Description": "Option that enables access to MATLAB on your cloud instance within a browser. Opening MATLAB in a browser opens a separate MATLAB session to your Remote Desktop Protocol (RDP) session or NICE DCV session.",
      "Default": "Yes",
      "Type": "String",
      "AllowedValues": [
        "Yes",
        "No"
      ]
    },
    "UseElasticIpAddress": {
      "Description": "Flag indicating whether you want to keep the same public IP address for the instance",
      "Default": "No",
      "Type": "String",
      "AllowedValues": [
        "Yes",
        "No"
      ]
    },
    "RootVolumeSize": {
      "Description": "Size in GB of the root volume",
      "Default": "128",
      "Type": "Number",
      "MinValue": "128",
      "MaxValue": "1024",
      "ConstraintDescription": "Size must be between 128 and 1024GB"
    },
    "CustomIamRole": {
      "Description": "Name of a custom IAM Role to associate with this instance. If not specified, a predefined role is used. If specified, features requiring special permissions will be unavailable (NICE DCV, CloudWatch, IAM Policies).",
      "Default": "",
      "Type": "String"
    },
    "AdditionalIamPolicies": {
      "Description": "Semicolon-delimited list of IAM Policy ARNs to add to the predefined role. This option cannot be used with a custom IAM Role.",
      "Default": "",
      "Type": "String",
      "AllowedPattern": "^(arn:[^:;]+:iam::[^:;]+:policy/[^:;]+(;arn:[^:;]+:iam::[^:;]+:policy/[^:;]+)*)?$",
      "ConstraintDescription": "If specified, must be a semicolon (;) delimited list of ARNs (arn:<partition>:iam::<account-id>:policy/<resource-id>)."
    },
    "VPC": {
      "Description": "ID of an existing VPC in which to deploy this stack",
      "Type": "AWS::EC2::VPC::Id",
      "ConstraintDescription": "Must be the ID of an existing VPC.",
      "AllowedPattern": ".+"
    },
    "Subnet": {
      "Description": "ID of an existing subnet. To access the instance from anywhere, ensure that your subnet auto-assigns public IP addresses and is connected to the internet.",
      "Type": "AWS::EC2::Subnet::Id",
      "ConstraintDescription": "Must be the ID of an existing Subnet within the chosen VPC.",
      "AllowedPattern": ".+"
    },
    "SSHKeyName": {
      "Description": "Name of an existing EC2 KeyPair to allow SSH access to all the instances. See https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html for details on creating these.",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "ConstraintDescription": "Must be the name of an existing EC2 KeyPair.",
      "AllowedPattern": ".+"
    },
    "ClientIPAddress": {
      "Description": "Comma-separated list of IP address ranges that will be allowed to connect to this instance. Each IP CIDR should be formatted as <ip_address>/<mask>. The mask determines the number of IP addresses to include. A mask of 32 is a single IP address. Example of allowed values: 10.0.0.1/32 or 10.0.0.0/16,192.34.56.78/32. This calculator can be used to build a specific range: https://www.ipaddressguide.com/cidr. You may need to contact your IT administrator to determine which address is appropriate.",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "189",
      "AllowedPattern": "^((\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2}))(,((\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2}))){0,9}$",
      "ConstraintDescription": "Must be a comma-separated list of valid IP CIDR ranges of the form x.x.x.x/x. A maximum of 10 such IP CIDRs are allowed in the list."
    },
    "Password": {
      "NoEcho": "true",
      "Description": "Password for the \"ubuntu\" user. You also need to enter this as an authentication token to access MATLAB on your cloud instance within a browser.",
      "Type": "String",
      "ConstraintDescription": "Must have a minimum of 14 characters, 1 uppercase letter, 1 lowercase letter, 1 number, and 1 special character",
      "AllowedPattern": "^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[^a-zA-Z0-9]).{14,}$"
    },
    "ConfirmPassword": {
      "NoEcho": "true",
      "Description": "Confirm Password",
      "Type": "String"
    },
    "LicenseManager": {
      "Description": "Optional License Manager for MATLAB, specified as a string in the form <port>@<hostname>. If not specified, use online licensing. If specified, the network license manager (NLM) must be accessible from the specified VPC and subnets. To use the private hostname of the NLM hub instead of the public hostname, specify the security group ID of the NLM hub in the AdditionalSecurityGroup parameter. For more information, see https://github.com/mathworks-ref-arch/license-manager-for-matlab-on-aws.",
      "Type": "String",
      "Default": "",
      "AllowedPattern": "([0-9]+@[a-zA-Z0-9.\\-]+)?",
      "ConstraintDescription": "If specified, must be in the form <port>@<hostname>"
    },
    "EnableCloudWatch": {
      "Description": "Flag indicating whether cloudwatch logging for the MATLAB instance is enabled.",
      "Type": "String",
      "AllowedValues": [
        "Yes",
        "No"
      ],
      "Default": "No"
    },
    "AutoShutdown": {
      "Description": "Choose whether you want to enable autoshutdown for your instance after a certain number of hours",
      "Type": "String",
      "AllowedValues": [
        "Never",
        "After 1 hour",
        "After 2 hours",
        "After 3 hours",
        "After 4 hours",
        "After 5 hours",
        "After 6 hours",
        "After 7 hours",
        "After 8 hours",
        "After 9 hours",
        "After 10 hours",
        "After 11 hours",
        "After 12 hours",
        "After 13 hours",
        "After 14 hours",
        "After 15 hours",
        "After 16 hours",
        "After 17 hours",
        "After 18 hours",
        "After 19 hours",
        "After 20 hours",
        "After 21 hours",
        "After 22 hours",
        "After 23 hours",
        "After 24 hours"
      ],
      "Default": "Never"
    },
    "AdditionalSecurityGroup": {
      "Description": "ID of an additional (optional) Security Group for the instances to be placed in. Often the License Manager for MATLAB's Security Group.",
      "Type": "String",
      "Default": ""
    },
    "CustomAmiId": {
      "Default": "",
      "Description": "ID of a custom Amazon Machine Image (AMI) in the target region (optional). If the build has been customized then the resulting machine image may no longer be compatible with the provided CloudFormation template. Compatability can in some cases be restored by making corresponding modifications to the CloudFormation template. The ID should start with 'ami-'.",
      "Type": "String"
    },
    "OptionalUserCommand": {
      "Description": "Provide an optional inline shell command to run on machine launch. For example, to set an environment variable CLOUD=AWS, use this command excluding the angle brackets: <echo -e \"export CLOUD=AWS\" | tee -a /etc/profile.d/setenvvar.sh && source /etc/profile>. To run an external script, use this command excluding the angle brackets: <wget -O /tmp/my-script.sh \"https://www.example.com/script.sh\" && bash /tmp/my-script.sh>. Find the logs at '/var/log/mathworks/startup.log'.",
      "Type": "String",
      "Default": ""
    }
  },
  "Rules": {
    "matchPasswords": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "Password"
              },
              {
                "Ref": "ConfirmPassword"
              }
            ]
          },
          "AssertDescription": "Passwords do not match"
        }
      ]
    },
    "SubnetInVPC": {
      "Assertions": [
        {
          "Assert": {
            "Fn::EachMemberEquals": [
              {
                "Fn::ValueOfAll": [
                  "AWS::EC2::Subnet::Id",
                  "VpcId"
                ]
              },
              {
                "Ref": "VPC"
              }
            ]
          },
          "AssertDescription": "Subnet must exist in the VPC you have selected"
        }
      ]
    },
    "NoAdditionalPoliciesOnCustomRole": {
      "RuleCondition": {
        "Fn::Not": [
          {
            "Fn::Equals": [
              {
                "Ref": "CustomIamRole"
              },
              ""
            ]
          }
        ]
      },
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "AdditionalIamPolicies"
              },
              ""
            ]
          },
          "AssertDescription": "You cannot add IAM Policies when using a custom IAM Role."
        }
      ]
    },
    "MultipleRolesMustNotExist": {
      "RuleCondition": {
        "Fn::Not": [
          {
            "Fn::Equals": [
              {
                "Ref": "CustomIamRole"
              },
              ""
            ]
          }
        ]
      },
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "EnableCloudWatch"
              },
              "No"
            ]
          },
          "AssertDescription": "You cannot use CloudWatch when using a custom IAM role. The deployment will create an IAM role which you can later modify with additional policies if needed."
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "AccessProtocol"
                  },
                  "NICE DCV"
                ]
              }
            ]
          },
          "AssertDescription": "You cannot use NICE DCV when using a custom IAM role. The deployment will create an IAM role which you can later modify with additional policies if needed."
        }
      ]
    }
  },
  "Conditions": {
    "UsePredefinedRole": {
      "Fn::Equals": [
        {
          "Ref": "CustomIamRole"
        },
        ""
      ]
    },
    "UseAdditionalPolicies": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalIamPolicies"
            },
            ""
          ]
        }
      ]
    },
    "UseCloudWatch": {
      "Fn::Equals": [
        {
          "Ref": "EnableCloudWatch"
        },
        "Yes"
      ]
    },
    "UseNICEDCV": {
      "Fn::Equals": [
        {
          "Ref": "AccessProtocol"
        },
        "NICE DCV"
      ]
    },
    "UseXRDP": {
      "Fn::Equals": [
        {
          "Ref": "AccessProtocol"
        },
        "RDP"
      ]
    },
    "UseMATLABProxy": {
      "Fn::Equals": [
        {
          "Ref": "EnableMATLABProxy"
        },
        "Yes"
      ]
    },
    "UseElasticIPAddress": {
      "Fn::Equals": [
        {
          "Ref": "UseElasticIpAddress"
        },
        "Yes"
      ]
    },
    "UseCustomAMI": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "CustomAmiId"
            },
            ""
          ]
        }
      ]
    },
    "AddSG": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalSecurityGroup"
            },
            ""
          ]
        }
      ]
    }
  },
  "Outputs": {
    "CloudWatchLogs": {
      "Condition": "UseCloudWatch",
      "Description": "The cloudwatch logs containing logging information about the MATLAB instance",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://console.aws.amazon.com/cloudwatch/home?region=",
            {
              "Ref": "AWS::Region"
            },
            "#logsV2:log-groups/log-group/",
            {
              "Ref": "MWLogLocation"
            }
          ]
        ]
      }
    },
    "NiceDCVConnection": {
      "Condition": "UseNICEDCV",
      "Description": "Public url of the newly created EC2 instance to connect to the session via NICE DCV",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://",
            {
              "Fn::GetAtt": [
                "MATLABEC2Instance",
                "PublicDnsName"
              ]
            },
            ":8443/#console"
          ]
        ]
      }
    },
    "RDPConnection": {
      "Condition": "UseXRDP",
      "Description": "Public DNSName of the newly created EC2 instance",
      "Value": {
        "Fn::GetAtt": [
          "MATLABEC2Instance",
          "PublicDnsName"
        ]
      }
    },
    "BrowserConnection": {
      "Condition": "UseMATLABProxy",
      "Description": "URL to connect to and open MATLAB in a browser.",
      "Value": {
        "Fn::Sub": "https://${MATLABEC2Instance.PublicDnsName}:8123"
      }
    }
  },
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "EC2 Instance"
          },
          "Parameters": [
            "InstanceName",
            "InstanceType",
            "RootVolumeSize",
            "CustomIamRole",
            "AdditionalIamPolicies"
          ]
        },
        {
          "Label": {
            "default": "Remote Access"
          },
          "Parameters": [
            "AccessProtocol",
            "EnableMATLABProxy",
            "UseElasticIpAddress",
            "ClientIPAddress",
            "SSHKeyName",
            "Password",
            "ConfirmPassword"
          ]
        },
        {
          "Label": {
            "default": "Network Configuration"
          },
          "Parameters": [
            "VPC",
            "Subnet",
            "AdditionalSecurityGroup"
          ]
        },
        {
          "Label": {
            "default": "License Configuration"
          },
          "Parameters": [
            "LicenseManager"
          ]
        },
        {
          "Label": {
            "default": "Logging Configuration"
          },
          "Parameters": [
            "EnableCloudWatch"
          ]
        },
        {
          "Label": {
            "default": "Autoshutdown Configuration"
          },
          "Parameters": [
            "AutoShutdown"
          ]
        },
        {
          "Label": {
            "default": "Custom AMI"
          },
          "Parameters": [
            "CustomAmiId"
          ]
        },
        {
          "Label": {
            "default": "Optional User Command"
          },
          "Parameters": [
            "OptionalUserCommand"
          ]
        }
      ],
      "ParameterLabels": {
        "ClientIPAddress": {
          "default": "Allow connections from"
        },
        "UseElasticIpAddress": {
          "default": "Keep public ip the same"
        },
        "InstanceType": {
          "default": "AWS EC2 Instance type"
        },
        "InstanceName": {
          "default": "Instance Name"
        },
        "RootVolumeSize": {
          "default": "Storage Size (GiB)"
        },
        "CustomIamRole": {
          "default": "Custom IAM Role (Optional)"
        },
        "AdditionalIamPolicies": {
          "default": "Additional IAM Policies (Optional)"
        },
        "VPC": {
          "default": "VPC to deploy this stack to"
        },
        "Subnet": {
          "default": "Subnet"
        },
        "Password": {
          "default": "Remote password"
        },
        "ConfirmPassword": {
          "default": "Confirm remote password"
        },
        "SSHKeyName": {
          "default": "SSH Key Pair"
        },
        "EnableMATLABProxy": {
          "default": "Enable browser access for MATLAB"
        },
        "LicenseManager": {
          "default": "License Manager for MATLAB connection string"
        },
        "AdditionalSecurityGroup": {
          "default": "Additional security group to place instances in"
        },
        "EnableCloudWatch": {
          "default": "Configure cloudwatch logging for the MATLAB instance"
        },
        "AccessProtocol": {
          "default": "Remote access protocol"
        },
        "CustomAmiId": {
          "default": "Custom AMI ID (Optional)"
        },
        "OptionalUserCommand": {
          "default": "Optional user inline command"
        }
      }
    }
  }
}
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2024b/README.md">
# MATLAB on Amazon Web Services (Linux VM)

## Step 1. Launch the Template

Click the **Launch Stack** button to deploy a standalone MATLAB&reg; desktop client on AWS&reg;. This opens the CloudFormation Create Stack screen in your web browser.

| Region | Launch Link |
| --------------- | ----------- |
| **us-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-east-1.console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024b/aws-matlab-template.json) |
| **us-east-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-east-2.console.aws.amazon.com/cloudformation/home?region=us-east-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024b/aws-matlab-template.json) |
| **us-west-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-west-1.console.aws.amazon.com/cloudformation/home?region=us-west-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024b/aws-matlab-template.json) |
| **us-west-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-west-2.console.aws.amazon.com/cloudformation/home?region=us-west-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024b/aws-matlab-template.json) |
| **ca-central-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ca-central-1.console.aws.amazon.com/cloudformation/home?region=ca-central-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024b/aws-matlab-template.json) |
| **eu-central-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-central-1.console.aws.amazon.com/cloudformation/home?region=eu-central-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024b/aws-matlab-template.json) |
| **eu-west-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-1.console.aws.amazon.com/cloudformation/home?region=eu-west-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024b/aws-matlab-template.json) |
| **eu-west-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-2.console.aws.amazon.com/cloudformation/home?region=eu-west-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024b/aws-matlab-template.json) |
| **eu-west-3** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-3.console.aws.amazon.com/cloudformation/home?region=eu-west-3#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024b/aws-matlab-template.json) |
| **eu-north-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-north-1.console.aws.amazon.com/cloudformation/home?region=eu-north-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024b/aws-matlab-template.json) |
| **sa-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://sa-east-1.console.aws.amazon.com/cloudformation/home?region=sa-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024b/aws-matlab-template.json) |
| **me-south-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://me-south-1.console.aws.amazon.com/cloudformation/home?region=me-south-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024b/aws-matlab-template.json) |
| **ap-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-east-1.console.aws.amazon.com/cloudformation/home?region=ap-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024b/aws-matlab-template.json) |
| **ap-south-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-south-1.console.aws.amazon.com/cloudformation/home?region=ap-south-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024b/aws-matlab-template.json) |
| **ap-northeast-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-northeast-1.console.aws.amazon.com/cloudformation/home?region=ap-northeast-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024b/aws-matlab-template.json) |
| **ap-northeast-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-northeast-2.console.aws.amazon.com/cloudformation/home?region=ap-northeast-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024b/aws-matlab-template.json) |
| **ap-southeast-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-southeast-1.console.aws.amazon.com/cloudformation/home?region=ap-southeast-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024b/aws-matlab-template.json) |
| **ap-southeast-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-southeast-2.console.aws.amazon.com/cloudformation/home?region=ap-southeast-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024b/aws-matlab-template.json) |


**Note**: Creating a stack on AWS can take a few minutes.

## Step 2. Configure the Cloud Resources
After you click the Launch Stack button above, the “Create stack” page will open in your browser where you can configure the parameters. It is easier to complete the steps if you position these instructions and the AWS console window side by side.

1. Specify a stack name. This will be shown in the AWS CloudFormation console and must be unique within the AWS account.


2. Specify and check the defaults for these resource parameters:

| Parameter label | Description |
| --------------- | ----------- |
| **AWS EC2 Instance type** | AWS instance type to use for MATLAB. See https://aws.amazon.com/ec2/instance-types for a list of instance types. |
| **Instance Name** | Name for the MATLAB virtual machine |
| **Remote access protocol** | Access protocol to connect to this instance |
| **Enable browser access for MATLAB** | Option that enables access to MATLAB on your cloud instance within a browser. Opening MATLAB in a browser opens a separate MATLAB session to your Remote Desktop Protocol (RDP) session or NICE DCV session. |
| **Keep public ip the same** | Flag indicating whether you want to keep the same public IP address for the instance |
| **Storage Size (GiB)** | Size in GB of the root volume |
| **Custom IAM Role (Optional)** | Name of a custom IAM Role to associate with this instance. If not specified, a predefined role is used. If specified, features requiring special permissions will be unavailable (NICE DCV, CloudWatch, IAM Policies). |
| **Additional IAM Policies (Optional)** | Semicolon-delimited list of IAM Policy ARNs to add to the predefined role. This option cannot be used with a custom IAM Role. |
| **VPC to deploy this stack to** | ID of an existing VPC in which to deploy this stack |
| **Subnet** | ID of an existing subnet. To access the instance from anywhere, ensure that your subnet auto-assigns public IP addresses and is connected to the internet. |
| **SSH Key Pair** | Name of an existing EC2 KeyPair to allow SSH access to all the instances. See https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html for details on creating these. |
| **Allow connections from** | Comma-separated list of IP address ranges that will be allowed to connect to this instance. Each IP CIDR should be formatted as \<ip_address>/\<mask>. The mask determines the number of IP addresses to include. A mask of 32 is a single IP address. Example of allowed values: 10.0.0.1/32 or 10.0.0.0/16,192.34.56.78/32. This calculator can be used to build a specific range: https://www.ipaddressguide.com/cidr. You may need to contact your IT administrator to determine which address is appropriate. |
| **Remote password** | Password for the "ubuntu" user. You also need to enter this as an authentication token to access MATLAB on your cloud instance within a browser. |
| **Confirm remote password** | Confirm Password |
| **License Manager for MATLAB connection string** | Optional License Manager for MATLAB, specified as a string in the form \<port>@\<hostname>. If not specified, use online licensing. If specified, the network license manager (NLM) must be accessible from the specified VPC and subnets. To use the private hostname of the NLM hub instead of the public hostname, specify the security group ID of the NLM hub in the AdditionalSecurityGroup parameter. For more information, see https://github.com/mathworks-ref-arch/license-manager-for-matlab-on-aws. |
| **Configure cloudwatch logging for the MATLAB instance** | Flag indicating whether cloudwatch logging for the MATLAB instance is enabled. |
| **AutoShutdown** | Choose whether you want to enable autoshutdown for your instance after a certain number of hours |
| **Additional security group to place instances in** | ID of an additional (optional) Security Group for the instances to be placed in. Often the License Manager for MATLAB's Security Group. |
| **Custom AMI ID (Optional)** | ID of a custom Amazon Machine Image (AMI) in the target region (optional). If the build has been customized then the resulting machine image may no longer be compatible with the provided CloudFormation template. Compatability can in some cases be restored by making corresponding modifications to the CloudFormation template. The ID should start with 'ami-'. |
| **Optional user inline command** | Provide an optional inline shell command to run on machine launch. For example, to set an environment variable CLOUD=AWS, use this command excluding the angle brackets: \<echo -e "export CLOUD=AWS" \| tee -a /etc/profile.d/setenvvar.sh && source /etc/profile>. To run an external script, use this command excluding the angle brackets: \<wget -O /tmp/my-script.sh "https://www.example.com/script.sh" && bash /tmp/my-script.sh>. Find the logs at '/var/log/mathworks/startup.log'. |


>**Note**: In the capabilities section, you must acknowledge that AWS Cloudformation might create IAM resources and autoexpand nested templates when creating the stack.

3. Click the **Create Stack** button.  The CloudFormation service will start creating the resources for the stack. <p>After clicking **Create** you will be taken to the *Stack Detail* page for your stack. Wait for the Status to reach **CREATE\_COMPLETE**. This may take up to 10 minutes.</p>

## Step 3. Connect to the Virtual Machine in the Cloud

If you chose RDP, then:
1. Expand the **Outputs** section in the the *Stack Detail* page.
1. Look for the key named `RDPConnection` and copy the corresponding public DNS name listed under value. *For example*: ec2-11-222-33-44.compute-1.amazonaws.com
1. Launch any remote desktop client, paste the public DNS name in the appropriate field, and connect. On the Windows Remote Desktop Client you need to paste the public DNS name in the **Computer** field and click **Connect**.
1. In the login screen that's displayed, use the username `ubuntu` and the password you specified while setting up the stack in [Step 2](#step-2-configure-the-stack).

If you chose NICE DCV, then:
1. Expand the **Outputs** section in the the *Stack Detail* page.
1. Look for the key named `NiceDCVConnection` and click on it
1. In the login screen that's displayed, use the username `ubuntu` and the password you specified while setting up the stack in [Step 2](#step-2-configure-the-stack).

If you chose to enable browser access for MATLAB, then:
1. Expand the **Outputs** section in the *Stack Details* page.
1. Look for the key named `BrowserConnection` and click on it
1. On the login screen, use the password you specified while deploying the stack in [Step 2](#step-2-configure-the-stack) as the 'auth token' to authenticate.
1. Browser access for MATLAB is enabled using `matlab-proxy`, a MathWorks&reg; developed Python&reg; package. For more information on `matlab-proxy`, refer to [matlab-proxy GitHub repository](https://github.com/mathworks/matlab-proxy).

## Step 4. Start MATLAB
Double-click the MATLAB icon on the virtual machine desktop to start MATLAB. The first time you start MATLAB, you need to enter your MathWorks Account credentials to license MATLAB. For other ways to license MATLAB, see [MATLAB Licensing in the Cloud](https://www.mathworks.com/help/install/license/licensing-for-mathworks-products-running-on-the-cloud.html).

>**Note**: It may take up to a minute for MATLAB to start the first time.


# Additional Information

## Delete Your Cloud Resources

Once you have finished using your stack, it is recommended that you delete all resources to avoid incurring further cost. To delete the stack, do the following:
1. Log in to the AWS Console.
1. Go to the AWS CloudFormation page and select the stack you created.
1. Click the **Actions** button and click **Delete Stack** from the menu that appears.

## Nested Stacks

This CloudFormation template uses nested stacks to reference templates used by multiple reference architectures. For details, see the [MathWorks Infrastructure as Code Building Blocks](https://github.com/mathworks-ref-arch/iac-building-blocks) repository.

## CloudWatch Logs
CloudWatch logs enables you to access logs from all the resources in your stack in a single place. To use CloudWatch logs, launch the stack with the feature "Configure cloudwatch logging for the MATLAB instance" enabled. Once the stack deployment is complete, you can access your logs in the "Outputs" of the stack by clicking the link next to "CloudWatchLogs". Note that if you delete the stack, the CloudWatch log group is also deleted. For more information, see [What is Amazon CloudWatch Logs?](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/WhatIsCloudWatchLogs.html).

----

Copyright 2018-2024 The MathWorks, Inc.

----
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2019b/README.md">
# MATLAB on Amazon Web Services

## Requirements
Before starting, you will need the following:
-   A MATLAB® license that is current on Software
    Maintenance Service (SMS). For more information, see [Configure MATLAB Licensing on the Cloud](https://www.mathworks.com/help/licensingoncloud/matlab-on-the-cloud.html.).
-   An Amazon Web Services™ (AWS) account.
-   An SSH Key Pair for your AWS account in the appropriate region. For more information, see [Amazon EC2 Key Pairs](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html).

## Costs
You are responsible for the cost of the AWS services used when you create a cluster using this guide. Resource settings, such as instance type, will affect the cost of deployment. For cost estimates, see the pricing pages for each AWS service you will be using. Prices are subject to change.

## Introduction

The following guide will help you automate the process of running the MATLAB desktop on Amazon Web Services and connect to it using the Remote Desktop Protocol (RDP). The automation is accomplished using an AWS CloudFormation template. The template is a JSON file that defines the resources needed to run MATLAB on AWS. For information about the architecture of this solution, see [Architecture and Resources](#architecture-and-resources). For information about templates, see [AWS CloudFormation Templates](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-guide.html).


## Prepare your AWS Account

1. If you don't have an AWS account, create one at https://aws.amazon.com by following the on-screen instructions.
2. Use the regions selector in the navigation bar to choose the **US East (N. Virginia)** or **EU (Ireland)** region where you want to deploy MATLAB.
3. Create a [key pair](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html) in that region.  The key pair is necessary as it is the only way to connect to the instance as an administrator.
4. If necessary, [request a service limit increase](https://console.aws.amazon.com/support/home#/case/create?issueType=service-limit-increase&limitType=service-code-) for the Amazon EC2 instance type or VPCs.  You might need to do this if you already have existing deployments that use that instance type or you think you might exceed the [default limit](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-resource-limits.html) with this deployment.

# Deployment Steps

## Step 1. Launch the Template

Click the **Launch Stack** button to deploy a standalone MATLAB desktop client on AWS. This will open the CloudFormation Create Stack screen in your web browser.


| Release | Region | Ubuntu 18.04 VM |
|-|-|-|
| MATLAB R2019b | us-east-1 (N. Virginia) | <a href="https://us-east-1.console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://s3.amazonaws.com/matlab-on-aws/aws-matlab-2019b-template.json" target="_blank">     <img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png"/> </a> |
| MATLAB R2019b | eu-west-1 (Ireland) | <a href="https://eu-west-1.console.aws.amazon.com/cloudformation/home?region=eu-west-1#/stacks/create/review?templateURL=https://s3.amazonaws.com/matlab-on-aws/aws-matlab-2019b-template.json" target="_blank">     <img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png"/> </a> |
| MATLAB R2019b | ap-northeast-1 (Tokyo) | <a href="https://ap-northeast-1.console.aws.amazon.com/cloudformation/home?region=ap-northeast-1#/stacks/create/review?templateURL=https://s3.amazonaws.com/matlab-on-aws/aws-matlab-2019b-template.json" target="_blank">     <img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png"/> </a> |



For other releases, see [How do I launch a template that uses a previous MATLAB release?](#how-do-i-launch-a-template-that-uses-a-previous-matlab-release)

**Note**: Creating a stack on AWS can take a few minutes.

## Step 2. Configure the Stack
1. Provide values for parameters in the Create Stack page:

    | Name                           | Value                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
    |--------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
    | **Stack name**                 | Stack name can include letters (A-Z and a-z), numbers (0-9), and dashes (-).  It must be unique within an AWS account. <p><em>Example</em>: Boston</p>                                                                                                                                                                                                                                                                                                                                                                                                |
    | **Instance Name**      | Give your MATLAB virtual machine a name. <p><em>Example</em>: MATLAB Desktop</p>                                                                                                                               |
    | **AWS EC2 Instance type**      | Choose the AWS instance type to use for running MATLAB. Check to ensure the instance type is available as not all types are available in all regions. For more information, see [Amazon EC2 Instance Types](https://aws.amazon.com/ec2/instance-types/) and [Pricing](https://aws.amazon.com/ec2/pricing/on-demand/). <p><em>Example</em>: m5.xlarge</p>                                                                                                                                                                                                                                                             |
     | **Storage Size**      | Specify the size in GB of the root volume.  Must be a number <p><em>Example</em>: 128</p>                                                                                                                               |
    | **IAM Role (optional)**                 | Specify an name of an IAM Role to associate with this instance. <p><em>Example</em>: S3AccessRole</p>                                                                                                                                                                                                                                                                                                                                                                |
    | **Allow RDP connections from** | This is the IP address range that will be allowed to connect to this instance using the Remote Desktop Protocol. The format for this field is IP Address/Mask. <p><em>Example</em>: </p>10.0.0.1/32 <ul><li>This is the public IP address which can be found by searching for "what is my ip address" on the web. The mask determines the number of IP addresses to include.</li><li>A mask of 32 is a single IP address.</li><li>Use a [CIDR calculator](https://www.ipaddressguide.com/cidr) if you need a range of more than one IP addresses.</li><li>You may need to contact your IT administrator to determine which address is appropriate.</li></ul></p> |
    | **SSH Key Pair**                 | The name of an existing EC2 KeyPair to allow SSH access to the instance. See https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html for details on creating these. <p><em>Example</em>: my-keypair</p>                                                          |
	| **Username**					 | Enter a username you would like to use to connect to the virtual machine in the cloud using remote desktop.																																																																																																																																						|
	| **Password**					 | Enter a password you would like to use to connect to the virtual machine in the cloud using remote desktop.																																																																																																																																							|
	| **Confirm Password**			 | Retype the password to confirm. 																																																																																																																																					|
    | **VPC** | ID of an existing VPC in which to deploy this stack |
    | **Subnet** | Select a subnet within the chosen VPC |
    | **License Manager (Optional)** | Enter the license manager hostname for in the form <port>@<hostname>. If not specified, online licensing is used. If specified, the license manager must be accessible from the specified VPC and subnets |

    >**Note**: If you chose to associate an IAM role above you'll need to acknowledge that it may create IAM resources in the Capabilities before creating the stack.

2. Click the **Create Stack** button.  The CloudFormation service will start creating the resources for the stack. <p>After clicking **Create** you will be taken to the *Stack Detail* page for your stack. Wait for the Status to reach **CREATE\_COMPLETE**. This may take up to 10 minutes.</p>

## Step 3. Connect to the Virtual Machine in the Cloud

1. Expand the **Outputs** section in the the *Stack Detail* page.
1. Look for the key named `RDPConnection` and copy the corresponding public DNS name listed under value. *For example*: ec2-11-222-33-44.compute-1.amazonaws.com
1. Launch any remote desktop client, paste the public DNS name in the appropriate field, and connect. On the Windows Remote Desktop Client you need to paste the public DNS name in the **Computer** field and click **Connect**.
1. In the login screen that's displayed, use the username and password you specified while setting up the stack in [Step 2](#step-2-configure-the-stack).

## Step 4. Launch MATLAB
Double-click the MATLAB icon on the virtual machine desktop to launch MATLAB. The first time you start MATLAB you will need to activate it. By default you will be asked to use your MathWorks Account to activate MATLAB. For other ways to activate MATLAB, see [Configure MATLAB Licensing on the Cloud](http://www.mathworks.com/support/cloud/configure-matlab-licensing-on-the-cloud.html).

>**Note**:It may take a few minutes for activation to complete and MATLAB to start. You will experience this delay only the first time you start MATLAB.


# Additional Information

## Delete Your Stack

Once you have finished using your stack, it is recommended that you delete all resources to avoid incurring further cost. To delete the stack, do the following:
1. Log in to the AWS Console.
1. Go to the AWS CloudFormation page and select the stack you created.
1. Click the **Actions** button and click **Delete Stack** from the menu that appears.

## FAQ
### How do I launch a template that uses a previous MATLAB release?

| Release | Region | Ubuntu 16.04 VM |
|---------------|-----------------|-----------------|
| MATLAB R2018b | us-east-1 | <a href="https://us-east-1.console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://s3.amazonaws.com/matlab-on-aws/aws-matlab-2018b-vpc-template.json" target="_blank">     <img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png"/> </a>
| MATLAB R2018a | us-east-1 | <a href="https://us-east-1.console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://s3.amazonaws.com/matlab-on-aws/aws-matlab-2018a-vpc-template.json" target="_blank">     <img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png"/> </a> |


### How do I save my changes in the VM?
All your files and changes are stored locally on the virtual machine.  They will persist until you either terminate the virtual machine instance or delete the stack.  Stopping the instance does not destroy the data on the instance.  If you want your changes to persist  outside the stack or before you terminate an instance you’ll need to:
* copy your files to another location (*Example*: S3 or Mount an Amazon EBS volume and create a snapshot), or
* create an image of the virtual machine.

### What happens to my data if I shutdown the instance?
You may want to shutdown the instance when you aren’t using it to save some money (you only pay for the storage used by the virtual machine when it is stopped).  To shutdown an EC2 instance, locate it in the AWS web console, select the instance and choose “Instance State/Stop” from the “Actions” menu.  You can restart it from the same menu.  Any files or changes made to the virtual machine will persist when shutting down and will be there when you restart.  A side-effect of shutting down the virtual machine and restarting is that the public IP address and DNS name may change.  Inspecting the EC2 instance in the AWS console will reveal the new IP address and DNS name.
### How do I keep the same public IP address?
To avoid having to change the IP address between restarts you can establish a static IP using AWS Elastic IP Address. For more information, see https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html.
### How do I save a VM image?
To save a VM image, locate the EC2 Instance in the AWS web console and from the "Actions" menu select the instance and choose “Image/Create Image”.
### How do I customize the VM image?
You can customize a VM image by launching the reference architecture, applying any changes you want to the EC2 Instance such as installing additional software, drivers and files and then saving an image of that instance using the AWS Console. For more information, see [How Do I save a VM image?](#how-do-i-save-a-vm-image). When creating a stack, replace the AMI ID in the CloudFormation template with the AMI ID of your custom image.
### How do I use a different license manager?
The VM image uses MathWorks Hosted License Manager by default.  For information on using other license managers, see [Configure MATLAB Licensing on the Cloud](http://www.mathworks.com/support/cloud/configure-matlab-licensing-on-the-cloud.html).
### How do I deploy this reference architecture to an existing VPC?
In the `templates` folder of this repository you will find an example template for launching the reference architecture within an existing VPC and subnet. Edit the template to deploy this reference architecure to an existing VPC.

## Architecture and Resources

![MATLAB on AWS Reference Architecture](../../img/aws-matlab-diagram.png)

Deploying this reference architecture sets up a single AWS EC2 instance containing Linux and MATLAB, a private VPC with an internet gateway, a private subnet and a security group that opens the appropriate ports for SSH and RDP access.

To make deployment easy we have prepared an Amazon Machine Image (AMI) running Ubuntu 16.04 with pre-installed drivers. The AMI contains the following software:
* MATLAB, Simulink, Toolboxes, and support for GPUs.
* Add-Ons: Neural Network Toolbox Model for AlexNet Network, Neural Network Toolbox Model for GoogLeNet Network, and Neural Network Toolbox(TM) Model for ResNet-50 Network

### Resources

The following resources will be created as part of the CloudFormation Stack.

1. Security Group for SSH and RDP access
1. EC2 Instance
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2019b/aws-matlab-2019b-template.json">
{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "MATLAB 2019b on AWS Reference Architecture with License Manager",
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "EC2 Instance"
                    },
                    "Parameters": [
                        "InstanceName",
                        "InstanceType",
                        "RootVolumeSize",
                        "IamRole"
                    ]
                },
                {
                    "Label": {
                        "default": "Remote Access"
                    },
                    "Parameters": [
                        "ClientIPAddress",
                        "SSHKeyName",
                        "Username",
                        "Password",
                        "ConfirmPassword"
                    ]
                },
                {
                    "Label": {
                        "default": "Networking"
                    },
                    "Parameters": [
                        "VPC",
                        "SubnetA"
                    ]
                },
                {
                    "Label": {
                        "default": "License Manager (Optional)"
                    },
                    "Parameters": [
                        "LicenseManager"
                    ]
                },
                {
                  "Label": {
                    "default": "Un-attended Security Updates"
                  },
                  "Parameters": [
                    "SuppressSecurityUpdates"
                  ]
                }
            ],
            "ParameterLabels": {
                "ClientIPAddress": {
                    "default": "Allow RDP connections from"
                },
                "InstanceType": {
                    "default": "AWS EC2 Instance type"
                },
                "InstanceName": {
                    "default": "Instance Name"
                },
                "RootVolumeSize": {
                    "default": "Storage Size (GiB)"
                },
                "IamRole": {
                    "default": "IAM Role (Optional)"
                },
                "SubnetA": {
                    "default": "Subnet"
                },
                "Username": {
                    "default": "Remote username"
                },
                "Password": {
                    "default": "Remote password"
                },
                "ConfirmPassword": {
                    "default": "Confirm remote password"
                },
                "LicenseManager": {
                    "default": "License manager hostname"
                },
                "SSHKeyName": {
                    "default": "SSH Key Pair"
                },
                "SuppressSecurityUpdates": {
                  "default": "Suppress critical security updates"
                }
            }
        }
    },
    "Parameters": {
        "InstanceType": {
            "Description": "The AWS instance type to use for MATLAB. See https://aws.amazon.com/ec2/instance-types for a list of instance types.",
            "Default": "m5.xlarge",
            "Type": "String"
        },
        "InstanceName": {
            "Description": "Give your MATLAB virtual machine a name",
            "Default": "MATLAB R2019b Desktop",
            "Type": "String"
        },
        "RootVolumeSize": {
            "Description": "Specify the size in GB of the root volume",
            "Default": "64",
            "Type": "Number",
            "MinValue": "64",
            "MaxValue": "1024",
            "ConstraintDescription": "Size must be between 64 and 1024GB"
        },
        "IamRole": {
            "Description": "Specify an IAM Role to associate with this instance.",
            "Default": "",
            "Type": "String"
        },
        "VPC": {
            "Description": "ID of an existing VPC in which to deploy this stack",
            "Type": "AWS::EC2::VPC::Id",
            "ConstraintDescription": "Must be the Id of an existing VPC.",
            "Default": ""
        },
        "SubnetA": {
            "Description": "List of existing subnets IDs",
            "Type": "AWS::EC2::Subnet::Id",
            "ConstraintDescription": "must be the Id of an existing Subnet within the chosen VPC.",
            "Default": ""
        },
        "SSHKeyName": {
            "Description": "The name of an existing EC2 KeyPair to allow SSH access to all the instances. See https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html for details on creating these.",
            "Type": "AWS::EC2::KeyPair::KeyName",
            "ConstraintDescription": "must be the name of an existing EC2 KeyPair.",
            "Default": ""
        },
        "ClientIPAddress": {
            "Description": "The IP address range that will be allowed to connect to this instance from outside of the VPC. This field should be formatted as <ip_address>/<mask>. E.g. 10.0.0.1/32. This is the public IP address which can be found by searching for 'what is my ip address' on the web. The mask determines the number of IP addresses to include. A mask of 32 is a single IP address. This calculator can be used to build a specific range: https://www.ipaddressguide.com/cidr. You may need to contact your IT administrator to determine which address is appropriate.",
            "Type": "String",
            "MinLength": "9",
            "MaxLength": "18",
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "Must be a valid IP CIDR range of the form x.x.x.x/x."
        },
        "Username": {
            "Description": "Specify a user name.  This will create a new user on the instance which can be used to sign in using Remote Desktop Protocol (RDP).",
            "Type": "String",
            "ConstraintDescription": "Must be a valid user name",
            "Default": ""
        },
        "Password": {
            "NoEcho": "true",
            "Description": "Enter a password for the username",
            "Type": "String",
            "ConstraintDescription": "",
            "Default": ""
        },
        "ConfirmPassword": {
            "NoEcho": "true",
            "Description": "Confirm Password",
            "Type": "String",
            "ConstraintDescription": "",
            "Default": ""
        },
        "LicenseManager": {
            "Description": "Optional License Manager for MATLAB string in the form <port>@<hostname>. If not specified, online licensing is used. If specified, the license manager must be accessible from the specified VPC and subnets",
            "Type": "String",
            "Default": "",
            "AllowedPattern": "([0-9]+@[a-zA-Z0-9.]+)?",
            "ConstraintDescription": "If specified, must be in the form <port>@<hostname>"
        },
        "SuppressSecurityUpdates": {
          "Description": "By default, the un-attended critical security upgrades are enabled, a user can explicitly suppress the security upgrades at their own risk. Specify either 'No' or 'Yes'",
          "Type": "String",
          "Default": "No",
          "AllowedPattern": "(\bYes\b|\bNo\b)",
          "ConstraintDescription": "Must be either 'No' or 'Yes'"
        }
    },
    "Mappings": {
        "RegionMap" : {
            "us-east-1"      : { "HVM64" : "ami-07a881cf8f8b0e6c3"},
            "eu-west-1"      : { "HVM64" : "ami-045172b3f9e30759c"},
            "ap-northeast-1" : { "HVM64" : "ami-0163ff1fec5d041d9"}
          }
    },
    "Rules": {
        "matchPasswords": {
            "Assertions": [
                {
                    "Assert": {
                        "Fn::Equals": [
                            {
                                "Ref": "Password"
                            },
                            {
                                "Ref": "ConfirmPassword"
                            }
                        ]
                    },
                    "AssertDescription": "Passwords do not match"
                }
            ]
        },
        "SubnetInVPC": {
            "Assertions": [
                {
                    "Assert": {
                        "Fn::EachMemberEquals": [
                            {
                            "Fn::ValueOfAll": [
                                "AWS::EC2::Subnet::Id",
                                "VpcId"
                            ]
                            },
                            {
                                "Ref": "VPC"
                            }
                        ]
                    },
                    "AssertDescription":"Subnet must exist in the VPC you have selected"
                }
            ]
        }
    },
    "Conditions": {
        "UseIamRole": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        "",
                        {
                            "Ref": "IamRole"
                        }
                    ]
                }
            ]
        }
    },
    "Resources": {
        "MATLABSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "GroupDescription": "Enable SSH and RDP Access",
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "22",
                        "ToPort": "22",
                        "CidrIp": {
                            "Ref": "ClientIPAddress"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "3389",
                        "ToPort": "3389",
                        "CidrIp": {
                            "Ref": "ClientIPAddress"
                        }
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": -1,
                        "CidrIp": "0.0.0.0/0"
                    }
                ]
            }
        },
        "MATLABInstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Condition": "UseIamRole",
            "Properties": {
                "Path": "/",
                "Roles": [
                    {
                        "Ref": "IamRole"
                    }
                ]
            }
        },
        "MATLABEC2Instance": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "ImageId" : { "Fn::FindInMap" : [ "RegionMap", { "Ref" : "AWS::Region" }, "HVM64"]},
                "KeyName": {
                    "Ref": "SSHKeyName"
                },
                "SecurityGroupIds": [
                    {
                        "Ref": "MATLABSecurityGroup"
                    }
                ],
                "SubnetId": {
                    "Ref": "SubnetA"
                },
                "IamInstanceProfile": {
                    "Fn::If": [
                        "UseIamRole",
                        {
                            "Ref": "MATLABInstanceProfile"
                        },
                        {
                            "Ref": "AWS::NoValue"
                        }
                    ]
                },
                "InstanceType": {
                    "Ref": "InstanceType"
                },
                "EbsOptimized": "true",
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/sda1",
                        "Ebs": {
                            "VolumeSize": {
                                "Ref": "RootVolumeSize"
                            }
                        }
                    }
                ],
                "Tags":[
                { "Key": "Name", "Value":  {"Ref": "InstanceName"}}
                ],
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "#!/bin/bash\n",
                                "# Copyright 2011-2017 The MathWorks, Inc.\n",
                                "cd /usr/local/matlab\n",
                                "sudo echo $PATH:/usr/local/matlab/bin | sudo tee /etc/environment > /dev/null\n",                               
                                "nohup /usr/local/matlab/bin/glnxa64/MATLABStartupAccelerator &>/dev/null &\n",
                                "sudo useradd -s /bin/bash -m -p `echo ",
                                {
                                    "Ref": "Password"
                                },
                                " | mkpasswd --method=sha-512 -s` ",
                                {
                                    "Ref": "Username"
                                },
                                "\n",
                                "if [ -n '",
                                {
                                    "Ref": "LicenseManager"
                                },
                                "' ]\n",
                                " then \n",
                                "#disable online licensing and enable a license server\n",
                                "sudo rm /usr/local/matlab/licenses/license_info.xml\n",
                                "echo 'export MLM_LICENSE_FILE=",
                                {
                                    "Ref": "LicenseManager"
                                },
                                "' | sudo tee -a /etc/profile.d/mlmlicensefile.sh\n",
                                "\n",
                                "fi\n",
                                "sudo usermod -aG sudo ",
                                {
                                    "Ref": "Username"
                                },
                                "\n",
                                "sudo apt-get install awscli -y\n",
                                "if [ 'No' == '",
                                { "Ref": "SuppressSecurityUpdates" },
                                "' ]\n",
                                " then \n",
                                "#install unattended-upgrades\n",
                                "sudo apt-get update --fix-missing\n",
                                "sudo apt-get install unattended-upgrades\n",
                                "\n",
                                "fi\n"
                            ]
                        ]
                    }
                }
            }
        }
    },
    "Outputs": {
        "RDPConnection": {
            "Description": "Public DNSName of the newly created EC2 instance",
            "Value": {
                "Fn::GetAtt": [
                    "MATLABEC2Instance",
                    "PublicDnsName"
                ]
            }
        }
    }
}
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2024a/aws-matlab-template.json">
{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Mappings": {
    "RegionMap": {
      "us-east-1": {
        "AMI": "ami-058c73f2ebdca9595"
      },
      "us-east-2": {
        "AMI": "ami-018bc3f9e471cc049"
      },
      "us-west-1": {
        "AMI": "ami-00bf0d3468b0b62ef"
      },
      "us-west-2": {
        "AMI": "ami-05865edb0dba554ff"
      },
      "ca-central-1": {
        "AMI": "ami-0c762755d060ad482"
      },
      "eu-central-1": {
        "AMI": "ami-08e3dce4d7c9a9a53"
      },
      "eu-west-1": {
        "AMI": "ami-063c20de5b06ac3cc"
      },
      "eu-west-2": {
        "AMI": "ami-08d04c47c7fbcd767"
      },
      "eu-west-3": {
        "AMI": "ami-0ba152aee9f5216f0"
      },
      "eu-north-1": {
        "AMI": "ami-0dd7934baf74da2d8"
      },
      "sa-east-1": {
        "AMI": "ami-0d22ad5c22eac9460"
      },
      "me-south-1": {
        "AMI": "ami-0d1629cb86ed6f4cd"
      },
      "ap-east-1": {
        "AMI": "ami-060dc678a157db562"
      },
      "ap-south-1": {
        "AMI": "ami-084f413c4ccefe72a"
      },
      "ap-northeast-1": {
        "AMI": "ami-03581be82811ef248"
      },
      "ap-northeast-2": {
        "AMI": "ami-0c5ab8e9f92d86733"
      },
      "ap-southeast-1": {
        "AMI": "ami-00fdf8a591847dd1c"
      },
      "ap-southeast-2": {
        "AMI": "ami-07bf260a137f52790"
      }
    }
  },
  "Resources": {
    "PredefinedRole": {
      "Type": "AWS::IAM::Role",
      "Condition": "UsePredefinedRole",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "ec2.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/",
        "ManagedPolicyArns": {
          "Fn::If": [
            "UseAdditionalPolicies",
            {
              "Fn::Split": [
                ";",
                {
                  "Ref": "AdditionalIamPolicies"
                }
              ]
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "Policies": [
          {
            "Fn::If": [
              "UseCloudWatch",
              {
                "PolicyName": "cloudwatch-access-policy",
                "PolicyDocument": {
                  "Version": "2012-10-17",
                  "Statement": [
                    {
                      "Effect": "Allow",
                      "Action": [
                        "logs:CreateLogStream",
                        "logs:DescribeLogStreams",
                        "logs:PutLogEvents"
                      ],
                      "Resource": {
                        "Fn::Sub": [
                          "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:${name}:*",
                          {
                            "name": {
                              "Fn::GetAtt": [
                                "MWLogLocation",
                                "Outputs.LogGroupName"
                              ]
                            }
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          {
            "PolicyName": "dcv-access-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "s3:GetObject",
                  "Resource": {
                    "Fn::Sub": "arn:${AWS::Partition}:s3:::dcv-license.${AWS::Region}/*"
                  }
                }
              ]
            }
          },
          {
            "PolicyName": "ssm-access-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "ssm:DescribeAssociation",
                    "ssm:GetDeployablePatchSnapshotForInstance",
                    "ssm:GetDocument",
                    "ssm:DescribeDocument",
                    "ssm:GetManifest",
                    "ssm:GetParameter",
                    "ssm:GetParameters",
                    "ssm:ListAssociations",
                    "ssm:ListInstanceAssociations",
                    "ssm:PutInventory",
                    "ssm:PutComplianceItems",
                    "ssm:PutConfigurePackageResult",
                    "ssm:UpdateAssociationStatus",
                    "ssm:UpdateInstanceAssociationStatus",
                    "ssm:UpdateInstanceInformation"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ssmmessages:CreateControlChannel",
                    "ssmmessages:CreateDataChannel",
                    "ssmmessages:OpenControlChannel",
                    "ssmmessages:OpenDataChannel"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ec2messages:AcknowledgeMessage",
                    "ec2messages:DeleteMessage",
                    "ec2messages:FailMessage",
                    "ec2messages:GetEndpoint",
                    "ec2messages:GetMessages",
                    "ec2messages:SendReply"
                  ],
                  "Resource": "*"
                }
              ]
            }
          },
          {
            "PolicyName": "describe-tags-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "ec2:DescribeTags",
                  "Resource": "*"
                }
              ]
            }
          }
        ]
      }
    },
    "MATLABInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Fn::If": [
              "UsePredefinedRole",
              {
                "Ref": "PredefinedRole"
              },
              {
                "Ref": "CustomIamRole"
              }
            ]
          }
        ]
      }
    },
    "MWSecurityGroup": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": "https://mathworks-reference-architectures-templates.s3.amazonaws.com/security-group/v1/1/0/security-group.yml",
        "Parameters": {
          "VpcId": {
            "Ref": "VPC"
          },
          "CidrIp": {
            "Ref": "ClientIPAddress"
          },
          "SSHAccess": "Yes",
          "RDPAccess": "Yes",
          "NICEDCVAccess": "Yes",
          "MATLABProxyAccess": "Yes"
        }
      }
    },
    "MWLogLocation": {
      "Type": "AWS::CloudFormation::Stack",
      "Condition": "UseCloudWatch",
      "Properties": {
        "TemplateURL": "https://mathworks-reference-architectures-templates.s3.amazonaws.com/log-location/v1/0/0/log-location.yml"
      }
    },
    "MATLABEC2Instance": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "ImageId": {
          "Fn::If": [
            "UseCustomAMI",
            {
              "Ref": "CustomAmiId"
            },
            {
              "Fn::FindInMap": [
                "RegionMap",
                {
                  "Ref": "AWS::Region"
                },
                "AMI"
              ]
            }
          ]
        },
        "KeyName": {
          "Ref": "SSHKeyName"
        },
        "SecurityGroupIds": [
          {
            "Fn::GetAtt": [
              "MWSecurityGroup",
              "Outputs.SecurityGroupId"
            ]
          },
          {
            "Fn::If": [
              "AddSG",
              {
                "Ref": "AdditionalSecurityGroup"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          }
        ],
        "SubnetId": {
          "Ref": "Subnet"
        },
        "InstanceType": {
          "Ref": "InstanceType"
        },
        "IamInstanceProfile": {
          "Ref": "MATLABInstanceProfile"
        },
        "EbsOptimized": "true",
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "VolumeSize": {
                "Ref": "RootVolumeSize"
              }
            }
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Ref": "InstanceName"
            }
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "\n",
              [
                "#!/bin/bash",
                "",
                "# Copyright 2022 The MathWorks, Inc.",
                "",
                "STARTUP_FOLDER=/opt/mathworks/startup",
                "# Load startup variables",
                "if [[ -r ${STARTUP_FOLDER}/.env ]]; then",
                "    set -o allexport",
                "    source ${STARTUP_FOLDER}/.env",
                "    set +o allexport",
                "fi",
                "",
                "# Define startup parameters",
                {
                  "Fn::Sub": [
                    "export PASSWORD=${PasswordBase64}",
                    {
                      "PasswordBase64": {
                        "Fn::Base64": {
                          "Ref": "Password"
                        }
                      }
                    }
                  ]
                },
                {
                  "Fn::Sub": "export MLM_LICENSE_FILE=${LicenseManager}"
                },
                {
                  "Fn::Sub": [
                    "export CLOUD_LOG_NAME=${LogGroupName}",
                    {
                      "LogGroupName": {
                        "Fn::If": [
                          "UseCloudWatch",
                          {
                            "Fn::GetAtt": [
                              "MWLogLocation",
                              "Outputs.LogGroupName"
                            ]
                          },
                          ""
                        ]
                      }
                    }
                  ]
                },
                {
                  "Fn::Sub": "export ACCESS_PROTOCOL='${AccessProtocol}'"
                },
                {
                  "Fn::Sub": "export ENABLE_MATLAB_PROXY='${EnableMATLABProxy}'"
                },
                {
                  "Fn::Sub": "export OPTIONAL_USER_COMMAND='${OptionalUserCommand}'"
                },
                "",
                "# Run startup scripts",
                "mkdir -p /var/log/mathworks",
                "run-parts --exit-on-error --verbose --regex '^[0-9]+_.+$' ${STARTUP_FOLDER} >> /var/log/mathworks/startup.log 2>&1",
                "",
                "# Signal the status from cfn-init",
                {
                  "Fn::Sub": "/opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --region ${AWS::Region} --resource MATLABEC2Instance"
                }
              ]
            ]
          }
        }
      },
      "CreationPolicy": {
        "ResourceSignal": {
          "Timeout": "PT15M"
        }
      }
    },
    "ElasticIP": {
      "Type": "AWS::EC2::EIP",
      "Condition": "UseElasticIPAddress",
      "Properties": {
        "InstanceId": {
          "Ref": "MATLABEC2Instance"
        },
        "Domain": "vpc"
      }
    },
    "document": {
      "Type": "AWS::SSM::Document",
      "Condition": "UsePredefinedRole",
      "Properties": {
        "DocumentType": "Command",
        "Content": {
          "schemaVersion": "2.2",
          "description": "Run a script on Linux instances.",
          "parameters": {
            "commands": {
              "type": "String",
              "description": "Command to run on EC2 instance",
              "default": "echo 'Hello World'"
            }
          },
          "mainSteps": [
            {
              "action": "aws:runShellScript",
              "name": "runCommands",
              "inputs": {
                "timeoutSeconds": "60",
                "runCommand": [
                  "{{ commands }}"
                ]
              }
            }
          ]
        }
      }
    },
    "AutoShutdownLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "ZipFile": "# Copyright 2021-2024 The MathWorks, Inc.\n\nimport boto3,os,re\nfrom datetime import datetime as dt,timedelta\n\nec2=boto3.client(\"ec2\")\nDEFAULT_TIME_INTERVAL=os.environ['DEFAULT_TIME_INTERVAL']\n# Uniquely identify instance using AWS-provided stack-level tags\nres=ec2.describe_instances(Filters=[{'Name':'tag:aws:cloudformation:stack-name','Values':[os.environ['STACK_NAME']]},{'Name':'tag:aws:cloudformation:logical-id','Values':['MATLABEC2Instance']},{'Name': 'instance-state-name','Values': ['running', 'pending']}])\nINSTANCE=res[\"Reservations\"][0][\"Instances\"][0]\nINSTANCE_ID=INSTANCE[\"InstanceId\"]\nLOG_MESSAGES={\"instance-stopped\":\"Instance is stopped.\",\"tag-never\":\"Autoshutdown is not enabled. Change the value of mw-autoshutdown tag of the EC2 instance to enable the autoshutdown feature.\",\"tag-invalid\":\"The value of the mw-autoshutdown tag you have set is not valid. The format of the timestamp must be a valid RFC 1123 UTC timestamp, such as Thu, 16 Dec 2021 12:28:47 GMT.\",\"instance-booted\":\"Instance has just started. Setting mw-autoshutdown value.\",\"stop-instance\":\"Shutdown time has been reached. Shutting instance down.\",\"early-to-shutdown\":\"Shutdown time has not been reached yet. Too early to shutdown instance.\"}\nRET_VAL={\"statusCode\": 200}\n\ndef log_to_cloudwatch(id):\n    print(LOG_MESSAGES[id])\n\ndef get_start_time():\n    launch_time=INSTANCE[\"LaunchTime\"]\n    return re.sub(r\"\\+00:00\",\"\",str(launch_time))\n\ndef get_shutdown_tag():\n    tags=INSTANCE[\"Tags\"]\n    shutdown_tag=next((tag for tag in tags if tag[\"Key\"]==\"mw-autoshutdown\"), None)\n    return shutdown_tag\n\ndef set_shutdown_tag(shutdown_time):\n    ec2.create_tags(Resources=[INSTANCE_ID], Tags=[{\"Key\": \"mw-autoshutdown\",\"Value\": str(shutdown_time)}])\n\ndef set_shutdown_time():\n    time_interval=int(re.findall(\"[0-9]+\",DEFAULT_TIME_INTERVAL)[0])\n    launch_time=dt.fromisoformat(get_start_time())\n    shutdown_time=launch_time+timedelta(hours=int(time_interval))\n    shutdown_time_gmt=dt.strftime(shutdown_time,'%a, %d %b %Y %H:%M:%S GMT')\n    set_shutdown_tag(shutdown_time_gmt)\n\ndef lambda_handler(event, context):\n    # No action while the instance is stopped.\n    if INSTANCE[\"State\"][\"Name\"]==\"stopped\":\n        log_to_cloudwatch(id=\"instance-stopped\")\n        return RET_VAL\n    shutdown_tag=get_shutdown_tag()\n    # In the first function run, use DEFAULT_TIME_INTERVAL to determine what to do.\n    if shutdown_tag is None:\n        if DEFAULT_TIME_INTERVAL==\"Never\":\n            # Set the tag to \"never\".\n            set_shutdown_tag(\"never\")\n            # No action when tag is \"never\"\n            log_to_cloudwatch(id=\"tag-never\")\n            return RET_VAL\n        else:\n            # Set the tag to start time + user chosen time interval.\n            set_shutdown_time()\n            log_to_cloudwatch(id=\"instance-booted\")\n            return RET_VAL\n    # If the tag exists, use it to determine what to do.\n    if shutdown_tag[\"Value\"]==\"change_me_on_boot\":\n        set_shutdown_time()\n        log_to_cloudwatch(id=\"instance-booted\")\n        return RET_VAL\n    elif shutdown_tag[\"Value\"]==\"never\":\n        # No action when tag is \"never\"\n        log_to_cloudwatch(id=\"tag-never\")\n        return RET_VAL\n    else:\n        # Check the tag value to determine whether instance needs to be shutdown.\n        try:\n            shutdown_time=dt.strptime(shutdown_tag[\"Value\"],'%a, %d %b %Y %H:%M:%S GMT')\n        except ValueError:\n            log_to_cloudwatch(id=\"tag-invalid\")\n            return RET_VAL\n        curr_time=dt.now(shutdown_time.tzinfo)\n        if curr_time>shutdown_time:\n            ec2.stop_instances(InstanceIds=[INSTANCE_ID])\n            # Set the shutdown time as mw-last-autoshutdown-event tag\n            curr_time_gmt=dt.strftime(curr_time, '%a, %d %b %Y %H:%M:%S GMT')\n            ec2.create_tags(Resources=[INSTANCE_ID], Tags=[{\"Key\": \"mw-last-autoshutdown-event\",\"Value\": str(curr_time_gmt)}])\n            log_to_cloudwatch(id=\"stop-instance\")\n            if DEFAULT_TIME_INTERVAL==\"Never\":\n                set_shutdown_tag(\"never\")\n            else:\n                set_shutdown_tag(\"change_me_on_boot\")\n            return RET_VAL\n        else:\n            log_to_cloudwatch(id=\"early-to-shutdown\")\n            return RET_VAL"
        },
        "Environment": {
          "Variables": {
            "DEFAULT_TIME_INTERVAL": {
              "Ref": "AutoShutdown"
            },
            "STACK_NAME": {
              "Ref": "AWS::StackName"
            }
          }
        },
        "Handler": "index.lambda_handler",
        "Runtime": "python3.12",
        "Timeout": "60",
        "Role": {
          "Fn::GetAtt": [
            "AutoShutdownLambdaRole",
            "Arn"
          ]
        }
      }
    },
    "AutoShutdownLambdaRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/",
        "Policies": [
          {
            "PolicyName": "autoshutdown-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "ec2:DescribeInstances",
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": "ec2:DescribeTags",
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": "ec2:Stopinstances",
                  "Resource": {
                    "Fn::Sub": "arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:instance/*"
                  },
                  "Condition": {
                    "StringEquals": {
                      "aws:ResourceTag/aws:cloudformation:stack-name": {
                        "Ref": "AWS::StackName"
                      },
                      "aws:ResourceTag/aws:cloudformation:logical-id": "MATLABEC2Instance"
                    }
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": "ec2:CreateTags",
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": "ec2:DeleteTags",
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": {
                    "Fn::Sub": "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*"
                  }
                }
              ]
            }
          }
        ]
      }
    },
    "AutoShutdownScheduledRule": {
      "Type": "AWS::Events::Rule",
      "Properties": {
        "Description": "AutoShutdownScheduledRule",
        "ScheduleExpression": "rate(15 minutes)",
        "State": "ENABLED",
        "Targets": [
          {
            "Arn": {
              "Fn::GetAtt": [
                "AutoShutdownLambda",
                "Arn"
              ]
            },
            "Id": "TargetFunctionV1"
          }
        ]
      }
    },
    "PermissionForEventsToInvokeLambda": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": {
          "Ref": "AutoShutdownLambda"
        },
        "Action": "lambda:InvokeFunction",
        "Principal": "events.amazonaws.com",
        "SourceArn": {
          "Fn::GetAtt": [
            "AutoShutdownScheduledRule",
            "Arn"
          ]
        }
      }
    },
    "AutoShutdownLambdaLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": {
          "Fn::Join": [
            "",
            [
              "/aws/lambda/",
              {
                "Ref": "AutoShutdownLambda"
              }
            ]
          ]
        }
      }
    }
  },
  "Parameters": {
    "InstanceType": {
      "Description": "AWS instance type to use for MATLAB. See https://aws.amazon.com/ec2/instance-types for a list of instance types.",
      "Default": "m5.xlarge",
      "Type": "String"
    },
    "InstanceName": {
      "Description": "Name for the MATLAB virtual machine",
      "Default": "MATLAB Desktop",
      "Type": "String"
    },
    "AccessProtocol": {
      "Description": "Access protocol to connect to this instance",
      "Default": "RDP",
      "Type": "String",
      "AllowedValues": [
        "NICE DCV",
        "RDP"
      ]
    },
    "EnableMATLABProxy": {
      "Description": "Option that enables access to MATLAB on your cloud instance within a browser. Opening MATLAB in a browser opens a separate MATLAB session to your Remote Desktop Protocol (RDP) session or NICE DCV session.",
      "Default": "Yes",
      "Type": "String",
      "AllowedValues": [
        "Yes",
        "No"
      ]
    },
    "UseElasticIpAddress": {
      "Description": "Flag indicating whether you want to keep the same public IP address for the instance",
      "Default": "No",
      "Type": "String",
      "AllowedValues": [
        "Yes",
        "No"
      ]
    },
    "RootVolumeSize": {
      "Description": "Size in GB of the root volume",
      "Default": "128",
      "Type": "Number",
      "MinValue": "128",
      "MaxValue": "1024",
      "ConstraintDescription": "Size must be between 128 and 1024GB"
    },
    "CustomIamRole": {
      "Description": "Name of a custom IAM Role to associate with this instance. If not specified, a predefined role is used. If specified, features requiring special permissions will be unavailable (NICE DCV, CloudWatch, IAM Policies).",
      "Default": "",
      "Type": "String"
    },
    "AdditionalIamPolicies": {
      "Description": "Semicolon-delimited list of IAM Policy ARNs to add to the predefined role. This option cannot be used with a custom IAM Role.",
      "Default": "",
      "Type": "String",
      "AllowedPattern": "^(arn:[^:;]+:iam::[^:;]+:policy/[^:;]+(;arn:[^:;]+:iam::[^:;]+:policy/[^:;]+)*)?$",
      "ConstraintDescription": "If specified, must be a semicolon (;) delimited list of ARNs (arn:<partition>:iam::<account-id>:policy/<resource-id>)."
    },
    "VPC": {
      "Description": "ID of an existing VPC in which to deploy this stack",
      "Type": "AWS::EC2::VPC::Id",
      "ConstraintDescription": "Must be the ID of an existing VPC.",
      "AllowedPattern": ".+"
    },
    "Subnet": {
      "Description": "ID of an existing subnet. To access the instance from anywhere, ensure that your subnet auto-assigns public IP addresses and is connected to the internet.",
      "Type": "AWS::EC2::Subnet::Id",
      "ConstraintDescription": "Must be the ID of an existing Subnet within the chosen VPC.",
      "AllowedPattern": ".+"
    },
    "SSHKeyName": {
      "Description": "Name of an existing EC2 KeyPair to allow SSH access to all the instances. See https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html for details on creating these.",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "ConstraintDescription": "Must be the name of an existing EC2 KeyPair.",
      "AllowedPattern": ".+"
    },
    "ClientIPAddress": {
      "Description": "IP address range that will be allowed to connect to this instance from outside of the VPC. This field should be formatted as <ip_address>/<mask>. E.g. 10.0.0.1/32. This is the public IP address which can be found by searching for 'what is my ip address' on the web. The mask determines the number of IP addresses to include. A mask of 32 is a single IP address. This calculator can be used to build a specific range: https://www.ipaddressguide.com/cidr. You may need to contact your IT administrator to determine which address is appropriate.",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription": "Must be a valid IP CIDR range of the form x.x.x.x/x."
    },
    "Password": {
      "NoEcho": "true",
      "Description": "Password for the \"ubuntu\" user. You also need to enter this as an authentication token to access MATLAB on your cloud instance within a browser.",
      "Type": "String",
      "ConstraintDescription": "Must have a minimum of 14 characters, 1 uppercase letter, 1 lowercase letter, 1 number, and 1 special character",
      "AllowedPattern": "^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[^a-zA-Z0-9]).{14,}$"
    },
    "ConfirmPassword": {
      "NoEcho": "true",
      "Description": "Confirm Password",
      "Type": "String"
    },
    "LicenseManager": {
      "Description": "Optional License Manager for MATLAB, specified as a string in the form <port>@<hostname>. If not specified, use online licensing. If specified, the network license manager (NLM) must be accessible from the specified VPC and subnets. To use the private hostname of the NLM hub instead of the public hostname, specify the security group ID of the NLM hub in the AdditionalSecurityGroup parameter. For more information, see https://github.com/mathworks-ref-arch/license-manager-for-matlab-on-aws.",
      "Type": "String",
      "Default": "",
      "AllowedPattern": "([0-9]+@[a-zA-Z0-9.\\-]+)?",
      "ConstraintDescription": "If specified, must be in the form <port>@<hostname>"
    },
    "EnableCloudWatch": {
      "Description": "Flag indicating whether cloudwatch logging for the MATLAB instance is enabled.",
      "Type": "String",
      "AllowedValues": [
        "Yes",
        "No"
      ],
      "Default": "No"
    },
    "AutoShutdown": {
      "Description": "Choose whether you want to enable autoshutdown for your instance after a certain number of hours",
      "Type": "String",
      "AllowedValues": [
        "Never",
        "After 1 hour",
        "After 2 hours",
        "After 3 hours",
        "After 4 hours",
        "After 5 hours",
        "After 6 hours",
        "After 7 hours",
        "After 8 hours",
        "After 9 hours",
        "After 10 hours",
        "After 11 hours",
        "After 12 hours",
        "After 13 hours",
        "After 14 hours",
        "After 15 hours",
        "After 16 hours",
        "After 17 hours",
        "After 18 hours",
        "After 19 hours",
        "After 20 hours",
        "After 21 hours",
        "After 22 hours",
        "After 23 hours",
        "After 24 hours"
      ],
      "Default": "Never"
    },
    "AdditionalSecurityGroup": {
      "Description": "ID of an additional (optional) Security Group for the instances to be placed in. Often the License Manager for MATLAB's Security Group.",
      "Type": "String",
      "Default": ""
    },
    "CustomAmiId": {
      "Default": "",
      "Description": "ID of a custom Amazon Machine Image (AMI) in the target region (optional). If the build has been customized then the resulting machine image may no longer be compatible with the provided CloudFormation template. Compatability can in some cases be restored by making corresponding modifications to the CloudFormation template. The ID should start with 'ami-'.",
      "Type": "String"
    },
    "OptionalUserCommand": {
      "Description": "Provide an optional inline shell command to run on machine launch. For example, to set an environment variable CLOUD=AWS, use this command excluding the angle brackets: <echo -e \"export CLOUD=AWS\" | tee -a /etc/profile.d/setenvvar.sh && source /etc/profile>. To run an external script, use this command excluding the angle brackets: <wget -O /tmp/my-script.sh \"https://www.example.com/script.sh\" && bash /tmp/my-script.sh>. Find the logs at '/var/log/mathworks/startup.log'.",
      "Type": "String",
      "Default": ""
    }
  },
  "Rules": {
    "matchPasswords": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "Password"
              },
              {
                "Ref": "ConfirmPassword"
              }
            ]
          },
          "AssertDescription": "Passwords do not match"
        }
      ]
    },
    "SubnetInVPC": {
      "Assertions": [
        {
          "Assert": {
            "Fn::EachMemberEquals": [
              {
                "Fn::ValueOfAll": [
                  "AWS::EC2::Subnet::Id",
                  "VpcId"
                ]
              },
              {
                "Ref": "VPC"
              }
            ]
          },
          "AssertDescription": "Subnet must exist in the VPC you have selected"
        }
      ]
    },
    "NoAdditionalPoliciesOnCustomRole": {
      "RuleCondition": {
        "Fn::Not": [
          {
            "Fn::Equals": [
              {
                "Ref": "CustomIamRole"
              },
              ""
            ]
          }
        ]
      },
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "AdditionalIamPolicies"
              },
              ""
            ]
          },
          "AssertDescription": "You cannot add IAM Policies when using a custom IAM Role."
        }
      ]
    },
    "MultipleRolesMustNotExist": {
      "RuleCondition": {
        "Fn::Not": [
          {
            "Fn::Equals": [
              {
                "Ref": "CustomIamRole"
              },
              ""
            ]
          }
        ]
      },
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "EnableCloudWatch"
              },
              "No"
            ]
          },
          "AssertDescription": "You cannot use CloudWatch when using a custom IAM role. The deployment will create an IAM role which you can later modify with additional policies if needed."
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "AccessProtocol"
                  },
                  "NICE DCV"
                ]
              }
            ]
          },
          "AssertDescription": "You cannot use NICE DCV when using a custom IAM role. The deployment will create an IAM role which you can later modify with additional policies if needed."
        }
      ]
    }
  },
  "Conditions": {
    "UsePredefinedRole": {
      "Fn::Equals": [
        {
          "Ref": "CustomIamRole"
        },
        ""
      ]
    },
    "UseAdditionalPolicies": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalIamPolicies"
            },
            ""
          ]
        }
      ]
    },
    "UseCloudWatch": {
      "Fn::Equals": [
        {
          "Ref": "EnableCloudWatch"
        },
        "Yes"
      ]
    },
    "UseNICEDCV": {
      "Fn::Equals": [
        {
          "Ref": "AccessProtocol"
        },
        "NICE DCV"
      ]
    },
    "UseXRDP": {
      "Fn::Equals": [
        {
          "Ref": "AccessProtocol"
        },
        "RDP"
      ]
    },
    "UseMATLABProxy": {
      "Fn::Equals": [
        {
          "Ref": "EnableMATLABProxy"
        },
        "Yes"
      ]
    },
    "UseElasticIPAddress": {
      "Fn::Equals": [
        {
          "Ref": "UseElasticIpAddress"
        },
        "Yes"
      ]
    },
    "UseCustomAMI": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "CustomAmiId"
            },
            ""
          ]
        }
      ]
    },
    "AddSG": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalSecurityGroup"
            },
            ""
          ]
        }
      ]
    }
  },
  "Outputs": {
    "CloudWatchLogs": {
      "Condition": "UseCloudWatch",
      "Description": "The cloudwatch logs containing logging information about the MATLAB instance",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://console.aws.amazon.com/cloudwatch/home?region=",
            {
              "Ref": "AWS::Region"
            },
            "#logsV2:log-groups/log-group/",
            {
              "Fn::GetAtt": [
                "MWLogLocation",
                "Outputs.LogGroupName"
              ]
            }
          ]
        ]
      }
    },
    "NiceDCVConnection": {
      "Condition": "UseNICEDCV",
      "Description": "Public url of the newly created EC2 instance to connect to the session via NICE DCV",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://",
            {
              "Fn::GetAtt": [
                "MATLABEC2Instance",
                "PublicDnsName"
              ]
            },
            ":8443/#console"
          ]
        ]
      }
    },
    "RDPConnection": {
      "Condition": "UseXRDP",
      "Description": "Public DNSName of the newly created EC2 instance",
      "Value": {
        "Fn::GetAtt": [
          "MATLABEC2Instance",
          "PublicDnsName"
        ]
      }
    },
    "BrowserConnection": {
      "Condition": "UseMATLABProxy",
      "Description": "URL to connect to and open MATLAB in a browser.",
      "Value": {
        "Fn::Sub": "https://${MATLABEC2Instance.PublicDnsName}:8123"
      }
    }
  },
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "EC2 Instance"
          },
          "Parameters": [
            "InstanceName",
            "InstanceType",
            "RootVolumeSize",
            "CustomIamRole",
            "AdditionalIamPolicies"
          ]
        },
        {
          "Label": {
            "default": "Remote Access"
          },
          "Parameters": [
            "AccessProtocol",
            "EnableMATLABProxy",
            "UseElasticIpAddress",
            "ClientIPAddress",
            "SSHKeyName",
            "Password",
            "ConfirmPassword"
          ]
        },
        {
          "Label": {
            "default": "Network Configuration"
          },
          "Parameters": [
            "VPC",
            "Subnet",
            "AdditionalSecurityGroup"
          ]
        },
        {
          "Label": {
            "default": "License Configuration"
          },
          "Parameters": [
            "LicenseManager"
          ]
        },
        {
          "Label": {
            "default": "Logging Configuration"
          },
          "Parameters": [
            "EnableCloudWatch"
          ]
        },
        {
          "Label": {
            "default": "Autoshutdown Configuration"
          },
          "Parameters": [
            "AutoShutdown"
          ]
        },
        {
          "Label": {
            "default": "Custom AMI"
          },
          "Parameters": [
            "CustomAmiId"
          ]
        },
        {
          "Label": {
            "default": "Optional User Command"
          },
          "Parameters": [
            "OptionalUserCommand"
          ]
        }
      ],
      "ParameterLabels": {
        "ClientIPAddress": {
          "default": "Allow connections from"
        },
        "UseElasticIpAddress": {
          "default": "Keep public ip the same"
        },
        "InstanceType": {
          "default": "AWS EC2 Instance type"
        },
        "InstanceName": {
          "default": "Instance Name"
        },
        "RootVolumeSize": {
          "default": "Storage Size (GiB)"
        },
        "CustomIamRole": {
          "default": "Custom IAM Role (Optional)"
        },
        "AdditionalIamPolicies": {
          "default": "Additional IAM Policies (Optional)"
        },
        "VPC": {
          "default": "VPC to deploy this stack to"
        },
        "Subnet": {
          "default": "Subnet"
        },
        "Password": {
          "default": "Remote password"
        },
        "ConfirmPassword": {
          "default": "Confirm remote password"
        },
        "SSHKeyName": {
          "default": "SSH Key Pair"
        },
        "EnableMATLABProxy": {
          "default": "Enable browser access for MATLAB"
        },
        "LicenseManager": {
          "default": "License Manager for MATLAB connection string"
        },
        "AdditionalSecurityGroup": {
          "default": "Additional security group to place instances in"
        },
        "EnableCloudWatch": {
          "default": "Configure cloudwatch logging for the MATLAB instance"
        },
        "AccessProtocol": {
          "default": "Remote access protocol"
        },
        "CustomAmiId": {
          "default": "Custom AMI ID (Optional)"
        },
        "OptionalUserCommand": {
          "default": "Optional user inline command"
        }
      }
    }
  }
}
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2024a/README.md">
# MATLAB on Amazon Web Services (Linux VM)

## Step 1. Launch the Template

Click the **Launch Stack** button to deploy a standalone MATLAB&reg; desktop client on AWS&reg;. This opens the CloudFormation Create Stack screen in your web browser.

| Region | Launch Link |
| --------------- | ----------- |
| **us-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-east-1.console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024a/aws-matlab-template.json) |
| **us-east-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-east-2.console.aws.amazon.com/cloudformation/home?region=us-east-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024a/aws-matlab-template.json) |
| **us-west-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-west-1.console.aws.amazon.com/cloudformation/home?region=us-west-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024a/aws-matlab-template.json) |
| **us-west-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-west-2.console.aws.amazon.com/cloudformation/home?region=us-west-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024a/aws-matlab-template.json) |
| **ca-central-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ca-central-1.console.aws.amazon.com/cloudformation/home?region=ca-central-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024a/aws-matlab-template.json) |
| **eu-central-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-central-1.console.aws.amazon.com/cloudformation/home?region=eu-central-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024a/aws-matlab-template.json) |
| **eu-west-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-1.console.aws.amazon.com/cloudformation/home?region=eu-west-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024a/aws-matlab-template.json) |
| **eu-west-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-2.console.aws.amazon.com/cloudformation/home?region=eu-west-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024a/aws-matlab-template.json) |
| **eu-west-3** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-3.console.aws.amazon.com/cloudformation/home?region=eu-west-3#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024a/aws-matlab-template.json) |
| **eu-north-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-north-1.console.aws.amazon.com/cloudformation/home?region=eu-north-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024a/aws-matlab-template.json) |
| **sa-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://sa-east-1.console.aws.amazon.com/cloudformation/home?region=sa-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024a/aws-matlab-template.json) |
| **me-south-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://me-south-1.console.aws.amazon.com/cloudformation/home?region=me-south-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024a/aws-matlab-template.json) |
| **ap-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-east-1.console.aws.amazon.com/cloudformation/home?region=ap-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024a/aws-matlab-template.json) |
| **ap-south-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-south-1.console.aws.amazon.com/cloudformation/home?region=ap-south-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024a/aws-matlab-template.json) |
| **ap-northeast-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-northeast-1.console.aws.amazon.com/cloudformation/home?region=ap-northeast-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024a/aws-matlab-template.json) |
| **ap-northeast-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-northeast-2.console.aws.amazon.com/cloudformation/home?region=ap-northeast-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024a/aws-matlab-template.json) |
| **ap-southeast-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-southeast-1.console.aws.amazon.com/cloudformation/home?region=ap-southeast-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024a/aws-matlab-template.json) |
| **ap-southeast-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-southeast-2.console.aws.amazon.com/cloudformation/home?region=ap-southeast-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2024a/aws-matlab-template.json) |


**Note**: Creating a stack on AWS can take a few minutes.

## Step 2. Configure the Cloud Resources
After you click the Launch Stack button above, the “Create stack” page will open in your browser where you can configure the parameters. It is easier to complete the steps if you position these instructions and the AWS console window side by side.

1. Specify a stack name. This will be shown in the AWS CloudFormation console and must be unique within the AWS account.


2. Specify and check the defaults for these resource parameters:

| Parameter label | Description |
| --------------- | ----------- |
| **AWS EC2 Instance type** | AWS instance type to use for MATLAB. See https://aws.amazon.com/ec2/instance-types for a list of instance types. |
| **Instance Name** | Name for the MATLAB virtual machine |
| **Remote access protocol** | Access protocol to connect to this instance |
| **Enable browser access for MATLAB** | Option that enables access to MATLAB on your cloud instance within a browser. Opening MATLAB in a browser opens a separate MATLAB session to your Remote Desktop Protocol (RDP) session or NICE DCV session. |
| **Keep public ip the same** | Flag indicating whether you want to keep the same public IP address for the instance |
| **Storage Size (GiB)** | Size in GB of the root volume |
| **Custom IAM Role (Optional)** | Name of a custom IAM Role to associate with this instance. If not specified, a predefined role is used. If specified, features requiring special permissions will be unavailable (NICE DCV, CloudWatch, IAM Policies). |
| **Additional IAM Policies (Optional)** | Semicolon-delimited list of IAM Policy ARNs to add to the predefined role. This option cannot be used with a custom IAM Role. |
| **VPC to deploy this stack to** | ID of an existing VPC in which to deploy this stack |
| **Subnet** | ID of an existing subnet. To access the instance from anywhere, ensure that your subnet auto-assigns public IP addresses and is connected to the internet. |
| **SSH Key Pair** | Name of an existing EC2 KeyPair to allow SSH access to all the instances. See https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html for details on creating these. |
| **Allow connections from** | IP address range that will be allowed to connect to this instance from outside of the VPC. This field should be formatted as \<ip_address>/\<mask>. E.g. 10.0.0.1/32. This is the public IP address which can be found by searching for 'what is my ip address' on the web. The mask determines the number of IP addresses to include. A mask of 32 is a single IP address. This calculator can be used to build a specific range: https://www.ipaddressguide.com/cidr. You may need to contact your IT administrator to determine which address is appropriate. |
| **Remote password** | Password for the "ubuntu" user. You also need to enter this as an authentication token to access MATLAB on your cloud instance within a browser. |
| **Confirm remote password** | Confirm Password |
| **License Manager for MATLAB connection string** | Optional License Manager for MATLAB, specified as a string in the form \<port>@\<hostname>. If not specified, use online licensing. If specified, the network license manager (NLM) must be accessible from the specified VPC and subnets. To use the private hostname of the NLM hub instead of the public hostname, specify the security group ID of the NLM hub in the AdditionalSecurityGroup parameter. For more information, see https://github.com/mathworks-ref-arch/license-manager-for-matlab-on-aws. |
| **Configure cloudwatch logging for the MATLAB instance** | Flag indicating whether cloudwatch logging for the MATLAB instance is enabled. |
| **AutoShutdown** | Choose whether you want to enable autoshutdown for your instance after a certain number of hours |
| **Additional security group to place instances in** | ID of an additional (optional) Security Group for the instances to be placed in. Often the License Manager for MATLAB's Security Group. |
| **Custom AMI ID (Optional)** | ID of a custom Amazon Machine Image (AMI) in the target region (optional). If the build has been customized then the resulting machine image may no longer be compatible with the provided CloudFormation template. Compatability can in some cases be restored by making corresponding modifications to the CloudFormation template. The ID should start with 'ami-'. |
| **Optional user inline command** | Provide an optional inline shell command to run on machine launch. For example, to set an environment variable CLOUD=AWS, use this command excluding the angle brackets: \<echo -e "export CLOUD=AWS" \| tee -a /etc/profile.d/setenvvar.sh && source /etc/profile>. To run an external script, use this command excluding the angle brackets: \<wget -O /tmp/my-script.sh "https://www.example.com/script.sh" && bash /tmp/my-script.sh>. Find the logs at '/var/log/mathworks/startup.log'. |


>**Note**: In the capabilities section, you must acknowledge that AWS Cloudformation might create IAM resources and autoexpand nested templates when creating the stack.

3. Click the **Create Stack** button.  The CloudFormation service will start creating the resources for the stack. <p>After clicking **Create** you will be taken to the *Stack Detail* page for your stack. Wait for the Status to reach **CREATE\_COMPLETE**. This may take up to 10 minutes.</p>

## Step 3. Connect to the Virtual Machine in the Cloud

If you chose RDP, then:
1. Expand the **Outputs** section in the the *Stack Detail* page.
1. Look for the key named `RDPConnection` and copy the corresponding public DNS name listed under value. *For example*: ec2-11-222-33-44.compute-1.amazonaws.com
1. Launch any remote desktop client, paste the public DNS name in the appropriate field, and connect. On the Windows Remote Desktop Client you need to paste the public DNS name in the **Computer** field and click **Connect**.
1. In the login screen that's displayed, use the username `ubuntu` and the password you specified while setting up the stack in [Step 2](#step-2-configure-the-stack).

If you chose NICE DCV, then:
1. Expand the **Outputs** section in the the *Stack Detail* page.
1. Look for the key named `NiceDCVConnection` and click on it
1. In the login screen that's displayed, use the username `ubuntu` and the password you specified while setting up the stack in [Step 2](#step-2-configure-the-stack).

If you chose to enable browser access for MATLAB, then:
1. Expand the **Outputs** section in the *Stack Details* page.
1. Look for the key named `BrowserConnection` and click on it
1. On the login screen, use the password you specified while deploying the stack in [Step 2](#step-2-configure-the-stack) as the 'auth token' to authenticate.
1. Browser access for MATLAB is enabled using `matlab-proxy`, a MathWorks&reg; developed Python&reg; package. For more information on `matlab-proxy`, refer to [matlab-proxy GitHub repository](https://github.com/mathworks/matlab-proxy).

## Step 4. Start MATLAB
Double-click the MATLAB icon on the virtual machine desktop to start MATLAB. The first time you start MATLAB, you need to enter your MathWorks Account credentials to license MATLAB. For other ways to license MATLAB, see [MATLAB Licensing in the Cloud](https://www.mathworks.com/help/install/license/licensing-for-mathworks-products-running-on-the-cloud.html).

>**Note**: It may take up to a minute for MATLAB to start the first time.


# Additional Information

## Delete Your Cloud Resources

Once you have finished using your stack, it is recommended that you delete all resources to avoid incurring further cost. To delete the stack, do the following:
1. Log in to the AWS Console.
1. Go to the AWS CloudFormation page and select the stack you created.
1. Click the **Actions** button and click **Delete Stack** from the menu that appears.

## Nested Stacks

This CloudFormation template uses nested stacks to reference templates used by multiple reference architectures. For details, see the [MathWorks Infrastructure as Code Building Blocks](https://github.com/mathworks-ref-arch/iac-building-blocks) repository.

## CloudWatch Logs
CloudWatch logs enables you to access logs from all the resources in your stack in a single place. To use CloudWatch logs, launch the stack with the feature "Configure cloudwatch logging for the MATLAB instance" enabled. Once the stack deployment is complete, you can access your logs in the "Outputs" of the stack by clicking the link next to "CloudWatchLogs". Note that if you delete the stack, the CloudWatch log group is also deleted. For more information, see [What is Amazon CloudWatch Logs?](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/WhatIsCloudWatchLogs.html).

----

Copyright 2018-2024 The MathWorks, Inc.

----
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2021a/aws-matlab-template.json">
{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Mappings": {
    "RegionMap": {
      "us-east-1": {
        "AMI": "ami-0e97b071d8921d12c"
      },
      "us-east-2": {
        "AMI": "ami-069338b6da3b370b8"
      },
      "us-west-1": {
        "AMI": "ami-0190d677fbc2a6d2d"
      },
      "us-west-2": {
        "AMI": "ami-09dab4904f2f0b9e8"
      },
      "ca-central-1": {
        "AMI": "ami-06e5200728b476a8a"
      },
      "eu-central-1": {
        "AMI": "ami-0b9b3fdc9edd15397"
      },
      "eu-west-1": {
        "AMI": "ami-0b6aeadf6baa9371a"
      },
      "eu-west-2": {
        "AMI": "ami-0691fb80275aff897"
      },
      "eu-west-3": {
        "AMI": "ami-08282e4527988d19a"
      },
      "eu-north-1": {
        "AMI": "ami-0febf6d78e3a127b3"
      },
      "sa-east-1": {
        "AMI": "ami-0c666a801bced478a"
      },
      "me-south-1": {
        "AMI": "ami-0af55394b42cee0a1"
      },
      "ap-east-1": {
        "AMI": "ami-0a2dcd17165b1a989"
      },
      "ap-south-1": {
        "AMI": "ami-09eb815f944068548"
      },
      "ap-northeast-1": {
        "AMI": "ami-0bc2b6f059fadab42"
      },
      "ap-northeast-2": {
        "AMI": "ami-096eb6897446ea039"
      },
      "ap-southeast-1": {
        "AMI": "ami-0f34126d42daa3f17"
      },
      "ap-southeast-2": {
        "AMI": "ami-031a853fb654b8c8b"
      }
    }
  },
  "Resources": {
    "MATLABSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": {
          "Ref": "VPC"
        },
        "GroupDescription": "Enable SSH and RDP Access",
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "22",
            "ToPort": "22",
            "CidrIp": {
              "Ref": "ClientIPAddress"
            }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "3389",
            "ToPort": "3389",
            "CidrIp": {
              "Ref": "ClientIPAddress"
            }
          }
        ]
      }
    },
    "MATLABInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Condition": "UseIamRole",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "IamRole"
          }
        ]
      }
    },
    "MATLABEC2Instance": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "ImageId": {
          "Fn::FindInMap": [
            "RegionMap",
            {
              "Ref": "AWS::Region"
            },
            "AMI"
          ]
        },
        "KeyName": {
          "Ref": "SSHKeyName"
        },
        "SecurityGroupIds": [
          {
            "Ref": "MATLABSecurityGroup"
          },
          {
            "Fn::If": [
              "AddSG",
              {
                "Ref": "AdditionalSecurityGroup"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          }
        ],
        "SubnetId": {
          "Ref": "Subnet"
        },
        "IamInstanceProfile": {
          "Fn::If": [
            "UseIamRole",
            {
              "Ref": "MATLABInstanceProfile"
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "InstanceType": {
          "Ref": "InstanceType"
        },
        "EbsOptimized": "true",
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "VolumeSize": {
                "Ref": "RootVolumeSize"
              }
            }
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Ref": "InstanceName"
            }
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash\n",
                "# Copyright 2011-2020 The MathWorks, Inc.\n",
                "cd /usr/local/matlab\n",
                "sudo echo $PATH:/usr/local/matlab/bin | sudo tee /etc/environment > /dev/null\n",
                "nohup /usr/local/matlab/bin/glnxa64/MATLABStartupAccelerator &>/dev/null &\n",
                "echo \"",
                {
                  "Fn::Join": [
                    ":",
                    [
                      "ubuntu",
                      {
                        "Fn::Join": [
                          "",
                          [
                            "$(echo \"",
                            {
                              "Fn::Base64": {
                                "Ref": "Password"
                              }
                            },
                            "\" | base64 -d)"
                          ]
                        ]
                      }
                    ]
                  ]
                },
                "\" | sudo chpasswd",
                "\n",
                "if [ -n '",
                {
                  "Ref": "LicenseManager"
                },
                "' ]\n",
                " then \n",
                "#disable online licensing and enable a license server\n",
                "sudo rm /usr/local/matlab/licenses/license_info.xml\n",
                "echo 'export MLM_LICENSE_FILE=",
                {
                  "Ref": "LicenseManager"
                },
                "' | sudo tee -a /etc/profile.d/mlmlicensefile.sh\n",
                "\n",
                "fi\n",
                "sudo apt-get install awscli -y\n"
              ]
            ]
          }
        }
      }
    }
  },
  "Parameters": {
    "InstanceType": {
      "Description": "The AWS instance type to use for MATLAB. See https://aws.amazon.com/ec2/instance-types for a list of instance types.",
      "Default": "m5.xlarge",
      "Type": "String"
    },
    "InstanceName": {
      "Description": "Give your MATLAB virtual machine a name",
      "Default": "MATLAB Desktop",
      "Type": "String"
    },
    "RootVolumeSize": {
      "Description": "Specify the size in GB of the root volume",
      "Default": "128",
      "Type": "Number",
      "MinValue": "128",
      "MaxValue": "1024",
      "ConstraintDescription": "Size must be between 64 and 1024GB"
    },
    "IamRole": {
      "Description": "Specify an IAM Role to associate with this instance.",
      "Default": "",
      "Type": "String"
    },
    "VPC": {
      "Description": "ID of an existing VPC in which to deploy this stack",
      "Type": "AWS::EC2::VPC::Id",
      "ConstraintDescription": "Must be the ID of an existing VPC.",
      "AllowedPattern": ".+"
    },
    "Subnet": {
      "Description": "List of existing subnets IDs",
      "Type": "AWS::EC2::Subnet::Id",
      "ConstraintDescription": "Must be the ID of an existing Subnet within the chosen VPC.",
      "AllowedPattern": ".+"
    },
    "SSHKeyName": {
      "Description": "The name of an existing EC2 KeyPair to allow SSH access to all the instances. See https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html for details on creating these.",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "ConstraintDescription": "Must be the name of an existing EC2 KeyPair.",
      "AllowedPattern": ".+"
    },
    "ClientIPAddress": {
      "Description": "The IP address range that will be allowed to connect to this instance from outside of the VPC. This field should be formatted as <ip_address>/<mask>. E.g. 10.0.0.1/32. This is the public IP address which can be found by searching for 'what is my ip address' on the web. The mask determines the number of IP addresses to include. A mask of 32 is a single IP address. This calculator can be used to build a specific range: https://www.ipaddressguide.com/cidr. You may need to contact your IT administrator to determine which address is appropriate.",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription": "Must be a valid IP CIDR range of the form x.x.x.x/x."
    },
    "Password": {
      "NoEcho": "true",
      "Description": "Enter a password for the \"ubuntu\" user",
      "Type": "String",
      "ConstraintDescription": "",
      "Default": ""
    },
    "ConfirmPassword": {
      "NoEcho": "true",
      "Description": "Confirm Password",
      "Type": "String",
      "ConstraintDescription": "",
      "Default": ""
    },
    "LicenseManager": {
      "Description": "Optional License Manager for MATLAB string in the form <port>@<hostname>. If not specified, online licensing is used. If specified, the license manager must be accessible from the specified VPC and subnets",
      "Type": "String",
      "Default": "",
      "AllowedPattern": "([0-9]+@[a-zA-Z0-9.\\-]+)?",
      "ConstraintDescription": "If specified, must be in the form <port>@<hostname>"
    },
    "AdditionalSecurityGroup": {
      "Description": "The ID of an additional (optional) Security Group for the instances to be placed in. Often the License Manager for MATLAB's Security Group.",
      "Type": "String",
      "Default": ""
    }
  },
  "Rules": {
    "matchPasswords": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "Password"
              },
              {
                "Ref": "ConfirmPassword"
              }
            ]
          },
          "AssertDescription": "Passwords do not match"
        }
      ]
    },
    "SubnetInVPC": {
      "Assertions": [
        {
          "Assert": {
            "Fn::EachMemberEquals": [
              {
                "Fn::ValueOfAll": [
                  "AWS::EC2::Subnet::Id",
                  "VpcId"
                ]
              },
              {
                "Ref": "VPC"
              }
            ]
          },
          "AssertDescription": "Subnet must exist in the VPC you have selected"
        }
      ]
    }
  },
  "Conditions": {
    "UseIamRole": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            "",
            {
              "Ref": "IamRole"
            }
          ]
        }
      ]
    },
    "AddSG": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalSecurityGroup"
            },
            ""
          ]
        }
      ]
    }
  },
  "Outputs": {
    "RDPConnection": {
      "Description": "Public DNSName of the newly created EC2 instance",
      "Value": {
        "Fn::GetAtt": [
          "MATLABEC2Instance",
          "PublicDnsName"
        ]
      }
    }
  },
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "EC2 Instance"
          },
          "Parameters": [
            "InstanceName",
            "InstanceType",
            "RootVolumeSize",
            "IamRole"
          ]
        },
        {
          "Label": {
            "default": "Remote Access"
          },
          "Parameters": [
            "ClientIPAddress",
            "SSHKeyName",
            "Password",
            "ConfirmPassword"
          ]
        },
        {
          "Label": {
            "default": "Network Configuration"
          },
          "Parameters": [
            "VPC",
            "Subnet",
            "AdditionalSecurityGroup"
          ]
        },
        {
          "Label": {
            "default": "License Configuration"
          },
          "Parameters": [
            "LicenseManager"
          ]
        }
      ],
      "ParameterLabels": {
        "ClientIPAddress": {
          "default": "Allow RDP connections from"
        },
        "InstanceType": {
          "default": "AWS EC2 Instance type"
        },
        "InstanceName": {
          "default": "Instance Name"
        },
        "RootVolumeSize": {
          "default": "Storage Size (GiB)"
        },
        "IamRole": {
          "default": "IAM Role (Optional)"
        },
        "VPC": {
          "default": "VPC to deploy this stack to"
        },
        "Subnet": {
          "default": "Subnet"
        },
        "Password": {
          "default": "Remote password"
        },
        "ConfirmPassword": {
          "default": "Confirm remote password"
        },
        "SSHKeyName": {
          "default": "SSH Key Pair"
        },
        "LicenseManager": {
          "default": "License Manager for MATLAB connection string"
        },
        "AdditionalSecurityGroup": {
          "default": "Additional security group to place instances in"
        }
      }
    }
  }
}
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2021a/README.md">
# MATLAB on Amazon Web Services (Linux VM)

## Step 1. Launch the Template

Click the **Launch Stack** button to deploy a standalone MATLAB desktop client on AWS. This will open the CloudFormation Create Stack screen in your web browser.

| Region | Launch Link |
| --------------- | ----------- |
| **us-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-east-1.console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021a/aws-matlab-template.json) |
| **us-east-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-east-2.console.aws.amazon.com/cloudformation/home?region=us-east-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021a/aws-matlab-template.json) |
| **us-west-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-west-1.console.aws.amazon.com/cloudformation/home?region=us-west-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021a/aws-matlab-template.json) |
| **us-west-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-west-2.console.aws.amazon.com/cloudformation/home?region=us-west-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021a/aws-matlab-template.json) |
| **ca-central-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ca-central-1.console.aws.amazon.com/cloudformation/home?region=ca-central-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021a/aws-matlab-template.json) |
| **eu-central-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-central-1.console.aws.amazon.com/cloudformation/home?region=eu-central-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021a/aws-matlab-template.json) |
| **eu-west-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-1.console.aws.amazon.com/cloudformation/home?region=eu-west-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021a/aws-matlab-template.json) |
| **eu-west-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-2.console.aws.amazon.com/cloudformation/home?region=eu-west-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021a/aws-matlab-template.json) |
| **eu-west-3** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-3.console.aws.amazon.com/cloudformation/home?region=eu-west-3#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021a/aws-matlab-template.json) |
| **eu-north-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-north-1.console.aws.amazon.com/cloudformation/home?region=eu-north-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021a/aws-matlab-template.json) |
| **sa-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://sa-east-1.console.aws.amazon.com/cloudformation/home?region=sa-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021a/aws-matlab-template.json) |
| **me-south-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://me-south-1.console.aws.amazon.com/cloudformation/home?region=me-south-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021a/aws-matlab-template.json) |
| **ap-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-east-1.console.aws.amazon.com/cloudformation/home?region=ap-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021a/aws-matlab-template.json) |
| **ap-south-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-south-1.console.aws.amazon.com/cloudformation/home?region=ap-south-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021a/aws-matlab-template.json) |
| **ap-northeast-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-northeast-1.console.aws.amazon.com/cloudformation/home?region=ap-northeast-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021a/aws-matlab-template.json) |
| **ap-northeast-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-northeast-2.console.aws.amazon.com/cloudformation/home?region=ap-northeast-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021a/aws-matlab-template.json) |
| **ap-southeast-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-southeast-1.console.aws.amazon.com/cloudformation/home?region=ap-southeast-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021a/aws-matlab-template.json) |
| **ap-southeast-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-southeast-2.console.aws.amazon.com/cloudformation/home?region=ap-southeast-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021a/aws-matlab-template.json) |


**Note**: Creating a stack on AWS can take a few minutes.

## Step 2. Configure the Cloud Resources
After you click the Launch Stack button above, the “Create stack” page will open in your browser where you can configure the parameters. It is easier to complete the steps if you position these instructions and the AWS console window side by side.

1. Specify a stack name. This will be shown in the AWS CloudFormation console and must be unique within the AWS account.


2. Specify and check the defaults for these resource parameters:

| Parameter label | Description |
| --------------- | ----------- |
| **AWS EC2 Instance type** | The AWS instance type to use for MATLAB. See https://aws.amazon.com/ec2/instance-types for a list of instance types. |
| **Instance Name** | Give your MATLAB virtual machine a name |
| **Storage Size (GiB)** | Specify the size in GB of the root volume |
| **IAM Role (Optional)** | Specify an IAM Role to associate with this instance. |
| **VPC to deploy this stack to** | ID of an existing VPC in which to deploy this stack |
| **Subnet** | List of existing subnets IDs |
| **SSH Key Pair** | The name of an existing EC2 KeyPair to allow SSH access to all the instances. See https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html for details on creating these. |
| **Allow RDP connections from** | The IP address range that will be allowed to connect to this instance from outside of the VPC. This field should be formatted as \<ip_address>/\<mask>. E.g. 10.0.0.1/32. This is the public IP address which can be found by searching for 'what is my ip address' on the web. The mask determines the number of IP addresses to include. A mask of 32 is a single IP address. This calculator can be used to build a specific range: https://www.ipaddressguide.com/cidr. You may need to contact your IT administrator to determine which address is appropriate. |
| **Remote password** | Enter a password for the "ubuntu" user |
| **Confirm remote password** | Confirm Password |
| **License Manager for MATLAB connection string** | Optional License Manager for MATLAB string in the form \<port>@\<hostname>. If not specified, online licensing is used. If specified, the license manager must be accessible from the specified VPC and subnets |
| **Additional security group to place instances in** | The ID of an additional (optional) Security Group for the instances to be placed in. Often the License Manager for MATLAB's Security Group. |


>**Note**: If you chose to associate an IAM role above you'll need to acknowledge that it may create IAM resources in the Capabilities before creating the stack.

3. Click the **Create Stack** button.  The CloudFormation service will start creating the resources for the stack. <p>After clicking **Create** you will be taken to the *Stack Detail* page for your stack. Wait for the Status to reach **CREATE\_COMPLETE**. This may take up to 10 minutes.</p>

## Step 3. Connect to the Virtual Machine in the Cloud

1. Expand the **Outputs** section in the the *Stack Detail* page.
1. Look for the key named `RDPConnection` and copy the corresponding public DNS name listed under value. *For example*: ec2-11-222-33-44.compute-1.amazonaws.com
1. Launch any remote desktop client, paste the public DNS name in the appropriate field, and connect. On the Windows Remote Desktop Client you need to paste the public DNS name in the **Computer** field and click **Connect**.
1. In the login screen that's displayed, use the username `ubuntu` and the password you specified while setting up the stack in [Step 2](#step-2-configure-the-stack).

## Step 4. Launch MATLAB
Double-click the MATLAB icon on the virtual machine desktop to launch MATLAB. The first time you start MATLAB you will need to activate it. By default, you will be asked to use your MathWorks Account to activate MATLAB. For other ways to activate MATLAB, see [MATLAB Licensing in the Cloud](https://www.mathworks.com/help/licensingoncloud/matlab-on-the-cloud.html).

>**Note**: It may take a few minutes for activation to complete and MATLAB to start. You will experience this delay only the first time you start MATLAB.


# Additional Information

## Delete Your Cloud Resources

Once you have finished using your stack, it is recommended that you delete all resources to avoid incurring further cost. To delete the stack, do the following:
1. Log in to the AWS Console.
1. Go to the AWS CloudFormation page and select the stack you created.
1. Click the **Actions** button and click **Delete Stack** from the menu that appears.

### Resources

The following resources will be created as part of the CloudFormation Stack.

1. Security Group for SSH and RDP access
1. EC2 Instance
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2022a/aws-matlab-template.json">
{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Mappings": {
    "RegionMap": {
      "us-east-1": {
        "AMI": "ami-0d420428640d5ced9"
      },
      "us-east-2": {
        "AMI": "ami-0d03552e11e61420a"
      },
      "us-west-1": {
        "AMI": "ami-0dcbb6f73f7aee9b8"
      },
      "us-west-2": {
        "AMI": "ami-0ec1f40daa882914d"
      },
      "ca-central-1": {
        "AMI": "ami-0480ea8b3e812b52a"
      },
      "eu-central-1": {
        "AMI": "ami-01a7516620e709ee8"
      },
      "eu-west-1": {
        "AMI": "ami-03bf63dad51328578"
      },
      "eu-west-2": {
        "AMI": "ami-0c3eac82471d43d02"
      },
      "eu-west-3": {
        "AMI": "ami-09fe03a72fc3aa17f"
      },
      "eu-north-1": {
        "AMI": "ami-0bea59b652c023e82"
      },
      "sa-east-1": {
        "AMI": "ami-018fcaf3e3a45283c"
      },
      "me-south-1": {
        "AMI": "ami-0fb0538796f0f5b40"
      },
      "ap-east-1": {
        "AMI": "ami-013169906e04e914f"
      },
      "ap-south-1": {
        "AMI": "ami-0e1d0dc5324dcc76c"
      },
      "ap-northeast-1": {
        "AMI": "ami-001d0571205a8cd70"
      },
      "ap-northeast-2": {
        "AMI": "ami-016bdf90c1e0c1b70"
      },
      "ap-southeast-1": {
        "AMI": "ami-0997a32211c19ef35"
      },
      "ap-southeast-2": {
        "AMI": "ami-05afbc9b42045063a"
      }
    }
  },
  "Resources": {
    "PredefinedRole": {
      "Type": "AWS::IAM::Role",
      "Condition": "UsePredefinedRole",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "ec2.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/",
        "ManagedPolicyArns": {
          "Fn::If": [
            "UseAdditionalPolicies",
            {
              "Fn::Split": [
                ";",
                {
                  "Ref": "AdditionalIamPolicies"
                }
              ]
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "cloudwatch-access-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogStream",
                    "logs:DescribeLogStreams",
                    "logs:PutLogEvents"
                  ],
                  "Resource": {
                    "Fn::Join": [
                      ":",
                      [
                        "arn:aws:logs",
                        {
                          "Ref": "AWS::Region"
                        },
                        {
                          "Ref": "AWS::AccountId"
                        },
                        "log-group",
                        {
                          "Fn::Join": [
                            "-",
                            [
                              {
                                "Ref": "AWS::StackName"
                              },
                              {
                                "Fn::Select": [
                                  "2",
                                  {
                                    "Fn::Split": [
                                      "/",
                                      {
                                        "Ref": "AWS::StackId"
                                      }
                                    ]
                                  }
                                ]
                              }
                            ]
                          ]
                        },
                        "*"
                      ]
                    ]
                  }
                }
              ]
            }
          },
          {
            "PolicyName": "dcv-access-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "s3:GetObject"
                  ],
                  "Resource": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:aws:s3:::dcv-license.",
                        {
                          "Ref": "AWS::Region"
                        },
                        "/*"
                      ]
                    ]
                  }
                }
              ]
            }
          },
          {
            "PolicyName": "ssm-access-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "ssm:DescribeAssociation",
                    "ssm:GetDeployablePatchSnapshotForInstance",
                    "ssm:GetDocument",
                    "ssm:DescribeDocument",
                    "ssm:GetManifest",
                    "ssm:GetParameter",
                    "ssm:GetParameters",
                    "ssm:ListAssociations",
                    "ssm:ListInstanceAssociations",
                    "ssm:PutInventory",
                    "ssm:PutComplianceItems",
                    "ssm:PutConfigurePackageResult",
                    "ssm:UpdateAssociationStatus",
                    "ssm:UpdateInstanceAssociationStatus",
                    "ssm:UpdateInstanceInformation"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ssmmessages:CreateControlChannel",
                    "ssmmessages:CreateDataChannel",
                    "ssmmessages:OpenControlChannel",
                    "ssmmessages:OpenDataChannel"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ec2messages:AcknowledgeMessage",
                    "ec2messages:DeleteMessage",
                    "ec2messages:FailMessage",
                    "ec2messages:GetEndpoint",
                    "ec2messages:GetMessages",
                    "ec2messages:SendReply"
                  ],
                  "Resource": "*"
                }
              ]
            }
          },
          {
            "PolicyName": "describe-tags-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "ec2:DescribeTags",
                  "Resource": "*"
                }
              ]
            }
          }
        ]
      }
    },
    "MATLABInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Fn::If": [
              "UsePredefinedRole",
              {
                "Ref": "PredefinedRole"
              },
              {
                "Ref": "CustomIamRole"
              }
            ]
          }
        ]
      }
    },
    "MATLABSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": {
          "Ref": "VPC"
        },
        "GroupDescription": "Enable SSH and RDP Access",
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "22",
            "ToPort": "22",
            "CidrIp": {
              "Ref": "ClientIPAddress"
            }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "3389",
            "ToPort": "3389",
            "CidrIp": {
              "Ref": "ClientIPAddress"
            }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "8443",
            "ToPort": "8443",
            "CidrIp": {
              "Ref": "ClientIPAddress"
            }
          }
        ]
      }
    },
    "MATLABEC2Instance": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "ImageId": {
          "Fn::FindInMap": [
            "RegionMap",
            {
              "Ref": "AWS::Region"
            },
            "AMI"
          ]
        },
        "KeyName": {
          "Ref": "SSHKeyName"
        },
        "SecurityGroupIds": [
          {
            "Ref": "MATLABSecurityGroup"
          },
          {
            "Fn::If": [
              "AddSG",
              {
                "Ref": "AdditionalSecurityGroup"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          }
        ],
        "SubnetId": {
          "Ref": "Subnet"
        },
        "IamInstanceProfile": {
          "Ref": "MATLABInstanceProfile"
        },
        "InstanceType": {
          "Ref": "InstanceType"
        },
        "EbsOptimized": "true",
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "VolumeSize": {
                "Ref": "RootVolumeSize"
              }
            }
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Ref": "InstanceName"
            }
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash\n",
                "# Copyright 2011-2022 The MathWorks, Inc.\n",
                "cd /usr/local/matlab\n",
                "nohup /usr/bin/parallel -j64 -m --nice 10 --arg-file /usr/local/etc/msa/msa.ini /bin/cat {} > /dev/null 2>&1 &\n",
                "echo \"",
                {
                  "Fn::Join": [
                    ":",
                    [
                      "ubuntu",
                      {
                        "Fn::Join": [
                          "",
                          [
                            "$(echo \"",
                            {
                              "Fn::Base64": {
                                "Ref": "Password"
                              }
                            },
                            "\" | base64 -d)"
                          ]
                        ]
                      }
                    ]
                  ]
                },
                "\" | sudo chpasswd",
                "\n",
                "if [ -n '",
                {
                  "Ref": "LicenseManager"
                },
                "' ]\n",
                " then \n",
                "#disable online licensing and enable a license server\n",
                "sudo rm /usr/local/matlab/licenses/license_info.xml\n",
                "echo 'export MLM_LICENSE_FILE=",
                {
                  "Ref": "LicenseManager"
                },
                "' | sudo tee -a /etc/profile.d/mlmlicensefile.sh\n",
                "\n",
                "fi\n",
                {
                  "Fn::Sub": "export ENABLE_CLOUDWATCH_LOGGING=\"${EnableCloudWatch}\""
                },
                "\n",
                {
                  "Fn::Join": [
                    "=",
                    [
                      "export LOG_GROUP_NAME",
                      {
                        "Fn::Join": [
                          "-",
                          [
                            {
                              "Ref": "AWS::StackName"
                            },
                            {
                              "Fn::Select": [
                                "2",
                                {
                                  "Fn::Split": [
                                    "/",
                                    {
                                      "Ref": "AWS::StackId"
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        ]
                      }
                    ]
                  ]
                },
                "\n",
                "/usr/local/bin/start-logging.sh\n",
                {
                  "Fn::Sub": "export ACCESS_PROTOCOL=\"${AccessProtocol}\"\n"
                },
                "/usr/local/bin/start-desktop.sh\n",
                "/usr/local/bin/aws-cfn-bootstrap-*/bin/cfn-signal -e $? ",
                "         --stack ",
                {
                  "Ref": "AWS::StackName"
                },
                "         --resource MATLABEC2Instance ",
                "         --region ",
                {
                  "Ref": "AWS::Region"
                },
                "\n"
              ]
            ]
          }
        }
      },
      "CreationPolicy": {
        "ResourceSignal": {
          "Timeout": "PT15M"
        }
      }
    },
    "MATLABLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Condition": "UseCloudWatch",
      "Properties": {
        "LogGroupName": {
          "Fn::Join": [
            "-",
            [
              {
                "Ref": "AWS::StackName"
              },
              {
                "Fn::Select": [
                  "2",
                  {
                    "Fn::Split": [
                      "/",
                      {
                        "Ref": "AWS::StackId"
                      }
                    ]
                  }
                ]
              }
            ]
          ]
        }
      }
    },
    "ElasticIP": {
      "Type": "AWS::EC2::EIP",
      "Condition": "UseElasticIPAddress",
      "Properties": {
        "InstanceId": {
          "Ref": "MATLABEC2Instance"
        },
        "Domain": "vpc"
      }
    },
    "document": {
      "Type": "AWS::SSM::Document",
      "Condition": "UsePredefinedRole",
      "Properties": {
        "Content": {
          "schemaVersion": "2.2",
          "description": "Run a script on Linux instances.",
          "parameters": {
            "commands": {
              "type": "String",
              "description": "Run script to switch between xrdp and nice dcv.",
              "default": "/usr/local/bin/swap-desktop-solution.sh"
            }
          },
          "mainSteps": [
            {
              "action": "aws:runShellScript",
              "name": "runCommands",
              "inputs": {
                "timeoutSeconds": "60",
                "runCommand": [
                  "{{ commands }}"
                ]
              }
            }
          ]
        },
        "DocumentType": "Command",
        "Name": {
          "Fn::Select": [
            "2",
            {
              "Fn::Split": [
                "/",
                {
                  "Ref": "AWS::StackId"
                }
              ]
            }
          ]
        }
      }
    },
    "AutoShutdownLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "ZipFile": {
            "Fn::Sub": [
              "import json\nfrom logging import shutdown\nimport boto3\nfrom datetime import datetime, timedelta\nimport re\n\nec2 = boto3.client(\"ec2\")\nDEFAULT_TIME_INTERVAL=\"${DEFAULT_TIME_INTERVAL}\"\n\n# Uniquely identify instance using AWS-provided stack-level tags\nresponse = ec2.describe_instances(\n                Filters=[\n                    {\n                        'Name':'tag:aws:cloudformation:stack-name',\n                        'Values':['${STACK_NAME}']\n                    },\n                    {\n                        'Name':'tag:aws:cloudformation:logical-id',\n                        'Values':['MATLABEC2Instance']\n                    }\n                ]\n        )\n\nINSTANCE_ID=response[\"Reservations\"][0][\"Instances\"][0][\"InstanceId\"]\n\nLOG_MESSAGES={\n    \"instance-is-stopped\": \"Instance is stopped.\",\n    \"tag-is-never\": \"Autoshutdown is not enabled. Change the value of mw-autoshutdown tag of the EC2 instance to enable the autoshutdown feature.\",\n    \"tag-is-invalid\": \"The value of the mw-autoshutdown tag you have set is not valid. The format of the timestamp must be a valid RFC 1123 UTC timestamp, such as Thu, 16 Dec 2021 12:28:47 GMT.\",\n    \"instance-just-booted\": \"Instance has just started. Setting mw-autoshutdown value.\",\n    \"ready-to-shutdown\": \"Shutdown time has been reached. Shutting instance down.\",\n    \"too-early-to-shutdown\": \"Shutdown time has not been reached yet. Too early to shutdown instance.\"\n   }\n\ndef log_to_cloudwatch(message_id):\n    print(LOG_MESSAGES[message_id])\n\ndef get_start_time():\n    # Get boot time. This is always UTC\n    launch_time = response[\"Reservations\"][0][\"Instances\"][0][\"LaunchTime\"]\n    return re.sub(r\"\\+00:00\",\"\",str(launch_time))\n\ndef get_shutdown_tag():\n    instance_tags = response[\"Reservations\"][0][\"Instances\"][0][\"Tags\"]\n    shutdown_tag = next((tag for tag in instance_tags if tag[\"Key\"] == \"mw-autoshutdown\"), None)\n    return shutdown_tag\n\ndef set_shutdown_tag(shutdown_time):\n    ec2.create_tags(Resources=[INSTANCE_ID], Tags=[{\"Key\": \"mw-autoshutdown\",\"Value\": str(shutdown_time)}])\n\ndef set_last_autoshutdown_event_tag(shutdown_time):\n    ec2.create_tags(Resources=[INSTANCE_ID], Tags=[{\"Key\": \"mw-last-autoshutdown-event\",\"Value\": str(shutdown_time)}])\n\ndef clear_shutdown_tag():\n    ec2.delete_tags(Resources=[INSTANCE_ID], Tags=[{\"Key\": \"mw-autoshutdown\"}])\n\ndef set_shutdown_time():\n    time_interval_before_shutdown = int(re.findall(\"[0-9]+\", DEFAULT_TIME_INTERVAL)[0])\n    launch_time = datetime.fromisoformat(get_start_time())\n    shutdown_time = launch_time + timedelta(hours=int(time_interval_before_shutdown))\n    shutdown_time_formatted = datetime.strftime(shutdown_time,'%a, %d %b %Y %H:%M:%S GMT')\n    set_shutdown_tag(shutdown_time_formatted)\n\ndef is_instance_stopped():\n    status = response[\"Reservations\"][0][\"Instances\"][0][\"State\"][\"Name\"]\n    if status == \"stopped\":\n        return True\n    return False\n\ndef lambda_handler(event, context):\n\n    # Don\"t do anything while the instance is stopped.\n    if is_instance_stopped():\n        log_to_cloudwatch(message_id=\"instance-is-stopped\")\n        return {\"statusCode\": 200}\n\n    shutdown_tag = get_shutdown_tag()\n\n    # When the lambda function first runs, the tag doesn't exist yet.\n    # Use the specified option to determine what to do.\n    if shutdown_tag is None:\n        if DEFAULT_TIME_INTERVAL == \"Never\":\n            # Set the tag to \"never\".\n            set_shutdown_tag(\"never\")\n            # Don't do anything when tag is \"never\"\n            log_to_cloudwatch(message_id=\"tag-is-never\")\n            return {\"statusCode\": 200}\n        else:\n            # Set the tag to start time + user chosen time interval.\n            set_shutdown_time()\n            log_to_cloudwatch(message_id=\"instance-just-booted\")\n            return {\"statusCode\": 200}\n\n    # If the tag exists, then use it to determine what to do.\n    if shutdown_tag[\"Value\"] == \"change_me_on_boot\":\n        set_shutdown_time()\n        log_to_cloudwatch(message_id=\"instance-just-booted\")\n        return {\"statusCode\": 200}\n    elif shutdown_tag[\"Value\"] == \"never\":\n        # Don't do anything when tag is \"never\"\n        log_to_cloudwatch(message_id=\"tag-is-never\")\n        return {\"statusCode\": 200}\n    else:\n        # Check the tag value to determine whether instance needs to be shutdown.\n        try:\n            shutdown_time = datetime.strptime(shutdown_tag[\"Value\"],'%a, %d %b %Y %H:%M:%S GMT')\n        except ValueError:\n            log_to_cloudwatch(message_id=\"tag-is-invalid\")\n            return {\"statusCode\": 200}\n        timezone = shutdown_time.tzinfo\n        current_time = datetime.now(timezone)\n\n        if current_time > shutdown_time:\n            ec2.stop_instances(InstanceIds=[INSTANCE_ID])\n\n            # Explicitly set the shutdown time as mw-last-autoshutdown-event tag\n            current_time_formatted = datetime.strftime(current_time, '%a, %d %b %Y %H:%M:%S GMT')\n            set_last_autoshutdown_event_tag(current_time_formatted)\n\n            log_to_cloudwatch(message_id=\"ready-to-shutdown\")\n\n            # If the DEFAULT_TIME_INTERVAL is never, set the tag to never. Otherwise, give the tag an empty value.\n            if DEFAULT_TIME_INTERVAL == \"Never\":\n                set_shutdown_tag(\"never\")\n            else:\n                set_shutdown_tag(\"change_me_on_boot\")\n            return {\"statusCode\": 200}\n        else:\n            log_to_cloudwatch(message_id=\"too-early-to-shutdown\")\n            return {\"statusCode\": 200}",
              {
                "STACK_NAME": {
                  "Ref": "AWS::StackName"
                },
                "DEFAULT_TIME_INTERVAL": {
                  "Ref": "AutoShutdown"
                }
              }
            ]
          }
        },
        "Handler": "index.lambda_handler",
        "Runtime": "python3.12",
        "Timeout": "60",
        "Role": {
          "Fn::GetAtt": [
            "AutoShutdownLambdaRole",
            "Arn"
          ]
        }
      }
    },
    "AutoShutdownLambdaRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/",
        "Policies": [
          {
            "PolicyName": "autoshutdown-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "ec2:DescribeInstances",
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": "ec2:DescribeTags",
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": "ec2:Stopinstances",
                  "Resource": {
                    "Fn::Sub": [
                      "arn:aws:ec2:${region}:${accountId}:instance/*",
                      {
                        "region": {
                          "Ref": "AWS::Region"
                        },
                        "accountId": {
                          "Ref": "AWS::AccountId"
                        }
                      }
                    ]
                  },
                  "Condition": {
                    "StringEquals": {
                      "aws:ResourceTag/aws:cloudformation:stack-name": {
                        "Fn::Sub": [
                          "${STACK_NAME}",
                          {
                            "STACK_NAME": {
                              "Ref": "AWS::StackName"
                            }
                          }
                        ]
                      },
                      "aws:ResourceTag/aws:cloudformation:logical-id": "MATLABEC2Instance"
                    }
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": "ec2:CreateTags",
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": "ec2:DeleteTags",
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": {
                    "Fn::Join": [
                      "",
                      [
                        "arn:aws:logs:",
                        {
                          "Ref": "AWS::Region"
                        },
                        ":",
                        {
                          "Ref": "AWS::AccountId"
                        },
                        ":",
                        "log-group:",
                        "/aws/lambda/*"
                      ]
                    ]
                  }
                }
              ]
            }
          }
        ]
      }
    },
    "AutoShutdownScheduledRule": {
      "Type": "AWS::Events::Rule",
      "Properties": {
        "Description": "AutoShutdownScheduledRule",
        "ScheduleExpression": "rate(15 minutes)",
        "State": "ENABLED",
        "Targets": [
          {
            "Arn": {
              "Fn::GetAtt": [
                "AutoShutdownLambda",
                "Arn"
              ]
            },
            "Id": "TargetFunctionV1"
          }
        ]
      }
    },
    "PermissionForEventsToInvokeLambda": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": {
          "Ref": "AutoShutdownLambda"
        },
        "Action": "lambda:InvokeFunction",
        "Principal": "events.amazonaws.com",
        "SourceArn": {
          "Fn::GetAtt": [
            "AutoShutdownScheduledRule",
            "Arn"
          ]
        }
      }
    },
    "AutoShutdownLambdaLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": {
          "Fn::Join": [
            "",
            [
              "/aws/lambda/",
              {
                "Ref": "AutoShutdownLambda"
              }
            ]
          ]
        }
      }
    }
  },
  "Parameters": {
    "InstanceType": {
      "Description": "AWS instance type to use for MATLAB. See https://aws.amazon.com/ec2/instance-types for a list of instance types.",
      "Default": "m5.xlarge",
      "Type": "String"
    },
    "InstanceName": {
      "Description": "Name for the MATLAB virtual machine",
      "Default": "MATLAB Desktop",
      "Type": "String"
    },
    "AccessProtocol": {
      "Description": "Access protocol to connect to this instance",
      "Default": "RDP",
      "Type": "String",
      "AllowedValues": [
        "NICE DCV",
        "RDP"
      ]
    },
    "UseElasticIpAddress": {
      "Description": "Flag indicating whether you want to keep the same public IP address for the instance",
      "Default": "No",
      "Type": "String",
      "AllowedValues": [
        "Yes",
        "No"
      ]
    },
    "RootVolumeSize": {
      "Description": "Size in GB of the root volume",
      "Default": "128",
      "Type": "Number",
      "MinValue": "128",
      "MaxValue": "1024",
      "ConstraintDescription": "Size must be between 128 and 1024GB"
    },
    "CustomIamRole": {
      "Description": "Name of a custom IAM Role to associate with this instance. If not specified, a predefined role is used. If specified, features requiring special permissions will be unavailable (NICE DCV, CloudWatch, IAM Policies).",
      "Default": "",
      "Type": "String"
    },
    "AdditionalIamPolicies": {
      "Description": "Semicolon-delimited list of IAM Policy ARNs to add to the predefined role. This option cannot be used with a custom IAM Role.",
      "Default": "",
      "Type": "String",
      "AllowedPattern": "^(arn:[^:;]+:iam::[^:;]+:policy/[^:;]+(;arn:[^:;]+:iam::[^:;]+:policy/[^:;]+)*)?$",
      "ConstraintDescription": "If specified, must be a semicolon (;) delimited list of ARNs (arn:<partition>:iam::<account-id>:policy/<resource-id>)."
    },
    "VPC": {
      "Description": "ID of an existing VPC in which to deploy this stack",
      "Type": "AWS::EC2::VPC::Id",
      "ConstraintDescription": "Must be the ID of an existing VPC.",
      "AllowedPattern": ".+"
    },
    "Subnet": {
      "Description": "ID of an existing subnet",
      "Type": "AWS::EC2::Subnet::Id",
      "ConstraintDescription": "Must be the ID of an existing Subnet within the chosen VPC.",
      "AllowedPattern": ".+"
    },
    "SSHKeyName": {
      "Description": "Name of an existing EC2 KeyPair to allow SSH access to all the instances. See https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html for details on creating these.",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "ConstraintDescription": "Must be the name of an existing EC2 KeyPair.",
      "AllowedPattern": ".+"
    },
    "ClientIPAddress": {
      "Description": "IP address range that will be allowed to connect to this instance from outside of the VPC. This field should be formatted as <ip_address>/<mask>. E.g. 10.0.0.1/32. This is the public IP address which can be found by searching for 'what is my ip address' on the web. The mask determines the number of IP addresses to include. A mask of 32 is a single IP address. This calculator can be used to build a specific range: https://www.ipaddressguide.com/cidr. You may need to contact your IT administrator to determine which address is appropriate.",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription": "Must be a valid IP CIDR range of the form x.x.x.x/x."
    },
    "Password": {
      "NoEcho": "true",
      "Description": "Password for the \"ubuntu\" user",
      "Type": "String",
      "ConstraintDescription": "",
      "Default": ""
    },
    "ConfirmPassword": {
      "NoEcho": "true",
      "Description": "Confirm Password",
      "Type": "String",
      "ConstraintDescription": "",
      "Default": ""
    },
    "LicenseManager": {
      "Description": "Optional License Manager for MATLAB string in the form <port>@<hostname>. If not specified, online licensing is used. If specified, the license manager must be accessible from the specified VPC and subnets",
      "Type": "String",
      "Default": "",
      "AllowedPattern": "([0-9]+@[a-zA-Z0-9.\\-]+)?",
      "ConstraintDescription": "If specified, must be in the form <port>@<hostname>"
    },
    "EnableCloudWatch": {
      "Description": "Flag indicating whether cloudwatch logging for the MATLAB instance is enabled.",
      "Type": "String",
      "AllowedValues": [
        "Yes",
        "No"
      ],
      "Default": "No"
    },
    "AutoShutdown": {
      "Description": "Choose whether you want to enable autoshutdown for your instance after a certain number of hours",
      "Type": "String",
      "AllowedValues": [
        "Never",
        "After 1 hour",
        "After 2 hours",
        "After 3 hours",
        "After 4 hours",
        "After 5 hours",
        "After 6 hours",
        "After 7 hours",
        "After 8 hours",
        "After 9 hours",
        "After 10 hours",
        "After 11 hours",
        "After 12 hours",
        "After 13 hours",
        "After 14 hours",
        "After 15 hours",
        "After 16 hours",
        "After 17 hours",
        "After 18 hours",
        "After 19 hours",
        "After 20 hours",
        "After 21 hours",
        "After 22 hours",
        "After 23 hours",
        "After 24 hours"
      ],
      "Default": "Never"
    },
    "AdditionalSecurityGroup": {
      "Description": "ID of an additional (optional) Security Group for the instances to be placed in. Often the License Manager for MATLAB's Security Group.",
      "Type": "String",
      "Default": ""
    }
  },
  "Rules": {
    "matchPasswords": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "Password"
              },
              {
                "Ref": "ConfirmPassword"
              }
            ]
          },
          "AssertDescription": "Passwords do not match"
        }
      ]
    },
    "SubnetInVPC": {
      "Assertions": [
        {
          "Assert": {
            "Fn::EachMemberEquals": [
              {
                "Fn::ValueOfAll": [
                  "AWS::EC2::Subnet::Id",
                  "VpcId"
                ]
              },
              {
                "Ref": "VPC"
              }
            ]
          },
          "AssertDescription": "Subnet must exist in the VPC you have selected"
        }
      ]
    },
    "NoAdditionalPoliciesOnCustomRole": {
      "RuleCondition": {
        "Fn::Not": [
          {
            "Fn::Equals": [
              {
                "Ref": "CustomIamRole"
              },
              ""
            ]
          }
        ]
      },
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "AdditionalIamPolicies"
              },
              ""
            ]
          },
          "AssertDescription": "You cannot add IAM Policies when using a custom IAM Role."
        }
      ]
    },
    "MultipleRolesMustNotExist": {
      "RuleCondition": {
        "Fn::Not": [
          {
            "Fn::Equals": [
              {
                "Ref": "CustomIamRole"
              },
              ""
            ]
          }
        ]
      },
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "EnableCloudWatch"
              },
              "No"
            ]
          },
          "AssertDescription": "You cannot use CloudWatch when using a custom IAM role. The deployment will create an IAM role which you can later modify with additional policies if needed."
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "AccessProtocol"
                  },
                  "NICE DCV"
                ]
              }
            ]
          },
          "AssertDescription": "You cannot use NICE DCV when using a custom IAM role. The deployment will create an IAM role which you can later modify with additional policies if needed."
        }
      ]
    }
  },
  "Conditions": {
    "UsePredefinedRole": {
      "Fn::Equals": [
        {
          "Ref": "CustomIamRole"
        },
        ""
      ]
    },
    "UseCustomIamRole": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "CustomIamRole"
            },
            ""
          ]
        }
      ]
    },
    "UseAdditionalPolicies": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalIamPolicies"
            },
            ""
          ]
        }
      ]
    },
    "UseCloudWatch": {
      "Fn::Equals": [
        {
          "Ref": "EnableCloudWatch"
        },
        "Yes"
      ]
    },
    "UseNICEDCV": {
      "Fn::Equals": [
        {
          "Ref": "AccessProtocol"
        },
        "NICE DCV"
      ]
    },
    "UseXRDP": {
      "Fn::Equals": [
        {
          "Ref": "AccessProtocol"
        },
        "RDP"
      ]
    },
    "UseElasticIPAddress": {
      "Fn::Equals": [
        {
          "Ref": "UseElasticIpAddress"
        },
        "Yes"
      ]
    },
    "AddSG": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalSecurityGroup"
            },
            ""
          ]
        }
      ]
    }
  },
  "Outputs": {
    "CloudWatchLogs": {
      "Condition": "UseCloudWatch",
      "Description": "The cloudwatch logs containing logging information about the MATLAB instance",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://console.aws.amazon.com/cloudwatch/home?region=",
            {
              "Ref": "AWS::Region"
            },
            "#logsV2:log-groups/log-group/",
            {
              "Fn::Join": [
                "-",
                [
                  {
                    "Ref": "AWS::StackName"
                  },
                  {
                    "Fn::Select": [
                      "2",
                      {
                        "Fn::Split": [
                          "/",
                          {
                            "Ref": "AWS::StackId"
                          }
                        ]
                      }
                    ]
                  }
                ]
              ]
            }
          ]
        ]
      }
    },
    "NiceDCVConnection": {
      "Condition": "UseNICEDCV",
      "Description": "Public url of the newly created EC2 instance to connect to the session via NICE DCV",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://",
            {
              "Fn::GetAtt": [
                "MATLABEC2Instance",
                "PublicDnsName"
              ]
            },
            ":8443/#console"
          ]
        ]
      }
    },
    "RDPConnection": {
      "Condition": "UseXRDP",
      "Description": "Public DNSName of the newly created EC2 instance",
      "Value": {
        "Fn::GetAtt": [
          "MATLABEC2Instance",
          "PublicDnsName"
        ]
      }
    }
  },
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "EC2 Instance"
          },
          "Parameters": [
            "InstanceName",
            "InstanceType",
            "RootVolumeSize",
            "CustomIamRole",
            "AdditionalIamPolicies"
          ]
        },
        {
          "Label": {
            "default": "Remote Access"
          },
          "Parameters": [
            "AccessProtocol",
            "UseElasticIpAddress",
            "ClientIPAddress",
            "SSHKeyName",
            "Password",
            "ConfirmPassword"
          ]
        },
        {
          "Label": {
            "default": "Network Configuration"
          },
          "Parameters": [
            "VPC",
            "Subnet",
            "AdditionalSecurityGroup"
          ]
        },
        {
          "Label": {
            "default": "License Configuration"
          },
          "Parameters": [
            "LicenseManager"
          ]
        },
        {
          "Label": {
            "default": "Logging Configuration"
          },
          "Parameters": [
            "EnableCloudWatch"
          ]
        },
        {
          "Label": {
            "default": "Autoshutdown Configuration"
          },
          "Parameters": [
            "AutoShutdown"
          ]
        }
      ],
      "ParameterLabels": {
        "ClientIPAddress": {
          "default": "Allow connections from"
        },
        "UseElasticIpAddress": {
          "default": "Keep public ip the same"
        },
        "InstanceType": {
          "default": "AWS EC2 Instance type"
        },
        "InstanceName": {
          "default": "Instance Name"
        },
        "RootVolumeSize": {
          "default": "Storage Size (GiB)"
        },
        "CustomIamRole": {
          "default": "Custom IAM Role (Optional)"
        },
        "AdditionalIamPolicies": {
          "default": "Additional IAM Policies (Optional)"
        },
        "VPC": {
          "default": "VPC to deploy this stack to"
        },
        "Subnet": {
          "default": "Subnet"
        },
        "Password": {
          "default": "Remote password"
        },
        "ConfirmPassword": {
          "default": "Confirm remote password"
        },
        "SSHKeyName": {
          "default": "SSH Key Pair"
        },
        "LicenseManager": {
          "default": "License Manager for MATLAB connection string"
        },
        "AdditionalSecurityGroup": {
          "default": "Additional security group to place instances in"
        },
        "EnableCloudWatch": {
          "default": "Configure cloudwatch logging for the MATLAB instance"
        },
        "AccessProtocol": {
          "default": "Remote access protocol"
        }
      }
    }
  }
}
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2022a/README.md">
# MATLAB on Amazon Web Services (Linux VM)

## Step 1. Launch the Template

Click the **Launch Stack** button to deploy a standalone MATLAB desktop client on AWS. This will open the CloudFormation Create Stack screen in your web browser.

| Region | Launch Link |
| --------------- | ----------- |
| **us-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-east-1.console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022a/aws-matlab-template.json) |
| **us-east-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-east-2.console.aws.amazon.com/cloudformation/home?region=us-east-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022a/aws-matlab-template.json) |
| **us-west-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-west-1.console.aws.amazon.com/cloudformation/home?region=us-west-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022a/aws-matlab-template.json) |
| **us-west-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-west-2.console.aws.amazon.com/cloudformation/home?region=us-west-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022a/aws-matlab-template.json) |
| **ca-central-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ca-central-1.console.aws.amazon.com/cloudformation/home?region=ca-central-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022a/aws-matlab-template.json) |
| **eu-central-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-central-1.console.aws.amazon.com/cloudformation/home?region=eu-central-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022a/aws-matlab-template.json) |
| **eu-west-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-1.console.aws.amazon.com/cloudformation/home?region=eu-west-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022a/aws-matlab-template.json) |
| **eu-west-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-2.console.aws.amazon.com/cloudformation/home?region=eu-west-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022a/aws-matlab-template.json) |
| **eu-west-3** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-3.console.aws.amazon.com/cloudformation/home?region=eu-west-3#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022a/aws-matlab-template.json) |
| **eu-north-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-north-1.console.aws.amazon.com/cloudformation/home?region=eu-north-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022a/aws-matlab-template.json) |
| **sa-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://sa-east-1.console.aws.amazon.com/cloudformation/home?region=sa-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022a/aws-matlab-template.json) |
| **me-south-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://me-south-1.console.aws.amazon.com/cloudformation/home?region=me-south-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022a/aws-matlab-template.json) |
| **ap-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-east-1.console.aws.amazon.com/cloudformation/home?region=ap-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022a/aws-matlab-template.json) |
| **ap-south-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-south-1.console.aws.amazon.com/cloudformation/home?region=ap-south-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022a/aws-matlab-template.json) |
| **ap-northeast-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-northeast-1.console.aws.amazon.com/cloudformation/home?region=ap-northeast-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022a/aws-matlab-template.json) |
| **ap-northeast-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-northeast-2.console.aws.amazon.com/cloudformation/home?region=ap-northeast-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022a/aws-matlab-template.json) |
| **ap-southeast-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-southeast-1.console.aws.amazon.com/cloudformation/home?region=ap-southeast-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022a/aws-matlab-template.json) |
| **ap-southeast-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-southeast-2.console.aws.amazon.com/cloudformation/home?region=ap-southeast-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2022a/aws-matlab-template.json) |


**Note**: Creating a stack on AWS can take a few minutes.

## Step 2. Configure the Cloud Resources
After you click the Launch Stack button above, the “Create stack” page will open in your browser where you can configure the parameters. It is easier to complete the steps if you position these instructions and the AWS console window side by side.

1. Specify a stack name. This will be shown in the AWS CloudFormation console and must be unique within the AWS account.


2. Specify and check the defaults for these resource parameters:

| Parameter label | Description |
| --------------- | ----------- |
| **AWS EC2 Instance type** | AWS instance type to use for MATLAB. See https://aws.amazon.com/ec2/instance-types for a list of instance types. |
| **Instance Name** | Name for the MATLAB virtual machine |
| **Remote access protocol** | Access protocol to connect to this instance |
| **Keep public ip the same** | Flag indicating whether you want to keep the same public IP address for the instance |
| **Storage Size (GiB)** | Size in GB of the root volume |
| **Custom IAM Role (Optional)** | Name of a custom IAM Role to associate with this instance. If not specified, a predefined role is used. If specified, features requiring special permissions will be unavailable (NICE DCV, CloudWatch, IAM Policies). |
| **Additional IAM Policies (Optional)** | Semicolon-delimited list of IAM Policy ARNs to add to the predefined role. This option cannot be used with a custom IAM Role. |
| **VPC to deploy this stack to** | ID of an existing VPC in which to deploy this stack |
| **Subnet** | ID of an existing subnet |
| **SSH Key Pair** | Name of an existing EC2 KeyPair to allow SSH access to all the instances. See https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html for details on creating these. |
| **Allow connections from** | IP address range that will be allowed to connect to this instance from outside of the VPC. This field should be formatted as \<ip_address>/\<mask>. E.g. 10.0.0.1/32. This is the public IP address which can be found by searching for 'what is my ip address' on the web. The mask determines the number of IP addresses to include. A mask of 32 is a single IP address. This calculator can be used to build a specific range: https://www.ipaddressguide.com/cidr. You may need to contact your IT administrator to determine which address is appropriate. |
| **Remote password** | Password for the "ubuntu" user |
| **Confirm remote password** | Confirm Password |
| **License Manager for MATLAB connection string** | Optional License Manager for MATLAB string in the form \<port>@\<hostname>. If not specified, online licensing is used. If specified, the license manager must be accessible from the specified VPC and subnets |
| **Configure cloudwatch logging for the MATLAB instance** | Flag indicating whether cloudwatch logging for the MATLAB instance is enabled. |
| **AutoShutdown** | Choose whether you want to enable autoshutdown for your instance after a certain number of hours |
| **Additional security group to place instances in** | ID of an additional (optional) Security Group for the instances to be placed in. Often the License Manager for MATLAB's Security Group. |


>**Note**: If you chose to associate an IAM role above you'll need to acknowledge that it may create IAM resources in the Capabilities before creating the stack.

3. Click the **Create Stack** button.  The CloudFormation service will start creating the resources for the stack. <p>After clicking **Create** you will be taken to the *Stack Detail* page for your stack. Wait for the Status to reach **CREATE\_COMPLETE**. This may take up to 10 minutes.</p>

## Step 3. Connect to the Virtual Machine in the Cloud

If you chose RDP, then:
1. Expand the **Outputs** section in the the *Stack Detail* page.
1. Look for the key named `RDPConnection` and copy the corresponding public DNS name listed under value. *For example*: ec2-11-222-33-44.compute-1.amazonaws.com
1. Launch any remote desktop client, paste the public DNS name in the appropriate field, and connect. On the Windows Remote Desktop Client you need to paste the public DNS name in the **Computer** field and click **Connect**.
1. In the login screen that's displayed, use the username `ubuntu` and the password you specified while setting up the stack in [Step 2](#step-2-configure-the-stack).

If you chose NICE DCV, then:
1. Expand the **Outputs** section in the the *Stack Detail* page.
1. Look for the key named `NiceDCVConnection` and click on it
1. In the login screen that's displayed, use the username `ubuntu` and the password you specified while setting up the stack in [Step 2](#step-2-configure-the-stack).

## Step 4. Launch MATLAB
Double-click the MATLAB icon on the virtual machine desktop to launch MATLAB. The first time you start MATLAB you will need to activate it. By default, you will be asked to use your MathWorks Account to activate MATLAB. For other ways to activate MATLAB, see [MATLAB Licensing in the Cloud](https://mathworks.com/help/install/license/licensing-for-mathworks-products-running-on-the-cloud.html).

>**Note**: It may take a few minutes for activation to complete and MATLAB to start. You will experience this delay only the first time you start MATLAB.


# Additional Information

## Delete Your Cloud Resources

Once you have finished using your stack, it is recommended that you delete all resources to avoid incurring further cost. To delete the stack, do the following:
1. Log in to the AWS Console.
1. Go to the AWS CloudFormation page and select the stack you created.
1. Click the **Actions** button and click **Delete Stack** from the menu that appears.

### Resources

The following resources will be created as part of the CloudFormation Stack.

1. Security Group for SSH, RDP and NICE DCV access
1. EC2 Instance

### CloudWatch Logs
CloudWatch logs enables you to access logs from all the resources in your stack in a single place. To use CloudWatch logs, launch the stack with the feature "Configure cloudwatch logging for the MATLAB instance" enabled. Once the stack deployment is complete, you can access your logs in the "Outputs" of the stack by clicking the link next to "CloudWatchLogs". Note that if you delete the stack, the CloudWatch log group is also deleted. For more information, see [What is Amazon CloudWatch Logs?](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/WhatIsCloudWatchLogs.html).
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2020a/aws-matlab-template.json">
{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Mappings": {
    "RegionMap": {
      "us-east-1": {
        "AMI": "ami-068f31919b80f83c0"
      },
      "us-east-2": {
        "AMI": "ami-0547c4a9f9b76e707"
      },
      "us-west-1": {
        "AMI": "ami-08143b9fa008913d6"
      },
      "us-west-2": {
        "AMI": "ami-0ed83798ecd58abc4"
      },
      "ca-central-1": {
        "AMI": "ami-0194d404e072a7810"
      },
      "eu-central-1": {
        "AMI": "ami-030fd8c4d047a5520"
      },
      "eu-west-1": {
        "AMI": "ami-0ea1bce5093e830b8"
      },
      "eu-west-2": {
        "AMI": "ami-02551c90e29048c2b"
      },
      "eu-west-3": {
        "AMI": "ami-0eef871c04170aee5"
      },
      "eu-north-1": {
        "AMI": "ami-0c9eb2e13d9e72f59"
      },
      "sa-east-1": {
        "AMI": "ami-045cf8bc5945857b9"
      },
      "me-south-1": {
        "AMI": "ami-0b3954e0b87a20da4"
      },
      "ap-east-1": {
        "AMI": "ami-0518b1dbca7511976"
      },
      "ap-south-1": {
        "AMI": "ami-0ad21de45f700bfe6"
      },
      "ap-northeast-1": {
        "AMI": "ami-0799b89de0252cdee"
      },
      "ap-northeast-2": {
        "AMI": "ami-04cc1b560173a0bbf"
      },
      "ap-southeast-1": {
        "AMI": "ami-0e36e21da3ae705ce"
      },
      "ap-southeast-2": {
        "AMI": "ami-0ef4c9e5cc1de2abd"
      }
    }
  },
  "Resources": {
    "MATLABSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": {
          "Ref": "VPC"
        },
        "GroupDescription": "Enable SSH and RDP Access",
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "22",
            "ToPort": "22",
            "CidrIp": {
              "Ref": "ClientIPAddress"
            }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "3389",
            "ToPort": "3389",
            "CidrIp": {
              "Ref": "ClientIPAddress"
            }
          }
        ]
      }
    },
    "MATLABInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Condition": "UseIamRole",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "IamRole"
          }
        ]
      }
    },
    "MATLABEC2Instance": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "ImageId": {
          "Fn::FindInMap": [
            "RegionMap",
            {
              "Ref": "AWS::Region"
            },
            "AMI"
          ]
        },
        "KeyName": {
          "Ref": "SSHKeyName"
        },
        "SecurityGroupIds": [
          {
            "Ref": "MATLABSecurityGroup"
          },
          {
            "Fn::If": [
              "AddSG",
              {
                "Ref": "AdditionalSecurityGroup"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          }
        ],
        "SubnetId": {
          "Ref": "Subnet"
        },
        "IamInstanceProfile": {
          "Fn::If": [
            "UseIamRole",
            {
              "Ref": "MATLABInstanceProfile"
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "InstanceType": {
          "Ref": "InstanceType"
        },
        "EbsOptimized": "true",
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "VolumeSize": {
                "Ref": "RootVolumeSize"
              }
            }
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Ref": "InstanceName"
            }
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash\n",
                "# Copyright 2011-2020 The MathWorks, Inc.\n",
                "cd /usr/local/matlab\n",
                "sudo echo $PATH:/usr/local/matlab/bin | sudo tee /etc/environment > /dev/null\n",
                "nohup /usr/local/matlab/bin/glnxa64/MATLABStartupAccelerator &>/dev/null &\n",
                "sudo useradd -s /bin/bash -m -p `echo '",
                {
                  "Fn::Base64": {
                    "Ref": "Password"
                  }
                },
                "' | base64 -d | mkpasswd --method=sha-512 -s` ",
                {
                  "Ref": "Username"
                },
                "\n",
                "if [ -n '",
                {
                  "Ref": "LicenseManager"
                },
                "' ]\n",
                " then \n",
                "#disable online licensing and enable a license server\n",
                "sudo rm /usr/local/matlab/licenses/license_info.xml\n",
                "echo 'export MLM_LICENSE_FILE=",
                {
                  "Ref": "LicenseManager"
                },
                "' | sudo tee -a /etc/profile.d/mlmlicensefile.sh\n",
                "\n",
                "fi\n",
                "sudo usermod -aG sudo ",
                {
                  "Ref": "Username"
                },
                "\n",
                "sudo cp /usr/local/matlab/matlab.mlsettings ",
                {
                  "Fn::Join": [
                    "",
                    [
                      "/home/",
                      {
                        "Ref": "Username"
                      },
                      "/.matlab/R2020a/matlab.mlsettings"
                    ]
                  ]
                },
                "\n"
              ]
            ]
          }
        }
      }
    }
  },
  "Parameters": {
    "InstanceType": {
      "Description": "The AWS instance type to use for MATLAB. See https://aws.amazon.com/ec2/instance-types for a list of instance types.",
      "Default": "m5.xlarge",
      "Type": "String"
    },
    "InstanceName": {
      "Description": "Give your MATLAB virtual machine a name",
      "Default": "MATLAB Desktop",
      "Type": "String"
    },
    "RootVolumeSize": {
      "Description": "Specify the size in GB of the root volume",
      "Default": "128",
      "Type": "Number",
      "MinValue": "128",
      "MaxValue": "1024",
      "ConstraintDescription": "Size must be between 64 and 1024GB"
    },
    "IamRole": {
      "Description": "Specify an IAM Role to associate with this instance.",
      "Default": "",
      "Type": "String"
    },
    "VPC": {
      "Description": "ID of an existing VPC in which to deploy this stack",
      "Type": "AWS::EC2::VPC::Id",
      "ConstraintDescription": "Must be the Id of an existing VPC.",
      "Default": ""
    },
    "Subnet": {
      "Description": "List of existing subnets IDs",
      "Type": "AWS::EC2::Subnet::Id",
      "ConstraintDescription": "must be the Id of an existing Subnet within the chosen VPC.",
      "Default": ""
    },
    "SSHKeyName": {
      "Description": "The name of an existing EC2 KeyPair to allow SSH access to all the instances. See https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html for details on creating these.",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "ConstraintDescription": "must be the name of an existing EC2 KeyPair.",
      "Default": ""
    },
    "ClientIPAddress": {
      "Description": "The IP address range that will be allowed to connect to this instance from outside of the VPC. This field should be formatted as <ip_address>/<mask>. E.g. 10.0.0.1/32. This is the public IP address which can be found by searching for 'what is my ip address' on the web. The mask determines the number of IP addresses to include. A mask of 32 is a single IP address. This calculator can be used to build a specific range: https://www.ipaddressguide.com/cidr. You may need to contact your IT administrator to determine which address is appropriate.",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription": "Must be a valid IP CIDR range of the form x.x.x.x/x."
    },
    "Username": {
      "Description": "Specify a user name.  This will create a new user on the instance which can be used to sign in using Remote Desktop Protocol (RDP).",
      "Type": "String",
      "ConstraintDescription": "Must be a valid user name",
      "Default": ""
    },
    "Password": {
      "NoEcho": "true",
      "Description": "Enter a password for the username",
      "Type": "String",
      "ConstraintDescription": "",
      "Default": ""
    },
    "ConfirmPassword": {
      "NoEcho": "true",
      "Description": "Confirm Password",
      "Type": "String",
      "ConstraintDescription": "",
      "Default": ""
    },
    "LicenseManager": {
      "Description": "Optional License Manager for MATLAB string in the form <port>@<hostname>. If not specified, online licensing is used. If specified, the license manager must be accessible from the specified VPC and subnets. If the Network License Manager for MATLAB was deployed using the reference architecture, this can be achieved by specifying the security group of that deployment as the AdditionalSecurityGroup parameter, and by using the private hostname of the license manager host.",
      "Type": "String",
      "Default": "",
      "AllowedPattern": "([0-9]+@[a-zA-Z0-9.]+)?",
      "ConstraintDescription": "If specified, must be in the form <port>@<hostname>"
    },
    "AdditionalSecurityGroup": {
      "Description": "The ID of an additional (optional) Security Group for the instances to be placed in. Often the License Manager for MATLAB's Security Group.",
      "Type": "String",
      "Default": ""
    }
  },
  "Rules": {
    "matchPasswords": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "Password"
              },
              {
                "Ref": "ConfirmPassword"
              }
            ]
          },
          "AssertDescription": "Passwords do not match"
        }
      ]
    },
    "SubnetInVPC": {
      "Assertions": [
        {
          "Assert": {
            "Fn::EachMemberEquals": [
              {
                "Fn::ValueOfAll": [
                  "AWS::EC2::Subnet::Id",
                  "VpcId"
                ]
              },
              {
                "Ref": "VPC"
              }
            ]
          },
          "AssertDescription": "Subnet must exist in the VPC you have selected"
        }
      ]
    }
  },
  "Conditions": {
    "UseIamRole": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            "",
            {
              "Ref": "IamRole"
            }
          ]
        }
      ]
    },
    "AddSG": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalSecurityGroup"
            },
            ""
          ]
        }
      ]
    }
  },
  "Outputs": {
    "RDPConnection": {
      "Description": "Public DNSName of the newly created EC2 instance",
      "Value": {
        "Fn::GetAtt": [
          "MATLABEC2Instance",
          "PublicDnsName"
        ]
      }
    }
  },
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "EC2 Instance"
          },
          "Parameters": [
            "InstanceName",
            "InstanceType",
            "RootVolumeSize",
            "IamRole"
          ]
        },
        {
          "Label": {
            "default": "Remote Access"
          },
          "Parameters": [
            "ClientIPAddress",
            "SSHKeyName",
            "Username",
            "Password",
            "ConfirmPassword"
          ]
        },
        {
          "Label": {
            "default": "Network Configuration"
          },
          "Parameters": [
            "VPC",
            "Subnet",
            "AdditionalSecurityGroup"
          ]
        },
        {
          "Label": {
            "default": "License Configuration"
          },
          "Parameters": [
            "LicenseManager"
          ]
        }
      ],
      "ParameterLabels": {
        "ClientIPAddress": {
          "default": "Allow RDP connections from"
        },
        "InstanceType": {
          "default": "AWS EC2 Instance type"
        },
        "InstanceName": {
          "default": "Instance Name"
        },
        "RootVolumeSize": {
          "default": "Storage Size (GiB)"
        },
        "IamRole": {
          "default": "IAM Role (Optional)"
        },
        "VPC": {
          "default": "VPC to deploy this stack to"
        },
        "Subnet": {
          "default": "Subnet"
        },
        "Username": {
          "default": "Remote username"
        },
        "Password": {
          "default": "Remote password"
        },
        "ConfirmPassword": {
          "default": "Confirm remote password"
        },
        "SSHKeyName": {
          "default": "SSH Key Pair"
        },
        "LicenseManager": {
          "default": "License Manager for MATLAB connection string"
        },
        "AdditionalSecurityGroup": {
          "default": "Additional security group to place instances in"
        }
      }
    }
  }
}
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2020a/README.md">
# MATLAB on Amazon Web Services

## Step 1. Launch the Template

Click the **Launch Stack** button to deploy a standalone MATLAB desktop client on AWS. This will open the CloudFormation Create Stack screen in your web browser.

| Region | Launch Link |
| --------------- | ----------- |
| **us-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-east-1.console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020a/aws-matlab-template.json) |
| **us-east-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-east-2.console.aws.amazon.com/cloudformation/home?region=us-east-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020a/aws-matlab-template.json) |
| **us-west-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-west-1.console.aws.amazon.com/cloudformation/home?region=us-west-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020a/aws-matlab-template.json) |
| **us-west-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-west-2.console.aws.amazon.com/cloudformation/home?region=us-west-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020a/aws-matlab-template.json) |
| **ca-central-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ca-central-1.console.aws.amazon.com/cloudformation/home?region=ca-central-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020a/aws-matlab-template.json) |
| **eu-central-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-central-1.console.aws.amazon.com/cloudformation/home?region=eu-central-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020a/aws-matlab-template.json) |
| **eu-west-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-1.console.aws.amazon.com/cloudformation/home?region=eu-west-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020a/aws-matlab-template.json) |
| **eu-west-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-2.console.aws.amazon.com/cloudformation/home?region=eu-west-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020a/aws-matlab-template.json) |
| **eu-west-3** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-3.console.aws.amazon.com/cloudformation/home?region=eu-west-3#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020a/aws-matlab-template.json) |
| **eu-north-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-north-1.console.aws.amazon.com/cloudformation/home?region=eu-north-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020a/aws-matlab-template.json) |
| **sa-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://sa-east-1.console.aws.amazon.com/cloudformation/home?region=sa-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020a/aws-matlab-template.json) |
| **me-south-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://me-south-1.console.aws.amazon.com/cloudformation/home?region=me-south-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020a/aws-matlab-template.json) |
| **ap-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-east-1.console.aws.amazon.com/cloudformation/home?region=ap-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020a/aws-matlab-template.json) |
| **ap-south-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-south-1.console.aws.amazon.com/cloudformation/home?region=ap-south-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020a/aws-matlab-template.json) |
| **ap-northeast-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-northeast-1.console.aws.amazon.com/cloudformation/home?region=ap-northeast-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020a/aws-matlab-template.json) |
| **ap-northeast-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-northeast-2.console.aws.amazon.com/cloudformation/home?region=ap-northeast-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020a/aws-matlab-template.json) |
| **ap-southeast-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-southeast-1.console.aws.amazon.com/cloudformation/home?region=ap-southeast-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020a/aws-matlab-template.json) |
| **ap-southeast-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-southeast-2.console.aws.amazon.com/cloudformation/home?region=ap-southeast-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2020a/aws-matlab-template.json) |


**Note**: Creating a stack on AWS can take a few minutes.

## Step 2. Configure the Cloud Resources
After you click the Launch Stack button above, the “Create stack” page will open in your browser where you can configure the parameters. It is easier to complete the steps if you position these instructions and the AWS console window side by side.

1. Specify a stack name. This will be shown in the AWS CloudFormation console and must be unique within the AWS account.


2. Specify and check the defaults for these resource parameters:

| Parameter label | Description |
| --------------- | ----------- |
| **AWS EC2 Instance type** | The AWS instance type to use for MATLAB. See https://aws.amazon.com/ec2/instance-types for a list of instance types. |
| **Instance Name** | Give your MATLAB virtual machine a name |
| **Storage Size (GiB)** | Specify the size in GB of the root volume |
| **IAM Role (Optional)** | Specify an IAM Role to associate with this instance. |
| **VPC to deploy this stack to** | ID of an existing VPC in which to deploy this stack |
| **Subnet** | List of existing subnets IDs |
| **SSH Key Pair** | The name of an existing EC2 KeyPair to allow SSH access to all the instances. See https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html for details on creating these. |
| **Allow RDP connections from** | The IP address range that will be allowed to connect to this instance from outside of the VPC. This field should be formatted as \<ip_address>/\<mask>. E.g. 10.0.0.1/32. This is the public IP address which can be found by searching for 'what is my ip address' on the web. The mask determines the number of IP addresses to include. A mask of 32 is a single IP address. This calculator can be used to build a specific range: https://www.ipaddressguide.com/cidr. You may need to contact your IT administrator to determine which address is appropriate. |
| **Remote username** | Specify a user name.  This will create a new user on the instance which can be used to sign in using Remote Desktop Protocol (RDP). |
| **Remote password** | Enter a password for the username |
| **Confirm remote password** | Confirm Password |
| **License Manager for MATLAB connection string** | Optional License Manager for MATLAB string in the form \<port>@\<hostname>. If not specified, online licensing is used. If specified, the license manager must be accessible from the specified VPC and subnets. If the Network License Manager for MATLAB was deployed using the reference architecture, this can be achieved by specifying the security group of that deployment as the AdditionalSecurityGroup parameter, and by using the private hostname of the license manager host. |
| **Additional security group to place instances in** | The ID of an additional (optional) Security Group for the instances to be placed in. Often the License Manager for MATLAB's Security Group. |


>**Note**: If you chose to associate an IAM role above you'll need to acknowledge that it may create IAM resources in the Capabilities before creating the stack.

3. Click the **Create Stack** button.  The CloudFormation service will start creating the resources for the stack. <p>After clicking **Create** you will be taken to the *Stack Detail* page for your stack. Wait for the Status to reach **CREATE\_COMPLETE**. This may take up to 10 minutes.</p>

## Step 3. Connect to the Virtual Machine in the Cloud

1. Expand the **Outputs** section in the the *Stack Detail* page.
1. Look for the key named `RDPConnection` and copy the corresponding public DNS name listed under value. *For example*: ec2-11-222-33-44.compute-1.amazonaws.com
1. Launch any remote desktop client, paste the public DNS name in the appropriate field, and connect. On the Windows Remote Desktop Client you need to paste the public DNS name in the **Computer** field and click **Connect**.
1. In the login screen that's displayed, use the username and password you specified while setting up the stack in [Step 2](#step-2-configure-the-stack).

## Step 4. Launch MATLAB
Double-click the MATLAB icon on the virtual machine desktop to launch MATLAB. The first time you start MATLAB you will need to activate it. By default you will be asked to use your MathWorks Account to activate MATLAB. For other ways to activate MATLAB, see [Configure MATLAB Licensing on the Cloud](http://www.mathworks.com/support/cloud/configure-matlab-licensing-on-the-cloud.html).

>**Note**:It may take a few minutes for activation to complete and MATLAB to start. You will experience this delay only the first time you start MATLAB.


# Additional Information

## Delete Your Cloud Resources

Once you have finished using your stack, it is recommended that you delete all resources to avoid incurring further cost. To delete the stack, do the following:
1. Log in to the AWS Console.
1. Go to the AWS CloudFormation page and select the stack you created.
1. Click the **Actions** button and click **Delete Stack** from the menu that appears.

### Resources

The following resources will be created as part of the CloudFormation Stack.

1. Security Group for SSH and RDP access
1. EC2 Instance
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2021b/aws-matlab-template.json">
{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Mappings": {
    "RegionMap": {
      "us-east-1": {
        "AMI": "ami-0c43c0989a3ec9cae"
      },
      "us-east-2": {
        "AMI": "ami-08689f4e4100da4d8"
      },
      "us-west-1": {
        "AMI": "ami-0358e92826f5b8af5"
      },
      "us-west-2": {
        "AMI": "ami-075182c95a3c2877a"
      },
      "ca-central-1": {
        "AMI": "ami-010d6e045fdc0eb06"
      },
      "eu-central-1": {
        "AMI": "ami-0abdbe695224ca004"
      },
      "eu-west-1": {
        "AMI": "ami-062ae36a34fd65919"
      },
      "eu-west-2": {
        "AMI": "ami-0731a81317b65effd"
      },
      "eu-west-3": {
        "AMI": "ami-05c63e2436161c681"
      },
      "eu-north-1": {
        "AMI": "ami-0168a7fe267777926"
      },
      "sa-east-1": {
        "AMI": "ami-0ed0a44ef0150ec73"
      },
      "me-south-1": {
        "AMI": "ami-0ac30d6409b2c1e2a"
      },
      "ap-east-1": {
        "AMI": "ami-07e86ef249ef32fb1"
      },
      "ap-south-1": {
        "AMI": "ami-09b3d0a5ce2a1768f"
      },
      "ap-northeast-1": {
        "AMI": "ami-0a160e2460a3c0d8a"
      },
      "ap-northeast-2": {
        "AMI": "ami-0eedeefcef20bff13"
      },
      "ap-southeast-1": {
        "AMI": "ami-0166ac8bf31f8330f"
      },
      "ap-southeast-2": {
        "AMI": "ami-005ceafaa839bfa09"
      }
    }
  },
  "Resources": {
    "PredefinedRole": {
      "Type": "AWS::IAM::Role",
      "Condition": "UsePredefinedRole",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "ec2.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/",
        "ManagedPolicyArns": {
          "Fn::If": [
            "UseAdditionalPolicies",
            {
              "Fn::Split": [
                ";",
                {
                  "Ref": "AdditionalIamPolicies"
                }
              ]
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "Policies": [
          {
            "Fn::If": [
              "UseCloudWatch",
              {
                "PolicyName": "cloudwatch-access-policy",
                "PolicyDocument": {
                  "Version": "2012-10-17",
                  "Statement": [
                    {
                      "Effect": "Allow",
                      "Action": [
                        "logs:CreateLogStream",
                        "logs:DescribeLogStreams",
                        "logs:PutLogEvents"
                      ],
                      "Resource": {
                        "Fn::Sub": [
                          "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:${name}:*",
                          {
                            "name": {
                              "Fn::GetAtt": [
                                "MWLogLocation",
                                "Outputs.LogGroupName"
                              ]
                            }
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          {
            "PolicyName": "dcv-access-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "s3:GetObject",
                  "Resource": {
                    "Fn::Sub": "arn:aws:s3:::dcv-license.${AWS::Region}/*"
                  }
                }
              ]
            }
          },
          {
            "PolicyName": "ssm-access-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "ssm:DescribeAssociation",
                    "ssm:GetDeployablePatchSnapshotForInstance",
                    "ssm:GetDocument",
                    "ssm:DescribeDocument",
                    "ssm:GetManifest",
                    "ssm:GetParameter",
                    "ssm:GetParameters",
                    "ssm:ListAssociations",
                    "ssm:ListInstanceAssociations",
                    "ssm:PutInventory",
                    "ssm:PutComplianceItems",
                    "ssm:PutConfigurePackageResult",
                    "ssm:UpdateAssociationStatus",
                    "ssm:UpdateInstanceAssociationStatus",
                    "ssm:UpdateInstanceInformation"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ssmmessages:CreateControlChannel",
                    "ssmmessages:CreateDataChannel",
                    "ssmmessages:OpenControlChannel",
                    "ssmmessages:OpenDataChannel"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ec2messages:AcknowledgeMessage",
                    "ec2messages:DeleteMessage",
                    "ec2messages:FailMessage",
                    "ec2messages:GetEndpoint",
                    "ec2messages:GetMessages",
                    "ec2messages:SendReply"
                  ],
                  "Resource": "*"
                }
              ]
            }
          },
          {
            "PolicyName": "describe-tags-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "ec2:DescribeTags",
                  "Resource": "*"
                }
              ]
            }
          }
        ]
      }
    },
    "AttachInstanceProfileLambdaRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/",
        "Policies": [
          {
            "PolicyName": "attachprofile-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "cloudformation:DescribeStackResource",
                  "Resource": {
                    "Fn::Sub": "arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/*"
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": "iam:PassRole",
                  "Resource": {
                    "Fn::Sub": [
                      "arn:aws:iam::${AWS::AccountId}:role/${role}",
                      {
                        "role": {
                          "Fn::If": [
                            "UsePredefinedRole",
                            {
                              "Ref": "PredefinedRole"
                            },
                            {
                              "Ref": "CustomIamRole"
                            }
                          ]
                        }
                      }
                    ]
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": "ec2:AssociateIamInstanceProfile",
                  "Resource": {
                    "Fn::Sub": "arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:instance/*"
                  },
                  "Condition": {
                    "StringEquals": {
                      "aws:ResourceTag/aws:cloudformation:stack-name": {
                        "Ref": "AWS::StackName"
                      },
                      "aws:ResourceTag/aws:cloudformation:logical-id": "MATLABEC2Instance"
                    }
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": {
                    "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*"
                  }
                }
              ]
            }
          }
        ]
      }
    },
    "AttachInstanceProfileLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Role": {
          "Fn::GetAtt": [
            "AttachInstanceProfileLambdaRole",
            "Arn"
          ]
        },
        "Runtime": "python3.12",
        "Handler": "index.lambda_handler",
        "Timeout": "300",
        "Code": {
          "ZipFile": "# Copyright 2023 The MathWorks Inc.\nimport http, json, os, uuid, boto3\nfrom urllib.parse import urlparse\nfrom botocore.waiter import WaiterModel as Waiter, create_waiter_with_client as create_waiter\n\nINSTANCE_ID=os.environ['EC2_INSTANCE_ID']\nPROFILE_ID=os.environ['INSTANCE_PROFILE_ID']\nREGION=os.environ['AWS_REGION']\nLOG_GROUP='https://'+REGION+'.console.aws.amazon.com/cloudwatch/home?region='+REGION+'#logsV2:log-groups/log-group/$252Faws$252Flambda$252F'+os.environ['AWS_LAMBDA_FUNCTION_NAME']\n\ndef get_waiter_cfg(operation,argument,expected):\n    cfg={\"version\":2,\"waiters\":{\"CustomWaiter\":{\"delay\":2,\"operation\":operation,\"maxAttempts\":90,\"acceptors\":[{\"matcher\":\"path\",\"expected\":True,\"argument\":argument,\"state\":\"success\"},{\"matcher\":\"error\",\"expected\":expected,\"state\":\"retry\",\"argument\":\"Code\"}]}}}\n    return cfg\n\ndef get_resources(stack,response):\n    cfn=boto3.client('cloudformation')\n    res={}\n    waiter_cfg=get_waiter_cfg(\"DescribeStackResource\",\"StackResourceDetail.ResourceStatus==`CREATE_IN_PROGRESS` || StackResourceDetail.ResourceStatus==`CREATE_COMPLETE`\",\"ValidationError\")\n    waiter=create_waiter('CustomWaiter', Waiter(waiter_cfg), cfn)\n    for id in [INSTANCE_ID, PROFILE_ID]:\n        try:\n            waiter.wait(StackName=stack,LogicalResourceId=id)\n            resource=cfn.describe_stack_resource(StackName=stack,LogicalResourceId=id)\n            res[id]=resource['StackResourceDetail']['PhysicalResourceId']\n        except Exception as E:\n            print(E)\n            response['Reason']='Failed to get information on EC2 instance or instance profile. Check the log stream under the CloudWatch log group: '+LOG_GROUP\n    return res\n\ndef send_response(request,response):\n    url=urlparse(request['ResponseURL'])\n    body=json.dumps(response)\n    https=http.client.HTTPSConnection(url.netloc)\n    https.request('PUT', url.path+'?'+url.query,body)\n    return response\n \ndef lambda_handler(event,context): \n    response={'StackId':event['StackId'],'RequestId':event['RequestId'],'LogicalResourceId':event['LogicalResourceId'],'Status':'SUCCESS'}\n    stack=str(event['StackId']).split('/')[1]\n    if 'PhysicalResourceId' in event:\n        response['PhysicalResourceId']=event['PhysicalResourceId']\n    else:\n        response['PhysicalResourceId']=str(uuid.uuid4())\n    if event['RequestType'] == 'Delete':\n        return send_response(event,response)\n    try:\n        ec2=boto3.client('ec2')\n        resources=get_resources(stack,response)\n        waiter_cfg=get_waiter_cfg(\"AssociateIamInstanceProfile\",\"IamInstanceProfileAssociation.State==`associated` || IamInstanceProfileAssociation.State==`associating`\",\"InvalidParameterValue\")\n        waiter=create_waiter('CustomWaiter', Waiter(waiter_cfg), ec2)\n        waiter.wait(IamInstanceProfile={'Name':resources[PROFILE_ID]},InstanceId=resources[INSTANCE_ID])\n        response['Reason']='Attached instance profile successfully'\n        print(response['Reason'])\n    except Exception as E:\n        print(E)\n        response['Status']='FAILED'\n        if 'Reason' not in response:\n           response['Reason']='Failed to attach instance profile to the EC2 instance. Check the log stream under the CloudWatch log group: '+LOG_GROUP\n    return send_response(event,response)"
        },
        "Environment": {
          "Variables": {
            "EC2_INSTANCE_ID": "MATLABEC2Instance",
            "INSTANCE_PROFILE_ID": "MATLABInstanceProfile"
          }
        }
      }
    },
    "AttachInstanceProfileToEC2": {
      "Type": "AWS::CloudFormation::CustomResource",
      "Version": "1.0",
      "Properties": {
        "ServiceToken": {
          "Fn::GetAtt": [
            "AttachInstanceProfileLambda",
            "Arn"
          ]
        }
      }
    },
    "MATLABInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Fn::If": [
              "UsePredefinedRole",
              {
                "Ref": "PredefinedRole"
              },
              {
                "Ref": "CustomIamRole"
              }
            ]
          }
        ]
      }
    },
    "MWSecurityGroup": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": "https://mathworks-reference-architectures-templates.s3.amazonaws.com/security-group/v1/0/0/security-group.yml",
        "Parameters": {
          "VpcId": {
            "Ref": "VPC"
          },
          "CidrIp": {
            "Ref": "ClientIPAddress"
          },
          "SSHAccess": "Yes",
          "RDPAccess": "Yes",
          "NICEDCVAccess": "Yes"
        }
      }
    },
    "MWLogLocation": {
      "Type": "AWS::CloudFormation::Stack",
      "Condition": "UseCloudWatch",
      "Properties": {
        "TemplateURL": "https://mathworks-reference-architectures-templates.s3.amazonaws.com/log-location/v1/0/0/log-location.yml"
      }
    },
    "MATLABEC2Instance": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "ImageId": {
          "Fn::If": [
            "UseCustomAMI",
            {
              "Ref": "CustomAmiId"
            },
            {
              "Fn::FindInMap": [
                "RegionMap",
                {
                  "Ref": "AWS::Region"
                },
                "AMI"
              ]
            }
          ]
        },
        "KeyName": {
          "Ref": "SSHKeyName"
        },
        "SecurityGroupIds": [
          {
            "Fn::GetAtt": [
              "MWSecurityGroup",
              "Outputs.SecurityGroupId"
            ]
          },
          {
            "Fn::If": [
              "AddSG",
              {
                "Ref": "AdditionalSecurityGroup"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          }
        ],
        "SubnetId": {
          "Ref": "Subnet"
        },
        "InstanceType": {
          "Ref": "InstanceType"
        },
        "EbsOptimized": "true",
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "VolumeSize": {
                "Ref": "RootVolumeSize"
              }
            }
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Ref": "InstanceName"
            }
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "\n",
              [
                "#!/bin/bash",
                "",
                "# Copyright 2022 The MathWorks, Inc.",
                "",
                "STARTUP_FOLDER=/opt/mathworks/startup",
                "# Load startup variables",
                "if [[ -r ${STARTUP_FOLDER}/.env ]]; then",
                "    set -o allexport",
                "    source ${STARTUP_FOLDER}/.env",
                "    set +o allexport",
                "fi",
                "",
                "# Define startup parameters",
                {
                  "Fn::Sub": [
                    "export PASSWORD=${PasswordBase64}",
                    {
                      "PasswordBase64": {
                        "Fn::Base64": {
                          "Ref": "Password"
                        }
                      }
                    }
                  ]
                },
                {
                  "Fn::Sub": "export MLM_LICENSE_FILE=${LicenseManager}"
                },
                {
                  "Fn::Sub": [
                    "export CLOUD_LOG_NAME=${LogGroupName}",
                    {
                      "LogGroupName": {
                        "Fn::If": [
                          "UseCloudWatch",
                          {
                            "Fn::GetAtt": [
                              "MWLogLocation",
                              "Outputs.LogGroupName"
                            ]
                          },
                          ""
                        ]
                      }
                    }
                  ]
                },
                {
                  "Fn::Sub": "export ACCESS_PROTOCOL='${AccessProtocol}'"
                },
                {
                  "Fn::Sub": "export OPTIONAL_USER_COMMAND='${OptionalUserCommand}'"
                },
                "",
                "# Run startup scripts",
                "mkdir -p /var/log/mathworks",
                "run-parts --exit-on-error --verbose --regex '^[0-9]+_.+$' ${STARTUP_FOLDER} >> /var/log/mathworks/startup.log 2>&1",
                "",
                "# Signal the status from cfn-init",
                {
                  "Fn::Sub": "/opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --region ${AWS::Region} --resource MATLABEC2Instance"
                }
              ]
            ]
          }
        }
      },
      "CreationPolicy": {
        "ResourceSignal": {
          "Timeout": "PT15M"
        }
      }
    },
    "ElasticIP": {
      "Type": "AWS::EC2::EIP",
      "Condition": "UseElasticIPAddress",
      "Properties": {
        "InstanceId": {
          "Ref": "MATLABEC2Instance"
        },
        "Domain": "vpc"
      }
    },
    "document": {
      "Type": "AWS::SSM::Document",
      "Condition": "UsePredefinedRole",
      "Properties": {
        "Content": {
          "schemaVersion": "2.2",
          "description": "Run a script on Linux instances.",
          "parameters": {
            "commands": {
              "type": "String",
              "description": "Run script to switch between xrdp and nice dcv.",
              "default": "/usr/local/bin/swap-desktop-solution.sh"
            }
          },
          "mainSteps": [
            {
              "action": "aws:runShellScript",
              "name": "runCommands",
              "inputs": {
                "timeoutSeconds": "60",
                "runCommand": [
                  "{{ commands }}"
                ]
              }
            }
          ]
        },
        "DocumentType": "Command",
        "Name": {
          "Fn::Select": [
            "2",
            {
              "Fn::Split": [
                "/",
                {
                  "Ref": "AWS::StackId"
                }
              ]
            }
          ]
        }
      }
    },
    "AutoShutdownLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "ZipFile": "# Copyright 2021-23 The MathWorks Inc.\nimport boto3,os,re\nfrom datetime import datetime as dt,timedelta\n\nec2=boto3.client(\"ec2\")\nDEFAULT_TIME_INTERVAL=os.environ['DEFAULT_TIME_INTERVAL']\n# Uniquely identify instance using AWS-provided stack-level tags\nres=ec2.describe_instances(Filters=[{'Name':'tag:aws:cloudformation:stack-name','Values':[os.environ['STACK_NAME']]},{'Name':'tag:aws:cloudformation:logical-id','Values':['MATLABEC2Instance']},{'Name': 'instance-state-name','Values': ['running', 'pending']}])\nINSTANCE=res[\"Reservations\"][0][\"Instances\"][0]\nINSTANCE_ID=INSTANCE[\"InstanceId\"]\nLOG_MESSAGES={\"instance-stopped\":\"Instance is stopped.\",\"tag-never\":\"Autoshutdown is not enabled. Change the value of mw-autoshutdown tag of the EC2 instance to enable the autoshutdown feature.\",\"tag-invalid\":\"The value of the mw-autoshutdown tag you have set is not valid. The format of the timestamp must be a valid RFC 1123 UTC timestamp, such as Thu, 16 Dec 2021 12:28:47 GMT.\",\"instance-booted\":\"Instance has just started. Setting mw-autoshutdown value.\",\"stop-instance\":\"Shutdown time has been reached. Shutting instance down.\",\"early-to-shutdown\":\"Shutdown time has not been reached yet. Too early to shutdown instance.\"}\nRET_VAL={\"statusCode\": 200}\n\ndef log_to_cloudwatch(id):\n    print(LOG_MESSAGES[id])\n\ndef get_start_time():\n    launch_time=INSTANCE[\"LaunchTime\"]\n    return re.sub(r\"\\+00:00\",\"\",str(launch_time))\n\ndef get_shutdown_tag():\n    tags=INSTANCE[\"Tags\"]\n    shutdown_tag=next((tag for tag in tags if tag[\"Key\"]==\"mw-autoshutdown\"), None)\n    return shutdown_tag\n\ndef set_shutdown_tag(shutdown_time):\n    ec2.create_tags(Resources=[INSTANCE_ID], Tags=[{\"Key\": \"mw-autoshutdown\",\"Value\": str(shutdown_time)}])\n\ndef set_shutdown_time():\n    time_interval=int(re.findall(\"[0-9]+\",DEFAULT_TIME_INTERVAL)[0])\n    launch_time=dt.fromisoformat(get_start_time())\n    shutdown_time=launch_time+timedelta(hours=int(time_interval))\n    shutdown_time_gmt=dt.strftime(shutdown_time,'%a, %d %b %Y %H:%M:%S GMT')\n    set_shutdown_tag(shutdown_time_gmt)\n\ndef lambda_handler(event, context):\n    # No action while the instance is stopped.\n    if INSTANCE[\"State\"][\"Name\"]==\"stopped\":\n        log_to_cloudwatch(id=\"instance-stopped\")\n        return RET_VAL\n    shutdown_tag=get_shutdown_tag()\n    # In the first function run, use DEFAULT_TIME_INTERVAL to determine what to do.\n    if shutdown_tag is None:\n        if DEFAULT_TIME_INTERVAL==\"Never\":\n            # Set the tag to \"never\".\n            set_shutdown_tag(\"never\")\n            # No action when tag is \"never\"\n            log_to_cloudwatch(id=\"tag-never\")\n            return RET_VAL\n        else:\n            # Set the tag to start time + user chosen time interval.\n            set_shutdown_time()\n            log_to_cloudwatch(id=\"instance-booted\")\n            return RET_VAL\n    # If the tag exists, use it to determine what to do.\n    if shutdown_tag[\"Value\"]==\"change_me_on_boot\":\n        set_shutdown_time()\n        log_to_cloudwatch(id=\"instance-booted\")\n        return RET_VAL\n    elif shutdown_tag[\"Value\"]==\"never\":\n        # No action when tag is \"never\"\n        log_to_cloudwatch(id=\"tag-never\")\n        return RET_VAL\n    else:\n        # Check the tag value to determine whether instance needs to be shutdown.\n        try:\n            shutdown_time=dt.strptime(shutdown_tag[\"Value\"],'%a, %d %b %Y %H:%M:%S GMT')\n        except ValueError:\n            log_to_cloudwatch(id=\"tag-invalid\")\n            return RET_VAL\n        curr_time=dt.now(shutdown_time.tzinfo)\n        if curr_time>shutdown_time:\n            ec2.stop_instances(InstanceIds=[INSTANCE_ID])\n            # Set the shutdown time as mw-last-autoshutdown-event tag\n            curr_time_gmt=dt.strftime(curr_time, '%a, %d %b %Y %H:%M:%S GMT')\n            ec2.create_tags(Resources=[INSTANCE_ID], Tags=[{\"Key\": \"mw-last-autoshutdown-event\",\"Value\": str(curr_time_gmt)}])\n            log_to_cloudwatch(id=\"stop-instance\")\n            if DEFAULT_TIME_INTERVAL==\"Never\":\n                set_shutdown_tag(\"never\")\n            else:\n                set_shutdown_tag(\"change_me_on_boot\")\n            return RET_VAL\n        else:\n            log_to_cloudwatch(id=\"early-to-shutdown\")\n            return RET_VAL"
        },
        "Environment": {
          "Variables": {
            "DEFAULT_TIME_INTERVAL": {
              "Ref": "AutoShutdown"
            },
            "STACK_NAME": {
              "Ref": "AWS::StackName"
            }
          }
        },
        "Handler": "index.lambda_handler",
        "Runtime": "python3.12",
        "Timeout": "60",
        "Role": {
          "Fn::GetAtt": [
            "AutoShutdownLambdaRole",
            "Arn"
          ]
        }
      }
    },
    "AutoShutdownLambdaRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/",
        "Policies": [
          {
            "PolicyName": "autoshutdown-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "ec2:DescribeInstances",
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": "ec2:DescribeTags",
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": "ec2:Stopinstances",
                  "Resource": {
                    "Fn::Sub": "arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:instance/*"
                  },
                  "Condition": {
                    "StringEquals": {
                      "aws:ResourceTag/aws:cloudformation:stack-name": {
                        "Ref": "AWS::StackName"
                      },
                      "aws:ResourceTag/aws:cloudformation:logical-id": "MATLABEC2Instance"
                    }
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": "ec2:CreateTags",
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": "ec2:DeleteTags",
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": {
                    "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*"
                  }
                }
              ]
            }
          }
        ]
      }
    },
    "AutoShutdownScheduledRule": {
      "Type": "AWS::Events::Rule",
      "Properties": {
        "Description": "AutoShutdownScheduledRule",
        "ScheduleExpression": "rate(15 minutes)",
        "State": "ENABLED",
        "Targets": [
          {
            "Arn": {
              "Fn::GetAtt": [
                "AutoShutdownLambda",
                "Arn"
              ]
            },
            "Id": "TargetFunctionV1"
          }
        ]
      }
    },
    "PermissionForEventsToInvokeLambda": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": {
          "Ref": "AutoShutdownLambda"
        },
        "Action": "lambda:InvokeFunction",
        "Principal": "events.amazonaws.com",
        "SourceArn": {
          "Fn::GetAtt": [
            "AutoShutdownScheduledRule",
            "Arn"
          ]
        }
      }
    },
    "AutoShutdownLambdaLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": {
          "Fn::Join": [
            "",
            [
              "/aws/lambda/",
              {
                "Ref": "AutoShutdownLambda"
              }
            ]
          ]
        }
      }
    }
  },
  "Parameters": {
    "InstanceType": {
      "Description": "AWS instance type to use for MATLAB. See https://aws.amazon.com/ec2/instance-types for a list of instance types.",
      "Default": "m5.xlarge",
      "Type": "String"
    },
    "InstanceName": {
      "Description": "Name for the MATLAB virtual machine",
      "Default": "MATLAB Desktop",
      "Type": "String"
    },
    "AccessProtocol": {
      "Description": "Access protocol to connect to this instance",
      "Default": "RDP",
      "Type": "String",
      "AllowedValues": [
        "NICE DCV",
        "RDP"
      ]
    },
    "UseElasticIpAddress": {
      "Description": "Flag indicating whether you want to keep the same public IP address for the instance",
      "Default": "No",
      "Type": "String",
      "AllowedValues": [
        "Yes",
        "No"
      ]
    },
    "RootVolumeSize": {
      "Description": "Size in GB of the root volume",
      "Default": "128",
      "Type": "Number",
      "MinValue": "128",
      "MaxValue": "1024",
      "ConstraintDescription": "Size must be between 128 and 1024GB"
    },
    "CustomIamRole": {
      "Description": "Name of a custom IAM Role to associate with this instance. If not specified, a predefined role is used. If specified, features requiring special permissions will be unavailable (NICE DCV, CloudWatch, IAM Policies).",
      "Default": "",
      "Type": "String"
    },
    "AdditionalIamPolicies": {
      "Description": "Semicolon-delimited list of IAM Policy ARNs to add to the predefined role. This option cannot be used with a custom IAM Role.",
      "Default": "",
      "Type": "String",
      "AllowedPattern": "^(arn:[^:;]+:iam::[^:;]+:policy/[^:;]+(;arn:[^:;]+:iam::[^:;]+:policy/[^:;]+)*)?$",
      "ConstraintDescription": "If specified, must be a semicolon (;) delimited list of ARNs (arn:<partition>:iam::<account-id>:policy/<resource-id>)."
    },
    "VPC": {
      "Description": "ID of an existing VPC in which to deploy this stack",
      "Type": "AWS::EC2::VPC::Id",
      "ConstraintDescription": "Must be the ID of an existing VPC.",
      "AllowedPattern": ".+"
    },
    "Subnet": {
      "Description": "ID of an existing subnet. To access the instance from anywhere, ensure that your subnet auto-assigns public IP addresses and is connected to the internet.",
      "Type": "AWS::EC2::Subnet::Id",
      "ConstraintDescription": "Must be the ID of an existing Subnet within the chosen VPC.",
      "AllowedPattern": ".+"
    },
    "SSHKeyName": {
      "Description": "Name of an existing EC2 KeyPair to allow SSH access to all the instances. See https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html for details on creating these.",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "ConstraintDescription": "Must be the name of an existing EC2 KeyPair.",
      "AllowedPattern": ".+"
    },
    "ClientIPAddress": {
      "Description": "IP address range that will be allowed to connect to this instance from outside of the VPC. This field should be formatted as <ip_address>/<mask>. E.g. 10.0.0.1/32. This is the public IP address which can be found by searching for 'what is my ip address' on the web. The mask determines the number of IP addresses to include. A mask of 32 is a single IP address. This calculator can be used to build a specific range: https://www.ipaddressguide.com/cidr. You may need to contact your IT administrator to determine which address is appropriate.",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription": "Must be a valid IP CIDR range of the form x.x.x.x/x."
    },
    "Password": {
      "NoEcho": "true",
      "Description": "Password for the \"ubuntu\" user",
      "Type": "String",
      "ConstraintDescription": "",
      "Default": ""
    },
    "ConfirmPassword": {
      "NoEcho": "true",
      "Description": "Confirm Password",
      "Type": "String",
      "ConstraintDescription": "",
      "Default": ""
    },
    "LicenseManager": {
      "Description": "Optional License Manager for MATLAB, specified as a string in the form <port>@<hostname>. If not specified, use online licensing. If specified, the network license manager (NLM) must be accessible from the specified VPC and subnets. To use the private hostname of the NLM hub instead of the public hostname, specify the security group ID of the NLM hub in the AdditionalSecurityGroup parameter. For more information, see https://github.com/mathworks-ref-arch/license-manager-for-matlab-on-aws.",
      "Type": "String",
      "Default": "",
      "AllowedPattern": "([0-9]+@[a-zA-Z0-9.\\-]+)?",
      "ConstraintDescription": "If specified, must be in the form <port>@<hostname>"
    },
    "EnableCloudWatch": {
      "Description": "Flag indicating whether cloudwatch logging for the MATLAB instance is enabled.",
      "Type": "String",
      "AllowedValues": [
        "Yes",
        "No"
      ],
      "Default": "No"
    },
    "AutoShutdown": {
      "Description": "Choose whether you want to enable autoshutdown for your instance after a certain number of hours",
      "Type": "String",
      "AllowedValues": [
        "Never",
        "After 1 hour",
        "After 2 hours",
        "After 3 hours",
        "After 4 hours",
        "After 5 hours",
        "After 6 hours",
        "After 7 hours",
        "After 8 hours",
        "After 9 hours",
        "After 10 hours",
        "After 11 hours",
        "After 12 hours",
        "After 13 hours",
        "After 14 hours",
        "After 15 hours",
        "After 16 hours",
        "After 17 hours",
        "After 18 hours",
        "After 19 hours",
        "After 20 hours",
        "After 21 hours",
        "After 22 hours",
        "After 23 hours",
        "After 24 hours"
      ],
      "Default": "Never"
    },
    "AdditionalSecurityGroup": {
      "Description": "ID of an additional (optional) Security Group for the instances to be placed in. Often the License Manager for MATLAB's Security Group.",
      "Type": "String",
      "Default": ""
    },
    "CustomAmiId": {
      "Default": "",
      "Description": "ID of a custom Amazon Machine Image (AMI) in the target region (optional). If the build has been customized then the resulting machine image may no longer be compatible with the provided CloudFormation template. Compatability can in some cases be restored by making corresponding modifications to the CloudFormation template. The ID should start with 'ami-'.",
      "Type": "String"
    },
    "OptionalUserCommand": {
      "Description": "Provide an optional inline shell command to run on machine launch. For example, to set an environment variable CLOUD=AWS, use this command excluding the angle brackets: <echo -e \"export CLOUD=AWS\" | tee -a /etc/profile.d/setenvvar.sh && source /etc/profile>. To run an external script, use this command excluding the angle brackets: <wget -O /tmp/my-script.sh \"https://www.example.com/script.sh\" && bash /tmp/my-script.sh>. Find the logs at '/var/log/mathworks/startup.log'.",
      "Type": "String",
      "Default": ""
    }
  },
  "Rules": {
    "matchPasswords": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "Password"
              },
              {
                "Ref": "ConfirmPassword"
              }
            ]
          },
          "AssertDescription": "Passwords do not match"
        }
      ]
    },
    "SubnetInVPC": {
      "Assertions": [
        {
          "Assert": {
            "Fn::EachMemberEquals": [
              {
                "Fn::ValueOfAll": [
                  "AWS::EC2::Subnet::Id",
                  "VpcId"
                ]
              },
              {
                "Ref": "VPC"
              }
            ]
          },
          "AssertDescription": "Subnet must exist in the VPC you have selected"
        }
      ]
    },
    "NoAdditionalPoliciesOnCustomRole": {
      "RuleCondition": {
        "Fn::Not": [
          {
            "Fn::Equals": [
              {
                "Ref": "CustomIamRole"
              },
              ""
            ]
          }
        ]
      },
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "AdditionalIamPolicies"
              },
              ""
            ]
          },
          "AssertDescription": "You cannot add IAM Policies when using a custom IAM Role."
        }
      ]
    },
    "MultipleRolesMustNotExist": {
      "RuleCondition": {
        "Fn::Not": [
          {
            "Fn::Equals": [
              {
                "Ref": "CustomIamRole"
              },
              ""
            ]
          }
        ]
      },
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "EnableCloudWatch"
              },
              "No"
            ]
          },
          "AssertDescription": "You cannot use CloudWatch when using a custom IAM role. The deployment will create an IAM role which you can later modify with additional policies if needed."
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "AccessProtocol"
                  },
                  "NICE DCV"
                ]
              }
            ]
          },
          "AssertDescription": "You cannot use NICE DCV when using a custom IAM role. The deployment will create an IAM role which you can later modify with additional policies if needed."
        }
      ]
    }
  },
  "Conditions": {
    "UsePredefinedRole": {
      "Fn::Equals": [
        {
          "Ref": "CustomIamRole"
        },
        ""
      ]
    },
    "UseCustomIamRole": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "CustomIamRole"
            },
            ""
          ]
        }
      ]
    },
    "UseAdditionalPolicies": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalIamPolicies"
            },
            ""
          ]
        }
      ]
    },
    "UseCloudWatch": {
      "Fn::Equals": [
        {
          "Ref": "EnableCloudWatch"
        },
        "Yes"
      ]
    },
    "UseNICEDCV": {
      "Fn::Equals": [
        {
          "Ref": "AccessProtocol"
        },
        "NICE DCV"
      ]
    },
    "UseXRDP": {
      "Fn::Equals": [
        {
          "Ref": "AccessProtocol"
        },
        "RDP"
      ]
    },
    "UseElasticIPAddress": {
      "Fn::Equals": [
        {
          "Ref": "UseElasticIpAddress"
        },
        "Yes"
      ]
    },
    "UseCustomAMI": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "CustomAmiId"
            },
            ""
          ]
        }
      ]
    },
    "AddSG": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalSecurityGroup"
            },
            ""
          ]
        }
      ]
    }
  },
  "Outputs": {
    "CloudWatchLogs": {
      "Condition": "UseCloudWatch",
      "Description": "The cloudwatch logs containing logging information about the MATLAB instance",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://console.aws.amazon.com/cloudwatch/home?region=",
            {
              "Ref": "AWS::Region"
            },
            "#logsV2:log-groups/log-group/",
            {
              "Fn::GetAtt": [
                "MWLogLocation",
                "Outputs.LogGroupName"
              ]
            }
          ]
        ]
      }
    },
    "NiceDCVConnection": {
      "Condition": "UseNICEDCV",
      "Description": "Public url of the newly created EC2 instance to connect to the session via NICE DCV",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://",
            {
              "Fn::GetAtt": [
                "MATLABEC2Instance",
                "PublicDnsName"
              ]
            },
            ":8443/#console"
          ]
        ]
      }
    },
    "RDPConnection": {
      "Condition": "UseXRDP",
      "Description": "Public DNSName of the newly created EC2 instance",
      "Value": {
        "Fn::GetAtt": [
          "MATLABEC2Instance",
          "PublicDnsName"
        ]
      }
    }
  },
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "EC2 Instance"
          },
          "Parameters": [
            "InstanceName",
            "InstanceType",
            "RootVolumeSize",
            "CustomIamRole",
            "AdditionalIamPolicies"
          ]
        },
        {
          "Label": {
            "default": "Remote Access"
          },
          "Parameters": [
            "AccessProtocol",
            "UseElasticIpAddress",
            "ClientIPAddress",
            "SSHKeyName",
            "Password",
            "ConfirmPassword"
          ]
        },
        {
          "Label": {
            "default": "Network Configuration"
          },
          "Parameters": [
            "VPC",
            "Subnet",
            "AdditionalSecurityGroup"
          ]
        },
        {
          "Label": {
            "default": "License Configuration"
          },
          "Parameters": [
            "LicenseManager"
          ]
        },
        {
          "Label": {
            "default": "Logging Configuration"
          },
          "Parameters": [
            "EnableCloudWatch"
          ]
        },
        {
          "Label": {
            "default": "Autoshutdown Configuration"
          },
          "Parameters": [
            "AutoShutdown"
          ]
        },
        {
          "Label": {
            "default": "Custom AMI"
          },
          "Parameters": [
            "CustomAmiId"
          ]
        },
        {
          "Label": {
            "default": "Optional User Command"
          },
          "Parameters": [
            "OptionalUserCommand"
          ]
        }
      ],
      "ParameterLabels": {
        "ClientIPAddress": {
          "default": "Allow connections from"
        },
        "UseElasticIpAddress": {
          "default": "Keep public ip the same"
        },
        "InstanceType": {
          "default": "AWS EC2 Instance type"
        },
        "InstanceName": {
          "default": "Instance Name"
        },
        "RootVolumeSize": {
          "default": "Storage Size (GiB)"
        },
        "CustomIamRole": {
          "default": "Custom IAM Role (Optional)"
        },
        "AdditionalIamPolicies": {
          "default": "Additional IAM Policies (Optional)"
        },
        "VPC": {
          "default": "VPC to deploy this stack to"
        },
        "Subnet": {
          "default": "Subnet"
        },
        "Password": {
          "default": "Remote password"
        },
        "ConfirmPassword": {
          "default": "Confirm remote password"
        },
        "SSHKeyName": {
          "default": "SSH Key Pair"
        },
        "LicenseManager": {
          "default": "License Manager for MATLAB connection string"
        },
        "AdditionalSecurityGroup": {
          "default": "Additional security group to place instances in"
        },
        "EnableCloudWatch": {
          "default": "Configure cloudwatch logging for the MATLAB instance"
        },
        "AccessProtocol": {
          "default": "Remote access protocol"
        },
        "CustomAmiId": {
          "default": "Custom AMI ID (Optional)"
        },
        "OptionalUserCommand": {
          "default": "Optional user inline command"
        }
      }
    }
  }
}
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2021b/README.md">
# MATLAB on Amazon Web Services (Linux VM)

## Step 1. Launch the Template

Click the **Launch Stack** button to deploy a standalone MATLAB&reg; desktop client on AWS&reg;. This will open the CloudFormation Create Stack screen in your web browser.

| Region | Launch Link |
| --------------- | ----------- |
| **us-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-east-1.console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021b/aws-matlab-template.json) |
| **us-east-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-east-2.console.aws.amazon.com/cloudformation/home?region=us-east-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021b/aws-matlab-template.json) |
| **us-west-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-west-1.console.aws.amazon.com/cloudformation/home?region=us-west-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021b/aws-matlab-template.json) |
| **us-west-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-west-2.console.aws.amazon.com/cloudformation/home?region=us-west-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021b/aws-matlab-template.json) |
| **ca-central-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ca-central-1.console.aws.amazon.com/cloudformation/home?region=ca-central-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021b/aws-matlab-template.json) |
| **eu-central-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-central-1.console.aws.amazon.com/cloudformation/home?region=eu-central-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021b/aws-matlab-template.json) |
| **eu-west-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-1.console.aws.amazon.com/cloudformation/home?region=eu-west-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021b/aws-matlab-template.json) |
| **eu-west-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-2.console.aws.amazon.com/cloudformation/home?region=eu-west-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021b/aws-matlab-template.json) |
| **eu-west-3** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-3.console.aws.amazon.com/cloudformation/home?region=eu-west-3#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021b/aws-matlab-template.json) |
| **eu-north-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-north-1.console.aws.amazon.com/cloudformation/home?region=eu-north-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021b/aws-matlab-template.json) |
| **sa-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://sa-east-1.console.aws.amazon.com/cloudformation/home?region=sa-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021b/aws-matlab-template.json) |
| **me-south-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://me-south-1.console.aws.amazon.com/cloudformation/home?region=me-south-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021b/aws-matlab-template.json) |
| **ap-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-east-1.console.aws.amazon.com/cloudformation/home?region=ap-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021b/aws-matlab-template.json) |
| **ap-south-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-south-1.console.aws.amazon.com/cloudformation/home?region=ap-south-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021b/aws-matlab-template.json) |
| **ap-northeast-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-northeast-1.console.aws.amazon.com/cloudformation/home?region=ap-northeast-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021b/aws-matlab-template.json) |
| **ap-northeast-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-northeast-2.console.aws.amazon.com/cloudformation/home?region=ap-northeast-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021b/aws-matlab-template.json) |
| **ap-southeast-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-southeast-1.console.aws.amazon.com/cloudformation/home?region=ap-southeast-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021b/aws-matlab-template.json) |
| **ap-southeast-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-southeast-2.console.aws.amazon.com/cloudformation/home?region=ap-southeast-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2021b/aws-matlab-template.json) |


**Note**: Creating a stack on AWS can take a few minutes.

## Step 2. Configure the Cloud Resources
After you click the Launch Stack button above, the “Create stack” page will open in your browser where you can configure the parameters. It is easier to complete the steps if you position these instructions and the AWS console window side by side.

1. Specify a stack name. This will be shown in the AWS CloudFormation console and must be unique within the AWS account.


2. Specify and check the defaults for these resource parameters:

| Parameter label | Description |
| --------------- | ----------- |
| **AWS EC2 Instance type** | AWS instance type to use for MATLAB. See https://aws.amazon.com/ec2/instance-types for a list of instance types. |
| **Instance Name** | Name for the MATLAB virtual machine |
| **Remote access protocol** | Access protocol to connect to this instance |
| **Keep public ip the same** | Flag indicating whether you want to keep the same public IP address for the instance |
| **Storage Size (GiB)** | Size in GB of the root volume |
| **Custom IAM Role (Optional)** | Name of a custom IAM Role to associate with this instance. If not specified, a predefined role is used. If specified, features requiring special permissions will be unavailable (NICE DCV, CloudWatch, IAM Policies). |
| **Additional IAM Policies (Optional)** | Semicolon-delimited list of IAM Policy ARNs to add to the predefined role. This option cannot be used with a custom IAM Role. |
| **VPC to deploy this stack to** | ID of an existing VPC in which to deploy this stack |
| **Subnet** | ID of an existing subnet. To access the instance from anywhere, ensure that your subnet auto-assigns public IP addresses and is connected to the internet. |
| **SSH Key Pair** | Name of an existing EC2 KeyPair to allow SSH access to all the instances. See https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html for details on creating these. |
| **Allow connections from** | IP address range that will be allowed to connect to this instance from outside of the VPC. This field should be formatted as \<ip_address>/\<mask>. E.g. 10.0.0.1/32. This is the public IP address which can be found by searching for 'what is my ip address' on the web. The mask determines the number of IP addresses to include. A mask of 32 is a single IP address. This calculator can be used to build a specific range: https://www.ipaddressguide.com/cidr. You may need to contact your IT administrator to determine which address is appropriate. |
| **Remote password** | Password for the "ubuntu" user |
| **Confirm remote password** | Confirm Password |
| **License Manager for MATLAB connection string** | Optional License Manager for MATLAB, specified as a string in the form \<port>@\<hostname>. If not specified, use online licensing. If specified, the network license manager (NLM) must be accessible from the specified VPC and subnets. To use the private hostname of the NLM hub instead of the public hostname, specify the security group ID of the NLM hub in the AdditionalSecurityGroup parameter. For more information, see https://github.com/mathworks-ref-arch/license-manager-for-matlab-on-aws. |
| **Configure cloudwatch logging for the MATLAB instance** | Flag indicating whether cloudwatch logging for the MATLAB instance is enabled. |
| **AutoShutdown** | Choose whether you want to enable autoshutdown for your instance after a certain number of hours |
| **Additional security group to place instances in** | ID of an additional (optional) Security Group for the instances to be placed in. Often the License Manager for MATLAB's Security Group. |
| **Custom AMI ID (Optional)** | ID of a custom Amazon Machine Image (AMI) in the target region (optional). If the build has been customized then the resulting machine image may no longer be compatible with the provided CloudFormation template. Compatability can in some cases be restored by making corresponding modifications to the CloudFormation template. The ID should start with 'ami-'. |
| **Optional user inline command** | Provide an optional inline shell command to run on machine launch. For example, to set an environment variable CLOUD=AWS, use this command excluding the angle brackets: \<echo -e "export CLOUD=AWS" \| tee -a /etc/profile.d/setenvvar.sh && source /etc/profile>. To run an external script, use this command excluding the angle brackets: \<wget -O /tmp/my-script.sh "https://www.example.com/script.sh" && bash /tmp/my-script.sh>. Find the logs at '/var/log/mathworks/startup.log'. |


>**Note**: In the capabilities section, you must acknowledge that AWS Cloudformation might create IAM resources and autoexpand nested templates when creating the stack.

3. Click the **Create Stack** button.  The CloudFormation service will start creating the resources for the stack. <p>After clicking **Create** you will be taken to the *Stack Detail* page for your stack. Wait for the Status to reach **CREATE\_COMPLETE**. This may take up to 10 minutes.</p>

## Step 3. Connect to the Virtual Machine in the Cloud

If you chose RDP, then:
1. Expand the **Outputs** section in the the *Stack Detail* page.
1. Look for the key named `RDPConnection` and copy the corresponding public DNS name listed under value. *For example*: ec2-11-222-33-44.compute-1.amazonaws.com
1. Launch any remote desktop client, paste the public DNS name in the appropriate field, and connect. On the Windows Remote Desktop Client you need to paste the public DNS name in the **Computer** field and click **Connect**.
1. In the login screen that's displayed, use the username `ubuntu` and the password you specified while setting up the stack in [Step 2](#step-2-configure-the-stack).

If you chose NICE DCV, then:
1. Expand the **Outputs** section in the the *Stack Detail* page.
1. Look for the key named `NiceDCVConnection` and click on it
1. In the login screen that's displayed, use the username `ubuntu` and the password you specified while setting up the stack in [Step 2](#step-2-configure-the-stack).

## Step 4. Start MATLAB
Double-click the MATLAB icon on the virtual machine desktop to start MATLAB. The first time you start MATLAB, you need to enter your MathWorks&reg; Account credentials to license MATLAB. For other ways to license MATLAB, see [MATLAB Licensing in the Cloud](https://www.mathworks.com/help/install/license/licensing-for-mathworks-products-running-on-the-cloud.html).

>**Note**: It may take up to a minute for MATLAB to start the first time.


# Additional Information

## Delete Your Cloud Resources

Once you have finished using your stack, it is recommended that you delete all resources to avoid incurring further cost. To delete the stack, do the following:
1. Log in to the AWS Console.
1. Go to the AWS CloudFormation page and select the stack you created.
1. Click the **Actions** button and click **Delete Stack** from the menu that appears.

## Nested Stacks

This CloudFormation template uses nested stacks to reference templates used by multiple reference architectures. For details, see the [MathWorks Infrastructure as Code Building Blocks](https://github.com/mathworks-ref-arch/iac-building-blocks) repository.

## CloudWatch Logs
CloudWatch logs enables you to access logs from all the resources in your stack in a single place. To use CloudWatch logs, launch the stack with the feature "Configure cloudwatch logging for the MATLAB instance" enabled. Once the stack deployment is complete, you can access your logs in the "Outputs" of the stack by clicking the link next to "CloudWatchLogs". Note that if you delete the stack, the CloudWatch log group is also deleted. For more information, see [What is Amazon CloudWatch Logs?](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/WhatIsCloudWatchLogs.html).

----

Copyright 2018-2023 The MathWorks, Inc.

----
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2025a/aws-matlab-template.json">
{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Mappings": {
    "RegionMap": {
      "us-east-1": {
        "AMI": "ami-06554a9c16731eeb8"
      },
      "us-east-2": {
        "AMI": "ami-040d3396a95f96a53"
      },
      "us-west-1": {
        "AMI": "ami-008fa692586b3a464"
      },
      "us-west-2": {
        "AMI": "ami-0d36511676e466738"
      },
      "ca-central-1": {
        "AMI": "ami-076bccca90d726a8a"
      },
      "eu-central-1": {
        "AMI": "ami-0a0d9afe6067c43a7"
      },
      "eu-west-1": {
        "AMI": "ami-0f67bd11ca9761a60"
      },
      "eu-west-2": {
        "AMI": "ami-0b06db3d5a4316ec1"
      },
      "eu-west-3": {
        "AMI": "ami-0926d9cdd6dfae3d5"
      },
      "eu-north-1": {
        "AMI": "ami-0f28478b04fdc4018"
      },
      "sa-east-1": {
        "AMI": "ami-08a999de3522e24db"
      },
      "me-south-1": {
        "AMI": "ami-0858e50e785ef6f2f"
      },
      "ap-east-1": {
        "AMI": "ami-06e8e5a7300b3aab4"
      },
      "ap-south-1": {
        "AMI": "ami-008ce8a1c0d6e4482"
      },
      "ap-northeast-1": {
        "AMI": "ami-0afb5eb6c649b1a34"
      },
      "ap-northeast-2": {
        "AMI": "ami-015a345dd9eb5f0c5"
      },
      "ap-southeast-1": {
        "AMI": "ami-065781ef522f1ec89"
      },
      "ap-southeast-2": {
        "AMI": "ami-0bbbc1a62bf9f4480"
      }
    }
  },
  "Resources": {
    "PredefinedRole": {
      "Type": "AWS::IAM::Role",
      "Condition": "UsePredefinedRole",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "ec2.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/MW/",
        "ManagedPolicyArns": {
          "Fn::If": [
            "UseAdditionalPolicies",
            {
              "Fn::Split": [
                ";",
                {
                  "Ref": "AdditionalIamPolicies"
                }
              ]
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "Policies": [
          {
            "Fn::If": [
              "UseCloudWatch",
              {
                "PolicyName": "cloudwatch-access-policy",
                "PolicyDocument": {
                  "Version": "2012-10-17",
                  "Statement": [
                    {
                      "Effect": "Allow",
                      "Action": [
                        "logs:CreateLogStream",
                        "logs:DescribeLogStreams",
                        "logs:PutLogEvents"
                      ],
                      "Resource": {
                        "Fn::Sub": [
                          "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:${LogGroupName}:*",
                          {
                            "LogGroupName": {
                              "Ref": "MWLogLocation"
                            }
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          {
            "PolicyName": "dcv-access-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "s3:GetObject",
                  "Resource": {
                    "Fn::Sub": "arn:${AWS::Partition}:s3:::dcv-license.${AWS::Region}/*"
                  }
                }
              ]
            }
          },
          {
            "PolicyName": "ssm-access-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "ssm:DescribeAssociation",
                    "ssm:GetDeployablePatchSnapshotForInstance",
                    "ssm:GetDocument",
                    "ssm:DescribeDocument",
                    "ssm:GetManifest",
                    "ssm:GetParameter",
                    "ssm:GetParameters",
                    "ssm:ListAssociations",
                    "ssm:ListInstanceAssociations",
                    "ssm:PutInventory",
                    "ssm:PutComplianceItems",
                    "ssm:PutConfigurePackageResult",
                    "ssm:UpdateAssociationStatus",
                    "ssm:UpdateInstanceAssociationStatus",
                    "ssm:UpdateInstanceInformation"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ssmmessages:CreateControlChannel",
                    "ssmmessages:CreateDataChannel",
                    "ssmmessages:OpenControlChannel",
                    "ssmmessages:OpenDataChannel"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ec2messages:AcknowledgeMessage",
                    "ec2messages:DeleteMessage",
                    "ec2messages:FailMessage",
                    "ec2messages:GetEndpoint",
                    "ec2messages:GetMessages",
                    "ec2messages:SendReply"
                  ],
                  "Resource": "*"
                }
              ]
            }
          },
          {
            "PolicyName": "describe-tags-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "ec2:DescribeTags",
                  "Resource": "*"
                }
              ]
            }
          }
        ]
      }
    },
    "MATLABInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/MW/",
        "Roles": [
          {
            "Fn::If": [
              "UsePredefinedRole",
              {
                "Ref": "PredefinedRole"
              },
              {
                "Ref": "CustomIamRole"
              }
            ]
          }
        ]
      }
    },
    "EC2AutoShutdown": {
      "Type": "AWS::CloudFormation::Stack",
      "DeletionPolicy": "Delete",
      "UpdateReplacePolicy": "Delete",
      "Properties": {
        "TemplateURL": "https://mathworks-reference-architectures-templates.s3.amazonaws.com/ec2-shutdown-lambda/v1/0/1/ec2-shutdown-lambda.yml",
        "Parameters": {
          "EC2InstanceId": {
            "Ref": "MATLABEC2Instance"
          },
          "MathWorksProductId": "MathWorks-MATLAB-Linux",
          "ShutdownBehaviour": {
            "Ref": "AutoShutdown"
          },
          "TagToMonitor": "mw-autoshutdown",
          "AutoShutdownLambdaLogRetentionInDays": 1
        }
      }
    },
    "MWSecurityGroup": {
      "Type": "AWS::CloudFormation::Stack",
      "DeletionPolicy": "Delete",
      "UpdateReplacePolicy": "Delete",
      "Properties": {
        "TemplateURL": "https://mathworks-reference-architectures-templates.s3.amazonaws.com/security-group/v2/0/0/security-group.yml",
        "Parameters": {
          "VpcId": {
            "Ref": "VPC"
          },
          "CidrRanges": {
            "Ref": "ClientIPAddress"
          },
          "SSHAccess": "Yes",
          "RDPAccess": "Yes",
          "NICEDCVAccess": "Yes",
          "MATLABProxyAccess": "Yes"
        }
      }
    },
    "MWLogLocation": {
      "Type": "AWS::Logs::LogGroup",
      "Condition": "UseCloudWatch"
    },
    "MATLABEC2Instance": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "ImageId": {
          "Fn::If": [
            "UseCustomAMI",
            {
              "Ref": "CustomAmiId"
            },
            {
              "Fn::FindInMap": [
                "RegionMap",
                {
                  "Ref": "AWS::Region"
                },
                "AMI"
              ]
            }
          ]
        },
        "KeyName": {
          "Ref": "SSHKeyName"
        },
        "SecurityGroupIds": [
          {
            "Fn::GetAtt": [
              "MWSecurityGroup",
              "Outputs.SecurityGroupId"
            ]
          },
          {
            "Fn::If": [
              "AddSG",
              {
                "Ref": "AdditionalSecurityGroup"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          }
        ],
        "SubnetId": {
          "Ref": "Subnet"
        },
        "InstanceType": {
          "Ref": "InstanceType"
        },
        "IamInstanceProfile": {
          "Ref": "MATLABInstanceProfile"
        },
        "EbsOptimized": "true",
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "VolumeSize": {
                "Ref": "RootVolumeSize"
              }
            }
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Ref": "InstanceName"
            }
          },
          {
            "Key": "mw-ProductID",
            "Value": "MathWorks-MATLAB-Linux"
          },
          {
            "Key": "mw-StackName",
            "Value": {
              "Ref": "AWS::StackName"
            }
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "\n",
              [
                "#!/bin/bash",
                "",
                "# Copyright 2022 The MathWorks, Inc.",
                "",
                "STARTUP_FOLDER=/opt/mathworks/startup",
                "# Load startup variables",
                "if [[ -r ${STARTUP_FOLDER}/.env ]]; then",
                "    set -o allexport",
                "    source ${STARTUP_FOLDER}/.env",
                "    set +o allexport",
                "fi",
                "",
                "# Define startup parameters",
                {
                  "Fn::Sub": [
                    "export PASSWORD=${PasswordBase64}",
                    {
                      "PasswordBase64": {
                        "Fn::Base64": {
                          "Ref": "Password"
                        }
                      }
                    }
                  ]
                },
                {
                  "Fn::Sub": "export MLM_LICENSE_FILE=${LicenseManager}"
                },
                {
                  "Fn::Sub": [
                    "export CLOUD_LOG_NAME=${LogGroupName}",
                    {
                      "LogGroupName": {
                        "Fn::If": [
                          "UseCloudWatch",
                          {
                            "Ref": "MWLogLocation"
                          },
                          ""
                        ]
                      }
                    }
                  ]
                },
                {
                  "Fn::Sub": "export ACCESS_PROTOCOL='${AccessProtocol}'"
                },
                {
                  "Fn::Sub": "export ENABLE_MATLAB_PROXY='${EnableMATLABProxy}'"
                },
                {
                  "Fn::Sub": "export OPTIONAL_USER_COMMAND='${OptionalUserCommand}'"
                },
                "",
                "# Run startup scripts",
                "mkdir -p /var/log/mathworks",
                "run-parts --exit-on-error --verbose --regex '^[0-9]+_.+$' ${STARTUP_FOLDER} >> /var/log/mathworks/startup.log 2>&1",
                "",
                "# Signal the status from cfn-init",
                {
                  "Fn::Sub": "/opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --region ${AWS::Region} --resource MATLABEC2Instance"
                }
              ]
            ]
          }
        }
      },
      "CreationPolicy": {
        "ResourceSignal": {
          "Timeout": "PT15M"
        }
      }
    },
    "ElasticIP": {
      "Type": "AWS::EC2::EIP",
      "Condition": "UseElasticIPAddress",
      "Properties": {
        "InstanceId": {
          "Ref": "MATLABEC2Instance"
        },
        "Domain": "vpc"
      }
    },
    "document": {
      "Type": "AWS::SSM::Document",
      "Condition": "UsePredefinedRole",
      "Properties": {
        "DocumentType": "Command",
        "Content": {
          "schemaVersion": "2.2",
          "description": "Run a script on Linux instances.",
          "parameters": {
            "commands": {
              "type": "String",
              "description": "Command to run on EC2 instance",
              "default": "echo 'Hello World'"
            }
          },
          "mainSteps": [
            {
              "action": "aws:runShellScript",
              "name": "runCommands",
              "inputs": {
                "timeoutSeconds": "60",
                "runCommand": [
                  "{{ commands }}"
                ]
              }
            }
          ]
        }
      }
    }
  },
  "Parameters": {
    "InstanceType": {
      "Description": "AWS instance type to use for MATLAB. See https://aws.amazon.com/ec2/instance-types for a list of instance types.",
      "Default": "m5.xlarge",
      "Type": "String"
    },
    "InstanceName": {
      "Description": "Name for the MATLAB virtual machine",
      "Default": "MATLAB Desktop",
      "Type": "String"
    },
    "AccessProtocol": {
      "Description": "Access protocol to connect to this instance",
      "Default": "RDP",
      "Type": "String",
      "AllowedValues": [
        "NICE DCV",
        "RDP"
      ]
    },
    "EnableMATLABProxy": {
      "Description": "Option that enables access to MATLAB on your cloud instance within a browser. Opening MATLAB in a browser opens a separate MATLAB session to your Remote Desktop Protocol (RDP) session or NICE DCV session.",
      "Default": "Yes",
      "Type": "String",
      "AllowedValues": [
        "Yes",
        "No"
      ]
    },
    "UseElasticIpAddress": {
      "Description": "Flag indicating whether you want to keep the same public IP address for the instance",
      "Default": "No",
      "Type": "String",
      "AllowedValues": [
        "Yes",
        "No"
      ]
    },
    "RootVolumeSize": {
      "Description": "Size in GB of the root volume",
      "Default": "128",
      "Type": "Number",
      "MinValue": "128",
      "MaxValue": "1024",
      "ConstraintDescription": "Size must be between 128 and 1024GB"
    },
    "CustomIamRole": {
      "Description": "Name of a custom IAM Role to associate with this instance. If not specified, a predefined role is used. If specified, features requiring special permissions will be unavailable (NICE DCV, CloudWatch, IAM Policies).",
      "Default": "",
      "Type": "String"
    },
    "AdditionalIamPolicies": {
      "Description": "Semicolon-delimited list of IAM Policy ARNs to add to the predefined role. This option cannot be used with a custom IAM Role.",
      "Default": "",
      "Type": "String",
      "AllowedPattern": "^(arn:[^:;]+:iam::[^:;]+:policy/[^:;]+(;arn:[^:;]+:iam::[^:;]+:policy/[^:;]+)*)?$",
      "ConstraintDescription": "If specified, must be a semicolon (;) delimited list of ARNs (arn:<partition>:iam::<account-id>:policy/<resource-id>)."
    },
    "VPC": {
      "Description": "ID of an existing VPC in which to deploy this stack",
      "Type": "AWS::EC2::VPC::Id",
      "ConstraintDescription": "Must be the ID of an existing VPC.",
      "AllowedPattern": ".+"
    },
    "Subnet": {
      "Description": "ID of an existing subnet. To access the instance from anywhere, ensure that your subnet auto-assigns public IP addresses and is connected to the internet.",
      "Type": "AWS::EC2::Subnet::Id",
      "ConstraintDescription": "Must be the ID of an existing Subnet within the chosen VPC.",
      "AllowedPattern": ".+"
    },
    "SSHKeyName": {
      "Description": "Name of an existing EC2 KeyPair to allow SSH access to all the instances. See https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html for details on creating these.",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "ConstraintDescription": "Must be the name of an existing EC2 KeyPair.",
      "AllowedPattern": ".+"
    },
    "ClientIPAddress": {
      "Description": "Comma-separated list of IP address ranges that will be allowed to connect to this instance. Each IP CIDR should be formatted as <ip_address>/<mask>. The mask determines the number of IP addresses to include. A mask of 32 is a single IP address. Example of allowed values: 10.0.0.1/32 or 10.0.0.0/16,192.34.56.78/32. This calculator can be used to build a specific range: https://www.ipaddressguide.com/cidr. You may need to contact your IT administrator to determine which address is appropriate.",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "189",
      "AllowedPattern": "^((\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2}))(,((\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2}))){0,9}$",
      "ConstraintDescription": "Must be a comma-separated list of valid IP CIDR ranges of the form x.x.x.x/x. A maximum of 10 such IP CIDRs are allowed in the list."
    },
    "Password": {
      "NoEcho": "true",
      "Description": "Password for the \"ubuntu\" user. You also need to enter this as an authentication token to access MATLAB on your cloud instance within a browser.",
      "Type": "String",
      "ConstraintDescription": "Must have a minimum of 14 characters, 1 uppercase letter, 1 lowercase letter, 1 number, and 1 special character",
      "AllowedPattern": "^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[^a-zA-Z0-9]).{14,}$"
    },
    "ConfirmPassword": {
      "NoEcho": "true",
      "Description": "Confirm Password",
      "Type": "String"
    },
    "LicenseManager": {
      "Description": "Optional License Manager for MATLAB, specified as a string in the form <port>@<hostname>. If not specified, use online licensing. If specified, the network license manager (NLM) must be accessible from the specified VPC and subnets. To use the private hostname of the NLM hub instead of the public hostname, specify the security group ID of the NLM hub in the AdditionalSecurityGroup parameter. For more information, see https://github.com/mathworks-ref-arch/license-manager-for-matlab-on-aws.",
      "Type": "String",
      "Default": "",
      "AllowedPattern": "([0-9]+@[a-zA-Z0-9.\\-]+)?",
      "ConstraintDescription": "If specified, must be in the form <port>@<hostname>"
    },
    "EnableCloudWatch": {
      "Description": "Flag indicating whether cloudwatch logging for the MATLAB instance is enabled.",
      "Type": "String",
      "AllowedValues": [
        "Yes",
        "No"
      ],
      "Default": "No"
    },
    "AutoShutdown": {
      "Description": "Choose whether you want to enable autoshutdown for your instance after a certain number of hours",
      "Type": "String",
      "AllowedValues": [
        "Never",
        "After 1 hour",
        "After 2 hours",
        "After 3 hours",
        "After 4 hours",
        "After 5 hours",
        "After 6 hours",
        "After 7 hours",
        "After 8 hours",
        "After 9 hours",
        "After 10 hours",
        "After 11 hours",
        "After 12 hours",
        "After 13 hours",
        "After 14 hours",
        "After 15 hours",
        "After 16 hours",
        "After 17 hours",
        "After 18 hours",
        "After 19 hours",
        "After 20 hours",
        "After 21 hours",
        "After 22 hours",
        "After 23 hours",
        "After 24 hours"
      ],
      "Default": "Never"
    },
    "AdditionalSecurityGroup": {
      "Description": "ID of an additional (optional) Security Group for the instances to be placed in. Often the License Manager for MATLAB's Security Group.",
      "Type": "String",
      "Default": ""
    },
    "CustomAmiId": {
      "Default": "",
      "Description": "ID of a custom Amazon Machine Image (AMI) in the target region (optional). If the build has been customized then the resulting machine image may no longer be compatible with the provided CloudFormation template. Compatability can in some cases be restored by making corresponding modifications to the CloudFormation template. The ID should start with 'ami-'.",
      "Type": "String"
    },
    "OptionalUserCommand": {
      "Description": "Provide an optional inline shell command to run on machine launch. For example, to set an environment variable CLOUD=AWS, use this command excluding the angle brackets: <echo -e \"export CLOUD=AWS\" | tee -a /etc/profile.d/setenvvar.sh && source /etc/profile>. To run an external script, use this command excluding the angle brackets: <wget -O /tmp/my-script.sh \"https://www.example.com/script.sh\" && bash /tmp/my-script.sh>. Find the logs at '/var/log/mathworks/startup.log'.",
      "Type": "String",
      "Default": ""
    }
  },
  "Rules": {
    "matchPasswords": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "Password"
              },
              {
                "Ref": "ConfirmPassword"
              }
            ]
          },
          "AssertDescription": "Passwords do not match"
        }
      ]
    },
    "SubnetInVPC": {
      "Assertions": [
        {
          "Assert": {
            "Fn::EachMemberEquals": [
              {
                "Fn::ValueOfAll": [
                  "AWS::EC2::Subnet::Id",
                  "VpcId"
                ]
              },
              {
                "Ref": "VPC"
              }
            ]
          },
          "AssertDescription": "Subnet must exist in the VPC you have selected"
        }
      ]
    },
    "NoAdditionalPoliciesOnCustomRole": {
      "RuleCondition": {
        "Fn::Not": [
          {
            "Fn::Equals": [
              {
                "Ref": "CustomIamRole"
              },
              ""
            ]
          }
        ]
      },
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "AdditionalIamPolicies"
              },
              ""
            ]
          },
          "AssertDescription": "You cannot add IAM Policies when using a custom IAM Role."
        }
      ]
    },
    "MultipleRolesMustNotExist": {
      "RuleCondition": {
        "Fn::Not": [
          {
            "Fn::Equals": [
              {
                "Ref": "CustomIamRole"
              },
              ""
            ]
          }
        ]
      },
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "EnableCloudWatch"
              },
              "No"
            ]
          },
          "AssertDescription": "You cannot use CloudWatch when using a custom IAM role. The deployment will create an IAM role which you can later modify with additional policies if needed."
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "AccessProtocol"
                  },
                  "NICE DCV"
                ]
              }
            ]
          },
          "AssertDescription": "You cannot use NICE DCV when using a custom IAM role. The deployment will create an IAM role which you can later modify with additional policies if needed."
        }
      ]
    }
  },
  "Conditions": {
    "UsePredefinedRole": {
      "Fn::Equals": [
        {
          "Ref": "CustomIamRole"
        },
        ""
      ]
    },
    "UseAdditionalPolicies": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalIamPolicies"
            },
            ""
          ]
        }
      ]
    },
    "UseCloudWatch": {
      "Fn::Equals": [
        {
          "Ref": "EnableCloudWatch"
        },
        "Yes"
      ]
    },
    "UseNICEDCV": {
      "Fn::Equals": [
        {
          "Ref": "AccessProtocol"
        },
        "NICE DCV"
      ]
    },
    "UseXRDP": {
      "Fn::Equals": [
        {
          "Ref": "AccessProtocol"
        },
        "RDP"
      ]
    },
    "UseMATLABProxy": {
      "Fn::Equals": [
        {
          "Ref": "EnableMATLABProxy"
        },
        "Yes"
      ]
    },
    "UseElasticIPAddress": {
      "Fn::Equals": [
        {
          "Ref": "UseElasticIpAddress"
        },
        "Yes"
      ]
    },
    "UseCustomAMI": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "CustomAmiId"
            },
            ""
          ]
        }
      ]
    },
    "AddSG": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalSecurityGroup"
            },
            ""
          ]
        }
      ]
    }
  },
  "Outputs": {
    "CloudWatchLogs": {
      "Condition": "UseCloudWatch",
      "Description": "The cloudwatch logs containing logging information about the MATLAB instance",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://console.aws.amazon.com/cloudwatch/home?region=",
            {
              "Ref": "AWS::Region"
            },
            "#logsV2:log-groups/log-group/",
            {
              "Ref": "MWLogLocation"
            }
          ]
        ]
      }
    },
    "NiceDCVConnection": {
      "Condition": "UseNICEDCV",
      "Description": "Public url of the newly created EC2 instance to connect to the session via NICE DCV",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://",
            {
              "Fn::GetAtt": [
                "MATLABEC2Instance",
                "PublicDnsName"
              ]
            },
            ":8443/#console"
          ]
        ]
      }
    },
    "RDPConnection": {
      "Condition": "UseXRDP",
      "Description": "Public DNSName of the newly created EC2 instance",
      "Value": {
        "Fn::GetAtt": [
          "MATLABEC2Instance",
          "PublicDnsName"
        ]
      }
    },
    "BrowserConnection": {
      "Condition": "UseMATLABProxy",
      "Description": "URL to connect to and open MATLAB in a browser.",
      "Value": {
        "Fn::Sub": "https://${MATLABEC2Instance.PublicDnsName}:8123"
      }
    }
  },
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "EC2 Instance"
          },
          "Parameters": [
            "InstanceName",
            "InstanceType",
            "RootVolumeSize",
            "CustomIamRole",
            "AdditionalIamPolicies"
          ]
        },
        {
          "Label": {
            "default": "Remote Access"
          },
          "Parameters": [
            "AccessProtocol",
            "EnableMATLABProxy",
            "UseElasticIpAddress",
            "ClientIPAddress",
            "SSHKeyName",
            "Password",
            "ConfirmPassword"
          ]
        },
        {
          "Label": {
            "default": "Network Configuration"
          },
          "Parameters": [
            "VPC",
            "Subnet",
            "AdditionalSecurityGroup"
          ]
        },
        {
          "Label": {
            "default": "License Configuration"
          },
          "Parameters": [
            "LicenseManager"
          ]
        },
        {
          "Label": {
            "default": "Logging Configuration"
          },
          "Parameters": [
            "EnableCloudWatch"
          ]
        },
        {
          "Label": {
            "default": "Autoshutdown Configuration"
          },
          "Parameters": [
            "AutoShutdown"
          ]
        },
        {
          "Label": {
            "default": "Custom AMI"
          },
          "Parameters": [
            "CustomAmiId"
          ]
        },
        {
          "Label": {
            "default": "Optional User Command"
          },
          "Parameters": [
            "OptionalUserCommand"
          ]
        }
      ],
      "ParameterLabels": {
        "ClientIPAddress": {
          "default": "Allow connections from"
        },
        "UseElasticIpAddress": {
          "default": "Keep public ip the same"
        },
        "InstanceType": {
          "default": "AWS EC2 Instance type"
        },
        "InstanceName": {
          "default": "Instance Name"
        },
        "RootVolumeSize": {
          "default": "Storage Size (GiB)"
        },
        "CustomIamRole": {
          "default": "Custom IAM Role (Optional)"
        },
        "AdditionalIamPolicies": {
          "default": "Additional IAM Policies (Optional)"
        },
        "VPC": {
          "default": "VPC to deploy this stack to"
        },
        "Subnet": {
          "default": "Subnet"
        },
        "Password": {
          "default": "Remote password"
        },
        "ConfirmPassword": {
          "default": "Confirm remote password"
        },
        "SSHKeyName": {
          "default": "SSH Key Pair"
        },
        "EnableMATLABProxy": {
          "default": "Enable browser access for MATLAB"
        },
        "LicenseManager": {
          "default": "License Manager for MATLAB connection string"
        },
        "AdditionalSecurityGroup": {
          "default": "Additional security group to place instances in"
        },
        "EnableCloudWatch": {
          "default": "Configure cloudwatch logging for the MATLAB instance"
        },
        "AccessProtocol": {
          "default": "Remote access protocol"
        },
        "CustomAmiId": {
          "default": "Custom AMI ID (Optional)"
        },
        "OptionalUserCommand": {
          "default": "Optional user inline command"
        }
      }
    }
  }
}
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2025a/README.md">
# MATLAB on Amazon Web Services (Linux VM)

## Step 1. Launch the Template

Click the **Launch Stack** button to deploy a standalone MATLAB&reg; desktop client on AWS&reg;. This opens the CloudFormation Create Stack screen in your web browser.

| Region | Launch Link |
| --------------- | ----------- |
| **us-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-east-1.console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2025a/aws-matlab-template.json) |
| **us-east-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-east-2.console.aws.amazon.com/cloudformation/home?region=us-east-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2025a/aws-matlab-template.json) |
| **us-west-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-west-1.console.aws.amazon.com/cloudformation/home?region=us-west-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2025a/aws-matlab-template.json) |
| **us-west-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-west-2.console.aws.amazon.com/cloudformation/home?region=us-west-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2025a/aws-matlab-template.json) |
| **ca-central-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ca-central-1.console.aws.amazon.com/cloudformation/home?region=ca-central-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2025a/aws-matlab-template.json) |
| **eu-central-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-central-1.console.aws.amazon.com/cloudformation/home?region=eu-central-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2025a/aws-matlab-template.json) |
| **eu-west-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-1.console.aws.amazon.com/cloudformation/home?region=eu-west-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2025a/aws-matlab-template.json) |
| **eu-west-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-2.console.aws.amazon.com/cloudformation/home?region=eu-west-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2025a/aws-matlab-template.json) |
| **eu-west-3** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-3.console.aws.amazon.com/cloudformation/home?region=eu-west-3#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2025a/aws-matlab-template.json) |
| **eu-north-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-north-1.console.aws.amazon.com/cloudformation/home?region=eu-north-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2025a/aws-matlab-template.json) |
| **sa-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://sa-east-1.console.aws.amazon.com/cloudformation/home?region=sa-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2025a/aws-matlab-template.json) |
| **me-south-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://me-south-1.console.aws.amazon.com/cloudformation/home?region=me-south-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2025a/aws-matlab-template.json) |
| **ap-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-east-1.console.aws.amazon.com/cloudformation/home?region=ap-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2025a/aws-matlab-template.json) |
| **ap-south-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-south-1.console.aws.amazon.com/cloudformation/home?region=ap-south-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2025a/aws-matlab-template.json) |
| **ap-northeast-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-northeast-1.console.aws.amazon.com/cloudformation/home?region=ap-northeast-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2025a/aws-matlab-template.json) |
| **ap-northeast-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-northeast-2.console.aws.amazon.com/cloudformation/home?region=ap-northeast-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2025a/aws-matlab-template.json) |
| **ap-southeast-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-southeast-1.console.aws.amazon.com/cloudformation/home?region=ap-southeast-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2025a/aws-matlab-template.json) |
| **ap-southeast-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-southeast-2.console.aws.amazon.com/cloudformation/home?region=ap-southeast-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2025a/aws-matlab-template.json) |


**Note**: Creating a stack on AWS can take a few minutes.

## Step 2. Configure the Cloud Resources
After you click the Launch Stack button above, the “Create stack” page will open in your browser where you can configure the parameters. It is easier to complete the steps if you position these instructions and the AWS console window side by side.

1. Specify a stack name. This will be shown in the AWS CloudFormation console and must be unique within the AWS account.


2. Specify and check the defaults for these resource parameters:

| Parameter label | Description |
| --------------- | ----------- |
| **AWS EC2 Instance type** | AWS instance type to use for MATLAB. See https://aws.amazon.com/ec2/instance-types for a list of instance types. |
| **Instance Name** | Name for the MATLAB virtual machine |
| **Remote access protocol** | Access protocol to connect to this instance |
| **Enable browser access for MATLAB** | Option that enables access to MATLAB on your cloud instance within a browser. Opening MATLAB in a browser opens a separate MATLAB session to your Remote Desktop Protocol (RDP) session or NICE DCV session. |
| **Keep public ip the same** | Flag indicating whether you want to keep the same public IP address for the instance |
| **Storage Size (GiB)** | Size in GB of the root volume |
| **Custom IAM Role (Optional)** | Name of a custom IAM Role to associate with this instance. If not specified, a predefined role is used. If specified, features requiring special permissions will be unavailable (NICE DCV, CloudWatch, IAM Policies). |
| **Additional IAM Policies (Optional)** | Semicolon-delimited list of IAM Policy ARNs to add to the predefined role. This option cannot be used with a custom IAM Role. |
| **VPC to deploy this stack to** | ID of an existing VPC in which to deploy this stack |
| **Subnet** | ID of an existing subnet. To access the instance from anywhere, ensure that your subnet auto-assigns public IP addresses and is connected to the internet. |
| **SSH Key Pair** | Name of an existing EC2 KeyPair to allow SSH access to all the instances. See https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html for details on creating these. |
| **Allow connections from** | Comma-separated list of IP address ranges that will be allowed to connect to this instance. Each IP CIDR should be formatted as \<ip_address>/\<mask>. The mask determines the number of IP addresses to include. A mask of 32 is a single IP address. Example of allowed values: 10.0.0.1/32 or 10.0.0.0/16,192.34.56.78/32. This calculator can be used to build a specific range: https://www.ipaddressguide.com/cidr. You may need to contact your IT administrator to determine which address is appropriate. |
| **Remote password** | Password for the "ubuntu" user. You also need to enter this as an authentication token to access MATLAB on your cloud instance within a browser. |
| **Confirm remote password** | Confirm Password |
| **License Manager for MATLAB connection string** | Optional License Manager for MATLAB, specified as a string in the form \<port>@\<hostname>. If not specified, use online licensing. If specified, the network license manager (NLM) must be accessible from the specified VPC and subnets. To use the private hostname of the NLM hub instead of the public hostname, specify the security group ID of the NLM hub in the AdditionalSecurityGroup parameter. For more information, see https://github.com/mathworks-ref-arch/license-manager-for-matlab-on-aws. |
| **Configure cloudwatch logging for the MATLAB instance** | Flag indicating whether cloudwatch logging for the MATLAB instance is enabled. |
| **AutoShutdown** | Choose whether you want to enable autoshutdown for your instance after a certain number of hours |
| **Additional security group to place instances in** | ID of an additional (optional) Security Group for the instances to be placed in. Often the License Manager for MATLAB's Security Group. |
| **Custom AMI ID (Optional)** | ID of a custom Amazon Machine Image (AMI) in the target region (optional). If the build has been customized then the resulting machine image may no longer be compatible with the provided CloudFormation template. Compatability can in some cases be restored by making corresponding modifications to the CloudFormation template. The ID should start with 'ami-'. |
| **Optional user inline command** | Provide an optional inline shell command to run on machine launch. For example, to set an environment variable CLOUD=AWS, use this command excluding the angle brackets: \<echo -e "export CLOUD=AWS" \| tee -a /etc/profile.d/setenvvar.sh && source /etc/profile>. To run an external script, use this command excluding the angle brackets: \<wget -O /tmp/my-script.sh "https://www.example.com/script.sh" && bash /tmp/my-script.sh>. Find the logs at '/var/log/mathworks/startup.log'. |


>**Note**: In the capabilities section, you must acknowledge that AWS Cloudformation might create IAM resources and autoexpand nested templates when creating the stack.

3. Click the **Create Stack** button.  The CloudFormation service will start creating the resources for the stack. <p>After clicking **Create** you will be taken to the *Stack Detail* page for your stack. Wait for the Status to reach **CREATE\_COMPLETE**. This may take up to 10 minutes.</p>

## Step 3. Connect to the Virtual Machine in the Cloud

If you chose RDP, then:
1. Expand the **Outputs** section in the the *Stack Detail* page.
1. Look for the key named `RDPConnection` and copy the corresponding public DNS name listed under value. *For example*: ec2-11-222-33-44.compute-1.amazonaws.com
1. Launch any remote desktop client, paste the public DNS name in the appropriate field, and connect. On the Windows Remote Desktop Client you need to paste the public DNS name in the **Computer** field and click **Connect**.
1. In the login screen that's displayed, use the username `ubuntu` and the password you specified while setting up the stack in [Step 2](#step-2-configure-the-stack).

If you chose NICE DCV, then:
1. Expand the **Outputs** section in the the *Stack Detail* page.
1. Look for the key named `NiceDCVConnection` and click on it
1. In the login screen that's displayed, use the username `ubuntu` and the password you specified while setting up the stack in [Step 2](#step-2-configure-the-stack).

If you chose to enable browser access for MATLAB, then:
1. Expand the **Outputs** section in the *Stack Details* page.
1. Look for the key named `BrowserConnection` and click on it
1. On the login screen, use the password you specified while deploying the stack in [Step 2](#step-2-configure-the-stack) as the 'auth token' to authenticate.
1. Browser access for MATLAB is enabled using `matlab-proxy`, a MathWorks&reg; developed Python&reg; package. For more information on `matlab-proxy`, refer to [matlab-proxy GitHub repository](https://github.com/mathworks/matlab-proxy).

## Step 4. Start MATLAB
Double-click the MATLAB icon on the virtual machine desktop to start MATLAB. The first time you start MATLAB, you need to enter your MathWorks Account credentials to license MATLAB. For other ways to license MATLAB, see [MATLAB Licensing in the Cloud](https://www.mathworks.com/help/install/license/licensing-for-mathworks-products-running-on-the-cloud.html).

>**Note**: It may take up to a minute for MATLAB to start the first time.


# Additional Information

## Delete Your Cloud Resources

Once you have finished using your stack, it is recommended that you delete all resources to avoid incurring further cost. To delete the stack, do the following:
1. Log in to the AWS Console.
1. Go to the AWS CloudFormation page and select the stack you created.
1. Click the **Actions** button and click **Delete Stack** from the menu that appears.

## Nested Stacks

This CloudFormation template uses nested stacks to reference templates used by multiple reference architectures. For details, see the [MathWorks Infrastructure as Code Building Blocks](https://github.com/mathworks-ref-arch/iac-building-blocks) repository.

## CloudWatch Logs
CloudWatch logs enables you to access logs from all the resources in your stack in a single place. To use CloudWatch logs, launch the stack with the feature "Configure cloudwatch logging for the MATLAB instance" enabled. Once the stack deployment is complete, you can access your logs in the "Outputs" of the stack by clicking the link next to "CloudWatchLogs". Note that if you delete the stack, the CloudWatch log group is also deleted. For more information, see [What is Amazon CloudWatch Logs?](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/WhatIsCloudWatchLogs.html).

----

Copyright 2018-2025 The MathWorks, Inc.

----
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2023b/aws-matlab-template.json">
{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Mappings": {
    "RegionMap": {
      "us-east-1": {
        "AMI": "ami-013cc59788d283695"
      },
      "us-east-2": {
        "AMI": "ami-0f5965b21f25deff2"
      },
      "us-west-1": {
        "AMI": "ami-0a550eef810675460"
      },
      "us-west-2": {
        "AMI": "ami-058fd1940275e83eb"
      },
      "ca-central-1": {
        "AMI": "ami-0e928ff4f505bda8c"
      },
      "eu-central-1": {
        "AMI": "ami-072b1c2a9cf5e69a8"
      },
      "eu-west-1": {
        "AMI": "ami-02f3cd6fb3b85b675"
      },
      "eu-west-2": {
        "AMI": "ami-0d0fce686fa116792"
      },
      "eu-west-3": {
        "AMI": "ami-003a1bc329600d55f"
      },
      "eu-north-1": {
        "AMI": "ami-06914f43ddcbd6021"
      },
      "sa-east-1": {
        "AMI": "ami-00d806af29a8f039d"
      },
      "me-south-1": {
        "AMI": "ami-0ba926ccc56c40b5d"
      },
      "ap-east-1": {
        "AMI": "ami-0db13a84202cc4d24"
      },
      "ap-south-1": {
        "AMI": "ami-0f2bd0a91d6bff29a"
      },
      "ap-northeast-1": {
        "AMI": "ami-03b785854ceedc779"
      },
      "ap-northeast-2": {
        "AMI": "ami-0c79d364bbf3e3cdf"
      },
      "ap-southeast-1": {
        "AMI": "ami-00d177990cf28b229"
      },
      "ap-southeast-2": {
        "AMI": "ami-08255b026c0e44021"
      }
    }
  },
  "Resources": {
    "PredefinedRole": {
      "Type": "AWS::IAM::Role",
      "Condition": "UsePredefinedRole",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "ec2.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/",
        "ManagedPolicyArns": {
          "Fn::If": [
            "UseAdditionalPolicies",
            {
              "Fn::Split": [
                ";",
                {
                  "Ref": "AdditionalIamPolicies"
                }
              ]
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "Policies": [
          {
            "Fn::If": [
              "UseCloudWatch",
              {
                "PolicyName": "cloudwatch-access-policy",
                "PolicyDocument": {
                  "Version": "2012-10-17",
                  "Statement": [
                    {
                      "Effect": "Allow",
                      "Action": [
                        "logs:CreateLogStream",
                        "logs:DescribeLogStreams",
                        "logs:PutLogEvents"
                      ],
                      "Resource": {
                        "Fn::Sub": [
                          "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:${name}:*",
                          {
                            "name": {
                              "Fn::GetAtt": [
                                "MWLogLocation",
                                "Outputs.LogGroupName"
                              ]
                            }
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          {
            "PolicyName": "dcv-access-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "s3:GetObject",
                  "Resource": {
                    "Fn::Sub": "arn:aws:s3:::dcv-license.${AWS::Region}/*"
                  }
                }
              ]
            }
          },
          {
            "PolicyName": "ssm-access-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "ssm:DescribeAssociation",
                    "ssm:GetDeployablePatchSnapshotForInstance",
                    "ssm:GetDocument",
                    "ssm:DescribeDocument",
                    "ssm:GetManifest",
                    "ssm:GetParameter",
                    "ssm:GetParameters",
                    "ssm:ListAssociations",
                    "ssm:ListInstanceAssociations",
                    "ssm:PutInventory",
                    "ssm:PutComplianceItems",
                    "ssm:PutConfigurePackageResult",
                    "ssm:UpdateAssociationStatus",
                    "ssm:UpdateInstanceAssociationStatus",
                    "ssm:UpdateInstanceInformation"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ssmmessages:CreateControlChannel",
                    "ssmmessages:CreateDataChannel",
                    "ssmmessages:OpenControlChannel",
                    "ssmmessages:OpenDataChannel"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ec2messages:AcknowledgeMessage",
                    "ec2messages:DeleteMessage",
                    "ec2messages:FailMessage",
                    "ec2messages:GetEndpoint",
                    "ec2messages:GetMessages",
                    "ec2messages:SendReply"
                  ],
                  "Resource": "*"
                }
              ]
            }
          },
          {
            "PolicyName": "describe-tags-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "ec2:DescribeTags",
                  "Resource": "*"
                }
              ]
            }
          }
        ]
      }
    },
    "MATLABInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Fn::If": [
              "UsePredefinedRole",
              {
                "Ref": "PredefinedRole"
              },
              {
                "Ref": "CustomIamRole"
              }
            ]
          }
        ]
      }
    },
    "MWSecurityGroup": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": "https://mathworks-reference-architectures-templates.s3.amazonaws.com/security-group/v1/1/0/security-group.yml",
        "Parameters": {
          "VpcId": {
            "Ref": "VPC"
          },
          "CidrIp": {
            "Ref": "ClientIPAddress"
          },
          "SSHAccess": "Yes",
          "RDPAccess": "Yes",
          "NICEDCVAccess": "Yes",
          "MATLABProxyAccess": "Yes"
        }
      }
    },
    "MWLogLocation": {
      "Type": "AWS::CloudFormation::Stack",
      "Condition": "UseCloudWatch",
      "Properties": {
        "TemplateURL": "https://mathworks-reference-architectures-templates.s3.amazonaws.com/log-location/v1/0/0/log-location.yml"
      }
    },
    "MATLABEC2Instance": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "ImageId": {
          "Fn::If": [
            "UseCustomAMI",
            {
              "Ref": "CustomAmiId"
            },
            {
              "Fn::FindInMap": [
                "RegionMap",
                {
                  "Ref": "AWS::Region"
                },
                "AMI"
              ]
            }
          ]
        },
        "KeyName": {
          "Ref": "SSHKeyName"
        },
        "SecurityGroupIds": [
          {
            "Fn::GetAtt": [
              "MWSecurityGroup",
              "Outputs.SecurityGroupId"
            ]
          },
          {
            "Fn::If": [
              "AddSG",
              {
                "Ref": "AdditionalSecurityGroup"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          }
        ],
        "SubnetId": {
          "Ref": "Subnet"
        },
        "InstanceType": {
          "Ref": "InstanceType"
        },
        "IamInstanceProfile": {
          "Ref": "MATLABInstanceProfile"
        },
        "EbsOptimized": "true",
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "VolumeSize": {
                "Ref": "RootVolumeSize"
              }
            }
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Ref": "InstanceName"
            }
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "\n",
              [
                "#!/bin/bash",
                "",
                "# Copyright 2022 The MathWorks, Inc.",
                "",
                "STARTUP_FOLDER=/opt/mathworks/startup",
                "# Load startup variables",
                "if [[ -r ${STARTUP_FOLDER}/.env ]]; then",
                "    set -o allexport",
                "    source ${STARTUP_FOLDER}/.env",
                "    set +o allexport",
                "fi",
                "",
                "# Define startup parameters",
                {
                  "Fn::Sub": [
                    "export PASSWORD=${PasswordBase64}",
                    {
                      "PasswordBase64": {
                        "Fn::Base64": {
                          "Ref": "Password"
                        }
                      }
                    }
                  ]
                },
                {
                  "Fn::Sub": "export MLM_LICENSE_FILE=${LicenseManager}"
                },
                {
                  "Fn::Sub": [
                    "export CLOUD_LOG_NAME=${LogGroupName}",
                    {
                      "LogGroupName": {
                        "Fn::If": [
                          "UseCloudWatch",
                          {
                            "Fn::GetAtt": [
                              "MWLogLocation",
                              "Outputs.LogGroupName"
                            ]
                          },
                          ""
                        ]
                      }
                    }
                  ]
                },
                {
                  "Fn::Sub": "export ACCESS_PROTOCOL='${AccessProtocol}'"
                },
                {
                  "Fn::Sub": "export ENABLE_MATLAB_PROXY='${EnableMATLABProxy}'"
                },
                {
                  "Fn::Sub": "export OPTIONAL_USER_COMMAND='${OptionalUserCommand}'"
                },
                "",
                "# Run startup scripts",
                "mkdir -p /var/log/mathworks",
                "run-parts --exit-on-error --verbose --regex '^[0-9]+_.+$' ${STARTUP_FOLDER} >> /var/log/mathworks/startup.log 2>&1",
                "",
                "# Signal the status from cfn-init",
                {
                  "Fn::Sub": "/opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --region ${AWS::Region} --resource MATLABEC2Instance"
                }
              ]
            ]
          }
        }
      },
      "CreationPolicy": {
        "ResourceSignal": {
          "Timeout": "PT15M"
        }
      }
    },
    "ElasticIP": {
      "Type": "AWS::EC2::EIP",
      "Condition": "UseElasticIPAddress",
      "Properties": {
        "InstanceId": {
          "Ref": "MATLABEC2Instance"
        },
        "Domain": "vpc"
      }
    },
    "document": {
      "Type": "AWS::SSM::Document",
      "Condition": "UsePredefinedRole",
      "Properties": {
        "DocumentType": "Command",
        "Content": {
          "schemaVersion": "2.2",
          "description": "Run a script on Linux instances.",
          "parameters": {
            "commands": {
              "type": "String",
              "description": "Command to run on EC2 instance",
              "default": "echo 'Hello World'"
            }
          },
          "mainSteps": [
            {
              "action": "aws:runShellScript",
              "name": "runCommands",
              "inputs": {
                "timeoutSeconds": "60",
                "runCommand": [
                  "{{ commands }}"
                ]
              }
            }
          ]
        }
      }
    },
    "AutoShutdownLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "ZipFile": "# Copyright 2021-2024 The MathWorks, Inc.\n\nimport boto3,os,re\nfrom datetime import datetime as dt,timedelta\n\nec2=boto3.client(\"ec2\")\nDEFAULT_TIME_INTERVAL=os.environ['DEFAULT_TIME_INTERVAL']\n# Uniquely identify instance using AWS-provided stack-level tags\nres=ec2.describe_instances(Filters=[{'Name':'tag:aws:cloudformation:stack-name','Values':[os.environ['STACK_NAME']]},{'Name':'tag:aws:cloudformation:logical-id','Values':['MATLABEC2Instance']},{'Name': 'instance-state-name','Values': ['running', 'pending']}])\nINSTANCE=res[\"Reservations\"][0][\"Instances\"][0]\nINSTANCE_ID=INSTANCE[\"InstanceId\"]\nLOG_MESSAGES={\"instance-stopped\":\"Instance is stopped.\",\"tag-never\":\"Autoshutdown is not enabled. Change the value of mw-autoshutdown tag of the EC2 instance to enable the autoshutdown feature.\",\"tag-invalid\":\"The value of the mw-autoshutdown tag you have set is not valid. The format of the timestamp must be a valid RFC 1123 UTC timestamp, such as Thu, 16 Dec 2021 12:28:47 GMT.\",\"instance-booted\":\"Instance has just started. Setting mw-autoshutdown value.\",\"stop-instance\":\"Shutdown time has been reached. Shutting instance down.\",\"early-to-shutdown\":\"Shutdown time has not been reached yet. Too early to shutdown instance.\"}\nRET_VAL={\"statusCode\": 200}\n\ndef log_to_cloudwatch(id):\n    print(LOG_MESSAGES[id])\n\ndef get_start_time():\n    launch_time=INSTANCE[\"LaunchTime\"]\n    return re.sub(r\"\\+00:00\",\"\",str(launch_time))\n\ndef get_shutdown_tag():\n    tags=INSTANCE[\"Tags\"]\n    shutdown_tag=next((tag for tag in tags if tag[\"Key\"]==\"mw-autoshutdown\"), None)\n    return shutdown_tag\n\ndef set_shutdown_tag(shutdown_time):\n    ec2.create_tags(Resources=[INSTANCE_ID], Tags=[{\"Key\": \"mw-autoshutdown\",\"Value\": str(shutdown_time)}])\n\ndef set_shutdown_time():\n    time_interval=int(re.findall(\"[0-9]+\",DEFAULT_TIME_INTERVAL)[0])\n    launch_time=dt.fromisoformat(get_start_time())\n    shutdown_time=launch_time+timedelta(hours=int(time_interval))\n    shutdown_time_gmt=dt.strftime(shutdown_time,'%a, %d %b %Y %H:%M:%S GMT')\n    set_shutdown_tag(shutdown_time_gmt)\n\ndef lambda_handler(event, context):\n    # No action while the instance is stopped.\n    if INSTANCE[\"State\"][\"Name\"]==\"stopped\":\n        log_to_cloudwatch(id=\"instance-stopped\")\n        return RET_VAL\n    shutdown_tag=get_shutdown_tag()\n    # In the first function run, use DEFAULT_TIME_INTERVAL to determine what to do.\n    if shutdown_tag is None:\n        if DEFAULT_TIME_INTERVAL==\"Never\":\n            # Set the tag to \"never\".\n            set_shutdown_tag(\"never\")\n            # No action when tag is \"never\"\n            log_to_cloudwatch(id=\"tag-never\")\n            return RET_VAL\n        else:\n            # Set the tag to start time + user chosen time interval.\n            set_shutdown_time()\n            log_to_cloudwatch(id=\"instance-booted\")\n            return RET_VAL\n    # If the tag exists, use it to determine what to do.\n    if shutdown_tag[\"Value\"]==\"change_me_on_boot\":\n        set_shutdown_time()\n        log_to_cloudwatch(id=\"instance-booted\")\n        return RET_VAL\n    elif shutdown_tag[\"Value\"]==\"never\":\n        # No action when tag is \"never\"\n        log_to_cloudwatch(id=\"tag-never\")\n        return RET_VAL\n    else:\n        # Check the tag value to determine whether instance needs to be shutdown.\n        try:\n            shutdown_time=dt.strptime(shutdown_tag[\"Value\"],'%a, %d %b %Y %H:%M:%S GMT')\n        except ValueError:\n            log_to_cloudwatch(id=\"tag-invalid\")\n            return RET_VAL\n        curr_time=dt.now(shutdown_time.tzinfo)\n        if curr_time>shutdown_time:\n            ec2.stop_instances(InstanceIds=[INSTANCE_ID])\n            # Set the shutdown time as mw-last-autoshutdown-event tag\n            curr_time_gmt=dt.strftime(curr_time, '%a, %d %b %Y %H:%M:%S GMT')\n            ec2.create_tags(Resources=[INSTANCE_ID], Tags=[{\"Key\": \"mw-last-autoshutdown-event\",\"Value\": str(curr_time_gmt)}])\n            log_to_cloudwatch(id=\"stop-instance\")\n            if DEFAULT_TIME_INTERVAL==\"Never\":\n                set_shutdown_tag(\"never\")\n            else:\n                set_shutdown_tag(\"change_me_on_boot\")\n            return RET_VAL\n        else:\n            log_to_cloudwatch(id=\"early-to-shutdown\")\n            return RET_VAL"
        },
        "Environment": {
          "Variables": {
            "DEFAULT_TIME_INTERVAL": {
              "Ref": "AutoShutdown"
            },
            "STACK_NAME": {
              "Ref": "AWS::StackName"
            }
          }
        },
        "Handler": "index.lambda_handler",
        "Runtime": "python3.12",
        "Timeout": "60",
        "Role": {
          "Fn::GetAtt": [
            "AutoShutdownLambdaRole",
            "Arn"
          ]
        }
      }
    },
    "AutoShutdownLambdaRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/",
        "Policies": [
          {
            "PolicyName": "autoshutdown-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "ec2:DescribeInstances",
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": "ec2:DescribeTags",
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": "ec2:Stopinstances",
                  "Resource": {
                    "Fn::Sub": "arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:instance/*"
                  },
                  "Condition": {
                    "StringEquals": {
                      "aws:ResourceTag/aws:cloudformation:stack-name": {
                        "Ref": "AWS::StackName"
                      },
                      "aws:ResourceTag/aws:cloudformation:logical-id": "MATLABEC2Instance"
                    }
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": "ec2:CreateTags",
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": "ec2:DeleteTags",
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": {
                    "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*"
                  }
                }
              ]
            }
          }
        ]
      }
    },
    "AutoShutdownScheduledRule": {
      "Type": "AWS::Events::Rule",
      "Properties": {
        "Description": "AutoShutdownScheduledRule",
        "ScheduleExpression": "rate(15 minutes)",
        "State": "ENABLED",
        "Targets": [
          {
            "Arn": {
              "Fn::GetAtt": [
                "AutoShutdownLambda",
                "Arn"
              ]
            },
            "Id": "TargetFunctionV1"
          }
        ]
      }
    },
    "PermissionForEventsToInvokeLambda": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": {
          "Ref": "AutoShutdownLambda"
        },
        "Action": "lambda:InvokeFunction",
        "Principal": "events.amazonaws.com",
        "SourceArn": {
          "Fn::GetAtt": [
            "AutoShutdownScheduledRule",
            "Arn"
          ]
        }
      }
    },
    "AutoShutdownLambdaLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": {
          "Fn::Join": [
            "",
            [
              "/aws/lambda/",
              {
                "Ref": "AutoShutdownLambda"
              }
            ]
          ]
        }
      }
    }
  },
  "Parameters": {
    "InstanceType": {
      "Description": "AWS instance type to use for MATLAB. See https://aws.amazon.com/ec2/instance-types for a list of instance types.",
      "Default": "m5.xlarge",
      "Type": "String"
    },
    "InstanceName": {
      "Description": "Name for the MATLAB virtual machine",
      "Default": "MATLAB Desktop",
      "Type": "String"
    },
    "AccessProtocol": {
      "Description": "Access protocol to connect to this instance",
      "Default": "RDP",
      "Type": "String",
      "AllowedValues": [
        "NICE DCV",
        "RDP"
      ]
    },
    "EnableMATLABProxy": {
      "Description": "Option that enables access to MATLAB on your cloud instance within a browser. Opening MATLAB in a browser opens a separate MATLAB session to your Remote Desktop Protocol (RDP) session or NICE DCV session.",
      "Default": "Yes",
      "Type": "String",
      "AllowedValues": [
        "Yes",
        "No"
      ]
    },
    "UseElasticIpAddress": {
      "Description": "Flag indicating whether you want to keep the same public IP address for the instance",
      "Default": "No",
      "Type": "String",
      "AllowedValues": [
        "Yes",
        "No"
      ]
    },
    "RootVolumeSize": {
      "Description": "Size in GB of the root volume",
      "Default": "128",
      "Type": "Number",
      "MinValue": "128",
      "MaxValue": "1024",
      "ConstraintDescription": "Size must be between 128 and 1024GB"
    },
    "CustomIamRole": {
      "Description": "Name of a custom IAM Role to associate with this instance. If not specified, a predefined role is used. If specified, features requiring special permissions will be unavailable (NICE DCV, CloudWatch, IAM Policies).",
      "Default": "",
      "Type": "String"
    },
    "AdditionalIamPolicies": {
      "Description": "Semicolon-delimited list of IAM Policy ARNs to add to the predefined role. This option cannot be used with a custom IAM Role.",
      "Default": "",
      "Type": "String",
      "AllowedPattern": "^(arn:[^:;]+:iam::[^:;]+:policy/[^:;]+(;arn:[^:;]+:iam::[^:;]+:policy/[^:;]+)*)?$",
      "ConstraintDescription": "If specified, must be a semicolon (;) delimited list of ARNs (arn:<partition>:iam::<account-id>:policy/<resource-id>)."
    },
    "VPC": {
      "Description": "ID of an existing VPC in which to deploy this stack",
      "Type": "AWS::EC2::VPC::Id",
      "ConstraintDescription": "Must be the ID of an existing VPC.",
      "AllowedPattern": ".+"
    },
    "Subnet": {
      "Description": "ID of an existing subnet. To access the instance from anywhere, ensure that your subnet auto-assigns public IP addresses and is connected to the internet.",
      "Type": "AWS::EC2::Subnet::Id",
      "ConstraintDescription": "Must be the ID of an existing Subnet within the chosen VPC.",
      "AllowedPattern": ".+"
    },
    "SSHKeyName": {
      "Description": "Name of an existing EC2 KeyPair to allow SSH access to all the instances. See https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html for details on creating these.",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "ConstraintDescription": "Must be the name of an existing EC2 KeyPair.",
      "AllowedPattern": ".+"
    },
    "ClientIPAddress": {
      "Description": "IP address range that will be allowed to connect to this instance from outside of the VPC. This field should be formatted as <ip_address>/<mask>. E.g. 10.0.0.1/32. This is the public IP address which can be found by searching for 'what is my ip address' on the web. The mask determines the number of IP addresses to include. A mask of 32 is a single IP address. This calculator can be used to build a specific range: https://www.ipaddressguide.com/cidr. You may need to contact your IT administrator to determine which address is appropriate.",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription": "Must be a valid IP CIDR range of the form x.x.x.x/x."
    },
    "Password": {
      "NoEcho": "true",
      "Description": "Password for the \"ubuntu\" user. You also need to enter this as an authentication token to access MATLAB on your cloud instance within a browser.",
      "Type": "String",
      "ConstraintDescription": "Must have a minimum of 14 characters, 1 uppercase letter, 1 lowercase letter, 1 number, and 1 special character",
      "AllowedPattern": "^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[^a-zA-Z0-9]).{14,}$"
    },
    "ConfirmPassword": {
      "NoEcho": "true",
      "Description": "Confirm Password",
      "Type": "String"
    },
    "LicenseManager": {
      "Description": "Optional License Manager for MATLAB, specified as a string in the form <port>@<hostname>. If not specified, use online licensing. If specified, the network license manager (NLM) must be accessible from the specified VPC and subnets. To use the private hostname of the NLM hub instead of the public hostname, specify the security group ID of the NLM hub in the AdditionalSecurityGroup parameter. For more information, see https://github.com/mathworks-ref-arch/license-manager-for-matlab-on-aws.",
      "Type": "String",
      "Default": "",
      "AllowedPattern": "([0-9]+@[a-zA-Z0-9.\\-]+)?",
      "ConstraintDescription": "If specified, must be in the form <port>@<hostname>"
    },
    "EnableCloudWatch": {
      "Description": "Flag indicating whether cloudwatch logging for the MATLAB instance is enabled.",
      "Type": "String",
      "AllowedValues": [
        "Yes",
        "No"
      ],
      "Default": "No"
    },
    "AutoShutdown": {
      "Description": "Choose whether you want to enable autoshutdown for your instance after a certain number of hours",
      "Type": "String",
      "AllowedValues": [
        "Never",
        "After 1 hour",
        "After 2 hours",
        "After 3 hours",
        "After 4 hours",
        "After 5 hours",
        "After 6 hours",
        "After 7 hours",
        "After 8 hours",
        "After 9 hours",
        "After 10 hours",
        "After 11 hours",
        "After 12 hours",
        "After 13 hours",
        "After 14 hours",
        "After 15 hours",
        "After 16 hours",
        "After 17 hours",
        "After 18 hours",
        "After 19 hours",
        "After 20 hours",
        "After 21 hours",
        "After 22 hours",
        "After 23 hours",
        "After 24 hours"
      ],
      "Default": "Never"
    },
    "AdditionalSecurityGroup": {
      "Description": "ID of an additional (optional) Security Group for the instances to be placed in. Often the License Manager for MATLAB's Security Group.",
      "Type": "String",
      "Default": ""
    },
    "CustomAmiId": {
      "Default": "",
      "Description": "ID of a custom Amazon Machine Image (AMI) in the target region (optional). If the build has been customized then the resulting machine image may no longer be compatible with the provided CloudFormation template. Compatability can in some cases be restored by making corresponding modifications to the CloudFormation template. The ID should start with 'ami-'.",
      "Type": "String"
    },
    "OptionalUserCommand": {
      "Description": "Provide an optional inline shell command to run on machine launch. For example, to set an environment variable CLOUD=AWS, use this command excluding the angle brackets: <echo -e \"export CLOUD=AWS\" | tee -a /etc/profile.d/setenvvar.sh && source /etc/profile>. To run an external script, use this command excluding the angle brackets: <wget -O /tmp/my-script.sh \"https://www.example.com/script.sh\" && bash /tmp/my-script.sh>. Find the logs at '/var/log/mathworks/startup.log'.",
      "Type": "String",
      "Default": ""
    }
  },
  "Rules": {
    "matchPasswords": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "Password"
              },
              {
                "Ref": "ConfirmPassword"
              }
            ]
          },
          "AssertDescription": "Passwords do not match"
        }
      ]
    },
    "SubnetInVPC": {
      "Assertions": [
        {
          "Assert": {
            "Fn::EachMemberEquals": [
              {
                "Fn::ValueOfAll": [
                  "AWS::EC2::Subnet::Id",
                  "VpcId"
                ]
              },
              {
                "Ref": "VPC"
              }
            ]
          },
          "AssertDescription": "Subnet must exist in the VPC you have selected"
        }
      ]
    },
    "NoAdditionalPoliciesOnCustomRole": {
      "RuleCondition": {
        "Fn::Not": [
          {
            "Fn::Equals": [
              {
                "Ref": "CustomIamRole"
              },
              ""
            ]
          }
        ]
      },
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "AdditionalIamPolicies"
              },
              ""
            ]
          },
          "AssertDescription": "You cannot add IAM Policies when using a custom IAM Role."
        }
      ]
    },
    "MultipleRolesMustNotExist": {
      "RuleCondition": {
        "Fn::Not": [
          {
            "Fn::Equals": [
              {
                "Ref": "CustomIamRole"
              },
              ""
            ]
          }
        ]
      },
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "EnableCloudWatch"
              },
              "No"
            ]
          },
          "AssertDescription": "You cannot use CloudWatch when using a custom IAM role. The deployment will create an IAM role which you can later modify with additional policies if needed."
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "AccessProtocol"
                  },
                  "NICE DCV"
                ]
              }
            ]
          },
          "AssertDescription": "You cannot use NICE DCV when using a custom IAM role. The deployment will create an IAM role which you can later modify with additional policies if needed."
        }
      ]
    }
  },
  "Conditions": {
    "UsePredefinedRole": {
      "Fn::Equals": [
        {
          "Ref": "CustomIamRole"
        },
        ""
      ]
    },
    "UseCustomIamRole": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "CustomIamRole"
            },
            ""
          ]
        }
      ]
    },
    "UseAdditionalPolicies": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalIamPolicies"
            },
            ""
          ]
        }
      ]
    },
    "UseCloudWatch": {
      "Fn::Equals": [
        {
          "Ref": "EnableCloudWatch"
        },
        "Yes"
      ]
    },
    "UseNICEDCV": {
      "Fn::Equals": [
        {
          "Ref": "AccessProtocol"
        },
        "NICE DCV"
      ]
    },
    "UseXRDP": {
      "Fn::Equals": [
        {
          "Ref": "AccessProtocol"
        },
        "RDP"
      ]
    },
    "UseMATLABProxy": {
      "Fn::Equals": [
        {
          "Ref": "EnableMATLABProxy"
        },
        "Yes"
      ]
    },
    "UseElasticIPAddress": {
      "Fn::Equals": [
        {
          "Ref": "UseElasticIpAddress"
        },
        "Yes"
      ]
    },
    "UseCustomAMI": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "CustomAmiId"
            },
            ""
          ]
        }
      ]
    },
    "AddSG": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalSecurityGroup"
            },
            ""
          ]
        }
      ]
    }
  },
  "Outputs": {
    "CloudWatchLogs": {
      "Condition": "UseCloudWatch",
      "Description": "The cloudwatch logs containing logging information about the MATLAB instance",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://console.aws.amazon.com/cloudwatch/home?region=",
            {
              "Ref": "AWS::Region"
            },
            "#logsV2:log-groups/log-group/",
            {
              "Fn::GetAtt": [
                "MWLogLocation",
                "Outputs.LogGroupName"
              ]
            }
          ]
        ]
      }
    },
    "NiceDCVConnection": {
      "Condition": "UseNICEDCV",
      "Description": "Public url of the newly created EC2 instance to connect to the session via NICE DCV",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://",
            {
              "Fn::GetAtt": [
                "MATLABEC2Instance",
                "PublicDnsName"
              ]
            },
            ":8443/#console"
          ]
        ]
      }
    },
    "RDPConnection": {
      "Condition": "UseXRDP",
      "Description": "Public DNSName of the newly created EC2 instance",
      "Value": {
        "Fn::GetAtt": [
          "MATLABEC2Instance",
          "PublicDnsName"
        ]
      }
    },
    "BrowserConnection": {
      "Condition": "UseMATLABProxy",
      "Description": "URL to connect to and open MATLAB in a browser.",
      "Value": {
        "Fn::Sub": "https://${MATLABEC2Instance.PublicDnsName}:8123"
      }
    }
  },
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "EC2 Instance"
          },
          "Parameters": [
            "InstanceName",
            "InstanceType",
            "RootVolumeSize",
            "CustomIamRole",
            "AdditionalIamPolicies"
          ]
        },
        {
          "Label": {
            "default": "Remote Access"
          },
          "Parameters": [
            "AccessProtocol",
            "EnableMATLABProxy",
            "UseElasticIpAddress",
            "ClientIPAddress",
            "SSHKeyName",
            "Password",
            "ConfirmPassword"
          ]
        },
        {
          "Label": {
            "default": "Network Configuration"
          },
          "Parameters": [
            "VPC",
            "Subnet",
            "AdditionalSecurityGroup"
          ]
        },
        {
          "Label": {
            "default": "License Configuration"
          },
          "Parameters": [
            "LicenseManager"
          ]
        },
        {
          "Label": {
            "default": "Logging Configuration"
          },
          "Parameters": [
            "EnableCloudWatch"
          ]
        },
        {
          "Label": {
            "default": "Autoshutdown Configuration"
          },
          "Parameters": [
            "AutoShutdown"
          ]
        },
        {
          "Label": {
            "default": "Custom AMI"
          },
          "Parameters": [
            "CustomAmiId"
          ]
        },
        {
          "Label": {
            "default": "Optional User Command"
          },
          "Parameters": [
            "OptionalUserCommand"
          ]
        }
      ],
      "ParameterLabels": {
        "ClientIPAddress": {
          "default": "Allow connections from"
        },
        "UseElasticIpAddress": {
          "default": "Keep public ip the same"
        },
        "InstanceType": {
          "default": "AWS EC2 Instance type"
        },
        "InstanceName": {
          "default": "Instance Name"
        },
        "RootVolumeSize": {
          "default": "Storage Size (GiB)"
        },
        "CustomIamRole": {
          "default": "Custom IAM Role (Optional)"
        },
        "AdditionalIamPolicies": {
          "default": "Additional IAM Policies (Optional)"
        },
        "VPC": {
          "default": "VPC to deploy this stack to"
        },
        "Subnet": {
          "default": "Subnet"
        },
        "Password": {
          "default": "Remote password"
        },
        "ConfirmPassword": {
          "default": "Confirm remote password"
        },
        "SSHKeyName": {
          "default": "SSH Key Pair"
        },
        "EnableMATLABProxy": {
          "default": "Enable browser access for MATLAB"
        },
        "LicenseManager": {
          "default": "License Manager for MATLAB connection string"
        },
        "AdditionalSecurityGroup": {
          "default": "Additional security group to place instances in"
        },
        "EnableCloudWatch": {
          "default": "Configure cloudwatch logging for the MATLAB instance"
        },
        "AccessProtocol": {
          "default": "Remote access protocol"
        },
        "CustomAmiId": {
          "default": "Custom AMI ID (Optional)"
        },
        "OptionalUserCommand": {
          "default": "Optional user inline command"
        }
      }
    }
  }
}
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/releases/R2023b/README.md">
# MATLAB on Amazon Web Services (Linux VM)

## Step 1. Launch the Template

Click the **Launch Stack** button to deploy a standalone MATLAB&reg; desktop client on AWS&reg;. This opens the CloudFormation Create Stack screen in your web browser.

| Region | Launch Link |
| --------------- | ----------- |
| **us-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-east-1.console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023b/aws-matlab-template.json) |
| **us-east-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-east-2.console.aws.amazon.com/cloudformation/home?region=us-east-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023b/aws-matlab-template.json) |
| **us-west-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-west-1.console.aws.amazon.com/cloudformation/home?region=us-west-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023b/aws-matlab-template.json) |
| **us-west-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://us-west-2.console.aws.amazon.com/cloudformation/home?region=us-west-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023b/aws-matlab-template.json) |
| **ca-central-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ca-central-1.console.aws.amazon.com/cloudformation/home?region=ca-central-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023b/aws-matlab-template.json) |
| **eu-central-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-central-1.console.aws.amazon.com/cloudformation/home?region=eu-central-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023b/aws-matlab-template.json) |
| **eu-west-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-1.console.aws.amazon.com/cloudformation/home?region=eu-west-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023b/aws-matlab-template.json) |
| **eu-west-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-2.console.aws.amazon.com/cloudformation/home?region=eu-west-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023b/aws-matlab-template.json) |
| **eu-west-3** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-west-3.console.aws.amazon.com/cloudformation/home?region=eu-west-3#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023b/aws-matlab-template.json) |
| **eu-north-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://eu-north-1.console.aws.amazon.com/cloudformation/home?region=eu-north-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023b/aws-matlab-template.json) |
| **sa-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://sa-east-1.console.aws.amazon.com/cloudformation/home?region=sa-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023b/aws-matlab-template.json) |
| **me-south-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://me-south-1.console.aws.amazon.com/cloudformation/home?region=me-south-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023b/aws-matlab-template.json) |
| **ap-east-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-east-1.console.aws.amazon.com/cloudformation/home?region=ap-east-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023b/aws-matlab-template.json) |
| **ap-south-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-south-1.console.aws.amazon.com/cloudformation/home?region=ap-south-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023b/aws-matlab-template.json) |
| **ap-northeast-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-northeast-1.console.aws.amazon.com/cloudformation/home?region=ap-northeast-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023b/aws-matlab-template.json) |
| **ap-northeast-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-northeast-2.console.aws.amazon.com/cloudformation/home?region=ap-northeast-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023b/aws-matlab-template.json) |
| **ap-southeast-1** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-southeast-1.console.aws.amazon.com/cloudformation/home?region=ap-southeast-1#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023b/aws-matlab-template.json) |
| **ap-southeast-2** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start an cluster using the template")](https://ap-southeast-2.console.aws.amazon.com/cloudformation/home?region=ap-southeast-2#/stacks/create/review?templateURL=https://matlab-on-aws.s3.amazonaws.com/R2023b/aws-matlab-template.json) |


**Note**: Creating a stack on AWS can take a few minutes.

## Step 2. Configure the Cloud Resources
After you click the Launch Stack button above, the “Create stack” page will open in your browser where you can configure the parameters. It is easier to complete the steps if you position these instructions and the AWS console window side by side.

1. Specify a stack name. This will be shown in the AWS CloudFormation console and must be unique within the AWS account.


2. Specify and check the defaults for these resource parameters:

| Parameter label | Description |
| --------------- | ----------- |
| **AWS EC2 Instance type** | AWS instance type to use for MATLAB. See https://aws.amazon.com/ec2/instance-types for a list of instance types. |
| **Instance Name** | Name for the MATLAB virtual machine |
| **Remote access protocol** | Access protocol to connect to this instance |
| **Enable browser access for MATLAB** | Option that enables access to MATLAB on your cloud instance within a browser. Opening MATLAB in a browser opens a separate MATLAB session to your Remote Desktop Protocol (RDP) session or NICE DCV session. |
| **Keep public ip the same** | Flag indicating whether you want to keep the same public IP address for the instance |
| **Storage Size (GiB)** | Size in GB of the root volume |
| **Custom IAM Role (Optional)** | Name of a custom IAM Role to associate with this instance. If not specified, a predefined role is used. If specified, features requiring special permissions will be unavailable (NICE DCV, CloudWatch, IAM Policies). |
| **Additional IAM Policies (Optional)** | Semicolon-delimited list of IAM Policy ARNs to add to the predefined role. This option cannot be used with a custom IAM Role. |
| **VPC to deploy this stack to** | ID of an existing VPC in which to deploy this stack |
| **Subnet** | ID of an existing subnet. To access the instance from anywhere, ensure that your subnet auto-assigns public IP addresses and is connected to the internet. |
| **SSH Key Pair** | Name of an existing EC2 KeyPair to allow SSH access to all the instances. See https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html for details on creating these. |
| **Allow connections from** | IP address range that will be allowed to connect to this instance from outside of the VPC. This field should be formatted as \<ip_address>/\<mask>. E.g. 10.0.0.1/32. This is the public IP address which can be found by searching for 'what is my ip address' on the web. The mask determines the number of IP addresses to include. A mask of 32 is a single IP address. This calculator can be used to build a specific range: https://www.ipaddressguide.com/cidr. You may need to contact your IT administrator to determine which address is appropriate. |
| **Remote password** | Password for the "ubuntu" user. You also need to enter this as an authentication token to access MATLAB on your cloud instance within a browser. |
| **Confirm remote password** | Confirm Password |
| **License Manager for MATLAB connection string** | Optional License Manager for MATLAB, specified as a string in the form \<port>@\<hostname>. If not specified, use online licensing. If specified, the network license manager (NLM) must be accessible from the specified VPC and subnets. To use the private hostname of the NLM hub instead of the public hostname, specify the security group ID of the NLM hub in the AdditionalSecurityGroup parameter. For more information, see https://github.com/mathworks-ref-arch/license-manager-for-matlab-on-aws. |
| **Configure cloudwatch logging for the MATLAB instance** | Flag indicating whether cloudwatch logging for the MATLAB instance is enabled. |
| **AutoShutdown** | Choose whether you want to enable autoshutdown for your instance after a certain number of hours |
| **Additional security group to place instances in** | ID of an additional (optional) Security Group for the instances to be placed in. Often the License Manager for MATLAB's Security Group. |
| **Custom AMI ID (Optional)** | ID of a custom Amazon Machine Image (AMI) in the target region (optional). If the build has been customized then the resulting machine image may no longer be compatible with the provided CloudFormation template. Compatability can in some cases be restored by making corresponding modifications to the CloudFormation template. The ID should start with 'ami-'. |
| **Optional user inline command** | Provide an optional inline shell command to run on machine launch. For example, to set an environment variable CLOUD=AWS, use this command excluding the angle brackets: \<echo -e "export CLOUD=AWS" \| tee -a /etc/profile.d/setenvvar.sh && source /etc/profile>. To run an external script, use this command excluding the angle brackets: \<wget -O /tmp/my-script.sh "https://www.example.com/script.sh" && bash /tmp/my-script.sh>. Find the logs at '/var/log/mathworks/startup.log'. |


>**Note**: In the capabilities section, you must acknowledge that AWS Cloudformation might create IAM resources and autoexpand nested templates when creating the stack.

3. Click the **Create Stack** button.  The CloudFormation service will start creating the resources for the stack. <p>After clicking **Create** you will be taken to the *Stack Detail* page for your stack. Wait for the Status to reach **CREATE\_COMPLETE**. This may take up to 10 minutes.</p>

## Step 3. Connect to the Virtual Machine in the Cloud

If you chose RDP, then:
1. Expand the **Outputs** section in the the *Stack Detail* page.
1. Look for the key named `RDPConnection` and copy the corresponding public DNS name listed under value. *For example*: ec2-11-222-33-44.compute-1.amazonaws.com
1. Launch any remote desktop client, paste the public DNS name in the appropriate field, and connect. On the Windows Remote Desktop Client you need to paste the public DNS name in the **Computer** field and click **Connect**.
1. In the login screen that's displayed, use the username `ubuntu` and the password you specified while setting up the stack in [Step 2](#step-2-configure-the-stack).

If you chose NICE DCV, then:
1. Expand the **Outputs** section in the the *Stack Detail* page.
1. Look for the key named `NiceDCVConnection` and click on it
1. In the login screen that's displayed, use the username `ubuntu` and the password you specified while setting up the stack in [Step 2](#step-2-configure-the-stack).

If you chose to enable browser access for MATLAB, then:
1. Expand the **Outputs** section in the *Stack Details* page.
1. Look for the key named `BrowserConnection` and click on it
1. On the login screen, use the password you specified while deploying the stack in [Step 2](#step-2-configure-the-stack) as the 'auth token' to authenticate.
1. Browser access for MATLAB is enabled using `matlab-proxy`, a MathWorks&reg; developed Python&reg; package. For more information on `matlab-proxy`, refer to [matlab-proxy GitHub repository](https://github.com/mathworks/matlab-proxy).

## Step 4. Start MATLAB
Double-click the MATLAB icon on the virtual machine desktop to start MATLAB. The first time you start MATLAB, you need to enter your MathWorks Account credentials to license MATLAB. For other ways to license MATLAB, see [MATLAB Licensing in the Cloud](https://www.mathworks.com/help/install/license/licensing-for-mathworks-products-running-on-the-cloud.html).

>**Note**: It may take up to a minute for MATLAB to start the first time.


# Additional Information

## Delete Your Cloud Resources

Once you have finished using your stack, it is recommended that you delete all resources to avoid incurring further cost. To delete the stack, do the following:
1. Log in to the AWS Console.
1. Go to the AWS CloudFormation page and select the stack you created.
1. Click the **Actions** button and click **Delete Stack** from the menu that appears.

## Nested Stacks

This CloudFormation template uses nested stacks to reference templates used by multiple reference architectures. For details, see the [MathWorks Infrastructure as Code Building Blocks](https://github.com/mathworks-ref-arch/iac-building-blocks) repository.

## CloudWatch Logs
CloudWatch logs enables you to access logs from all the resources in your stack in a single place. To use CloudWatch logs, launch the stack with the feature "Configure cloudwatch logging for the MATLAB instance" enabled. Once the stack deployment is complete, you can access your logs in the "Outputs" of the stack by clicking the link next to "CloudWatchLogs". Note that if you delete the stack, the CloudWatch log group is also deleted. For more information, see [What is Amazon CloudWatch Logs?](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/WhatIsCloudWatchLogs.html).

----

Copyright 2018-2024 The MathWorks, Inc.

----
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/src/aws-matlab-template.json">
{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Mappings": {
        "RegionMap" : {}
    },
    "Resources": {
        "PredefinedRole": {
            "Type": "AWS::IAM::Role",
            "Condition": "CreateNewRole",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": { "Service": "ec2.amazonaws.com" },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Path": "/MW/",
                "ManagedPolicyArns": {
                    "Fn::If": [
                        "UseAdditionalPolicies",
                        { "Fn::Split": [";", {"Ref": "AdditionalIamPolicies"}] },
                        { "Ref": "AWS::NoValue" }
                    ]
                },
                "Policies": [
                    {
                        "Fn::If": [
                            "UseCloudWatch",
                            {
                                "PolicyName": "cloudwatch-access-policy",
                                "PolicyDocument": {
                                    "Version": "2012-10-17",
                                    "Statement": [
                                        {
                                            "Effect": "Allow",
                                            "Action": [
                                                "logs:CreateLogStream",
                                                "logs:DescribeLogStreams",
                                                "logs:PutLogEvents"
                                            ],
                                            "Resource": {
                                                "Fn::Sub": [
                                                    "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:${LogGroupName}:*",
                                                    {
                                                        "LogGroupName": {"Ref": "MWLogLocation"}
                                                    }
                                                ]
                                            }
                                        }
                                    ]
                                }
                            },
                            { "Ref": "AWS::NoValue" }
                        ]
                    },
                    {
                        "PolicyName": "dcv-access-policy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": "s3:GetObject",
                                    "Resource": { "Fn::Sub": "arn:${AWS::Partition}:s3:::dcv-license.${AWS::Region}/*" }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "ssm-access-policy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ssm:DescribeAssociation",
                                        "ssm:GetDeployablePatchSnapshotForInstance",
                                        "ssm:GetDocument",
                                        "ssm:DescribeDocument",
                                        "ssm:GetManifest",
                                        "ssm:GetParameter",
                                        "ssm:GetParameters",
                                        "ssm:ListAssociations",
                                        "ssm:ListInstanceAssociations",
                                        "ssm:PutInventory",
                                        "ssm:PutComplianceItems",
                                        "ssm:PutConfigurePackageResult",
                                        "ssm:UpdateAssociationStatus",
                                        "ssm:UpdateInstanceAssociationStatus",
                                        "ssm:UpdateInstanceInformation"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ssmmessages:CreateControlChannel",
                                        "ssmmessages:CreateDataChannel",
                                        "ssmmessages:OpenControlChannel",
                                        "ssmmessages:OpenDataChannel"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2messages:AcknowledgeMessage",
                                        "ec2messages:DeleteMessage",
                                        "ec2messages:FailMessage",
                                        "ec2messages:GetEndpoint",
                                        "ec2messages:GetMessages",
                                        "ec2messages:SendReply"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "describe-tags-policy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": "ec2:DescribeTags",
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "MATLABInstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Path": "/MW/",
                "Roles": [
                    {
                        "Fn::If": ["CreateNewRole",
                            {
                                "Ref": "PredefinedRole"
                            },
                            {
                                "Ref": "CustomIamRole"
                            }
                        ]
                    }
                ]
            }
        },
        "EC2AutoShutdown": {
            "Type" : "AWS::CloudFormation::Stack",
            "DeletionPolicy" : "Delete",
            "UpdateReplacePolicy" : "Delete",
            "Properties" : {
                "TemplateURL" : "https://mathworks-reference-architectures-templates.s3.amazonaws.com/ec2-shutdown-lambda/v1/0/1/ec2-shutdown-lambda.yml",
                "Parameters" : {
                    "EC2InstanceId" : { "Ref" : "MATLABEC2Instance" },
                    "MathWorksProductId": "MathWorks-MATLAB-Linux",
                    "ShutdownBehaviour" : { "Ref" : "AutoShutdown" },
                    "TagToMonitor" : "mw-autoshutdown",
                    "AutoShutdownLambdaLogRetentionInDays" : 1,
                    "ShutdownLambdaExecutionRoleArn": { 
                        "Fn::If": [
                            "CreateNewRole",
                            "",
                            { "Fn::Sub" : "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/MW/${CustomIamRole}" }
                        ]
                    }
                }
            }
        },
        "MWSecurityGroup": {
            "Type" : "AWS::CloudFormation::Stack",
            "DeletionPolicy" : "Delete",
            "UpdateReplacePolicy" : "Delete",
            "Properties" : {
                "TemplateURL" : "https://mathworks-reference-architectures-templates.s3.amazonaws.com/security-group/v2/0/0/security-group.yml",
                "Parameters" : {
                    "VpcId" : { "Ref" : "VPC" },
                    "CidrRanges" : { "Ref" : "ClientIPAddress" },
                    "SSHAccess" : "Yes",
                    "RDPAccess" : "Yes",
                    "NICEDCVAccess" : "Yes",
                    "MATLABProxyAccess": "Yes"
                }
            }
        },
        "MWLogLocation": {
            "Type" : "AWS::Logs::LogGroup",
            "Condition": "UseCloudWatch",
            "DeletionPolicy" : "Delete",
            "UpdateReplacePolicy" : "Delete"
        },
        "MATLABEC2Instance": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "ImageId" : { 
                    "Fn::If": [
                        "UseCustomAMI",
                        {
                          "Ref": "CustomAmiId"
                        },
                        {
                            "Fn::FindInMap" : [ 
                                "RegionMap", 
                                {
                                    "Ref" : "AWS::Region"
                                }, 
                                "AMI"
                            ]
                        }
                    ]
                },
                "KeyName": {
                    "Ref": "SSHKeyName"
                },
                "NetworkInterfaces": [
                    {
                        "AssociatePublicIpAddress": {
                            "Fn::If": [
                                "UsePublicIp",
                                true,
                                false
                            ]
                        },
                        "DeviceIndex": "0",
                        "SubnetId": {"Ref": "Subnet"},
                        "GroupSet": [
                            { "Fn::GetAtt" : [ "MWSecurityGroup", "Outputs.SecurityGroupId" ] },
                            {
                                "Fn::If": [
                                    "AddSG",
                                    { "Ref": "AdditionalSecurityGroup" },
                                    { "Ref": "AWS::NoValue" }
                                ]
                            }
                        ]
                    }
                ],
                "InstanceType": {
                    "Ref": "InstanceType"
                },
                "IamInstanceProfile": {
                    "Ref": "MATLABInstanceProfile" 
                },
                "EbsOptimized": "true",
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/sda1",
                        "Ebs": {
                            "VolumeSize": {
                                "Ref": "RootVolumeSize"
                            }
                        }
                    }
                ],
                "Tags":[
                    { "Key": "Name", "Value":  {"Ref": "InstanceName"}},
                    { "Key": "mw-ProductID", "Value":  "MathWorks-MATLAB-Linux" },
                    { "Key": "mw-StackName", "Value": { "Ref" : "AWS::StackName" }}
                ],
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "\n",
                            [
                                "#!/bin/bash",
                                "",
                                "# Copyright 2022 The MathWorks, Inc.",
                                "",
                                "STARTUP_FOLDER=/opt/mathworks/startup",
                                "# Load startup variables",
                                "if [[ -r ${STARTUP_FOLDER}/.env ]]; then",
                                "    set -o allexport",
                                "    source ${STARTUP_FOLDER}/.env",
                                "    set +o allexport",
                                "fi",
                                "",
                                "# Define startup parameters",
                                { "Fn::Sub": [ "export PASSWORD=${PasswordBase64}", { "PasswordBase64": {"Fn::Base64": {"Ref": "Password"}} } ] },
                                { "Fn::Sub": "export MLM_LICENSE_FILE=${LicenseManager}" },
                                { "Fn::Sub": [ "export CLOUD_LOG_NAME=${LogGroupName}", { "LogGroupName": {"Fn::If": ["UseCloudWatch", {"Ref": "MWLogLocation"}, ""]} } ] },
                                { "Fn::Sub": "export ACCESS_PROTOCOL='${AccessProtocol}'" },
                                { "Fn::Sub": "export ENABLE_MATLAB_PROXY='${EnableMATLABProxy}'"},
                                { "Fn::Sub": "export OPTIONAL_USER_COMMAND='${OptionalUserCommand}'" },
                                "",
                                "# Run startup scripts",
                                "mkdir -p /var/log/mathworks",
                                "run-parts --exit-on-error --verbose --regex '^[0-9]+_.+$' ${STARTUP_FOLDER} >> /var/log/mathworks/startup.log 2>&1",
                                "",
                                "# Signal the status from cfn-init",
                                { "Fn::Sub": "/opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --region ${AWS::Region} --resource MATLABEC2Instance"}
                            ]
                        ]
                    }
                }
            },
            "CreationPolicy": {
                "ResourceSignal": {
                    "Timeout": "PT15M"
                }
            }
        },
        "ElasticIP": {
            "Type": "AWS::EC2::EIP",
            "Condition": "UseElasticIPAddress",
            "Properties": {
                "InstanceId": {"Ref" : "MATLABEC2Instance"},
                "Domain": "vpc"
            }
        },
        "document": {
            "Type": "AWS::SSM::Document",
            "Condition": "CreateNewRole",
            "Properties": {
                "DocumentType": "Command",
                "Content": {
                    "schemaVersion": "2.2",
                    "description": "Run a script on Linux instances.",
                    "parameters": {
                        "commands": {
                            "type": "String",
                            "description": "Command to run on EC2 instance",
                            "default": "echo 'Hello World'"
                        }
                    },
                    "mainSteps": [
                        {
                            "action": "aws:runShellScript",
                            "name": "runCommands",
                            "inputs": {
                                "timeoutSeconds": "60",
                                "runCommand": [
                                    "{{ commands }}"
                                ]
                            }
                        }
                    ]
                }
            }
        }
    },
    "Parameters": {
        "InstanceType": {
            "Description": "AWS instance type to use for MATLAB. For more information about instance types, see https://aws.amazon.com/ec2/instance-types.",
            "Default": "m5.xlarge",
            "Type": "String"
        },
        "InstanceName": {
            "Description": "Name for the MATLAB virtual machine.",
            "Default": "MATLAB Desktop",
            "Type": "String"
        },
        "AccessProtocol": {
            "Description": "Access protocol used to connect to the instance.",
            "Default":"RDP",
            "Type":"String",
            "AllowedValues": ["NICE DCV","RDP"]
        },
        "EnableMATLABProxy": {
            "Description": "Option that enables access to MATLAB in a browser on your cloud instance. Opening MATLAB in a browser starts a MATLAB session separate from your Remote Desktop Protocol (RDP) session or NICE DCV session.", 
            "Default":"Yes",
            "Type":"String",
            "AllowedValues": ["Yes","No"]
        },
        "EnablePublicIPAddress": {
            "Description": "Choose whether to attach a public IP address to the MATLAB EC2 instance. For details about using a private network configuration, see [Configure Private Network](#configure-private-network).",
            "Type": "String",
            "AllowedValues": [
              "Yes",
              "No"
            ],
            "Default": "Yes"
        },
        "UseElasticIpAddress": {
            "Description": "Flag specifying whether or not you want to keep the same public IP address for the instance.",
            "Default":"No",
            "Type":"String",
            "AllowedValues": ["Yes","No"]
        },
        "RootVolumeSize": {
            "Description": "Size of the root volume, in GiB.",
            "Default": "128",
            "Type": "Number",
            "MinValue": "128",
            "MaxValue": "1024",
            "ConstraintDescription": "Size must be between 128 and 1024 GiB"
        },
        "CustomIamRole": {
            "Description": "Name of a custom IAM Role to associate with this instance. Specify a role that has the necessary permissions listed in the Permission file in the GitHub repository: https://github.com/mathworks-ref-arch/matlab-on-aws/permission.md. If not specified, a predefined role is used.",
            "Default": "",
            "Type": "String"
        },
        "AdditionalIamPolicies": {
            "Description": "Semicolon-delimited list of IAM Policy ARNs to add to the predefined role. This option cannot be used with a custom IAM Role.",
            "Default": "",
            "Type": "String",
            "AllowedPattern": "^(arn:[^:;]+:iam::[^:;]+:policy\/[^:;]+(;arn:[^:;]+:iam::[^:;]+:policy\/[^:;]+)*)?$",
            "ConstraintDescription": "If specified, must be a semicolon (;) delimited list of ARNs (arn:<partition>:iam::<account-id>:policy/<resource-id>)."
        },
        "VPC": {
            "Description": "ID of an existing VPC to deploy this stack in.",
            "Type": "AWS::EC2::VPC::Id",
            "ConstraintDescription": "Must be the ID of an existing VPC.",
            "AllowedPattern" : ".+"
        },
        "Subnet": {
            "Description": "ID of an existing subnet in the VPC.",
            "Type": "AWS::EC2::Subnet::Id",
            "ConstraintDescription": "Must be the ID of an existing subnet within the chosen VPC.",
            "AllowedPattern" : ".+"
        },
        "SSHKeyName": {
            "Description": "Name of an existing EC2 key pair to allow SSH access to all the instances. For more information about creating these key pairs, see https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html.",
            "Type": "AWS::EC2::KeyPair::KeyName",
            "ConstraintDescription": "Must be the name of an existing EC2 KeyPair.",
            "AllowedPattern" : ".+"
        },
        "ClientIPAddress": {
            "Description": "Comma-separated list of IP address ranges that will be allowed to connect to this instance. Each IP CIDR must have the format <ip_address>/<mask>. The mask determines the number of IP addresses to include. A mask of 32 specifies a single IP address. Examples of allowed values: 10.0.0.1/32, 10.0.0.0/16,192.34.56.78/32. To identify the public IP address of your machine, you can use https://checkip.amazonaws.com. To build a specific range, you can use https://www.ipaddressguide.com/cidr. To determine which address is appropriate, contact your IT administrator.",
            "Type": "String",
            "MinLength": "9",
            "MaxLength": "189",
            "AllowedPattern": "^((\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2}))(,((\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2}))){0,9}$",
            "ConstraintDescription": "Must be a comma-separated list of valid IP CIDR ranges of the form x.x.x.x/x. A maximum of 10 such IP CIDRs are allowed in the list."
        },
        "Password": {
            "NoEcho": "true",
            "Description": "Password for the \"ubuntu\" user. You must also enter this password as an authentication token to access MATLAB in a browser on your cloud instance.",
            "Type": "String",
            "ConstraintDescription": "Must have a minimum of 14 characters, 1 uppercase letter, 1 lowercase letter, 1 number, and 1 special character",
            "AllowedPattern": "^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[^a-zA-Z0-9]).{14,}$"
        },
        "ConfirmPassword": {
            "NoEcho": "true",
            "Description": "Confirm password.",
            "Type": "String"
        },
        "LicenseManager": {
            "Description": "Optional License Manager for MATLAB, specified as a string of the form <port>@<hostname>. If not specified, online licensing is used instead. If specified, the network license manager (NLM) must be accessible from the specified VPC and subnets. To use the private hostname of the NLM hub instead of the public hostname, specify the security group ID of the NLM hub in the AdditionalSecurityGroup parameter. For more information, see https://github.com/mathworks-ref-arch/license-manager-for-matlab-on-aws.",
            "Type": "String",
            "Default": "",
            "AllowedPattern": "([0-9]+@[a-zA-Z0-9.\\-]+)?",
            "ConstraintDescription": "If specified, must be of the form <port>@<hostname>"
        },
        "EnableCloudWatch": {
            "Description": "Flag specifying whether to enable cloudwatch logging for the MATLAB instance. For private instances, CloudWatch logs might not be updated unless you set up a NAT Gateway or VPC endpoint. For details about private networking, see [Configure Private Network](#configure-private-network).",
            "Type": "String",
            "AllowedValues" : ["Yes", "No"],
            "Default": "No"
        },
        "AutoShutdown": {
            "Description": "Choose whether you want to enable autoshutdown for your instance after a certain number of hours",
            "Type": "String",
            "AllowedValues" : ["Never", "After 1 hour","After 2 hours","After 3 hours","After 4 hours","After 5 hours","After 6 hours","After 7 hours","After 8 hours","After 9 hours","After 10 hours","After 11 hours","After 12 hours","After 13 hours","After 14 hours","After 15 hours","After 16 hours","After 17 hours","After 18 hours","After 19 hours","After 20 hours","After 21 hours","After 22 hours","After 23 hours","After 24 hours"],
            "Default": "Never"
        },
        "AdditionalSecurityGroup": {
            "Description": "(Optional) ID of an additional security group to place the instances in. Often the security group of the License Manager for MATLAB.",
            "Type": "String",
            "Default": ""
        },
        "CustomAmiId": {
            "Default": "",
            "Description": "(Optional) ID of a custom Amazon Machine Image (AMI) in the target region. If the build has been customized then the resulting machine image might no longer be compatible with the provided CloudFormation template. In some cases you can restore compatability by making corresponding modifications to the CloudFormation template. The ID must start with 'ami-'.",
            "Type": "String"
          },
        "OptionalUserCommand": {
            "Description": "Provide an optional inline shell command to run on machine launch. For example, to set an environment variable CLOUD=AWS, use this command, excluding the angle brackets: <echo -e \"export CLOUD=AWS\" | tee -a /etc/profile.d/setenvvar.sh && source /etc/profile>. To run an external script, use this command, excluding the angle brackets: <wget -O /tmp/my-script.sh \"https://www.example.com/script.sh\" && bash /tmp/my-script.sh>. Find the logs at '/var/log/mathworks/startup.log'.",
            "Type": "String",
            "Default": ""
        }
    },
    "Rules": {
        "ElasticIPRequiresPublicIP": {
            "RuleCondition": {
                "Fn::Equals": [
                    {
                        "Ref": "EnablePublicIPAddress"
                    },
                    "No"
                ]
            },
            "Assertions": [
                {
                    "Assert": {
                        "Fn::Equals": [
                            {"Ref": "UseElasticIpAddress"},
                            "No"
                        ]
                    },
                    "AssertDescription": "Elastic IP cannot be used when Public IP address is disabled."
                }
            ]
        },
        "matchPasswords": {
            "Assertions": [
                {
                    "Assert": {
                        "Fn::Equals": [
                            {
                                "Ref": "Password"
                            },
                            {
                                "Ref": "ConfirmPassword"
                            }
                        ]
                    },
                    "AssertDescription": "Passwords do not match"
                }
            ]
        },
        "SubnetInVPC": {
            "Assertions": [
                {
                    "Assert": {
                        "Fn::EachMemberEquals": [
                            {
                            "Fn::ValueOfAll": [
                                "AWS::EC2::Subnet::Id",
                                "VpcId"
                            ]
                            },
                            {
                                "Ref": "VPC"
                            }
                        ]
                    },
                    "AssertDescription":"Subnet must exist in the VPC you have selected"
                }
            ]
        },
        "NoAdditionalPoliciesOnCustomRole" : {
            "RuleCondition": {
                "Fn::Not": [{"Fn::Equals": [{"Ref": "CustomIamRole"}, ""]}]
            },
            "Assertions": [
                {
                    "Assert": {
                        "Fn::Equals": [{"Ref": "AdditionalIamPolicies"}, ""]
                    },
                    "AssertDescription": "You cannot add IAM Policies when using a custom IAM Role."
                }
            ]
        }
    },
    "Conditions": {
        "UsePublicIp": {
            "Fn::Equals": [
              {
                "Ref": "EnablePublicIPAddress"
              },
              "Yes"
            ]
        },
        "CreateNewRole": {
            "Fn::Equals": [{"Ref": "CustomIamRole"}, ""]
        },
        "UseAdditionalPolicies": {
            "Fn::Not": [{"Fn::Equals": [{"Ref": "AdditionalIamPolicies"}, ""]}]
        },
        "UseCloudWatch": {
            "Fn::Equals": [{"Ref": "EnableCloudWatch"}, "Yes"]
        },
        "UseNICEDCV": {
            "Fn::Equals": [{"Ref": "AccessProtocol"}, "NICE DCV"]
        },
        "UseXRDP": {
            "Fn::Equals": [{"Ref": "AccessProtocol"}, "RDP"]
        },
        "UseMATLABProxy": {
            "Fn::Equals": [{"Ref": "EnableMATLABProxy"}, "Yes"]
        },
        "UseElasticIPAddress": {
            "Fn::Equals": [{"Ref": "UseElasticIpAddress"}, "Yes"]
        },
        "UseCustomAMI":{
            "Fn::Not": [ { "Fn::Equals": [ { "Ref": "CustomAmiId" }, "" ] } ]
        },
        "AddSG": {
            "Fn::Not": [{"Fn::Equals": [{"Ref": "AdditionalSecurityGroup"}, ""]}]
        }
    },
    "Outputs": {
        "CloudWatchLogs": {
            "Condition": "UseCloudWatch",
            "Description": "The cloudwatch logs containing logging information about the MATLAB instance",
            "Value": { "Fn::Sub": "https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#logsV2:log-groups/log-group/${MWLogLocation}" }
        },
        "NiceDCVConnection": {
            "Condition": "UseNICEDCV",
            "Description": "URL of the newly created EC2 instance to connect to the session via NICE DCV",
            "Value": { "Fn::If": [ "UsePublicIp", { "Fn::Sub": "https://${MATLABEC2Instance.PublicDnsName}:8443/#console" }, { "Fn::Sub": "https://${MATLABEC2Instance.PrivateDnsName}:8443/#console" } ] }
        },
        "RDPConnection": {
            "Condition": "UseXRDP",
            "Description": "DNS of the newly created EC2 instance.",
            "Value": {
                "Fn::If": [
                    "UsePublicIp",
                    {
                        "Fn::GetAtt": [
                        "MATLABEC2Instance",
                        "PublicDnsName"
                        ]
                    },
                    {
                        "Fn::GetAtt": [
                        "MATLABEC2Instance",
                        "PrivateDnsName"
                        ]
                    }
                ]
            }
        },
        "BrowserConnection": {
            "Condition": "UseMATLABProxy",
            "Description": "URL to connect to and open MATLAB in a browser.",
            "Value": { "Fn::If": [ "UsePublicIp", { "Fn::Sub": "https://${MATLABEC2Instance.PublicDnsName}:8123" }, { "Fn::Sub": "https://${MATLABEC2Instance.PrivateDnsName}:8123" } ] }
        }
    },
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "EC2 Instance"
                    },
                    "Parameters": [
                        "InstanceName",
                        "InstanceType",
                        "RootVolumeSize",
                        "CustomIamRole",
                        "AdditionalIamPolicies"
                    ]
                },
                {
                    "Label": {
                        "default": "Network Configuration"
                    },
                    "Parameters": [
                        "VPC",
                        "Subnet",
                        "AdditionalSecurityGroup",
                        "EnablePublicIPAddress",
                        "UseElasticIpAddress"
                    ]
                },
                {
                    "Label": {
                        "default": "Remote Access"
                    },
                    "Parameters": [
                        "AccessProtocol",
                        "EnableMATLABProxy",
                        "ClientIPAddress",
                        "SSHKeyName",
                        "Password",
                        "ConfirmPassword"
                    ]
                },
                {
                    "Label": {
                        "default": "License Configuration"
                    },
                    "Parameters": [
                        "LicenseManager"
                    ]
                },
                {
                    "Label": {
                        "default": "Logging Configuration"
                    },
                    "Parameters": [
                        "EnableCloudWatch"
                    ]
                },
                {
                    "Label": {
                        "default": "Autoshutdown Configuration"
                    },
                    "Parameters": [
                        "AutoShutdown"
                    ]
                },
                {
                    "Label": {
                        "default": "Custom AMI"
                    },
                    "Parameters": [
                        "CustomAmiId"
                    ]
                },
                {
                    "Label": {
                        "default": "Optional User Command"
                    },
                    "Parameters": [
                        "OptionalUserCommand"
                    ]
                }
            ],
            "ParameterLabels": {
                "ClientIPAddress": {
                    "default": "Allow connections from"
                },
                "UseElasticIpAddress": {
                    "default": "Keep public ip the same"
                },
                "InstanceType": {
                    "default": "AWS EC2 Instance type"
                },
                "InstanceName": {
                    "default": "Instance Name"
                },
                "RootVolumeSize": {
                    "default": "Storage Size (GiB)"
                },
                "CustomIamRole": {
                    "default": "Custom IAM Role (Optional)"
                },
                "AdditionalIamPolicies": {
                    "default": "Additional IAM Policies (Optional)"
                },
                "VPC": {
                    "default": "VPC to deploy this stack to"
                },
                "Subnet": {
                    "default": "Subnet"
                },
                "EnablePublicIPAddress": {
                    "default": "Choose if a public IP address should be attached to the MATLAB EC2 instance"
                },
                "Password": {
                    "default": "Remote password"
                },
                "ConfirmPassword": {
                    "default": "Confirm remote password"
                },
                "SSHKeyName": {
                    "default": "SSH Key Pair"
                },
                "EnableMATLABProxy": {
                    "default": "Enable browser access for MATLAB" 
                },
                "LicenseManager": {
                    "default": "License Manager for MATLAB connection string"
                },
                "AdditionalSecurityGroup": {
                    "default": "Additional security group to place instances in"
                },
                "EnableCloudWatch": {
                    "default": "Configure cloudwatch logging for the MATLAB instance"
                },
                "AccessProtocol": {
                    "default": "Remote access protocol"
                },
                "CustomAmiId": {
                    "default": "Custom AMI ID (Optional)"
                },
                "OptionalUserCommand": {
                    "default": "Optional user inline command"
                }
            }
        }
    }
}
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/src/codebase_prompt.txt">
PROJECT STRUCTURE:
src/
    aws-matlab-template.json
    README.md
    reporoll.py
    toplevel/
        LICENSE.md
        README.md
        permission.md
    static/
        SECURITY.md
        img/
    internal/
        permissions/
            execution_policy_trust.json
            execution_policy.json
            provisioning_policy.json
            test/
                parameter_overrides.json


==================================================

FILE CONTENTS:

<file path="/home/epatel/code/matlab-aws-refarch/src/aws-matlab-template.json">
{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Mappings": {
        "RegionMap" : {}
    },
    "Resources": {
        "PredefinedRole": {
            "Type": "AWS::IAM::Role",
            "Condition": "CreateNewRole",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": { "Service": "ec2.amazonaws.com" },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "Path": "/MW/",
                "ManagedPolicyArns": {
                    "Fn::If": [
                        "UseAdditionalPolicies",
                        { "Fn::Split": [";", {"Ref": "AdditionalIamPolicies"}] },
                        { "Ref": "AWS::NoValue" }
                    ]
                },
                "Policies": [
                    {
                        "Fn::If": [
                            "UseCloudWatch",
                            {
                                "PolicyName": "cloudwatch-access-policy",
                                "PolicyDocument": {
                                    "Version": "2012-10-17",
                                    "Statement": [
                                        {
                                            "Effect": "Allow",
                                            "Action": [
                                                "logs:CreateLogStream",
                                                "logs:DescribeLogStreams",
                                                "logs:PutLogEvents"
                                            ],
                                            "Resource": {
                                                "Fn::Sub": [
                                                    "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:${LogGroupName}:*",
                                                    {
                                                        "LogGroupName": {"Ref": "MWLogLocation"}
                                                    }
                                                ]
                                            }
                                        }
                                    ]
                                }
                            },
                            { "Ref": "AWS::NoValue" }
                        ]
                    },
                    {
                        "PolicyName": "dcv-access-policy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": "s3:GetObject",
                                    "Resource": { "Fn::Sub": "arn:${AWS::Partition}:s3:::dcv-license.${AWS::Region}/*" }
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "ssm-access-policy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ssm:DescribeAssociation",
                                        "ssm:GetDeployablePatchSnapshotForInstance",
                                        "ssm:GetDocument",
                                        "ssm:DescribeDocument",
                                        "ssm:GetManifest",
                                        "ssm:GetParameter",
                                        "ssm:GetParameters",
                                        "ssm:ListAssociations",
                                        "ssm:ListInstanceAssociations",
                                        "ssm:PutInventory",
                                        "ssm:PutComplianceItems",
                                        "ssm:PutConfigurePackageResult",
                                        "ssm:UpdateAssociationStatus",
                                        "ssm:UpdateInstanceAssociationStatus",
                                        "ssm:UpdateInstanceInformation"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ssmmessages:CreateControlChannel",
                                        "ssmmessages:CreateDataChannel",
                                        "ssmmessages:OpenControlChannel",
                                        "ssmmessages:OpenDataChannel"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2messages:AcknowledgeMessage",
                                        "ec2messages:DeleteMessage",
                                        "ec2messages:FailMessage",
                                        "ec2messages:GetEndpoint",
                                        "ec2messages:GetMessages",
                                        "ec2messages:SendReply"
                                    ],
                                    "Resource": "*"
                                }
                            ]
                        }
                    },
                    {
                        "PolicyName": "describe-tags-policy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": "ec2:DescribeTags",
                                    "Resource": "*"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "MATLABInstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Path": "/MW/",
                "Roles": [
                    {
                        "Fn::If": ["CreateNewRole",
                            {
                                "Ref": "PredefinedRole"
                            },
                            {
                                "Ref": "CustomIamRole"
                            }
                        ]
                    }
                ]
            }
        },
        "EC2AutoShutdown": {
            "Type" : "AWS::CloudFormation::Stack",
            "DeletionPolicy" : "Delete",
            "UpdateReplacePolicy" : "Delete",
            "Properties" : {
                "TemplateURL" : "https://mathworks-reference-architectures-templates.s3.amazonaws.com/ec2-shutdown-lambda/v1/0/1/ec2-shutdown-lambda.yml",
                "Parameters" : {
                    "EC2InstanceId" : { "Ref" : "MATLABEC2Instance" },
                    "MathWorksProductId": "MathWorks-MATLAB-Linux",
                    "ShutdownBehaviour" : { "Ref" : "AutoShutdown" },
                    "TagToMonitor" : "mw-autoshutdown",
                    "AutoShutdownLambdaLogRetentionInDays" : 1,
                    "ShutdownLambdaExecutionRoleArn": { 
                        "Fn::If": [
                            "CreateNewRole",
                            "",
                            { "Fn::Sub" : "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/MW/${CustomIamRole}" }
                        ]
                    }
                }
            }
        },
        "MWSecurityGroup": {
            "Type" : "AWS::CloudFormation::Stack",
            "DeletionPolicy" : "Delete",
            "UpdateReplacePolicy" : "Delete",
            "Properties" : {
                "TemplateURL" : "https://mathworks-reference-architectures-templates.s3.amazonaws.com/security-group/v2/0/0/security-group.yml",
                "Parameters" : {
                    "VpcId" : { "Ref" : "VPC" },
                    "CidrRanges" : { "Ref" : "ClientIPAddress" },
                    "SSHAccess" : "Yes",
                    "RDPAccess" : "Yes",
                    "NICEDCVAccess" : "Yes",
                    "MATLABProxyAccess": "Yes"
                }
            }
        },
        "MWLogLocation": {
            "Type" : "AWS::Logs::LogGroup",
            "Condition": "UseCloudWatch",
            "DeletionPolicy" : "Delete",
            "UpdateReplacePolicy" : "Delete"
        },
        "MATLABEC2Instance": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "ImageId" : { 
                    "Fn::If": [
                        "UseCustomAMI",
                        {
                          "Ref": "CustomAmiId"
                        },
                        {
                            "Fn::FindInMap" : [ 
                                "RegionMap", 
                                {
                                    "Ref" : "AWS::Region"
                                }, 
                                "AMI"
                            ]
                        }
                    ]
                },
                "KeyName": {
                    "Ref": "SSHKeyName"
                },
                "NetworkInterfaces": [
                    {
                        "AssociatePublicIpAddress": {
                            "Fn::If": [
                                "UsePublicIp",
                                true,
                                false
                            ]
                        },
                        "DeviceIndex": "0",
                        "SubnetId": {"Ref": "Subnet"},
                        "GroupSet": [
                            { "Fn::GetAtt" : [ "MWSecurityGroup", "Outputs.SecurityGroupId" ] },
                            {
                                "Fn::If": [
                                    "AddSG",
                                    { "Ref": "AdditionalSecurityGroup" },
                                    { "Ref": "AWS::NoValue" }
                                ]
                            }
                        ]
                    }
                ],
                "InstanceType": {
                    "Ref": "InstanceType"
                },
                "IamInstanceProfile": {
                    "Ref": "MATLABInstanceProfile" 
                },
                "EbsOptimized": "true",
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/sda1",
                        "Ebs": {
                            "VolumeSize": {
                                "Ref": "RootVolumeSize"
                            }
                        }
                    }
                ],
                "Tags":[
                    { "Key": "Name", "Value":  {"Ref": "InstanceName"}},
                    { "Key": "mw-ProductID", "Value":  "MathWorks-MATLAB-Linux" },
                    { "Key": "mw-StackName", "Value": { "Ref" : "AWS::StackName" }}
                ],
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "\n",
                            [
                                "#!/bin/bash",
                                "",
                                "# Copyright 2022 The MathWorks, Inc.",
                                "",
                                "STARTUP_FOLDER=/opt/mathworks/startup",
                                "# Load startup variables",
                                "if [[ -r ${STARTUP_FOLDER}/.env ]]; then",
                                "    set -o allexport",
                                "    source ${STARTUP_FOLDER}/.env",
                                "    set +o allexport",
                                "fi",
                                "",
                                "# Define startup parameters",
                                { "Fn::Sub": [ "export PASSWORD=${PasswordBase64}", { "PasswordBase64": {"Fn::Base64": {"Ref": "Password"}} } ] },
                                { "Fn::Sub": "export MLM_LICENSE_FILE=${LicenseManager}" },
                                { "Fn::Sub": [ "export CLOUD_LOG_NAME=${LogGroupName}", { "LogGroupName": {"Fn::If": ["UseCloudWatch", {"Ref": "MWLogLocation"}, ""]} } ] },
                                { "Fn::Sub": "export ACCESS_PROTOCOL='${AccessProtocol}'" },
                                { "Fn::Sub": "export ENABLE_MATLAB_PROXY='${EnableMATLABProxy}'"},
                                { "Fn::Sub": "export OPTIONAL_USER_COMMAND='${OptionalUserCommand}'" },
                                "",
                                "# Run startup scripts",
                                "mkdir -p /var/log/mathworks",
                                "run-parts --exit-on-error --verbose --regex '^[0-9]+_.+$' ${STARTUP_FOLDER} >> /var/log/mathworks/startup.log 2>&1",
                                "",
                                "# Signal the status from cfn-init",
                                { "Fn::Sub": "/opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --region ${AWS::Region} --resource MATLABEC2Instance"}
                            ]
                        ]
                    }
                }
            },
            "CreationPolicy": {
                "ResourceSignal": {
                    "Timeout": "PT15M"
                }
            }
        },
        "ElasticIP": {
            "Type": "AWS::EC2::EIP",
            "Condition": "UseElasticIPAddress",
            "Properties": {
                "InstanceId": {"Ref" : "MATLABEC2Instance"},
                "Domain": "vpc"
            }
        },
        "document": {
            "Type": "AWS::SSM::Document",
            "Condition": "CreateNewRole",
            "Properties": {
                "DocumentType": "Command",
                "Content": {
                    "schemaVersion": "2.2",
                    "description": "Run a script on Linux instances.",
                    "parameters": {
                        "commands": {
                            "type": "String",
                            "description": "Command to run on EC2 instance",
                            "default": "echo 'Hello World'"
                        }
                    },
                    "mainSteps": [
                        {
                            "action": "aws:runShellScript",
                            "name": "runCommands",
                            "inputs": {
                                "timeoutSeconds": "60",
                                "runCommand": [
                                    "{{ commands }}"
                                ]
                            }
                        }
                    ]
                }
            }
        }
    },
    "Parameters": {
        "InstanceType": {
            "Description": "AWS instance type to use for MATLAB. For more information about instance types, see https://aws.amazon.com/ec2/instance-types.",
            "Default": "m5.xlarge",
            "Type": "String"
        },
        "InstanceName": {
            "Description": "Name for the MATLAB virtual machine.",
            "Default": "MATLAB Desktop",
            "Type": "String"
        },
        "AccessProtocol": {
            "Description": "Access protocol used to connect to the instance.",
            "Default":"RDP",
            "Type":"String",
            "AllowedValues": ["NICE DCV","RDP"]
        },
        "EnableMATLABProxy": {
            "Description": "Option that enables access to MATLAB in a browser on your cloud instance. Opening MATLAB in a browser starts a MATLAB session separate from your Remote Desktop Protocol (RDP) session or NICE DCV session.", 
            "Default":"Yes",
            "Type":"String",
            "AllowedValues": ["Yes","No"]
        },
        "EnablePublicIPAddress": {
            "Description": "Choose whether to attach a public IP address to the MATLAB EC2 instance. For details about using a private network configuration, see [Configure Private Network](#configure-private-network).",
            "Type": "String",
            "AllowedValues": [
              "Yes",
              "No"
            ],
            "Default": "Yes"
        },
        "UseElasticIpAddress": {
            "Description": "Flag specifying whether or not you want to keep the same public IP address for the instance.",
            "Default":"No",
            "Type":"String",
            "AllowedValues": ["Yes","No"]
        },
        "RootVolumeSize": {
            "Description": "Size of the root volume, in GiB.",
            "Default": "128",
            "Type": "Number",
            "MinValue": "128",
            "MaxValue": "1024",
            "ConstraintDescription": "Size must be between 128 and 1024 GiB"
        },
        "CustomIamRole": {
            "Description": "Name of a custom IAM Role to associate with this instance. Specify a role that has the necessary permissions listed in the Permission file in the GitHub repository: https://github.com/mathworks-ref-arch/matlab-on-aws/permission.md. If not specified, a predefined role is used.",
            "Default": "",
            "Type": "String"
        },
        "AdditionalIamPolicies": {
            "Description": "Semicolon-delimited list of IAM Policy ARNs to add to the predefined role. This option cannot be used with a custom IAM Role.",
            "Default": "",
            "Type": "String",
            "AllowedPattern": "^(arn:[^:;]+:iam::[^:;]+:policy\/[^:;]+(;arn:[^:;]+:iam::[^:;]+:policy\/[^:;]+)*)?$",
            "ConstraintDescription": "If specified, must be a semicolon (;) delimited list of ARNs (arn:<partition>:iam::<account-id>:policy/<resource-id>)."
        },
        "VPC": {
            "Description": "ID of an existing VPC to deploy this stack in.",
            "Type": "AWS::EC2::VPC::Id",
            "ConstraintDescription": "Must be the ID of an existing VPC.",
            "AllowedPattern" : ".+"
        },
        "Subnet": {
            "Description": "ID of an existing subnet in the VPC.",
            "Type": "AWS::EC2::Subnet::Id",
            "ConstraintDescription": "Must be the ID of an existing subnet within the chosen VPC.",
            "AllowedPattern" : ".+"
        },
        "SSHKeyName": {
            "Description": "Name of an existing EC2 key pair to allow SSH access to all the instances. For more information about creating these key pairs, see https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html.",
            "Type": "AWS::EC2::KeyPair::KeyName",
            "ConstraintDescription": "Must be the name of an existing EC2 KeyPair.",
            "AllowedPattern" : ".+"
        },
        "ClientIPAddress": {
            "Description": "Comma-separated list of IP address ranges that will be allowed to connect to this instance. Each IP CIDR must have the format <ip_address>/<mask>. The mask determines the number of IP addresses to include. A mask of 32 specifies a single IP address. Examples of allowed values: 10.0.0.1/32, 10.0.0.0/16,192.34.56.78/32. To identify the public IP address of your machine, you can use https://checkip.amazonaws.com. To build a specific range, you can use https://www.ipaddressguide.com/cidr. To determine which address is appropriate, contact your IT administrator.",
            "Type": "String",
            "MinLength": "9",
            "MaxLength": "189",
            "AllowedPattern": "^((\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2}))(,((\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2}))){0,9}$",
            "ConstraintDescription": "Must be a comma-separated list of valid IP CIDR ranges of the form x.x.x.x/x. A maximum of 10 such IP CIDRs are allowed in the list."
        },
        "Password": {
            "NoEcho": "true",
            "Description": "Password for the \"ubuntu\" user. You must also enter this password as an authentication token to access MATLAB in a browser on your cloud instance.",
            "Type": "String",
            "ConstraintDescription": "Must have a minimum of 14 characters, 1 uppercase letter, 1 lowercase letter, 1 number, and 1 special character",
            "AllowedPattern": "^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[^a-zA-Z0-9]).{14,}$"
        },
        "ConfirmPassword": {
            "NoEcho": "true",
            "Description": "Confirm password.",
            "Type": "String"
        },
        "LicenseManager": {
            "Description": "Optional License Manager for MATLAB, specified as a string of the form <port>@<hostname>. If not specified, online licensing is used instead. If specified, the network license manager (NLM) must be accessible from the specified VPC and subnets. To use the private hostname of the NLM hub instead of the public hostname, specify the security group ID of the NLM hub in the AdditionalSecurityGroup parameter. For more information, see https://github.com/mathworks-ref-arch/license-manager-for-matlab-on-aws.",
            "Type": "String",
            "Default": "",
            "AllowedPattern": "([0-9]+@[a-zA-Z0-9.\\-]+)?",
            "ConstraintDescription": "If specified, must be of the form <port>@<hostname>"
        },
        "EnableCloudWatch": {
            "Description": "Flag specifying whether to enable cloudwatch logging for the MATLAB instance. For private instances, CloudWatch logs might not be updated unless you set up a NAT Gateway or VPC endpoint. For details about private networking, see [Configure Private Network](#configure-private-network).",
            "Type": "String",
            "AllowedValues" : ["Yes", "No"],
            "Default": "No"
        },
        "AutoShutdown": {
            "Description": "Choose whether you want to enable autoshutdown for your instance after a certain number of hours",
            "Type": "String",
            "AllowedValues" : ["Never", "After 1 hour","After 2 hours","After 3 hours","After 4 hours","After 5 hours","After 6 hours","After 7 hours","After 8 hours","After 9 hours","After 10 hours","After 11 hours","After 12 hours","After 13 hours","After 14 hours","After 15 hours","After 16 hours","After 17 hours","After 18 hours","After 19 hours","After 20 hours","After 21 hours","After 22 hours","After 23 hours","After 24 hours"],
            "Default": "Never"
        },
        "AdditionalSecurityGroup": {
            "Description": "(Optional) ID of an additional security group to place the instances in. Often the security group of the License Manager for MATLAB.",
            "Type": "String",
            "Default": ""
        },
        "CustomAmiId": {
            "Default": "",
            "Description": "(Optional) ID of a custom Amazon Machine Image (AMI) in the target region. If the build has been customized then the resulting machine image might no longer be compatible with the provided CloudFormation template. In some cases you can restore compatability by making corresponding modifications to the CloudFormation template. The ID must start with 'ami-'.",
            "Type": "String"
          },
        "OptionalUserCommand": {
            "Description": "Provide an optional inline shell command to run on machine launch. For example, to set an environment variable CLOUD=AWS, use this command, excluding the angle brackets: <echo -e \"export CLOUD=AWS\" | tee -a /etc/profile.d/setenvvar.sh && source /etc/profile>. To run an external script, use this command, excluding the angle brackets: <wget -O /tmp/my-script.sh \"https://www.example.com/script.sh\" && bash /tmp/my-script.sh>. Find the logs at '/var/log/mathworks/startup.log'.",
            "Type": "String",
            "Default": ""
        }
    },
    "Rules": {
        "ElasticIPRequiresPublicIP": {
            "RuleCondition": {
                "Fn::Equals": [
                    {
                        "Ref": "EnablePublicIPAddress"
                    },
                    "No"
                ]
            },
            "Assertions": [
                {
                    "Assert": {
                        "Fn::Equals": [
                            {"Ref": "UseElasticIpAddress"},
                            "No"
                        ]
                    },
                    "AssertDescription": "Elastic IP cannot be used when Public IP address is disabled."
                }
            ]
        },
        "matchPasswords": {
            "Assertions": [
                {
                    "Assert": {
                        "Fn::Equals": [
                            {
                                "Ref": "Password"
                            },
                            {
                                "Ref": "ConfirmPassword"
                            }
                        ]
                    },
                    "AssertDescription": "Passwords do not match"
                }
            ]
        },
        "SubnetInVPC": {
            "Assertions": [
                {
                    "Assert": {
                        "Fn::EachMemberEquals": [
                            {
                            "Fn::ValueOfAll": [
                                "AWS::EC2::Subnet::Id",
                                "VpcId"
                            ]
                            },
                            {
                                "Ref": "VPC"
                            }
                        ]
                    },
                    "AssertDescription":"Subnet must exist in the VPC you have selected"
                }
            ]
        },
        "NoAdditionalPoliciesOnCustomRole" : {
            "RuleCondition": {
                "Fn::Not": [{"Fn::Equals": [{"Ref": "CustomIamRole"}, ""]}]
            },
            "Assertions": [
                {
                    "Assert": {
                        "Fn::Equals": [{"Ref": "AdditionalIamPolicies"}, ""]
                    },
                    "AssertDescription": "You cannot add IAM Policies when using a custom IAM Role."
                }
            ]
        }
    },
    "Conditions": {
        "UsePublicIp": {
            "Fn::Equals": [
              {
                "Ref": "EnablePublicIPAddress"
              },
              "Yes"
            ]
        },
        "CreateNewRole": {
            "Fn::Equals": [{"Ref": "CustomIamRole"}, ""]
        },
        "UseAdditionalPolicies": {
            "Fn::Not": [{"Fn::Equals": [{"Ref": "AdditionalIamPolicies"}, ""]}]
        },
        "UseCloudWatch": {
            "Fn::Equals": [{"Ref": "EnableCloudWatch"}, "Yes"]
        },
        "UseNICEDCV": {
            "Fn::Equals": [{"Ref": "AccessProtocol"}, "NICE DCV"]
        },
        "UseXRDP": {
            "Fn::Equals": [{"Ref": "AccessProtocol"}, "RDP"]
        },
        "UseMATLABProxy": {
            "Fn::Equals": [{"Ref": "EnableMATLABProxy"}, "Yes"]
        },
        "UseElasticIPAddress": {
            "Fn::Equals": [{"Ref": "UseElasticIpAddress"}, "Yes"]
        },
        "UseCustomAMI":{
            "Fn::Not": [ { "Fn::Equals": [ { "Ref": "CustomAmiId" }, "" ] } ]
        },
        "AddSG": {
            "Fn::Not": [{"Fn::Equals": [{"Ref": "AdditionalSecurityGroup"}, ""]}]
        }
    },
    "Outputs": {
        "CloudWatchLogs": {
            "Condition": "UseCloudWatch",
            "Description": "The cloudwatch logs containing logging information about the MATLAB instance",
            "Value": { "Fn::Sub": "https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#logsV2:log-groups/log-group/${MWLogLocation}" }
        },
        "NiceDCVConnection": {
            "Condition": "UseNICEDCV",
            "Description": "URL of the newly created EC2 instance to connect to the session via NICE DCV",
            "Value": { "Fn::If": [ "UsePublicIp", { "Fn::Sub": "https://${MATLABEC2Instance.PublicDnsName}:8443/#console" }, { "Fn::Sub": "https://${MATLABEC2Instance.PrivateDnsName}:8443/#console" } ] }
        },
        "RDPConnection": {
            "Condition": "UseXRDP",
            "Description": "DNS of the newly created EC2 instance.",
            "Value": {
                "Fn::If": [
                    "UsePublicIp",
                    {
                        "Fn::GetAtt": [
                        "MATLABEC2Instance",
                        "PublicDnsName"
                        ]
                    },
                    {
                        "Fn::GetAtt": [
                        "MATLABEC2Instance",
                        "PrivateDnsName"
                        ]
                    }
                ]
            }
        },
        "BrowserConnection": {
            "Condition": "UseMATLABProxy",
            "Description": "URL to connect to and open MATLAB in a browser.",
            "Value": { "Fn::If": [ "UsePublicIp", { "Fn::Sub": "https://${MATLABEC2Instance.PublicDnsName}:8123" }, { "Fn::Sub": "https://${MATLABEC2Instance.PrivateDnsName}:8123" } ] }
        }
    },
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "EC2 Instance"
                    },
                    "Parameters": [
                        "InstanceName",
                        "InstanceType",
                        "RootVolumeSize",
                        "CustomIamRole",
                        "AdditionalIamPolicies"
                    ]
                },
                {
                    "Label": {
                        "default": "Network Configuration"
                    },
                    "Parameters": [
                        "VPC",
                        "Subnet",
                        "AdditionalSecurityGroup",
                        "EnablePublicIPAddress",
                        "UseElasticIpAddress"
                    ]
                },
                {
                    "Label": {
                        "default": "Remote Access"
                    },
                    "Parameters": [
                        "AccessProtocol",
                        "EnableMATLABProxy",
                        "ClientIPAddress",
                        "SSHKeyName",
                        "Password",
                        "ConfirmPassword"
                    ]
                },
                {
                    "Label": {
                        "default": "License Configuration"
                    },
                    "Parameters": [
                        "LicenseManager"
                    ]
                },
                {
                    "Label": {
                        "default": "Logging Configuration"
                    },
                    "Parameters": [
                        "EnableCloudWatch"
                    ]
                },
                {
                    "Label": {
                        "default": "Autoshutdown Configuration"
                    },
                    "Parameters": [
                        "AutoShutdown"
                    ]
                },
                {
                    "Label": {
                        "default": "Custom AMI"
                    },
                    "Parameters": [
                        "CustomAmiId"
                    ]
                },
                {
                    "Label": {
                        "default": "Optional User Command"
                    },
                    "Parameters": [
                        "OptionalUserCommand"
                    ]
                }
            ],
            "ParameterLabels": {
                "ClientIPAddress": {
                    "default": "Allow connections from"
                },
                "UseElasticIpAddress": {
                    "default": "Keep public ip the same"
                },
                "InstanceType": {
                    "default": "AWS EC2 Instance type"
                },
                "InstanceName": {
                    "default": "Instance Name"
                },
                "RootVolumeSize": {
                    "default": "Storage Size (GiB)"
                },
                "CustomIamRole": {
                    "default": "Custom IAM Role (Optional)"
                },
                "AdditionalIamPolicies": {
                    "default": "Additional IAM Policies (Optional)"
                },
                "VPC": {
                    "default": "VPC to deploy this stack to"
                },
                "Subnet": {
                    "default": "Subnet"
                },
                "EnablePublicIPAddress": {
                    "default": "Choose if a public IP address should be attached to the MATLAB EC2 instance"
                },
                "Password": {
                    "default": "Remote password"
                },
                "ConfirmPassword": {
                    "default": "Confirm remote password"
                },
                "SSHKeyName": {
                    "default": "SSH Key Pair"
                },
                "EnableMATLABProxy": {
                    "default": "Enable browser access for MATLAB" 
                },
                "LicenseManager": {
                    "default": "License Manager for MATLAB connection string"
                },
                "AdditionalSecurityGroup": {
                    "default": "Additional security group to place instances in"
                },
                "EnableCloudWatch": {
                    "default": "Configure cloudwatch logging for the MATLAB instance"
                },
                "AccessProtocol": {
                    "default": "Remote access protocol"
                },
                "CustomAmiId": {
                    "default": "Custom AMI ID (Optional)"
                },
                "OptionalUserCommand": {
                    "default": "Optional user inline command"
                }
            }
        }
    }
}
</file>

<file path="/home/epatel/code/matlab-aws-refarch/src/README.md">
# MATLAB on Amazon Web Services (Linux VM)

## Step 1. Launch the Template

Click the **Launch Stack** button to deploy a standalone MATLAB&reg; desktop client on AWS&reg;. This opens the CloudFormation Create Stack screen in your web browser.

| Region | Launch Link |
| --------------- | ----------- |
{% for region in regions -%}
| **{{ region }}** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start a MATLAB instance using the template")](https://{{ region }}.console.aws.amazon.com/cloudformation/home?region={{ region }}#/stacks/create/review?templateURL={{ template_url }}) |
{% endfor %}

**Note**: Creating a stack on AWS can take a few minutes.

## Step 2. Configure the Cloud Resources
After you click the Launch Stack button above, the “Create stack” page will open in your browser where you can configure the parameters. It is easier to complete the steps if you position these instructions and the AWS console window side by side.

1. Specify a stack name. This will be shown in the AWS CloudFormation console and must be unique within the AWS account.


2. Specify and check the defaults for these resource parameters:

| Parameter label | Description |
| --------------- | ----------- |
{% for parameter in parameters -%}
| **{{ parameter.label }}** | {{ parameter.description }} |
{% endfor %}

>**Note**: In the capabilities section, you must acknowledge that AWS Cloudformation might create IAM resources and autoexpand nested templates when creating the stack.

3. Click the **Create Stack** button.  The CloudFormation service will start creating the resources for the stack. <p>After clicking **Create** you will be taken to the *Stack Detail* page for your stack. Wait for the Status to reach **CREATE\_COMPLETE**. This may take up to 10 minutes.</p>

## Step 3. Connect to the Virtual Machine in the Cloud

If you chose RDP, then:
1. Expand the **Outputs** section in the the *Stack Detail* page.
2. Find and click the key named `RDPConnection` and copy the corresponding DNS name listed under value. *For example*: ec2-11-222-33-44.compute-1.amazonaws.com, or ip-11-222-33-44.ec2.internal, for a private instance.
3. Launch any remote desktop client, paste the DNS name in the appropriate field, and connect. On the Windows Remote Desktop Client you need to paste the DNS name in the **Computer** field and click **Connect**.
4. In the login screen displayed, use the username `ubuntu` and the password you specified while setting up the stack in [Step 2](#step-2-configure-the-stack).

If you chose NICE DCV, then:
1. Expand the **Outputs** section in the the *Stack Detail* page.
2. Find and click the key named `NiceDCVConnection`.
3. In the login screen displayed, use the username `ubuntu` and the password you specified while setting up the stack in [Step 2](#step-2-configure-the-stack).

If you chose to enable browser access for MATLAB, then:
1. Expand the **Outputs** section in the *Stack Details* page.
2. Find and click the key named `BrowserConnection`.
3. On the login screen, use the password you specified while deploying the stack in [Step 2](#step-2-configure-the-stack) as the 'auth token' to authenticate.
4. Browser access for MATLAB is enabled using `matlab-proxy`, a Python&reg; package developed by MathWorks&reg;. For more information on `matlab-proxy`, see [MATLAB Proxy on Github](https://github.com/mathworks/matlab-proxy).

## Step 4. Start MATLAB
Double-click the MATLAB icon on the virtual machine desktop to start MATLAB. The first time you start MATLAB, you need to enter your MathWorks Account credentials to license MATLAB. For other ways to license MATLAB, see [MATLAB Licensing in the Cloud](https://www.mathworks.com/help/install/license/licensing-for-mathworks-products-running-on-the-cloud.html).

>**Note**: It may take up to a minute for MATLAB to start the first time.


# Additional Information

## Configure Private Network
To set up a private networking configuration for the MATLAB EC2 instance, you can set the `EnablePublicIPAddress` parameter to `No` to avoid attaching a public IP to the MATLAB EC2 instance. Ensure these requirements before deploying your stack:

- **Client Access**: Specify the private IP addresses of the jumpbox or client(s) that will access the MATLAB EC2 instance, using the `ClientIPAddress` parameter. 
- **Online Licensing**: To use online licensing for MATLAB, your MATLAB EC2 instance must be able to access domains at `*.mathworks.com`. Allow outbound access to these domains by setting up an appropriate method in your VPC.
- **Stack Deployment**: Without a public IP, the MATLAB EC2 instance might get stuck in the `CREATE_IN_PROGRESS` state during stack deployment. To avoid this, ensure that your VPC has a NAT Gateway or a [VPC endpoint for the AWS CloudFormation service (AWS)](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/vpc-interface-endpoints.html#vpc-endpoint-create) before deployment.
- **CloudWatch Logs**: To deliver CloudWatch logs from the instance, ensure that your VPC has either a NAT Gateway or a [VPC endpoint for CloudWatch service (AWS)](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/cloudwatch-logs-and-interface-VPC.html#create-VPC-endpoint-for-CloudWatchLogs).
- **NICE DCV and S3 Data transfer**: To use NICE DCV or for data transfer between the MATLAB EC2 instance and S3 buckets, ensure that your VPC is configured to use [Gateway endpoint for the Amazon S3 service](https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints-s3.html#create-gateway-endpoint-s3). The MATLAB EC2 instance must be able to reach the S3 service for NICE DCV license verification.

To easily create a VPC with these settings, you can use the [VPC CloudFormation Template](https://github.com/mathworks-ref-arch/iac-building-blocks/tree/main/aws/vpc-template/v1/README.md).

## Delete Your Cloud Resources

Once you have finished using your stack, it is recommended that you delete all resources to avoid incurring further cost. To delete the stack, do the following:
1. Log in to the AWS Console.
2. Go to the AWS CloudFormation page and select the stack you created.
3. Click the **Actions** button and click **Delete Stack** from the menu that appears.

## Nested Stacks

This CloudFormation template uses nested stacks to reference templates used by multiple reference architectures. For details, see the [MathWorks Infrastructure as Code Building Blocks](https://github.com/mathworks-ref-arch/iac-building-blocks) repository.

## CloudWatch Logs
CloudWatch logs enables you to access logs from all the resources in your stack in a single place. To use CloudWatch logs, launch the stack with the feature "Configure cloudwatch logging for the MATLAB instance" enabled. Once the stack deployment is complete, you can access your logs in the "Outputs" of the stack by clicking the link next to "CloudWatchLogs". Note that if you delete the stack, the CloudWatch log group is also deleted. For more information, see [What is Amazon CloudWatch Logs?](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/WhatIsCloudWatchLogs.html).

----

Copyright 2018-2025 The MathWorks, Inc.

----

</file>

<file path="/home/epatel/code/matlab-aws-refarch/src/reporoll.py">
#!/usr/bin/env python3
import os
import fnmatch

# Configuration: Folders and files to always ignore
IGNORE_DIRS = {
    '.git', '__pycache__', 'node_modules', 'venv', '.env', 
    '.idea', '.vscode', 'dist', 'build', 'coverage'
}

IGNORE_FILES = {
    'package-lock.json', 'yarn.lock', '*.lock', '*.pyc', 
    '*.png', '*.jpg', '*.jpeg', '*.gif', '*.ico', '*.svg', 
    '*.exe', '*.dll', '*.so', '*.dylib', '.DS_Store'
}

def should_ignore(name, is_dir=False):
    """Checks if a file or directory should be ignored."""
    if is_dir:
        return name in IGNORE_DIRS
    
    # Check exact matches
    if name in IGNORE_FILES:
        return True
    
    # Check glob patterns (e.g., *.png)
    for pattern in IGNORE_FILES:
        if fnmatch.fnmatch(name, pattern):
            return True
    return False

def is_binary(file_path):
    """Simple heuristic to detect binary files."""
    try:
        with open(file_path, 'tr') as check_file:
            check_file.read()
            return False
    except:
        return True

def generate_tree(start_path):
    """Generates a string representation of the file tree."""
    tree_str = "PROJECT STRUCTURE:\n"
    for root, dirs, files in os.walk(start_path):
        dirs[:] = [d for d in dirs if not should_ignore(d, is_dir=True)]
        level = root.replace(start_path, '').count(os.sep)
        indent = ' ' * 4 * (level)
        tree_str += f"{indent}{os.path.basename(root)}/\n"
        subindent = ' ' * 4 * (level + 1)
        for f in files:
            if not should_ignore(f):
                tree_str += f"{subindent}{f}\n"
    return tree_str

def roll_codebase(start_path):
    """Reads all files and formats them into a prompt."""
    output = []
    
    # 1. Add the file tree
    output.append(generate_tree(start_path))
    output.append("\n" + "="*50 + "\n")
    output.append("FILE CONTENTS:\n")

    # 2. Walk through files
    for root, dirs, files in os.walk(start_path):
        # Modify dirs in-place to skip ignored directories
        dirs[:] = [d for d in dirs if not should_ignore(d, is_dir=True)]

        for file in files:
            if should_ignore(file):
                continue

            file_path = os.path.join(root, file)
            
            # Skip binaries
            if is_binary(file_path):
                print(f"Skipping binary file: {file_path}")
                continue

            # Format the output using XML tags for clarity
            try:
                with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                    content = f.read()
                    
                output.append(f'<file path="{file_path}">\n{content}\n</file>\n')
            except Exception as e:
                print(f"Error reading {file_path}: {e}")

    return "\n".join(output)

if __name__ == "__main__":
    # Get current directory
    cwd = os.getcwd()
    print(f"Rolling codebase from: {cwd} ...")
    
    full_prompt = roll_codebase(cwd)
    
    # Write to file
    output_filename = "codebase_prompt.txt"
    with open(output_filename, "w", encoding="utf-8") as f:
        f.write(full_prompt)
        
    print(f"Done! Prompt saved to: {output_filename}")
</file>

<file path="/home/epatel/code/matlab-aws-refarch/src/toplevel/LICENSE.md">
MATHWORKS CLOUD REFERENCE ARCHITECTURE LICENSE

The files in this GitHub repository refer to commercial software products and services, virtual machine images, and related materials of The MathWorks, Inc. (“MathWorks Programs”). MathWorks Programs are separately licensed under the MathWorks Software License Agreement, available in the desktop installation of the MathWorks Programs or in the virtual machine image. The files in this GitHub repository may also refer to third-party software licensed under separate terms provided by such third parties.

The following license terms apply only to the files in this GitHub repository, including files in this folder and its subfolders, and do not apply to MathWorks Programs. References to “software” and “code” in the following license terms refer to the files in this GitHub repository.

Copyright 2020 - {{current_year}} The MathWorks, Inc.

All rights reserved.

Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:

1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.
3. In all cases, the software is, and all modifications and derivatives of the software shall be, licensed to you solely for use in conjunction with MathWorks products and service offerings.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

</file>

<file path="/home/epatel/code/matlab-aws-refarch/src/toplevel/README.md">
# MATLAB on Amazon Web Services

This repository shows how to deploy MATLAB&reg; on an Amazon EC2&reg; instance using your Amazon&reg; Web Services (AWS&reg;) account and connect to it using the Remote Desktop Protocol (RDP), SSH, or NICE DCV. The automation uses an AWS CloudFormation template. 

For information about the architecture of this solution, see [Learn about Architecture](#learn-about-architecture). For information about templates, see [AWS CloudFormation Templates](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-guide.html).

This reference architecture has been reviewed and qualified by AWS.

![AWS Qualified Software badge](img/aws-qualified-software.png)


## Requirements
You need:
* A MATLAB license. For more information, see [License Requirements for MATLAB on Cloud Platforms](https://www.mathworks.com/help/install/license/licensing-for-mathworks-products-running-on-the-cloud.html).
* An [Amazon Web Services (AWS)](https://aws.amazon.com) account.
* A key pair for your AWS account, in the appropriate region. For more information, see [Amazon EC2 Key Pairs](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html).

## Costs
You are responsible for the cost of the AWS services used when you create cloud resources using this guide. Resource settings, such as instance type, affect the cost of deployment. For cost estimates, see the pricing pages for each AWS service you will be using. Prices are subject to change.

# Deployment Steps
By default, the MATLAB reference architectures below launch prebuilt machine images, described in [Learn about Architecture](#learn-about-architecture).
Using a prebuilt machine image is the easiest way to deploy a MATLAB reference architecture.
Prebuilt images are provided for the five most recent MATLAB releases.
Alternatively, to build your own machine image,
see [Build and Deploy Your Own Machine Image](#build-and-deploy-your-own-machine-image).
You can also use this workflow to install an earlier MATLAB release.

## Deploy Prebuilt Machine Image
To view instructions for deploying the MATLAB reference architecture, select a MATLAB release:

| Linux | Windows | Status |
| ----- | ------- | ------- |
{% for release in releases -%}
| {% if release.dir %}[{{ release.label }}](releases/{{ release.dir }}/README.md){% endif %} | {% if release.dual_url %}[{{ release.label }}]({{ release.dual_url }}/README.md){% endif %} | {% if loop.index >= 4 %}⚠️ Prebuilt will be removed in {{ release.removal_month }} {{ release.removal_year }}.{% else %}✅ Prebuilt available.{% endif %} |
{% endfor %}| [Earlier/Custom](./packer/v1) | {% if dual_url %}[Earlier/Custom]({{ dual_url }}/tree/master/packer/v1){% endif %} | For earlier MATLAB releases, you must build your own machine image. |

The above instructions allow you to launch instances based on the latest prebuilt MathWorks&reg; Amazon Machine Images (AMIs).
MathWorks periodically replaces older AMIs with new images.
For more details, see
[When are the MathWorks Amazon Machine Images updated?](#when-are-the-mathWorks-amazon-machine-images-updated)

## Build and Deploy Your Own Machine Image
For details of the scripts which form the basis of the MathWorks Linux AMI build process,
see [Build Your Own Machine Image](./packer/v1).
You can use these scripts to build a custom Linux machine image for running MATLAB on Amazon Web Services.
You can then deploy this custom image with the MathWorks infrastructure as code (IaC) templates.

You can customize the MATLAB release which is installed as part of this custom build.
This includes MATLAB releases supported by the prebuilt images, as well as earlier MATLAB releases.
For more details,
see [Customize MATLAB Release to Install](./packer/v1#customize-matlab-release-to-install).

Platform engineering teams can use these scripts to take advantage of optimizations MathWorks has developed
for running MathWorks products in the cloud.
For more details, see [What are the advantages of building images with MathWorks scripts?](#what-are-the-advantages-of-building-images-with-mathworks-scripts)

## Learn about Architecture

![MATLAB on AWS Reference Architecture](img/aws-matlab-diagram.png)

Deploying this reference architecture sets up a single AWS EC2 instance containing MATLAB, a private VPC with an internet gateway, a private subnet, and a security group that opens the appropriate ports for SSH and RDP access.

The Amazon Machine Image (AMI) contains pre-installed drivers and the following software:
* MATLAB, Simulink, toolboxes, and support for GPUs.
* Add-ons: several pretrained deep neural networks for classification, feature extraction, and transfer learning with Deep Learning Toolbox&trade;, including GoogLeNet, ResNet-50, and NASNet-Large.

### Resources

The following resources will be created as part of the CloudFormation Stack:

1. Security Group for SSH and RDP access
2. EC2 Instance

The following resources might be created, depending on your deployment configuration:

1. IAM role
2. A CloudWatch log group
3. An elastic IP address
4. A SSM document

## FAQ

### What permissions are required by end users to deploy MATLAB in an AWS account?

You do not need administrative-level access in AWS to deploy this reference architecture. If users already have the necessary permissions, no further action is required. If you are unsure whether you have sufficient permissions to deploy MATLAB on AWS, check with your AWS administrator and share the [permission document](./permission.md) with them. Using this document, administrators can assign the required permissions following the principle of least privilege. This document is kept current with the latest MATLAB release.

AWS administrators can assign the necessary permissions to end users in two ways:

* **Full Stack Creation Workflow**: MATLAB Users can create the entire stack. This approach is recommended for streamlined setups.

* **Pass Role Workflow**: MATLAB Users can only create non-IAM resources in their stack. AWS admins must create necessary IAM roles that the user must pass to the stack. This approach is suitable for tighter control over IAM policies.

For both options, the permission document provides a CloudFormation template to generate the necessary IAM roles and permissions. This template also supports granting additional permissions to EC2 instances depending on specific users' needs.

### When are the MathWorks Amazon Machine Images updated?
The links in [Deployment Steps](#deployment-steps) launch instances based on the latest MathWorks
AMIs for at least the four most recent MATLAB releases. MATLAB releases occur twice each year.

For each MATLAB release, MathWorks periodically replaces the corresponding AMI with a newer AMI
that includes the latest MATLAB updates and important security updates of the base OS image.

When MathWorks replaces an AMI, the older AMI is deleted.
However, any running instances previously launched from the older AMI are not affected.
To continue using an older AMI, copy the AMI into your AWS account.
For more details on how to copy an AMI, see
[How do I copy the AMI?](#how-do-I-copy-the-ami)
For more details on how to customize the reference architectures to
deploy the copied AMI see [How do I customize the AMI?](#how-do-I-customize-the-ami)

### How do I save my changes in the AMI?
All your files and changes are stored locally on the EC2 Instance. They persist until you either terminate the instance or delete the stack. Stopping the instance does not destroy the data on the instance. If you want your changes to persist outside the stack or before you terminate an instance, you need to:
* Copy your files to another location, or
* Create an image of the virtual machine.

### What happens to my data if I shut down the instance?
To minimize costs, you might want to shut down the instance when you are not using it. When the virtual machine is stopped, you are only charged for storage. To shut down an EC2 instance, locate it in the AWS web console, select the instance and choose “Instance State/Stop” from the “Actions” menu. You can restart it from the same menu. Any files or changes you make to the virtual machine will persist when you shut it down and will be present when you restart it. Shutting down the virtual machine and restarting it might change the public IP address and DNS name. Inspecting the EC2 instance in the AWS console will reveal the new IP address and DNS name.

### How do I keep the same public IP address?
To avoid having to change the IP address between restarts, enable the **Keep public IP address the same** option during deployment. For more information, see [Elastic IP addresses](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html).

### How do I manage my EC2 quotas?
See [Amazon EC2 Service Quotas](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-resource-limits.html).

### How do I save or copy an AMI?
To save an AMI, locate the EC2 Instance in the AWS web console and select **Actions** > **Image** > **Create Image.**

To copy the AMI for a certain MATLAB version to a target region of your choice, follow these steps:
* Choose the MATLAB release that you want to copy from the Releases folder of this repository. Download and open the CloudFormation template .json file for that release.
* Locate the Mappings section in the CloudFormation template. Copy the AMI ID for one of the existing regions, for example, us-east-1.
* To copy the AMI to your target region, see [Copy an AMI](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/CopyingAMIs.html) in the AWS documentation.
* In the Mappings section of the CloudFormation template, add a new RegionMap pair corresponding to your target region. Insert the new AMI ID of the AMI in the target region.
* In your AWS Console, change your region to your target region. In the CloudFormation menu, select the **Create Stack > With new resources** option. Provide the modified CloudFormation template.

You can now deploy the AMI in your target region using the AMI that you copied.

### How do I customize the AMI?
You can customize a prebuilt AMI by launching the reference architecture, applying changes you want to the EC2 Instance (such as installing additional software, drivers, and files), then saving an image of that instance using the AWS Console. For more information, see [How do I save or copy an AMI?](#how-do-i-save-or-copy-an-ami). When you create a stack, replace the AMI ID in the CloudFormation template with the AMI ID of your customized image.

You can also create a custom image by building your own using the Packer scripts we provide. See [Build and Deploy Your Own Machine Image](#build-and-deploy-your-own-machine-image).

### How do I use a different license manager?
The AMI uses MathWorks Hosted License Manager by default. For information on how to use other license managers, see [MATLAB Licensing in the Cloud](https://www.mathworks.com/help/install/license/licensing-for-mathworks-products-running-on-the-cloud.html).

### What are the advantages of building images with MathWorks scripts?
Images built with MathWorks scripts are optimized and tested for MathWorks workflows.
The images are deployed by MathWorks CloudFormation templates following AWS best practices.

The warmup scripts found in [startup](./packer/v1/startup) allow you to start MATLAB faster. The CloudFormation template uses these scripts to automatically initialize MathWorks files on the instance. This allows MATLAB to be responsive in as little as a minute after you start it. These scripts are automatically included in both the prebuilt images and the images that you build using the instructions in [Deployment Steps](#deployment-steps).

Without the optimization scripts, starting a large software application, such as MATLAB, for the first time can potentially take tens of minutes. Subsequent starts of the large software application will be faster. This is because AWS initializes the storage for the EC2 instance, as described in [Initialize Amazon EBS volumes](https://docs.aws.amazon.com/ebs/latest/userguide/ebs-initialize.html).



Other scripts in this repo also enable options for connecting to the instance, ensure that all the necessary MATLAB dependencies are installed, and make it easy to build an image with an older MATLAB release.

# Technical Support
To request assistance or additional features, contact [MathWorks Technical Support](https://www.mathworks.com/support/contact_us.html).

----

Copyright 2018-2025 The MathWorks, Inc.

----

</file>

<file path="/home/epatel/code/matlab-aws-refarch/src/toplevel/permission.md">
# Assign AWS IAM Permissions for MATLAB Users on Linux

AWS® administrators can grant the least privileged permissions to end users to deploy MATLAB® on a Linux® instance in AWS. If you are an end user, contact your AWS administrator to grant you the necessary permissions.

AWS administrators can choose between two permission levels for their users:

* *Full Stack Creation workflow*: Users can create the entire stack. This approach is recommended for streamlined setups.
* *Pass Role Workflow*: Users can only create non-IAM resources in their stack. AWS admins must create necessary IAM roles that the user must pass to the stack. This approach is suitable for tighter control over IAM policies.

For both options, see the [Quick Start using AWS CloudFormation template](#quick-start-using-aws-cloudformation-template) section to automatically generate the necessary IAM policies. If you want further configuration of the IAM policies, see [Customize IAM policies](#customize-iam-policies) section.

## Quick Start using AWS CloudFormation template

Using the CloudFormation template below is recommended for most use cases, as it automatically creates and configures your AWS account to grant the necessary permissions to your users.

1. Deploy the Permission CloudFormation template.<br>
    Click the "Launch Stack" button to open the CloudFormation console, fill out the template parameters, and create the stack. You must be logged in to your AWS account before clicking the button below.<br><br>

   [![Deploy Reference Architecture Permission Stack](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png)](https://console.aws.amazon.com/cloudformation/home?#/stacks/create/review?templateURL=https://mathworks-reference-architectures-templates.s3.us-east-1.amazonaws.com/permissions-template/v1/0/0/permissions-template.json)<br>

    <details> <summary>CloudFormation template parameters</summary> <table><thead><tr><th>Parameter Label</th><th>Description</th></tr></thead><tbody>

    <tr><td>Enable MATLAB deployment</td><td>Select yes to allow your users to deploy MATLAB. <br><br> <strong>Note: </strong>You might see other MathWorks' cloud products in the CloudFormation console, and if you want, you can enable those for your users as well.</td></tr>

    <tr><td>User permission level</td><td>Choose 'Full Stack Creation' or 'Pass Role' workflows. 'Full Stack Creation' allows users to create the entire stack, including IAM roles, while following the principle of least privilege. Recommended for streamlined setups. 'Pass Role Workflow' limits users to resource creation only. Suitable for tighter control over IAM roles and permissions.</td></tr>

    <tr><td>AWS Region restriction</td><td>Allowed AWS Region to deploy resources. Select '*' for all regions.</td></tr>

    <tr><td>Resource naming prefix</td><td>Prefix to restrict users to create CloudFormation stacks or resources with names starting with this value. Use up to 10 lowercase letters or hyphens. Useful for isolating resources by team (for example, 'engr-', 'mrkt-').</td></tr>

    <tr><td>Additional IAM policies for Common Execution Role</td><td>(Optional) Specify up to five valid IAM policy ARNs (AWS-managed or customer-managed) to grant additional permissions to your users' EC2 instances. These policies must have a path equal to '/MW/' and a name starting with the value in 'Resource Naming Prefix'. Applicable only when you configure 'User Permission Level' to 'Pass Role Workflow'. Users with 'Full Stack Creation' permissions can directly pass IAM policy ARNs during stack deployment.</td></tr>

    <tr><td>IAM role names</td><td>(Optional) Comma-separated list of existing IAM roles to extend permissions to. For example, specify existing IAM roles assumed by users to extend their permissions to allow users to deploy MathWorks' Reference Architecture.</td></tr>

    <tr><td>IAM group names</td><td>(Optional) Comma-separated list of existing IAM groups to extend permissions to. Applies to all members in these groups.</td></tr>

    <tr><td>IAM user names</td><td>(Optional) Comma-separated list of existing IAM users to extend permissions to.</td></tr>

    <tr><td>AWS principal ARN</td><td>(Optional) Specify an AWS principal ARN to assume the IAM role created by this stack. If your AWS Principal is not supported by this template, you can temporarily use '*'. In this case, after deployment, update the IAM role's trust relationship to your custom AWS Principal in the IAM Console.</td></tr>

    <tr><td>AWS principal external ID</td><td>(Optional) A unique identifier to allow third-party access to your AWS resources. This ensures that only trusted parties can assume roles in your account. For more information, see https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_common-scenarios_third-party.html.</td></tr>

    <tr><td>SAML federated identity provider ARN</td><td>(Optional) Specify the SAML Federated Identity Provider ARN to assume the provisioning role. If specified, you must also provide the 'SAML audience URL' parameter. Leave blank if you are not using SAML federation for user authentication.</td></tr>

    <tr><td>SAML audience URL</td><td>(Optional) If specified, you must also provide the 'SAMLFederatedIdentityProvider'. Leave blank if you are not using SAML federation for user authentication.</td></tr>

    </tbody></table> </details><br>

    (Optional) CloudFormation parameters offer sufficient flexibility for most use cases, allowing you to attach the generated policies to existing IAM users, groups, or roles, or to associate them with a new IAM role. However, for advanced setup cases, you can [update the IAM role's trust policy in AWS Console](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_update-role-trust-policy.html).

2. Inform your users about the following:

    * Users must ensure that the name of their stacks begins with the *Resource Naming Prefix* that you define in the template. Failure to do so will result in stack creation errors.

    * If you selected the "Pass Role Workflow" option for the user permission level, the CloudFormation template will create an IAM role, which your users must pass its name to "CustomIamRole" parameter when deploying their MATLAB stack. You can find its value in the CloudFormation output tab in AWS console as "CommonExecutionRoleName" output.

## Customize IAM policies

This section provides IAM policy JSONs for advanced use cases, enabling you to create custom IAM policies as an alternative to the managed policies offered by the CloudFormation template. Following this section gives you more control over the permissions but requires more effort and knowledge of AWS IAM. This section can also allow you to gain a clearer understanding of the permissions created by the CloudFormation template.

> <h3>Terminology & Definitions</h3> Before you continue, ensure that you are familiar with these terms.<br><details><summary><strong>Types of IAM Policies</strong></summary><ul><li><strong>Provisioning policy</strong>: A wrapper for permissions needed to create MATLAB deployment resources in the AWS account. Attaching this policy to an IAM user or role will allow them to deploy MATLAB CloudFormation template and its resources.</li><li><strong>Execution policy</strong>: Permissions required by AWS services (e.g., EC2 or Lambda functions) to execute automated workloads, such as pushing logs from an EC2 instance to CloudWatch. This policy is attached to the IAM role assumed by the EC2 instance or Lambda function.</li></ul></details><details><summary><strong>User Permission Levels</strong></summary>AWS administrators can choose between two permission levels for their users.<ul><li><em>Full Stack Creation</em>: This option is recommended for most users due to its streamlined setup process. Users can deploy the entire CloudFormation stack but cannot create additional IAM resources directly. However, the user's stack can create the necessary IAM resources required for deploying MATLAB on AWS.</li><li><em>Pass Role Workflow</em>: This option is suitable for organizations that require stricter control over IAM role creation and permissions. In this workflow, users can only create the necessary resources. The account administrator creates IAM roles to be attached to AWS resources, such as EC2 instances.</li></ul></details><details><summary><b>Trade-offs to consider when choosing between user permission levels</b></summary><p>Selecting the appropriate permission level for your users is important. While both options adhere to the principle of least privileged access, you must consider these trade-offs.</p><table><thead><tr><th>Description</th><th>Full Stack Creation workflow</th><th>Pass Role Workflow</th></tr></thead><tbody><tr><td>High-level responsibilities for admin and user</td><td><ul><li><strong>IAM Administrator:</strong><br>Lower admin involvement. Admin sets up the user role.<br><br></li><li><strong>Reference Architecture User:</strong><br>User deploys the stack.</li></ul></td><td><ul><li><strong>IAM Administrator:</strong><br>Higher admin involvement. Admin sets up the user role.<br>Admin also creates an execution IAM Role and shares its name with the user.<br><br></li><li><strong>Reference Architecture User:</strong><br>User passes the execution IAM Role name to CloudFormation template.<br>User deploys the stack.</li></ul></td></tr><tr><td>Ability to create new IAM Roles</td><td>Users cannot create IAM roles. However, users' stacks can create new IAM roles as required by the reference architecture template. <br><br><strong>Note:</strong> The default IAM policy provided below limits users to create IAM roles only when the CloudFormation template is hosted in MathWorks' approved S3 bucket.<br><br></td><td>Neither users nor their stacks can create IAM roles. Admin needs to create the IAM roles for EC2 instances, Lambda functions, and other AWS services. You can find the <code>Common Execution Role</code> below that you can use for all the services. <br><br><strong>Note:</strong> Even though the <code>Common Execution Role</code> has restricted permissions, it allows different stacks to use the same IAM role and interact with each other's resources. For stricter isolation, create separate IAM roles for each user/stack.</td></tr><tr><td>Additional permissions</td><td>Users can attach additional IAM policies to their EC2 instances when deploying their MATLAB CloudFormation template.<br><br><strong>Note:</strong> These IAM policies must have a path of <code>/MW/</code> and have a name that starts with the value specified as the <code>Resource Naming Prefix</code>, as detailed below. This allows account administrators to control the permissions that can be assigned to different user stacks and EC2 instances.</td><td>Users cannot attach additional IAM policies to their stacks and EC2 instances. Any additional permissions must be pre-configured by the AWS account administrator. For details, refer to the "Additional IAM Policies for Common Execution Role" CloudFormation parameter.</td></tr></tbody></table></details><details><summary><strong>Placeholders in IAM Policy JSONs</strong></summary><p>The JSON policies below contain placeholders denoted by <code>&lt;&lt;</code> and <code>&gt;&gt;</code>. This table explains each placeholder. If you are using these JSONs to create IAM policies, you must replace the placeholders with the appropriate values.</p><table><thead><tr><th>Placeholder</th><th>Description</th></tr></thead><tbody><tr><td><code>&lt;&lt;AWS_REGION&gt;&gt;</code></td><td>AWS Region to limit your users for resource deployment. It can be a specific <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html#concepts-available-regions">AWS Region</a> or <code>*</code> for all regions.</td></tr><tr><td><code>&lt;&lt;AWS_ACCOUNT_ID&gt;&gt;</code></td><td>Your AWS account ID, a 12-digit number.</td></tr><tr><td><code>&lt;&lt;AWS_PARTITION&gt;&gt;</code></td><td>For standard AWS Regions, the partition is <code>aws</code>. For other partitions, it is "aws-partitionname". See AWS documentation on <a href="https://docs.aws.amazon.com/whitepapers/latest/aws-fault-isolation-boundaries/partitions.html">Partitions</a>.</td></tr><tr><td><code>&lt;&lt;AWS_URL_SUFFIX&gt;&gt;</code></td><td>Typically <code>amazonaws.com</code>, but may differ by Region. For example, the suffix for China (Beijing) Region is <code>amazonaws.com.cn</code>.</td></tr><tr><td><code>&lt;&lt;RESOURCE_NAMING_PREFIX&gt;&gt;</code></td><td>Prefix for users to create CloudFormation stacks or resources. Must be ≤10 characters, containing only lowercase letters and hyphens. Used to manage resources by different teams independently.</td></tr></tbody></table></details>

### IAM Policy for Full Stack Creation Workflow

Below IAM Policy allows users to create the entire stack, including IAM roles required in the CloudFormation template. Users can attach additional existing IAM policies to their EC2 instances if these policies use the path '/MW/' and the policy name starts with the 'Resource naming prefix' that you specify in the JSON policy.

<details>

<summary>Provisioning IAM Policy (allows full stack creation)</summary>

```json
{{full_provisioning_policy}}
```

</details>

### IAM Policies for Pass Role Workflow

This workflow restricts users from creating IAM roles. Instead, you create a common IAM execution role, and the user must pass the name of the role to the stack during deployment. You can use the provisioning policy below to allow users to deploy the stack without creating IAM roles. This policy is similar to the one in the "Full Stack Creation Workflow" section but excludes any write permissions in the IAM service.

<details>

<summary>Provisioning IAM Policy (doesn't allow IAM resource creation in your users' stacks)</summary>

```json
{{restricted_provisioning_policy}}
```

</details>

Since your users cannot create IAM roles within their CloudFormation stacks, you, as the AWS admin, must create a common IAM execution role and share its name with your team, enabling them to pass it to the CloudFormation template when deploying their stacks. You can create this role using the following JSON policies. Ensure you use the path '/MW/' and prefix the role name with the "Resource naming prefix" you specified in the provisioning policy. If you wish to grant more permissions to your user's EC2 instances, you can attach additional IAM policies to this role.

<details>

<summary>Policy for Common Execution Role</summary>

```json
{{execution_policy}}
```

</details>

You can use this JSON as your Trust Policy for the Common Execution IAM Role.

<details>
<summary>Trust relationship JSON for execution role</summary>

```json
{{execution_policy_trust}}

```

</details>

## Related Information

* [AWS Cloudformation FAQs](https://aws.amazon.com/cloudformation/faqs/)
* [AWS Identity and Access Management (IAM) FAQs](https://aws.amazon.com/iam/faqs/)
* [AWS IAM service documentation](https://aws.amazon.com/iam/)
* [IAM JSON policy reference](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies.html)
* [Security best practices in IAM & least-privileged access model](https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege)
* [How to use the PassRole permission with IAM roles](https://aws.amazon.com/blogs/security/how-to-use-the-passrole-permission-with-iam-roles/)
* [How to use trust policies with IAM roles](https://aws.amazon.com/blogs/security/how-to-use-trust-policies-with-iam-roles/)
* [How to implement the principle of least privilege with CloudFormation StackSets](https://aws.amazon.com/blogs/security/how-to-implement-the-principle-of-least-privilege-with-cloudformation-stacksets/)
* [Grant a user permissions to pass a role to an AWS service](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_passrole.html)

## Technical Support

To request assistance or additional features, contact [MathWorks Technical Support](https://www.mathworks.com/support/contact_us.html).

----

Copyright 2025 The MathWorks, Inc.

----

</file>

<file path="/home/epatel/code/matlab-aws-refarch/src/static/SECURITY.md">
Reporting Security Vulnerabilities
==================================
If you believe you have discovered a security vulnerability, please report it to
security@mathworks.com instead of GitHub. Please see
[MathWorks Vulnerability Disclosure Policy for Security Researchers](https://www.mathworks.com/company/aboutus/policies_statements/vulnerability-disclosure-policy.html)
for additional information.
</file>

<file path="/home/epatel/code/matlab-aws-refarch/src/internal/permissions/execution_policy_trust.json">
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Service": "lambda.<<AWS_URL_SUFFIX>>"
            },
            "Action": [
                "sts:AssumeRole"
            ]
        },
        {
            "Effect": "Allow",
            "Principal": {
                "Service": "ec2.<<AWS_URL_SUFFIX>>"
            },
            "Action": [
                "sts:AssumeRole"
            ]
        }
    ]
}
</file>

<file path="/home/epatel/code/matlab-aws-refarch/src/internal/permissions/execution_policy.json">
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Condition": {
                "StringEquals": {
                    "aws:ResourceTag/mw-ProductID": "MathWorks-MATLAB-Linux"
                }
            },
            "Action": [
                "ec2:CreateTags",
                "ec2:DeleteTags",
                "ec2:StopInstances"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:ec2:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:instance/*",
            "Effect": "Allow"
        },
        {
            "Action": [
                "logs:CreateLogStream",
                "logs:DescribeLogStreams",
                "logs:PutLogEvents"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:logs:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:log-group:<<RESOURCE_NAMING_PREFIX>>*",
            "Effect": "Allow"
        },
        {
            "Action": "s3:GetObject",
            "Resource": "arn:<<AWS_PARTITION>>:s3:::dcv-license.<<AWS_REGION>>/*",
            "Effect": "Allow"
        },
        {
            "Action": "ec2:DescribeTags",
            "Resource": "*",
            "Effect": "Allow"
        },
        {
            "Action": [
                "ssm:DescribeAssociation",
                "ssm:DescribeDocument",
                "ssm:GetDeployablePatchSnapshotForInstance",
                "ssm:GetDocument",
                "ssm:GetManifest",
                "ssm:GetParameter",
                "ssm:GetParameters",
                "ssm:ListAssociations",
                "ssm:ListInstanceAssociations",
                "ssm:PutComplianceItems",
                "ssm:PutConfigurePackageResult",
                "ssm:PutInventory",
                "ssm:UpdateAssociationStatus",
                "ssm:UpdateInstanceAssociationStatus",
                "ssm:UpdateInstanceInformation"
            ],
            "Resource": "*",
            "Effect": "Allow"
        },
        {
            "Action": [
                "ssmmessages:CreateControlChannel",
                "ssmmessages:CreateDataChannel",
                "ssmmessages:OpenControlChannel",
                "ssmmessages:OpenDataChannel"
            ],
            "Resource": "*",
            "Effect": "Allow"
        },
        {
            "Action": [
                "ec2messages:AcknowledgeMessage",
                "ec2messages:DeleteMessage",
                "ec2messages:FailMessage",
                "ec2messages:GetEndpoint",
                "ec2messages:GetMessages",
                "ec2messages:SendReply"
            ],
            "Resource": "*",
            "Effect": "Allow"
        },
        {
            "Action": "ec2:DescribeInstances",
            "Resource": "*",
            "Effect": "Allow"
        },
        {
            "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:logs:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:log-group:/aws/lambda/*EC2ShutdownLambda*",
            "Effect": "Allow"
        }
    ]
}

</file>

<file path="/home/epatel/code/matlab-aws-refarch/src/internal/permissions/provisioning_policy.json">
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "CloudFormationCreate",
            "Effect": "Allow",
            "Action": [
                "cloudformation:CreateStack"
            ],
            "Resource": [
                "arn:<<AWS_PARTITION>>:cloudformation:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:stack/<<RESOURCE_NAMING_PREFIX>>*"
            ],
            "Condition": {
                "StringLike": {
                    "cloudformation:TemplateUrl": [
                        "https://mathworks-reference-architectures-templates.s3.amazonaws.com/*",
                        "https://matlab-on-aws.s3.amazonaws.com/*"
                    ]
                }
            }
        },
        {
            "Sid": "CloudformationActionsFromCloudFormation",
            "Effect": "Allow",
            "Action": [
                "cloudformation:DeleteStack",
                "cloudformation:DescribeStackEvents",
                "cloudformation:DescribeStacks"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:cloudformation:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:stack/<<RESOURCE_NAMING_PREFIX>>*"
        },
        {
            "Sid": "CloudformationActionsFromCloudFormation2",
            "Effect": "Allow",
            "Action": [
                "cloudformation:*ChangeSet*",
                "cloudformation:GetStackPolicy",
                "cloudformation:GetTemplate",
                "cloudformation:GetTemplateSummary",
                "cloudformation:ListStackResources"
            ],
            "Resource": [
                "arn:<<AWS_PARTITION>>:cloudformation:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:stack/<<RESOURCE_NAMING_PREFIX>>*",
                "arn:<<AWS_PARTITION>>:cloudformation:<<AWS_REGION>>:aws:transform/*"
            ]
        },
        {
            "Sid": "MultipleServicesActionsFromCloudFormation",
            "Effect": "Allow",
            "Action": [
                "ec2:AllocateAddress",
                "ec2:AssociateAddress",
                "ec2:AuthorizeSecurityGroupIngress",
                "ec2:CreateSecurityGroup",
                "ec2:CreateTags",
                "ec2:DeleteSecurityGroup",
                "ec2:DescribeAddresses",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstanceCreditSpecifications",
                "ec2:DescribeInstances",
                "ec2:DescribeKeyPairs",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DescribeSecurityGroupRules",
                "ec2:DescribeSecurityGroups",
                "ec2:DescribeSubnets",
                "ec2:DescribeVolumes",
                "ec2:DescribeVpcs",
                "ec2:DisassociateAddress",
                "ec2:ReleaseAddress",
                "ec2:RevokeSecurityGroupIngress",
                "ec2:RunInstances",
                "ec2:TerminateInstances",
                "logs:DescribeLogGroups",
                "logs:ListTagsForResource",
                "ssm:ListAssociations",
                "ssm:ListTagsForResource"
            ],
            "Resource": "*",
            "Condition": {
                "StringEquals": {
                    "aws:CalledViaFirst": [
                        "cloudformation.<<AWS_URL_SUFFIX>>"
                    ]
                }
            }
        },
        {
            "Sid": "EventsActionsFromCloudFormation",
            "Effect": "Allow",
            "Action": [
                "events:DeleteRule",
                "events:DescribeRule",
                "events:ListTargetsByRule",
                "events:PutRule",
                "events:PutTargets",
                "events:RemoveTargets"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:events:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:rule/<<RESOURCE_NAMING_PREFIX>>*",
            "Condition": {
                "StringEquals": {
                    "aws:CalledViaFirst": [
                        "cloudformation.<<AWS_URL_SUFFIX>>"
                    ]
                }
            }
        },
        {
            "Sid": "IamActionsFromCloudFormation",
            "Effect": "Allow",
            "Action": [
                "iam:AttachRolePolicy",
                "iam:CreateRole",
                "iam:DeleteRole",
                "iam:DeleteRolePolicy",
                "iam:DetachRolePolicy",
                "iam:GetRole",
                "iam:GetRolePolicy",
                "iam:ListAttachedRolePolicies",
                "iam:ListRolePolicies",
                "iam:PassRole",
                "iam:PutRolePolicy",
                "iam:TagRole"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:iam::<<AWS_ACCOUNT_ID>>:role/MW/<<RESOURCE_NAMING_PREFIX>>*",
            "Condition": {
                "StringEquals": {
                    "aws:CalledViaFirst": [
                        "cloudformation.<<AWS_URL_SUFFIX>>"
                    ]
                }
            }
        },
        {
            "Sid": "IamActionsFromCloudFormation2",
            "Effect": "Allow",
            "Action": [
                "iam:AddRoleToInstanceProfile",
                "iam:CreateInstanceProfile",
                "iam:DeleteInstanceProfile",
                "iam:GetInstanceProfile",
                "iam:RemoveRoleFromInstanceProfile"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:iam::<<AWS_ACCOUNT_ID>>:instance-profile/MW/<<RESOURCE_NAMING_PREFIX>>*",
            "Condition": {
                "StringEquals": {
                    "aws:CalledViaFirst": [
                        "cloudformation.<<AWS_URL_SUFFIX>>"
                    ]
                }
            }
        },
        {
            "Sid": "LambdaActionsFromCloudFormation",
            "Effect": "Allow",
            "Action": [
                "lambda:AddPermission",
                "lambda:CreateFunction",
                "lambda:DeleteFunction",
                "lambda:GetFunction",
                "lambda:GetFunctionCodeSigningConfig",
                "lambda:GetFunctionRecursionConfig",
                "lambda:GetPolicy",
                "lambda:GetRuntimeManagementConfig",
                "lambda:InvokeFunction",
                "lambda:RemovePermission",
                "lambda:TagResource"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:lambda:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:function:<<RESOURCE_NAMING_PREFIX>>*",
            "Condition": {
                "StringEquals": {
                    "aws:CalledViaFirst": [
                        "cloudformation.<<AWS_URL_SUFFIX>>"
                    ]
                }
            }
        },
        {
            "Sid": "LogsActionsFromCloudFormation",
            "Effect": "Allow",
            "Action": [
                "logs:CreateLogGroup",
                "logs:DeleteLogGroup"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:logs:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:log-group:<<RESOURCE_NAMING_PREFIX>>*",
            "Condition": {
                "StringEquals": {
                    "aws:CalledViaFirst": [
                        "cloudformation.<<AWS_URL_SUFFIX>>"
                    ]
                }
            }
        },
        {
            "Sid": "LogsActionsFromCloudFormation2",
            "Effect": "Allow",
            "Action": [
                "logs:CreateLogGroup",
                "logs:DeleteLogGroup",
                "logs:PutRetentionPolicy"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:logs:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:log-group:/aws/lambda/<<RESOURCE_NAMING_PREFIX>>*",
            "Condition": {
                "StringEquals": {
                    "aws:CalledViaFirst": [
                        "cloudformation.<<AWS_URL_SUFFIX>>"
                    ]
                }
            }
        },
        {
            "Sid": "SsmActionsFromCloudFormation",
            "Effect": "Allow",
            "Action": [
                "ssm:AddTagsToResource",
                "ssm:CreateDocument",
                "ssm:DeleteDocument",
                "ssm:DescribeDocument",
                "ssm:GetDocument"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:ssm:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:document/<<RESOURCE_NAMING_PREFIX>>*",
            "Condition": {
                "StringEquals": {
                    "aws:CalledViaFirst": [
                        "cloudformation.<<AWS_URL_SUFFIX>>"
                    ]
                }
            }
        },
        {
            "Sid": "EC2StopStart",
            "Effect": "Allow",
            "Action": [
                "ec2:StartInstances",
                "ec2:StopInstances"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:ec2:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:instance/*",
            "Condition": {
                "StringEquals": {
                    "aws:ResourceTag/mw-ProductID": "MathWorks-MATLAB-Linux"
                },
                "StringLike": {
                    "aws:ResourceTag/mw-StackName": "<<RESOURCE_NAMING_PREFIX>>*"
                }
            }
        },
        {
            "Sid": "ReadOnlyActionsForSmoothConsoleExperience",
            "Effect": "Allow",
            "Action": [
                "cloudformation:GetTemplateSummary",
                "cloudformation:ListStacks",
                "ec2:DescribeInstances",
                "ec2:DescribeKeyPairs",
                "ec2:DescribeSubnets",
                "ec2:DescribeVpcs",
                "logs:DescribeLogGroups",
                "ssm:DescribeInstanceInformation",
                "ssm:GetConnectionStatus"
            ],
            "Resource": "*"
        },
        {
            "Sid": "EC2KeyPairWriteAccess",
            "Effect": "Allow",
            "Action": [
                "ec2:CreateKeyPair",
                "ec2:DeleteKeyPair"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:ec2:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:key-pair/<<RESOURCE_NAMING_PREFIX>>*"
        },
        {
            "Sid": "CloudWatchLogsReadOnlyAccess",
            "Effect": "Allow",
            "Action": [
                "logs:DescribeLogStreams",
                "logs:GetLogEvents"
            ],
            "Resource": [
                "arn:<<AWS_PARTITION>>:logs:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:log-group:/aws/lambda/<<RESOURCE_NAMING_PREFIX>>*",
                "arn:<<AWS_PARTITION>>:logs:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:log-group:<<RESOURCE_NAMING_PREFIX>>*"
            ]
        }
    ]
}
</file>

<file path="/home/epatel/code/matlab-aws-refarch/src/internal/permissions/test/parameter_overrides.json">
{
    "AutoShutdown": "After 3 hours",
    "EnableCloudWatch": "Yes",
    "EnableMATLABProxy": "Yes",
    "UseElasticIpAddress": "Yes"
}
</file>

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/src/README.md">
# MATLAB on Amazon Web Services (Linux VM)

## Step 1. Launch the Template

Click the **Launch Stack** button to deploy a standalone MATLAB&reg; desktop client on AWS&reg;. This opens the CloudFormation Create Stack screen in your web browser.

| Region | Launch Link |
| --------------- | ----------- |
{% for region in regions -%}
| **{{ region }}** | [![alt text](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png "Start a MATLAB instance using the template")](https://{{ region }}.console.aws.amazon.com/cloudformation/home?region={{ region }}#/stacks/create/review?templateURL={{ template_url }}) |
{% endfor %}

**Note**: Creating a stack on AWS can take a few minutes.

## Step 2. Configure the Cloud Resources
After you click the Launch Stack button above, the “Create stack” page will open in your browser where you can configure the parameters. It is easier to complete the steps if you position these instructions and the AWS console window side by side.

1. Specify a stack name. This will be shown in the AWS CloudFormation console and must be unique within the AWS account.


2. Specify and check the defaults for these resource parameters:

| Parameter label | Description |
| --------------- | ----------- |
{% for parameter in parameters -%}
| **{{ parameter.label }}** | {{ parameter.description }} |
{% endfor %}

>**Note**: In the capabilities section, you must acknowledge that AWS Cloudformation might create IAM resources and autoexpand nested templates when creating the stack.

3. Click the **Create Stack** button.  The CloudFormation service will start creating the resources for the stack. <p>After clicking **Create** you will be taken to the *Stack Detail* page for your stack. Wait for the Status to reach **CREATE\_COMPLETE**. This may take up to 10 minutes.</p>

## Step 3. Connect to the Virtual Machine in the Cloud

If you chose RDP, then:
1. Expand the **Outputs** section in the the *Stack Detail* page.
2. Find and click the key named `RDPConnection` and copy the corresponding DNS name listed under value. *For example*: ec2-11-222-33-44.compute-1.amazonaws.com, or ip-11-222-33-44.ec2.internal, for a private instance.
3. Launch any remote desktop client, paste the DNS name in the appropriate field, and connect. On the Windows Remote Desktop Client you need to paste the DNS name in the **Computer** field and click **Connect**.
4. In the login screen displayed, use the username `ubuntu` and the password you specified while setting up the stack in [Step 2](#step-2-configure-the-stack).

If you chose NICE DCV, then:
1. Expand the **Outputs** section in the the *Stack Detail* page.
2. Find and click the key named `NiceDCVConnection`.
3. In the login screen displayed, use the username `ubuntu` and the password you specified while setting up the stack in [Step 2](#step-2-configure-the-stack).

If you chose to enable browser access for MATLAB, then:
1. Expand the **Outputs** section in the *Stack Details* page.
2. Find and click the key named `BrowserConnection`.
3. On the login screen, use the password you specified while deploying the stack in [Step 2](#step-2-configure-the-stack) as the 'auth token' to authenticate.
4. Browser access for MATLAB is enabled using `matlab-proxy`, a Python&reg; package developed by MathWorks&reg;. For more information on `matlab-proxy`, see [MATLAB Proxy on Github](https://github.com/mathworks/matlab-proxy).

## Step 4. Start MATLAB
Double-click the MATLAB icon on the virtual machine desktop to start MATLAB. The first time you start MATLAB, you need to enter your MathWorks Account credentials to license MATLAB. For other ways to license MATLAB, see [MATLAB Licensing in the Cloud](https://www.mathworks.com/help/install/license/licensing-for-mathworks-products-running-on-the-cloud.html).

>**Note**: It may take up to a minute for MATLAB to start the first time.


# Additional Information

## Configure Private Network
To set up a private networking configuration for the MATLAB EC2 instance, you can set the `EnablePublicIPAddress` parameter to `No` to avoid attaching a public IP to the MATLAB EC2 instance. Ensure these requirements before deploying your stack:

- **Client Access**: Specify the private IP addresses of the jumpbox or client(s) that will access the MATLAB EC2 instance, using the `ClientIPAddress` parameter. 
- **Online Licensing**: To use online licensing for MATLAB, your MATLAB EC2 instance must be able to access domains at `*.mathworks.com`. Allow outbound access to these domains by setting up an appropriate method in your VPC.
- **Stack Deployment**: Without a public IP, the MATLAB EC2 instance might get stuck in the `CREATE_IN_PROGRESS` state during stack deployment. To avoid this, ensure that your VPC has a NAT Gateway or a [VPC endpoint for the AWS CloudFormation service (AWS)](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/vpc-interface-endpoints.html#vpc-endpoint-create) before deployment.
- **CloudWatch Logs**: To deliver CloudWatch logs from the instance, ensure that your VPC has either a NAT Gateway or a [VPC endpoint for CloudWatch service (AWS)](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/cloudwatch-logs-and-interface-VPC.html#create-VPC-endpoint-for-CloudWatchLogs).
- **NICE DCV and S3 Data transfer**: To use NICE DCV or for data transfer between the MATLAB EC2 instance and S3 buckets, ensure that your VPC is configured to use [Gateway endpoint for the Amazon S3 service](https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints-s3.html#create-gateway-endpoint-s3). The MATLAB EC2 instance must be able to reach the S3 service for NICE DCV license verification.

To easily create a VPC with these settings, you can use the [VPC CloudFormation Template](https://github.com/mathworks-ref-arch/iac-building-blocks/tree/main/aws/vpc-template/v1/README.md).

## Delete Your Cloud Resources

Once you have finished using your stack, it is recommended that you delete all resources to avoid incurring further cost. To delete the stack, do the following:
1. Log in to the AWS Console.
2. Go to the AWS CloudFormation page and select the stack you created.
3. Click the **Actions** button and click **Delete Stack** from the menu that appears.

## Nested Stacks

This CloudFormation template uses nested stacks to reference templates used by multiple reference architectures. For details, see the [MathWorks Infrastructure as Code Building Blocks](https://github.com/mathworks-ref-arch/iac-building-blocks) repository.

## CloudWatch Logs
CloudWatch logs enables you to access logs from all the resources in your stack in a single place. To use CloudWatch logs, launch the stack with the feature "Configure cloudwatch logging for the MATLAB instance" enabled. Once the stack deployment is complete, you can access your logs in the "Outputs" of the stack by clicking the link next to "CloudWatchLogs". Note that if you delete the stack, the CloudWatch log group is also deleted. For more information, see [What is Amazon CloudWatch Logs?](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/WhatIsCloudWatchLogs.html).

----

Copyright 2018-2025 The MathWorks, Inc.

----

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/src/reporoll.py">
#!/usr/bin/env python3
import os
import fnmatch

# Configuration: Folders and files to always ignore
IGNORE_DIRS = {
    '.git', '__pycache__', 'node_modules', 'venv', '.env', 
    '.idea', '.vscode', 'dist', 'build', 'coverage'
}

IGNORE_FILES = {
    'package-lock.json', 'yarn.lock', '*.lock', '*.pyc', 
    '*.png', '*.jpg', '*.jpeg', '*.gif', '*.ico', '*.svg', 
    '*.exe', '*.dll', '*.so', '*.dylib', '.DS_Store'
}

def should_ignore(name, is_dir=False):
    """Checks if a file or directory should be ignored."""
    if is_dir:
        return name in IGNORE_DIRS
    
    # Check exact matches
    if name in IGNORE_FILES:
        return True
    
    # Check glob patterns (e.g., *.png)
    for pattern in IGNORE_FILES:
        if fnmatch.fnmatch(name, pattern):
            return True
    return False

def is_binary(file_path):
    """Simple heuristic to detect binary files."""
    try:
        with open(file_path, 'tr') as check_file:
            check_file.read()
            return False
    except:
        return True

def generate_tree(start_path):
    """Generates a string representation of the file tree."""
    tree_str = "PROJECT STRUCTURE:\n"
    for root, dirs, files in os.walk(start_path):
        dirs[:] = [d for d in dirs if not should_ignore(d, is_dir=True)]
        level = root.replace(start_path, '').count(os.sep)
        indent = ' ' * 4 * (level)
        tree_str += f"{indent}{os.path.basename(root)}/\n"
        subindent = ' ' * 4 * (level + 1)
        for f in files:
            if not should_ignore(f):
                tree_str += f"{subindent}{f}\n"
    return tree_str

def roll_codebase(start_path):
    """Reads all files and formats them into a prompt."""
    output = []
    
    # 1. Add the file tree
    output.append(generate_tree(start_path))
    output.append("\n" + "="*50 + "\n")
    output.append("FILE CONTENTS:\n")

    # 2. Walk through files
    for root, dirs, files in os.walk(start_path):
        # Modify dirs in-place to skip ignored directories
        dirs[:] = [d for d in dirs if not should_ignore(d, is_dir=True)]

        for file in files:
            if should_ignore(file):
                continue

            file_path = os.path.join(root, file)
            
            # Skip binaries
            if is_binary(file_path):
                print(f"Skipping binary file: {file_path}")
                continue

            # Format the output using XML tags for clarity
            try:
                with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                    content = f.read()
                    
                output.append(f'<file path="{file_path}">\n{content}\n</file>\n')
            except Exception as e:
                print(f"Error reading {file_path}: {e}")

    return "\n".join(output)

if __name__ == "__main__":
    # Get current directory
    cwd = os.getcwd()
    print(f"Rolling codebase from: {cwd} ...")
    
    full_prompt = roll_codebase(cwd)
    
    # Write to file
    output_filename = "codebase_prompt.txt"
    with open(output_filename, "w", encoding="utf-8") as f:
        f.write(full_prompt)
        
    print(f"Done! Prompt saved to: {output_filename}")
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/src/toplevel/LICENSE.md">
MATHWORKS CLOUD REFERENCE ARCHITECTURE LICENSE

The files in this GitHub repository refer to commercial software products and services, virtual machine images, and related materials of The MathWorks, Inc. (“MathWorks Programs”). MathWorks Programs are separately licensed under the MathWorks Software License Agreement, available in the desktop installation of the MathWorks Programs or in the virtual machine image. The files in this GitHub repository may also refer to third-party software licensed under separate terms provided by such third parties.

The following license terms apply only to the files in this GitHub repository, including files in this folder and its subfolders, and do not apply to MathWorks Programs. References to “software” and “code” in the following license terms refer to the files in this GitHub repository.

Copyright 2020 - {{current_year}} The MathWorks, Inc.

All rights reserved.

Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:

1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.
3. In all cases, the software is, and all modifications and derivatives of the software shall be, licensed to you solely for use in conjunction with MathWorks products and service offerings.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/src/toplevel/README.md">
# MATLAB on Amazon Web Services

This repository shows how to deploy MATLAB&reg; on an Amazon EC2&reg; instance using your Amazon&reg; Web Services (AWS&reg;) account and connect to it using the Remote Desktop Protocol (RDP), SSH, or NICE DCV. The automation uses an AWS CloudFormation template. 

For information about the architecture of this solution, see [Learn about Architecture](#learn-about-architecture). For information about templates, see [AWS CloudFormation Templates](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-guide.html).

This reference architecture has been reviewed and qualified by AWS.

![AWS Qualified Software badge](img/aws-qualified-software.png)


## Requirements
You need:
* A MATLAB license. For more information, see [License Requirements for MATLAB on Cloud Platforms](https://www.mathworks.com/help/install/license/licensing-for-mathworks-products-running-on-the-cloud.html).
* An [Amazon Web Services (AWS)](https://aws.amazon.com) account.
* A key pair for your AWS account, in the appropriate region. For more information, see [Amazon EC2 Key Pairs](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html).

## Costs
You are responsible for the cost of the AWS services used when you create cloud resources using this guide. Resource settings, such as instance type, affect the cost of deployment. For cost estimates, see the pricing pages for each AWS service you will be using. Prices are subject to change.

# Deployment Steps
By default, the MATLAB reference architectures below launch prebuilt machine images, described in [Learn about Architecture](#learn-about-architecture).
Using a prebuilt machine image is the easiest way to deploy a MATLAB reference architecture.
Prebuilt images are provided for the five most recent MATLAB releases.
Alternatively, to build your own machine image,
see [Build and Deploy Your Own Machine Image](#build-and-deploy-your-own-machine-image).
You can also use this workflow to install an earlier MATLAB release.

## Deploy Prebuilt Machine Image
To view instructions for deploying the MATLAB reference architecture, select a MATLAB release:

| Linux | Windows | Status |
| ----- | ------- | ------- |
{% for release in releases -%}
| {% if release.dir %}[{{ release.label }}](releases/{{ release.dir }}/README.md){% endif %} | {% if release.dual_url %}[{{ release.label }}]({{ release.dual_url }}/README.md){% endif %} | {% if loop.index >= 4 %}⚠️ Prebuilt will be removed in {{ release.removal_month }} {{ release.removal_year }}.{% else %}✅ Prebuilt available.{% endif %} |
{% endfor %}| [Earlier/Custom](./packer/v1) | {% if dual_url %}[Earlier/Custom]({{ dual_url }}/tree/master/packer/v1){% endif %} | For earlier MATLAB releases, you must build your own machine image. |

The above instructions allow you to launch instances based on the latest prebuilt MathWorks&reg; Amazon Machine Images (AMIs).
MathWorks periodically replaces older AMIs with new images.
For more details, see
[When are the MathWorks Amazon Machine Images updated?](#when-are-the-mathWorks-amazon-machine-images-updated)

## Build and Deploy Your Own Machine Image
For details of the scripts which form the basis of the MathWorks Linux AMI build process,
see [Build Your Own Machine Image](./packer/v1).
You can use these scripts to build a custom Linux machine image for running MATLAB on Amazon Web Services.
You can then deploy this custom image with the MathWorks infrastructure as code (IaC) templates.

You can customize the MATLAB release which is installed as part of this custom build.
This includes MATLAB releases supported by the prebuilt images, as well as earlier MATLAB releases.
For more details,
see [Customize MATLAB Release to Install](./packer/v1#customize-matlab-release-to-install).

Platform engineering teams can use these scripts to take advantage of optimizations MathWorks has developed
for running MathWorks products in the cloud.
For more details, see [What are the advantages of building images with MathWorks scripts?](#what-are-the-advantages-of-building-images-with-mathworks-scripts)

## Learn about Architecture

![MATLAB on AWS Reference Architecture](img/aws-matlab-diagram.png)

Deploying this reference architecture sets up a single AWS EC2 instance containing MATLAB, a private VPC with an internet gateway, a private subnet, and a security group that opens the appropriate ports for SSH and RDP access.

The Amazon Machine Image (AMI) contains pre-installed drivers and the following software:
* MATLAB, Simulink, toolboxes, and support for GPUs.
* Add-ons: several pretrained deep neural networks for classification, feature extraction, and transfer learning with Deep Learning Toolbox&trade;, including GoogLeNet, ResNet-50, and NASNet-Large.

### Resources

The following resources will be created as part of the CloudFormation Stack:

1. Security Group for SSH and RDP access
2. EC2 Instance

The following resources might be created, depending on your deployment configuration:

1. IAM role
2. A CloudWatch log group
3. An elastic IP address
4. A SSM document

## FAQ

### What permissions are required by end users to deploy MATLAB in an AWS account?

You do not need administrative-level access in AWS to deploy this reference architecture. If users already have the necessary permissions, no further action is required. If you are unsure whether you have sufficient permissions to deploy MATLAB on AWS, check with your AWS administrator and share the [permission document](./permission.md) with them. Using this document, administrators can assign the required permissions following the principle of least privilege. This document is kept current with the latest MATLAB release.

AWS administrators can assign the necessary permissions to end users in two ways:

* **Full Stack Creation Workflow**: MATLAB Users can create the entire stack. This approach is recommended for streamlined setups.

* **Pass Role Workflow**: MATLAB Users can only create non-IAM resources in their stack. AWS admins must create necessary IAM roles that the user must pass to the stack. This approach is suitable for tighter control over IAM policies.

For both options, the permission document provides a CloudFormation template to generate the necessary IAM roles and permissions. This template also supports granting additional permissions to EC2 instances depending on specific users' needs.

### When are the MathWorks Amazon Machine Images updated?
The links in [Deployment Steps](#deployment-steps) launch instances based on the latest MathWorks
AMIs for at least the four most recent MATLAB releases. MATLAB releases occur twice each year.

For each MATLAB release, MathWorks periodically replaces the corresponding AMI with a newer AMI
that includes the latest MATLAB updates and important security updates of the base OS image.

When MathWorks replaces an AMI, the older AMI is deleted.
However, any running instances previously launched from the older AMI are not affected.
To continue using an older AMI, copy the AMI into your AWS account.
For more details on how to copy an AMI, see
[How do I copy the AMI?](#how-do-I-copy-the-ami)
For more details on how to customize the reference architectures to
deploy the copied AMI see [How do I customize the AMI?](#how-do-I-customize-the-ami)

### How do I save my changes in the AMI?
All your files and changes are stored locally on the EC2 Instance. They persist until you either terminate the instance or delete the stack. Stopping the instance does not destroy the data on the instance. If you want your changes to persist outside the stack or before you terminate an instance, you need to:
* Copy your files to another location, or
* Create an image of the virtual machine.

### What happens to my data if I shut down the instance?
To minimize costs, you might want to shut down the instance when you are not using it. When the virtual machine is stopped, you are only charged for storage. To shut down an EC2 instance, locate it in the AWS web console, select the instance and choose “Instance State/Stop” from the “Actions” menu. You can restart it from the same menu. Any files or changes you make to the virtual machine will persist when you shut it down and will be present when you restart it. Shutting down the virtual machine and restarting it might change the public IP address and DNS name. Inspecting the EC2 instance in the AWS console will reveal the new IP address and DNS name.

### How do I keep the same public IP address?
To avoid having to change the IP address between restarts, enable the **Keep public IP address the same** option during deployment. For more information, see [Elastic IP addresses](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html).

### How do I manage my EC2 quotas?
See [Amazon EC2 Service Quotas](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-resource-limits.html).

### How do I save or copy an AMI?
To save an AMI, locate the EC2 Instance in the AWS web console and select **Actions** > **Image** > **Create Image.**

To copy the AMI for a certain MATLAB version to a target region of your choice, follow these steps:
* Choose the MATLAB release that you want to copy from the Releases folder of this repository. Download and open the CloudFormation template .json file for that release.
* Locate the Mappings section in the CloudFormation template. Copy the AMI ID for one of the existing regions, for example, us-east-1.
* To copy the AMI to your target region, see [Copy an AMI](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/CopyingAMIs.html) in the AWS documentation.
* In the Mappings section of the CloudFormation template, add a new RegionMap pair corresponding to your target region. Insert the new AMI ID of the AMI in the target region.
* In your AWS Console, change your region to your target region. In the CloudFormation menu, select the **Create Stack > With new resources** option. Provide the modified CloudFormation template.

You can now deploy the AMI in your target region using the AMI that you copied.

### How do I customize the AMI?
You can customize a prebuilt AMI by launching the reference architecture, applying changes you want to the EC2 Instance (such as installing additional software, drivers, and files), then saving an image of that instance using the AWS Console. For more information, see [How do I save or copy an AMI?](#how-do-i-save-or-copy-an-ami). When you create a stack, replace the AMI ID in the CloudFormation template with the AMI ID of your customized image.

You can also create a custom image by building your own using the Packer scripts we provide. See [Build and Deploy Your Own Machine Image](#build-and-deploy-your-own-machine-image).

### How do I use a different license manager?
The AMI uses MathWorks Hosted License Manager by default. For information on how to use other license managers, see [MATLAB Licensing in the Cloud](https://www.mathworks.com/help/install/license/licensing-for-mathworks-products-running-on-the-cloud.html).

### What are the advantages of building images with MathWorks scripts?
Images built with MathWorks scripts are optimized and tested for MathWorks workflows.
The images are deployed by MathWorks CloudFormation templates following AWS best practices.

The warmup scripts found in [startup](./packer/v1/startup) allow you to start MATLAB faster. The CloudFormation template uses these scripts to automatically initialize MathWorks files on the instance. This allows MATLAB to be responsive in as little as a minute after you start it. These scripts are automatically included in both the prebuilt images and the images that you build using the instructions in [Deployment Steps](#deployment-steps).

Without the optimization scripts, starting a large software application, such as MATLAB, for the first time can potentially take tens of minutes. Subsequent starts of the large software application will be faster. This is because AWS initializes the storage for the EC2 instance, as described in [Initialize Amazon EBS volumes](https://docs.aws.amazon.com/ebs/latest/userguide/ebs-initialize.html).



Other scripts in this repo also enable options for connecting to the instance, ensure that all the necessary MATLAB dependencies are installed, and make it easy to build an image with an older MATLAB release.

# Technical Support
To request assistance or additional features, contact [MathWorks Technical Support](https://www.mathworks.com/support/contact_us.html).

----

Copyright 2018-2025 The MathWorks, Inc.

----

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/src/toplevel/permission.md">
# Assign AWS IAM Permissions for MATLAB Users on Linux

AWS® administrators can grant the least privileged permissions to end users to deploy MATLAB® on a Linux® instance in AWS. If you are an end user, contact your AWS administrator to grant you the necessary permissions.

AWS administrators can choose between two permission levels for their users:

* *Full Stack Creation workflow*: Users can create the entire stack. This approach is recommended for streamlined setups.
* *Pass Role Workflow*: Users can only create non-IAM resources in their stack. AWS admins must create necessary IAM roles that the user must pass to the stack. This approach is suitable for tighter control over IAM policies.

For both options, see the [Quick Start using AWS CloudFormation template](#quick-start-using-aws-cloudformation-template) section to automatically generate the necessary IAM policies. If you want further configuration of the IAM policies, see [Customize IAM policies](#customize-iam-policies) section.

## Quick Start using AWS CloudFormation template

Using the CloudFormation template below is recommended for most use cases, as it automatically creates and configures your AWS account to grant the necessary permissions to your users.

1. Deploy the Permission CloudFormation template.<br>
    Click the "Launch Stack" button to open the CloudFormation console, fill out the template parameters, and create the stack. You must be logged in to your AWS account before clicking the button below.<br><br>

   [![Deploy Reference Architecture Permission Stack](https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png)](https://console.aws.amazon.com/cloudformation/home?#/stacks/create/review?templateURL=https://mathworks-reference-architectures-templates.s3.us-east-1.amazonaws.com/permissions-template/v1/0/0/permissions-template.json)<br>

    <details> <summary>CloudFormation template parameters</summary> <table><thead><tr><th>Parameter Label</th><th>Description</th></tr></thead><tbody>

    <tr><td>Enable MATLAB deployment</td><td>Select yes to allow your users to deploy MATLAB. <br><br> <strong>Note: </strong>You might see other MathWorks' cloud products in the CloudFormation console, and if you want, you can enable those for your users as well.</td></tr>

    <tr><td>User permission level</td><td>Choose 'Full Stack Creation' or 'Pass Role' workflows. 'Full Stack Creation' allows users to create the entire stack, including IAM roles, while following the principle of least privilege. Recommended for streamlined setups. 'Pass Role Workflow' limits users to resource creation only. Suitable for tighter control over IAM roles and permissions.</td></tr>

    <tr><td>AWS Region restriction</td><td>Allowed AWS Region to deploy resources. Select '*' for all regions.</td></tr>

    <tr><td>Resource naming prefix</td><td>Prefix to restrict users to create CloudFormation stacks or resources with names starting with this value. Use up to 10 lowercase letters or hyphens. Useful for isolating resources by team (for example, 'engr-', 'mrkt-').</td></tr>

    <tr><td>Additional IAM policies for Common Execution Role</td><td>(Optional) Specify up to five valid IAM policy ARNs (AWS-managed or customer-managed) to grant additional permissions to your users' EC2 instances. These policies must have a path equal to '/MW/' and a name starting with the value in 'Resource Naming Prefix'. Applicable only when you configure 'User Permission Level' to 'Pass Role Workflow'. Users with 'Full Stack Creation' permissions can directly pass IAM policy ARNs during stack deployment.</td></tr>

    <tr><td>IAM role names</td><td>(Optional) Comma-separated list of existing IAM roles to extend permissions to. For example, specify existing IAM roles assumed by users to extend their permissions to allow users to deploy MathWorks' Reference Architecture.</td></tr>

    <tr><td>IAM group names</td><td>(Optional) Comma-separated list of existing IAM groups to extend permissions to. Applies to all members in these groups.</td></tr>

    <tr><td>IAM user names</td><td>(Optional) Comma-separated list of existing IAM users to extend permissions to.</td></tr>

    <tr><td>AWS principal ARN</td><td>(Optional) Specify an AWS principal ARN to assume the IAM role created by this stack. If your AWS Principal is not supported by this template, you can temporarily use '*'. In this case, after deployment, update the IAM role's trust relationship to your custom AWS Principal in the IAM Console.</td></tr>

    <tr><td>AWS principal external ID</td><td>(Optional) A unique identifier to allow third-party access to your AWS resources. This ensures that only trusted parties can assume roles in your account. For more information, see https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_common-scenarios_third-party.html.</td></tr>

    <tr><td>SAML federated identity provider ARN</td><td>(Optional) Specify the SAML Federated Identity Provider ARN to assume the provisioning role. If specified, you must also provide the 'SAML audience URL' parameter. Leave blank if you are not using SAML federation for user authentication.</td></tr>

    <tr><td>SAML audience URL</td><td>(Optional) If specified, you must also provide the 'SAMLFederatedIdentityProvider'. Leave blank if you are not using SAML federation for user authentication.</td></tr>

    </tbody></table> </details><br>

    (Optional) CloudFormation parameters offer sufficient flexibility for most use cases, allowing you to attach the generated policies to existing IAM users, groups, or roles, or to associate them with a new IAM role. However, for advanced setup cases, you can [update the IAM role's trust policy in AWS Console](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_update-role-trust-policy.html).

2. Inform your users about the following:

    * Users must ensure that the name of their stacks begins with the *Resource Naming Prefix* that you define in the template. Failure to do so will result in stack creation errors.

    * If you selected the "Pass Role Workflow" option for the user permission level, the CloudFormation template will create an IAM role, which your users must pass its name to "CustomIamRole" parameter when deploying their MATLAB stack. You can find its value in the CloudFormation output tab in AWS console as "CommonExecutionRoleName" output.

## Customize IAM policies

This section provides IAM policy JSONs for advanced use cases, enabling you to create custom IAM policies as an alternative to the managed policies offered by the CloudFormation template. Following this section gives you more control over the permissions but requires more effort and knowledge of AWS IAM. This section can also allow you to gain a clearer understanding of the permissions created by the CloudFormation template.

> <h3>Terminology & Definitions</h3> Before you continue, ensure that you are familiar with these terms.<br><details><summary><strong>Types of IAM Policies</strong></summary><ul><li><strong>Provisioning policy</strong>: A wrapper for permissions needed to create MATLAB deployment resources in the AWS account. Attaching this policy to an IAM user or role will allow them to deploy MATLAB CloudFormation template and its resources.</li><li><strong>Execution policy</strong>: Permissions required by AWS services (e.g., EC2 or Lambda functions) to execute automated workloads, such as pushing logs from an EC2 instance to CloudWatch. This policy is attached to the IAM role assumed by the EC2 instance or Lambda function.</li></ul></details><details><summary><strong>User Permission Levels</strong></summary>AWS administrators can choose between two permission levels for their users.<ul><li><em>Full Stack Creation</em>: This option is recommended for most users due to its streamlined setup process. Users can deploy the entire CloudFormation stack but cannot create additional IAM resources directly. However, the user's stack can create the necessary IAM resources required for deploying MATLAB on AWS.</li><li><em>Pass Role Workflow</em>: This option is suitable for organizations that require stricter control over IAM role creation and permissions. In this workflow, users can only create the necessary resources. The account administrator creates IAM roles to be attached to AWS resources, such as EC2 instances.</li></ul></details><details><summary><b>Trade-offs to consider when choosing between user permission levels</b></summary><p>Selecting the appropriate permission level for your users is important. While both options adhere to the principle of least privileged access, you must consider these trade-offs.</p><table><thead><tr><th>Description</th><th>Full Stack Creation workflow</th><th>Pass Role Workflow</th></tr></thead><tbody><tr><td>High-level responsibilities for admin and user</td><td><ul><li><strong>IAM Administrator:</strong><br>Lower admin involvement. Admin sets up the user role.<br><br></li><li><strong>Reference Architecture User:</strong><br>User deploys the stack.</li></ul></td><td><ul><li><strong>IAM Administrator:</strong><br>Higher admin involvement. Admin sets up the user role.<br>Admin also creates an execution IAM Role and shares its name with the user.<br><br></li><li><strong>Reference Architecture User:</strong><br>User passes the execution IAM Role name to CloudFormation template.<br>User deploys the stack.</li></ul></td></tr><tr><td>Ability to create new IAM Roles</td><td>Users cannot create IAM roles. However, users' stacks can create new IAM roles as required by the reference architecture template. <br><br><strong>Note:</strong> The default IAM policy provided below limits users to create IAM roles only when the CloudFormation template is hosted in MathWorks' approved S3 bucket.<br><br></td><td>Neither users nor their stacks can create IAM roles. Admin needs to create the IAM roles for EC2 instances, Lambda functions, and other AWS services. You can find the <code>Common Execution Role</code> below that you can use for all the services. <br><br><strong>Note:</strong> Even though the <code>Common Execution Role</code> has restricted permissions, it allows different stacks to use the same IAM role and interact with each other's resources. For stricter isolation, create separate IAM roles for each user/stack.</td></tr><tr><td>Additional permissions</td><td>Users can attach additional IAM policies to their EC2 instances when deploying their MATLAB CloudFormation template.<br><br><strong>Note:</strong> These IAM policies must have a path of <code>/MW/</code> and have a name that starts with the value specified as the <code>Resource Naming Prefix</code>, as detailed below. This allows account administrators to control the permissions that can be assigned to different user stacks and EC2 instances.</td><td>Users cannot attach additional IAM policies to their stacks and EC2 instances. Any additional permissions must be pre-configured by the AWS account administrator. For details, refer to the "Additional IAM Policies for Common Execution Role" CloudFormation parameter.</td></tr></tbody></table></details><details><summary><strong>Placeholders in IAM Policy JSONs</strong></summary><p>The JSON policies below contain placeholders denoted by <code>&lt;&lt;</code> and <code>&gt;&gt;</code>. This table explains each placeholder. If you are using these JSONs to create IAM policies, you must replace the placeholders with the appropriate values.</p><table><thead><tr><th>Placeholder</th><th>Description</th></tr></thead><tbody><tr><td><code>&lt;&lt;AWS_REGION&gt;&gt;</code></td><td>AWS Region to limit your users for resource deployment. It can be a specific <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html#concepts-available-regions">AWS Region</a> or <code>*</code> for all regions.</td></tr><tr><td><code>&lt;&lt;AWS_ACCOUNT_ID&gt;&gt;</code></td><td>Your AWS account ID, a 12-digit number.</td></tr><tr><td><code>&lt;&lt;AWS_PARTITION&gt;&gt;</code></td><td>For standard AWS Regions, the partition is <code>aws</code>. For other partitions, it is "aws-partitionname". See AWS documentation on <a href="https://docs.aws.amazon.com/whitepapers/latest/aws-fault-isolation-boundaries/partitions.html">Partitions</a>.</td></tr><tr><td><code>&lt;&lt;AWS_URL_SUFFIX&gt;&gt;</code></td><td>Typically <code>amazonaws.com</code>, but may differ by Region. For example, the suffix for China (Beijing) Region is <code>amazonaws.com.cn</code>.</td></tr><tr><td><code>&lt;&lt;RESOURCE_NAMING_PREFIX&gt;&gt;</code></td><td>Prefix for users to create CloudFormation stacks or resources. Must be ≤10 characters, containing only lowercase letters and hyphens. Used to manage resources by different teams independently.</td></tr></tbody></table></details>

### IAM Policy for Full Stack Creation Workflow

Below IAM Policy allows users to create the entire stack, including IAM roles required in the CloudFormation template. Users can attach additional existing IAM policies to their EC2 instances if these policies use the path '/MW/' and the policy name starts with the 'Resource naming prefix' that you specify in the JSON policy.

<details>

<summary>Provisioning IAM Policy (allows full stack creation)</summary>

```json
{{full_provisioning_policy}}
```

</details>

### IAM Policies for Pass Role Workflow

This workflow restricts users from creating IAM roles. Instead, you create a common IAM execution role, and the user must pass the name of the role to the stack during deployment. You can use the provisioning policy below to allow users to deploy the stack without creating IAM roles. This policy is similar to the one in the "Full Stack Creation Workflow" section but excludes any write permissions in the IAM service.

<details>

<summary>Provisioning IAM Policy (doesn't allow IAM resource creation in your users' stacks)</summary>

```json
{{restricted_provisioning_policy}}
```

</details>

Since your users cannot create IAM roles within their CloudFormation stacks, you, as the AWS admin, must create a common IAM execution role and share its name with your team, enabling them to pass it to the CloudFormation template when deploying their stacks. You can create this role using the following JSON policies. Ensure you use the path '/MW/' and prefix the role name with the "Resource naming prefix" you specified in the provisioning policy. If you wish to grant more permissions to your user's EC2 instances, you can attach additional IAM policies to this role.

<details>

<summary>Policy for Common Execution Role</summary>

```json
{{execution_policy}}
```

</details>

You can use this JSON as your Trust Policy for the Common Execution IAM Role.

<details>
<summary>Trust relationship JSON for execution role</summary>

```json
{{execution_policy_trust}}

```

</details>

## Related Information

* [AWS Cloudformation FAQs](https://aws.amazon.com/cloudformation/faqs/)
* [AWS Identity and Access Management (IAM) FAQs](https://aws.amazon.com/iam/faqs/)
* [AWS IAM service documentation](https://aws.amazon.com/iam/)
* [IAM JSON policy reference](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies.html)
* [Security best practices in IAM & least-privileged access model](https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege)
* [How to use the PassRole permission with IAM roles](https://aws.amazon.com/blogs/security/how-to-use-the-passrole-permission-with-iam-roles/)
* [How to use trust policies with IAM roles](https://aws.amazon.com/blogs/security/how-to-use-trust-policies-with-iam-roles/)
* [How to implement the principle of least privilege with CloudFormation StackSets](https://aws.amazon.com/blogs/security/how-to-implement-the-principle-of-least-privilege-with-cloudformation-stacksets/)
* [Grant a user permissions to pass a role to an AWS service](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_passrole.html)

## Technical Support

To request assistance or additional features, contact [MathWorks Technical Support](https://www.mathworks.com/support/contact_us.html).

----

Copyright 2025 The MathWorks, Inc.

----

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/src/static/SECURITY.md">
Reporting Security Vulnerabilities
==================================
If you believe you have discovered a security vulnerability, please report it to
security@mathworks.com instead of GitHub. Please see
[MathWorks Vulnerability Disclosure Policy for Security Researchers](https://www.mathworks.com/company/aboutus/policies_statements/vulnerability-disclosure-policy.html)
for additional information.
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/src/internal/permissions/execution_policy_trust.json">
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Service": "lambda.<<AWS_URL_SUFFIX>>"
            },
            "Action": [
                "sts:AssumeRole"
            ]
        },
        {
            "Effect": "Allow",
            "Principal": {
                "Service": "ec2.<<AWS_URL_SUFFIX>>"
            },
            "Action": [
                "sts:AssumeRole"
            ]
        }
    ]
}
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/src/internal/permissions/execution_policy.json">
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Condition": {
                "StringEquals": {
                    "aws:ResourceTag/mw-ProductID": "MathWorks-MATLAB-Linux"
                }
            },
            "Action": [
                "ec2:CreateTags",
                "ec2:DeleteTags",
                "ec2:StopInstances"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:ec2:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:instance/*",
            "Effect": "Allow"
        },
        {
            "Action": [
                "logs:CreateLogStream",
                "logs:DescribeLogStreams",
                "logs:PutLogEvents"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:logs:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:log-group:<<RESOURCE_NAMING_PREFIX>>*",
            "Effect": "Allow"
        },
        {
            "Action": "s3:GetObject",
            "Resource": "arn:<<AWS_PARTITION>>:s3:::dcv-license.<<AWS_REGION>>/*",
            "Effect": "Allow"
        },
        {
            "Action": "ec2:DescribeTags",
            "Resource": "*",
            "Effect": "Allow"
        },
        {
            "Action": [
                "ssm:DescribeAssociation",
                "ssm:DescribeDocument",
                "ssm:GetDeployablePatchSnapshotForInstance",
                "ssm:GetDocument",
                "ssm:GetManifest",
                "ssm:GetParameter",
                "ssm:GetParameters",
                "ssm:ListAssociations",
                "ssm:ListInstanceAssociations",
                "ssm:PutComplianceItems",
                "ssm:PutConfigurePackageResult",
                "ssm:PutInventory",
                "ssm:UpdateAssociationStatus",
                "ssm:UpdateInstanceAssociationStatus",
                "ssm:UpdateInstanceInformation"
            ],
            "Resource": "*",
            "Effect": "Allow"
        },
        {
            "Action": [
                "ssmmessages:CreateControlChannel",
                "ssmmessages:CreateDataChannel",
                "ssmmessages:OpenControlChannel",
                "ssmmessages:OpenDataChannel"
            ],
            "Resource": "*",
            "Effect": "Allow"
        },
        {
            "Action": [
                "ec2messages:AcknowledgeMessage",
                "ec2messages:DeleteMessage",
                "ec2messages:FailMessage",
                "ec2messages:GetEndpoint",
                "ec2messages:GetMessages",
                "ec2messages:SendReply"
            ],
            "Resource": "*",
            "Effect": "Allow"
        },
        {
            "Action": "ec2:DescribeInstances",
            "Resource": "*",
            "Effect": "Allow"
        },
        {
            "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:logs:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:log-group:/aws/lambda/*EC2ShutdownLambda*",
            "Effect": "Allow"
        }
    ]
}

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/src/internal/permissions/provisioning_policy.json">
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "CloudFormationCreate",
            "Effect": "Allow",
            "Action": [
                "cloudformation:CreateStack"
            ],
            "Resource": [
                "arn:<<AWS_PARTITION>>:cloudformation:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:stack/<<RESOURCE_NAMING_PREFIX>>*"
            ],
            "Condition": {
                "StringLike": {
                    "cloudformation:TemplateUrl": [
                        "https://mathworks-reference-architectures-templates.s3.amazonaws.com/*",
                        "https://matlab-on-aws.s3.amazonaws.com/*"
                    ]
                }
            }
        },
        {
            "Sid": "CloudformationActionsFromCloudFormation",
            "Effect": "Allow",
            "Action": [
                "cloudformation:DeleteStack",
                "cloudformation:DescribeStackEvents",
                "cloudformation:DescribeStacks"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:cloudformation:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:stack/<<RESOURCE_NAMING_PREFIX>>*"
        },
        {
            "Sid": "CloudformationActionsFromCloudFormation2",
            "Effect": "Allow",
            "Action": [
                "cloudformation:*ChangeSet*",
                "cloudformation:GetStackPolicy",
                "cloudformation:GetTemplate",
                "cloudformation:GetTemplateSummary",
                "cloudformation:ListStackResources"
            ],
            "Resource": [
                "arn:<<AWS_PARTITION>>:cloudformation:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:stack/<<RESOURCE_NAMING_PREFIX>>*",
                "arn:<<AWS_PARTITION>>:cloudformation:<<AWS_REGION>>:aws:transform/*"
            ]
        },
        {
            "Sid": "MultipleServicesActionsFromCloudFormation",
            "Effect": "Allow",
            "Action": [
                "ec2:AllocateAddress",
                "ec2:AssociateAddress",
                "ec2:AuthorizeSecurityGroupIngress",
                "ec2:CreateSecurityGroup",
                "ec2:CreateTags",
                "ec2:DeleteSecurityGroup",
                "ec2:DescribeAddresses",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstanceCreditSpecifications",
                "ec2:DescribeInstances",
                "ec2:DescribeKeyPairs",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DescribeSecurityGroupRules",
                "ec2:DescribeSecurityGroups",
                "ec2:DescribeSubnets",
                "ec2:DescribeVolumes",
                "ec2:DescribeVpcs",
                "ec2:DisassociateAddress",
                "ec2:ReleaseAddress",
                "ec2:RevokeSecurityGroupIngress",
                "ec2:RunInstances",
                "ec2:TerminateInstances",
                "logs:DescribeLogGroups",
                "logs:ListTagsForResource",
                "ssm:ListAssociations",
                "ssm:ListTagsForResource"
            ],
            "Resource": "*",
            "Condition": {
                "StringEquals": {
                    "aws:CalledViaFirst": [
                        "cloudformation.<<AWS_URL_SUFFIX>>"
                    ]
                }
            }
        },
        {
            "Sid": "EventsActionsFromCloudFormation",
            "Effect": "Allow",
            "Action": [
                "events:DeleteRule",
                "events:DescribeRule",
                "events:ListTargetsByRule",
                "events:PutRule",
                "events:PutTargets",
                "events:RemoveTargets"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:events:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:rule/<<RESOURCE_NAMING_PREFIX>>*",
            "Condition": {
                "StringEquals": {
                    "aws:CalledViaFirst": [
                        "cloudformation.<<AWS_URL_SUFFIX>>"
                    ]
                }
            }
        },
        {
            "Sid": "IamActionsFromCloudFormation",
            "Effect": "Allow",
            "Action": [
                "iam:AttachRolePolicy",
                "iam:CreateRole",
                "iam:DeleteRole",
                "iam:DeleteRolePolicy",
                "iam:DetachRolePolicy",
                "iam:GetRole",
                "iam:GetRolePolicy",
                "iam:ListAttachedRolePolicies",
                "iam:ListRolePolicies",
                "iam:PassRole",
                "iam:PutRolePolicy",
                "iam:TagRole"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:iam::<<AWS_ACCOUNT_ID>>:role/MW/<<RESOURCE_NAMING_PREFIX>>*",
            "Condition": {
                "StringEquals": {
                    "aws:CalledViaFirst": [
                        "cloudformation.<<AWS_URL_SUFFIX>>"
                    ]
                }
            }
        },
        {
            "Sid": "IamActionsFromCloudFormation2",
            "Effect": "Allow",
            "Action": [
                "iam:AddRoleToInstanceProfile",
                "iam:CreateInstanceProfile",
                "iam:DeleteInstanceProfile",
                "iam:GetInstanceProfile",
                "iam:RemoveRoleFromInstanceProfile"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:iam::<<AWS_ACCOUNT_ID>>:instance-profile/MW/<<RESOURCE_NAMING_PREFIX>>*",
            "Condition": {
                "StringEquals": {
                    "aws:CalledViaFirst": [
                        "cloudformation.<<AWS_URL_SUFFIX>>"
                    ]
                }
            }
        },
        {
            "Sid": "LambdaActionsFromCloudFormation",
            "Effect": "Allow",
            "Action": [
                "lambda:AddPermission",
                "lambda:CreateFunction",
                "lambda:DeleteFunction",
                "lambda:GetFunction",
                "lambda:GetFunctionCodeSigningConfig",
                "lambda:GetFunctionRecursionConfig",
                "lambda:GetPolicy",
                "lambda:GetRuntimeManagementConfig",
                "lambda:InvokeFunction",
                "lambda:RemovePermission",
                "lambda:TagResource"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:lambda:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:function:<<RESOURCE_NAMING_PREFIX>>*",
            "Condition": {
                "StringEquals": {
                    "aws:CalledViaFirst": [
                        "cloudformation.<<AWS_URL_SUFFIX>>"
                    ]
                }
            }
        },
        {
            "Sid": "LogsActionsFromCloudFormation",
            "Effect": "Allow",
            "Action": [
                "logs:CreateLogGroup",
                "logs:DeleteLogGroup"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:logs:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:log-group:<<RESOURCE_NAMING_PREFIX>>*",
            "Condition": {
                "StringEquals": {
                    "aws:CalledViaFirst": [
                        "cloudformation.<<AWS_URL_SUFFIX>>"
                    ]
                }
            }
        },
        {
            "Sid": "LogsActionsFromCloudFormation2",
            "Effect": "Allow",
            "Action": [
                "logs:CreateLogGroup",
                "logs:DeleteLogGroup",
                "logs:PutRetentionPolicy"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:logs:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:log-group:/aws/lambda/<<RESOURCE_NAMING_PREFIX>>*",
            "Condition": {
                "StringEquals": {
                    "aws:CalledViaFirst": [
                        "cloudformation.<<AWS_URL_SUFFIX>>"
                    ]
                }
            }
        },
        {
            "Sid": "SsmActionsFromCloudFormation",
            "Effect": "Allow",
            "Action": [
                "ssm:AddTagsToResource",
                "ssm:CreateDocument",
                "ssm:DeleteDocument",
                "ssm:DescribeDocument",
                "ssm:GetDocument"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:ssm:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:document/<<RESOURCE_NAMING_PREFIX>>*",
            "Condition": {
                "StringEquals": {
                    "aws:CalledViaFirst": [
                        "cloudformation.<<AWS_URL_SUFFIX>>"
                    ]
                }
            }
        },
        {
            "Sid": "EC2StopStart",
            "Effect": "Allow",
            "Action": [
                "ec2:StartInstances",
                "ec2:StopInstances"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:ec2:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:instance/*",
            "Condition": {
                "StringEquals": {
                    "aws:ResourceTag/mw-ProductID": "MathWorks-MATLAB-Linux"
                },
                "StringLike": {
                    "aws:ResourceTag/mw-StackName": "<<RESOURCE_NAMING_PREFIX>>*"
                }
            }
        },
        {
            "Sid": "ReadOnlyActionsForSmoothConsoleExperience",
            "Effect": "Allow",
            "Action": [
                "cloudformation:GetTemplateSummary",
                "cloudformation:ListStacks",
                "ec2:DescribeInstances",
                "ec2:DescribeKeyPairs",
                "ec2:DescribeSubnets",
                "ec2:DescribeVpcs",
                "logs:DescribeLogGroups",
                "ssm:DescribeInstanceInformation",
                "ssm:GetConnectionStatus"
            ],
            "Resource": "*"
        },
        {
            "Sid": "EC2KeyPairWriteAccess",
            "Effect": "Allow",
            "Action": [
                "ec2:CreateKeyPair",
                "ec2:DeleteKeyPair"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:ec2:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:key-pair/<<RESOURCE_NAMING_PREFIX>>*"
        },
        {
            "Sid": "CloudWatchLogsReadOnlyAccess",
            "Effect": "Allow",
            "Action": [
                "logs:DescribeLogStreams",
                "logs:GetLogEvents"
            ],
            "Resource": [
                "arn:<<AWS_PARTITION>>:logs:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:log-group:/aws/lambda/<<RESOURCE_NAMING_PREFIX>>*",
                "arn:<<AWS_PARTITION>>:logs:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:log-group:<<RESOURCE_NAMING_PREFIX>>*"
            ]
        }
    ]
}
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/src/internal/permissions/test/parameter_overrides.json">
{
    "AutoShutdown": "After 3 hours",
    "EnableCloudWatch": "Yes",
    "EnableMATLABProxy": "Yes",
    "UseElasticIpAddress": "Yes"
}
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/.github/workflows/build-stage-test.yml">
name: 'Multi-version Build Pipeline'

on:
  workflow_dispatch:
    inputs:
      matlab_versions:
        description: "Comma-separated list (e.g. R2025a,R2024b). Empty = Latest 5."
        required: false
        type: string
        default: ""

permissions:
  id-token: write          # Required for AWS OIDC (Packer, Distribute)
  contents: write          # Required for Creating Releases (gh-release)
  attestations: write      # Required for SLSA Attestations
  security-events: write   # Required for uploading Trivy SARIF results
  actions: read            # Sometimes required if the repo is private/internal

jobs:
  prepare-versions:
    uses: eshans-nexus/actions-templates/.github/workflows/module-gh-get-versions.yml@main
    with:
      input_versions: ${{ inputs.matlab_versions }}
      search_dir: './releases'

  create-artifacts:
    needs: prepare-versions
    if: ${{ needs.prepare-versions.outputs.matrix != '[]' }}
    strategy:
        fail-fast: false
        max-parallel: 5
        matrix:
          version: ${{ fromJson(needs.prepare-versions.outputs.matrix) }}
    uses: eshans-nexus/actions-templates/.github/workflows/orchestrator-aws-single.yml@main
    with:
      matlab_version: ${{ matrix.version }}
      flavor: 'matlab-linux'
      packer_dir: './packer/v1'
      template_file_path: 'packer/v1/src/metatemplate.json'
      is_supplementary_build: true
      skip_build: true # chnage this to enable builds
    secrets: inherit

  release-artifacts:
    name: Create Aggregate GH Release
    needs: create-artifacts
    uses: eshans-nexus/actions-templates/.github/workflows/orchestrator-gh-release.yml@main
    with:
      target_versions: ${{ needs.prepare-versions.outputs.matrix }}
      files_pattern: "*" 
      release_tag: "Build-${{ github.run_number }}"
      release_title: "Ref Arch Build ${{ github.run_number }}"
      generate_attestations: true
    secrets: inherit
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/build-matlab-ami.pkr.hcl">
# Copyright 2023-2024 The MathWorks, Inc.

packer {
  required_plugins {
    amazon = {
      version = ">= 1.3.2"
      source  = "github.com/hashicorp/amazon"
    }
  }
}

# The following variables may have different value across releases and 
# it is recommended to modify them via the release-specific configuration file.
# To learn the release-specific values, visit the configuration file
# under /packer/v1/release-config/ folder.

variable "PRODUCTS" {
  type        = string
  default     = "5G_Toolbox AUTOSAR_Blockset Aerospace_Blockset Aerospace_Toolbox Antenna_Toolbox Audio_Toolbox Automated_Driving_Toolbox Bioinformatics_Toolbox Bluetooth_Toolbox C2000_Microcontroller_Blockset Communications_Toolbox Computer_Vision_Toolbox Control_System_Toolbox Curve_Fitting_Toolbox DDS_Blockset DSP_HDL_Toolbox DSP_System_Toolbox Database_Toolbox Datafeed_Toolbox Deep_Learning_HDL_Toolbox Deep_Learning_Toolbox Econometrics_Toolbox Embedded_Coder Filter_Design_HDL_Coder Financial_Instruments_Toolbox Financial_Toolbox Fixed-Point_Designer Fuzzy_Logic_Toolbox GPU_Coder Global_Optimization_Toolbox HDL_Coder HDL_Verifier Image_Acquisition_Toolbox Image_Processing_Toolbox Industrial_Communication_Toolbox Instrument_Control_Toolbox LTE_Toolbox Lidar_Toolbox MATLAB MATLAB_Coder MATLAB_Compiler MATLAB_Compiler_SDK MATLAB_Production_Server MATLAB_Report_Generator MATLAB_Test MATLAB_Web_App_Server Mapping_Toolbox Medical_Imaging_Toolbox Mixed-Signal_Blockset Model_Predictive_Control_Toolbox Motor_Control_Blockset Navigation_Toolbox Optimization_Toolbox Parallel_Computing_Toolbox Partial_Differential_Equation_Toolbox Phased_Array_System_Toolbox Powertrain_Blockset Predictive_Maintenance_Toolbox RF_Blockset RF_PCB_Toolbox RF_Toolbox ROS_Toolbox Radar_Toolbox Reinforcement_Learning_Toolbox Requirements_Toolbox Risk_Management_Toolbox Robotics_System_Toolbox Robust_Control_Toolbox Satellite_Communications_Toolbox Sensor_Fusion_and_Tracking_Toolbox SerDes_Toolbox Signal_Integrity_Toolbox Signal_Processing_Toolbox SimBiology SimEvents Simscape Simscape_Battery Simscape_Driveline Simscape_Electrical Simscape_Fluids Simscape_Multibody Simulink Simulink_3D_Animation Simulink_Check Simulink_Coder Simulink_Compiler Simulink_Control_Design Simulink_Coverage Simulink_Design_Optimization Simulink_Design_Verifier Simulink_Desktop_Real-Time Simulink_Fault_Analyzer Simulink_PLC_Coder Simulink_Real-Time Simulink_Report_Generator Simulink_Test SoC_Blockset Stateflow Statistics_and_Machine_Learning_Toolbox Symbolic_Math_Toolbox System_Composer System_Identification_Toolbox Text_Analytics_Toolbox UAV_Toolbox Vehicle_Dynamics_Blockset Vehicle_Network_Toolbox Vision_HDL_Toolbox WLAN_Toolbox Wavelet_Toolbox Wireless_HDL_Toolbox Wireless_Testbench"
  description = "Target products to install in the machine image, e.g. MATLAB SIMULINK."
}

variable "SPKGS" {
  type        = string
  default     = "Deep_Learning_Toolbox_Model_for_AlexNet_Network Deep_Learning_Toolbox_Model_for_EfficientNet-b0_Network Deep_Learning_Toolbox_Model_for_GoogLeNet_Network Deep_Learning_Toolbox_Model_for_ResNet-101_Network Deep_Learning_Toolbox_Model_for_ResNet-18_Network Deep_Learning_Toolbox_Model_for_ResNet-50_Network Deep_Learning_Toolbox_Model_for_Inception-ResNet-v2_Network Deep_Learning_Toolbox_Model_for_Inception-v3_Network Deep_Learning_Toolbox_Model_for_DenseNet-201_Network Deep_Learning_Toolbox_Model_for_Xception_Network Deep_Learning_Toolbox_Model_for_MobileNet-v2_Network Deep_Learning_Toolbox_Model_for_Places365-GoogLeNet_Network Deep_Learning_Toolbox_Model_for_NASNet-Large_Network Deep_Learning_Toolbox_Model_for_NASNet-Mobile_Network Deep_Learning_Toolbox_Model_for_ShuffleNet_Network Deep_Learning_Toolbox_Model_for_DarkNet-19_Network Deep_Learning_Toolbox_Model_for_DarkNet-53_Network Deep_Learning_Toolbox_Model_for_VGG-16_Network Deep_Learning_Toolbox_Model_for_VGG-19_Network"
  description = "Target support packages to install in the machine image, e.g. Deep_Learning_Toolbox_Model_for_AlexNet_Network."
}

variable "RELEASE" {
  type        = string
  default     = "R2024a"
  description = "Target MATLAB release to install in the machine image, must start with \"R\"."

  validation {
    condition     = can(regex("^R20[0-9][0-9](a|b)(U[0-9])?$", var.RELEASE))
    error_message = "The RELEASE value must be a valid MATLAB release, starting with \"R\"."
  }
}

variable "BASE_AMI_NAME" {
  type        = string
  default     = "ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*"
  description = "Default AMI name refers to the Ubuntu Server 22.04 image provided by Canonical."
}

variable "BUILD_SCRIPTS" {
  type        = list(string)
  default     = ["install-startup-scripts.sh", "install-swap-desktop-solution.sh", "install-dependencies.sh", "install-matlab-proxy.sh", "install-matlab-dependencies-ubuntu.sh", "install-ubuntu-desktop.sh", "install-mate.sh", "install-matlab.sh", "install-support-packages.sh", "setup-startup-accelerator.sh", "install-fabric-manager-ubuntu.sh", "generate-toolbox-cache.sh", "cleanup.sh"]
  description = "The list of installation scripts Packer will use when building the image."
}

variable "STARTUP_SCRIPTS" {
  type        = list(string)
  default     = [".env", "10_setup-disks.sh", "20_setup-machine.sh", "30_setup-logging.sh", "40_setup-rdp.sh", "50_setup-nicedcv.sh", "60_setup-matlab-proxy.sh", "70_setup-matlab.sh", "80_warmup-matlab.sh", "85_warmup-mathworks-service-host.sh", "99_run-optional-user-command.sh"]
  description = "The list of startup scripts Packer will copy to the remote machine image builder, which can be used during the CloudFormation Stack creation."
}

variable "RUNTIME_SCRIPTS" {
  type        = list(string)
  default     = ["swap-desktop-solution.sh", "launch-matlab-proxy.sh", "generate-certificate.py"]
  description = "The list of runtime scripts Packer will copy to the remote machine image builder, which can be used after the CloudFormation Stack creation."
}

variable "DCV_INSTALLER_URL" {
  type        = string
  default     = "https://d1uj6qtbmh3dt5.cloudfront.net/2023.0/Servers/nice-dcv-2023.0-15065-ubuntu2204-x86_64.tgz"
  description = "The URL to install NICE DCV, a remote display protocol to use."
}

variable "NVIDIA_DRIVER_VERSION" {
  type        = string
  default     = "535"
  description = "The version of target NVIDIA Driver to install."
}

variable "NVIDIA_CUDA_TOOLKIT" {
  type        = string
  default     = "https://developer.download.nvidia.com/compute/cuda/12.2.2/local_installers/cuda_12.2.2_535.104.05_linux.run"
  description = "The URL to install NVIDIA CUDA Toolkit into the target machine image. "
}

variable "NVIDIA_CUDA_KEYRING_URL" {
  type        = string
  default     = "https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.0-1_all.deb"
  description = "NVIDIA CUDA keyring url."
}

variable "MATLAB_PROXY_VERSION" {
  type        = string
  description = "Version of matlab-proxy to pull from PyPI."
  default     = "0.10.0"
  validation {
    condition     = length(var.MATLAB_PROXY_VERSION) > 0
    error_message = "A valid version must be provided to install matlab-proxy."
  }
}

variable "MATLAB_SOURCE_URL" {
  type        = string
  default     = ""
  description = "Optional URL from which to download a MATLAB and toolbox source file, for use with the mpm --source option."
}

# The following variables share the same setup across all MATLAB releases.
variable "VPC_ID" {
  type        = string
  default     = ""
  description = "The target AWS VPC to be used by Packer. If not specified, Packer will use default VPC."

  validation {
    condition     = length(var.VPC_ID) == 0 || substr(var.VPC_ID, 0, 4) == "vpc-"
    error_message = "The VPC_ID must start with \"vpc-\"."
  }
}

variable "SUBNET_ID" {
  type        = string
  default     = ""
  description = "The target subnet to be used by Packer. If not specified, Packer will use the subnet that has the most free IP addresses."

  validation {
    condition     = length(var.SUBNET_ID) == 0 || substr(var.SUBNET_ID, 0, 7) == "subnet-"
    error_message = "The SUBNET_ID must start with \"subnet-\"."
  }
}

variable "AWS_INSTANCE_PROFILE" {
  type        = string
  default     = ""
  description = "Name of the IAM instance profile to attach to the Packer builder EC2 instance."
}

variable "INSTANCE_TAGS" {
  type = map(string)
  default = {
    Name  = "Packer Builder"
    Build = "MATLAB"
  }
  description = "The tags Packer adds to the machine image builder."
}

variable "AMI_TAGS" {
  type = map(string)
  default = {
    Name          = "Packer Build"
    Build         = "MATLAB"
    Type          = "matlab-on-aws"
    Base_AMI_ID   = "{{ .SourceAMI }}"
    Base_AMI_Name = "{{ .SourceAMIName }}"
  }
  description = "The tags Packer adds to the resultant machine image."
}

variable "MANIFEST_OUTPUT_FILE" {
  type        = string
  default     = "manifest.json"
  description = "The name of the resultant manifest file."
}

# Set up local variables used by provisioners.
locals {
  timestamp       = regex_replace(timestamp(), "[- TZ:]", "")
  build_scripts   = [for s in var.BUILD_SCRIPTS : format("build/%s", s)]
  startup_scripts = [for s in var.STARTUP_SCRIPTS : format("startup/%s", s)]
  runtime_scripts = [for s in var.RUNTIME_SCRIPTS : format("runtime/%s", s)]
}

# Configure the EC2 instance that is used to build the machine image.
source "amazon-ebs" "AMI_Builder" {
  ami_name                = "CustomPacker-${var.RELEASE}-${local.timestamp}"
  region                  = "us-east-1"
  iam_instance_profile    = "${var.AWS_INSTANCE_PROFILE}"
  instance_type           = "g4dn.xlarge"
  aws_polling {
    delay_seconds = 30
    max_attempts  = 300
  }
  launch_block_device_mappings {
    delete_on_termination = true
    device_name           = "/dev/sda1"
    volume_size           = 128
    volume_type           = "gp2"
  }
  source_ami_filter {
    filters = {
      "virtualization-type" = "hvm"
      "name"                = "${var.BASE_AMI_NAME}"
      "root-device-type"    = "ebs"
    }
    owners      = ["099720109477"] # Canonical's owner ID https://documentation.ubuntu.com/aws/en/latest/aws-how-to/instances/find-ubuntu-images/
    most_recent = true
  }
  ssh_username = "ubuntu"
  run_tags     = "${var.INSTANCE_TAGS}"
  tags         = "${var.AMI_TAGS}"
  subnet_filter {
    most_free = true
    random    = false
  }
  subnet_id = "${var.SUBNET_ID}"
  vpc_filter {
    filters = {
      isDefault = "true"
    }
  }
  vpc_id                                    = "${var.VPC_ID}"
  temporary_security_group_source_public_ip = "true"
}

# Build the machine image.
build {
  sources = ["source.amazon-ebs.AMI_Builder"]

  provisioner "shell" {
    inline = ["mkdir /tmp/startup"]
  }

  provisioner "file" {
    destination = "/var/tmp/"
    source      = "build/config"
  }

  provisioner "file" {
    destination = "/tmp/startup/"
    sources     = "${local.startup_scripts}"
  }

  provisioner "file" {
    destination = "/tmp/"
    sources     = "${local.runtime_scripts}"
  }

  provisioner "shell" {
    environment_vars = [
      "RELEASE=${var.RELEASE}",
      "PRODUCTS=${var.PRODUCTS}",
      "SPKGS=${var.SPKGS}",
      "MATLAB_PROXY_VERSION=${var.MATLAB_PROXY_VERSION}",
      "DCV_INSTALLER_URL=${var.DCV_INSTALLER_URL}",
      "NVIDIA_DRIVER_VERSION=${var.NVIDIA_DRIVER_VERSION}",
      "NVIDIA_CUDA_TOOLKIT=${var.NVIDIA_CUDA_TOOLKIT}",
      "NVIDIA_CUDA_KEYRING_URL=${var.NVIDIA_CUDA_KEYRING_URL}",
      "MATLAB_SOURCE_URL=${var.MATLAB_SOURCE_URL}",
      "MATLAB_ROOT=/usr/local/matlab"
    ]
    expect_disconnect = true
    scripts           = "${local.build_scripts}"
  }

  post-processor "manifest" {
    output     = "${var.MANIFEST_OUTPUT_FILE}"
    strip_path = true
    custom_data = {
      release            = "MATLAB ${var.RELEASE}"
      specified_products = "${var.PRODUCTS}"
      specified_spkgs    = "${var.SPKGS}"
      build_scripts      = join(", ", "${var.BUILD_SCRIPTS}")
      base_ami_id        = "{{ .SourceAMI }}"
      base_ami_name      = "{{ .SourceAMIName }}"
    }
  }
}

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/.gitattributes">
# Shell scripts are run by the Packer build on the remote Linux machine,
# and so should have LF line endings on checkout.
*.sh text eol=lf

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/README.md">
# **Build Your Own Machine Image**

## **Introduction**
This guide shows how to build your own Amazon® Machine Image (AMI) using the same scripts that form the basis of the build process for MathWorks® prebuilt images.
You can use the scripts to install MATLAB®, MATLAB toolboxes, and the other features detailed below.

A HashiCorp® Packer template generates the machine image.
The template is an HCL2 file that tells Packer which plugins (builders, provisioners, post-processors) to use, how to configure each of those plugins, and what order to run them in.
For more information about templates, see [Packer Templates](https://www.packer.io/docs/templates#packer-templates).



## **Requirements**
Before starting, you will need:
* A valid Packer installation later than 1.7.0. For more information, see [Install Packer](https://www.packer.io/downloads).
* AWS credentials with sufficient permission. For more information, see [Packer Authentication](https://www.packer.io/plugins/builders/amazon#authentication).

## **Costs**
You are responsible for the cost of the AWS services used when you create cloud resources using this guide. Resource settings, such as instance type, will affect the cost of deployment. For cost estimates, see the pricing pages for each AWS service you will be using. Prices are subject to change.

## **Quick Launch Instructions**
This section shows how to build the latest MATLAB machine image in your own AWS account. 

Pull the source code and navigate to the Packer folder.
```bash
git clone https://github.com/mathworks-ref-arch/matlab-on-aws.git
cd matlab-on-aws/packer/v1
```

Initialize Packer to install the required plugins.
You only need to do this once.
For more information, see [init command reference (Packer)](https://developer.hashicorp.com/packer/docs/commands/init).
```bash
packer init build-matlab-ami.pkr.hcl
```

Launch the Packer build with the default settings.
```bash
packer build build-matlab-ami.pkr.hcl
```
Packer writes its output, including the ID of the generated machine image, to a `manifest.json` file at the end of the build.
To use the built image with a MathWorks CloudFormation template, see [Deploy Machine Image](#deploy-machine-image).


## **How to Run the Packer Build**
This section describes the complete Packer build process and the different options for launching the build.


### **Build-Time Variables**
The [Packer template](https://github.com/mathworks-ref-arch/matlab-on-aws/tree/master/packer/v1/build-matlab-ami.pkr.hcl)
supports these build-time variables.
| Argument Name | Default Value | Description |
|---|---|---|
| [PRODUCTS](#customize-products-to-install)| MATLAB and all available toolboxes | Products to install, specified as a list of product names separated by spaces. For example, `MATLAB Simulink Deep_Learning_Toolbox Parallel_Computing_Toolbox`.<br/>If no products are specified, the Packer build will install MATLAB with all available toolboxes. For more information, see [MATLAB Package Manager](https://github.com/mathworks-ref-arch/matlab-dockerfile/blob/main/MPM.md).|
| SPKGS | List of Deep Learning Support Packages, specified in [release-config](https://github.mathworks.com/development/matlab-aws-refarch/tree/dev/packer/v1/release-config) | A list of support packages to install, specified as a list of support package names separated by spaces. For example, `Deep_Learning_Toolbox_Model_for_GoogLeNet_Network Deep_Learning_Toolbox_Model_for_ResNet-101_Network` |
| BASE_AMI | Default AMI ID refers to ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server. | The base AMI upon which the image is built, defaults to an official Canonical Ubuntu image. |
| VPC_ID | *unset* | VPC to assign to the Packer build instance. If no VPC is specified, the default VPC will be used.|
| SUBNET_ID | *unset* | Subnet to assign to the Packer build instance. If no subnet is specified, the subnet with the most free IPv4 addresses will be used.|
| INSTANCE_TAGS |{Name="Packer Builder", Build="MATLAB"} | Tags to add to the Packer build instance.|
| AMI_TAGS | {Name="Packer Build", Build="MATLAB", Type="matlab-on-aws"} | Tags to add to the machine image.|

For a full list of the variables used in the build, see the description fields in the
[Packer template](https://github.com/mathworks-ref-arch/matlab-on-aws/tree/master/packer/v1/build-matlab-ami.pkr.hcl).



### **Customize Packer Build**
#### **Customize Products to Install**
Use the Packer build-time variable `PRODUCTS` to specify the list of products you want to install on the machine image. If unspecified, Packer will install MATLAB with all the available toolboxes.

For example, install the latest version of MATLAB and Deep Learning Toolbox.
```bash
packer build -var="PRODUCTS=MATLAB Deep_Learning_Toolbox" build-matlab-ami.pkr.hcl
```

#### **Customize MATLAB Release to Install**
To use an earlier MATLAB release, you must use one of the variable definition files in the [release-config](https://github.com/mathworks-ref-arch/matlab-on-aws/tree/master/packer/v1/release-config) folder. Note that although the files are available for MATLAB R2020a and later, MathWorks recommends using MATLAB R2023a or later. This is because the Packer builds for earlier releases use Ubuntu 20.04, which is no longer receiving security updates. 

For example, install MATLAB R2020a and all available toolboxes.
```bash
packer build -var-file="release-config/R2020a.pkrvars.hcl" build-matlab-ami.pkr.hcl
```
Command line arguments can also be combined. For example, install MATLAB R2020a and the Parallel Computing Toolbox only.
```bash
packer build -var-file="release-config/R2020a.pkrvars.hcl" -var="PRODUCTS=MATLAB Parallel_Computing_Toolbox" build-matlab-ami.pkr.hcl
```
Launch the customized image using the corresponding CloudFormation Template.
For instructions on how to use CloudFormation Templates, see the Deployment Steps
section on [MATLAB on Amazon Web Services](https://github.com/mathworks-ref-arch/matlab-on-aws).
#### **Customize Multiple Variables**
You can set multiple variables in a [Variable Definition File](https://developer.hashicorp.com/packer/docs/templates/hcl_templates/variables#standard-variable-definitions-files).

For example, to generate a machine image with the most recent MATLAB installed with additional toolboxes in a custom VPC, create a variable definition file named `custom-variables.pkrvars.hcl` containing these variable definitions.
```
VPC_ID    = <any_VPC_id>
PRODUCTS  = "MATLAB Deep_Learning_Toolbox Parallel_Computing_Toolbox"
```

To specify a MATLAB release using a variable definition file, modify the variable definition file
in the [release-config](https://github.com/mathworks-ref-arch/matlab-on-aws/tree/master/packer/v1/release-config)
folder corresponding to the desired release.

Save the variable definition file and include it in the Packer build command.
```bash
packer build -var-file="custom-variables.pkrvars.hcl" build-matlab-ami.pkr.hcl
```

### **Installation Scripts**
The Packer build executes scripts on the image builder instance during the build.
These scripts perform tasks such as
installing tools needed by the build (including gcc, wget, make, CloudWatch, cfn-signal),
installing MATLAB and toolboxes on the image using [MATLAB Package Manager](https://github.com/mathworks-ref-arch/matlab-dockerfile/blob/main/MPM.md),
and cleaning up build leftovers (including bash history, SSH keys).

For the full list of scripts that the Packer build executes during the build, see the `BUILD_SCRIPTS` parameter in the
[Packer template](https://github.com/mathworks-ref-arch/matlab-on-aws/tree/master/packer/v1/build-matlab-ami.pkr.hcl).
The prebuilt images that MathWorks provides are built using these scripts as a base, and additionally have support packages installed.

In addition to the build scripts above, the Packer build copies further scripts to the machine image,
to be used during startup and at runtime. These scripts perform tasks such as
mounting available storage and
initializing CloudWatch logging (if this is chosen),
among other utility tasks.

For the full list of startup and runtime scripts, see the `STARTUP_SCRIPTS` and the `RUNTIME_SCRIPTS` parameters in the
[Packer template](https://github.com/mathworks-ref-arch/matlab-on-aws/tree/master/packer/v1/build-matlab-ami.pkr.hcl).


## Validate Packer Template
To validate the syntax and configuration of a Packer template, use the `packer validate` command. This command also checks whether the provided input variables meet the custom validation rules defined by MathWorks. For more information, see [validate Command](https://www.packer.io/docs/commands/validate#validate-command).

You can also use command line interfaces provided by Packer to inspect and format the template. For more information, see [Packer Commands (CLI)](https://www.packer.io/docs/commands).

## Deploy Machine Image
When the build finishes, Packer writes
the output to a `manifest.json` file, which contains these fields:
```json
{
  "builds": [
    {
      "name":,
      "builder_type": ,
      "build_time": ,
      "files": ,
      "artifact_id": ,
      "packer_run_uuid": ,
      "custom_data": {
        "build_scripts": ,
        "release": ,
        "specified_products":
      }
    }
  ],
  "last_run_uuid": ""
}
```

The `artifact_id` section shows the ID of the machine image generated by the most recent Packer build.

The CloudFormation templates provided by MathWorks for releases R2022b onwards include an optional custom machine image ID field, `CustomAmiId`.
If you do not specify a custom machine image ID, the template
launches a prebuilt image provided by MathWorks. To launch a custom machine image,
provide the `artifact_id` from the `manifest.json` file as the `CustomAmiId`.

For AMIs built with an earlier MATLAB release, replace the AMI ID in the
corresponding CloudFormation template with the AMI ID of your customized image.

If the build has been customized, for example by removing or modifying one or more of the included scripts,
the resultant machine image **may no longer be compatible** with the provided CloudFormation template.
Compatibility can in some cases be restored by making corresponding modifications to the CloudFormation template.

## Help Make MATLAB Even Better
You can help improve MATLAB by providing user experience information on how you use MathWorks products. Your participation ensures that you are represented and helps us design better products.
To opt out of this service, remove the [mw_context_tag.sh](https://github.com/mathworks-ref-arch/matlab-on-aws/tree/master/packer/v1/build/config/matlab/mw_context_tag.sh)
script under the `config` folder,
and the line in [install-matlab.sh](https://github.com/mathworks-ref-arch/matlab-on-aws/tree/master/packer/v1/build/install-matlab.sh)
which moves `mw_context_tag.sh` on the image.

To learn more, see the documentation: [Help Make MATLAB Even Better - Frequently Asked Questions](https://www.mathworks.com/support/faq/user_experience_information_faq.html).

## Technical Support
If you require assistance or have a request for additional features or capabilities, please contact [MathWorks Technical Support](https://www.mathworks.com/support/contact_us.html).

----

Copyright 2023-2025 The MathWorks, Inc.

----

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/startup/85_warmup-mathworks-service-host.sh">
#!/usr/bin/env bash
#
# Copyright 2024 The MathWorks, Inc.

# Print commands for logging purposes, including timestamps.
PS4='+ [\d \t] '
set -x

MSH_ROOT_PATH="/opt/MathWorks/ServiceHost"

if [[ -d "${MSH_ROOT_PATH}" ]] && [[ -n "${MATLAB_ROOT}" ]]; then
    "${MATLAB_ROOT}/bin/glnxa64/MATLABStartupAccelerator" 64 "$MSH_ROOT_PATH" <(find "$MSH_ROOT_PATH" -type f) /var/log/mshsa.log
    echo 'MSH warm up done.'
fi

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/startup/30_setup-logging.sh">
#!/usr/bin/env bash
#
# Copyright 2021-2024 The MathWorks, Inc.

# Print commands for logging purposes, including timestamps.
PS4='+ [\d \t] '
set -x

if [[ -n ${CLOUD_LOG_NAME} ]]; then

    # Prepare cloudwatch config file
    cat > /opt/aws/amazon-cloudwatch-agent/bin/config.json << EOF
{
    "agent": {
        "metrics_collection_interval": 60
    },
    "logs": {
        "logs_collected": {
            "files": {
                "collect_list": [
                    {
                        "file_path": "/var/log/xrdp.log",
                        "log_group_name": "${CLOUD_LOG_NAME}",
                        "log_stream_name": "xrdp"
                    },
                    {
                        "file_path": "/var/log/mathworks/startup.log",
                        "log_group_name": "${CLOUD_LOG_NAME}",
                        "log_stream_name": "startup"
                    },
                    {
                        "file_path": "/tmp/mathworks_ubuntu.log",
                        "log_group_name": "${CLOUD_LOG_NAME}",
                        "log_stream_name": "matlab"
                    },
                    {
                        "file_path": "/var/log/mathworks/swap_desktop_solution.log",
                        "log_group_name": "${CLOUD_LOG_NAME}",
                        "log_stream_name": "desktop_swap"
                    },
                    {
                        "file_path": "/home/ubuntu/matlab_crash_dump*",
                        "log_group_name": "${CLOUD_LOG_NAME}",
                        "log_stream_name": "matlab_crashes"
                    },
                    {
                        "file_path": "/var/log/dcv/server.log*",
                        "log_group_name": "${CLOUD_LOG_NAME}",
                        "log_stream_name": "dcv_server"
                    },
                    {
                        "file_path": "/var/log/dcv/sessionlauncher.log*",
                        "log_group_name": "${CLOUD_LOG_NAME}",
                        "log_stream_name": "dcv_sessionlauncher"
                    },
                    {
                        "file_path": "/var/log/dcv/agent.*log*",
                        "log_group_name": "${CLOUD_LOG_NAME}",
                        "log_stream_name": "dcv_agent"
                    },
                    {
                        "file_path": "/var/log/syslog",
                        "log_group_name": "${CLOUD_LOG_NAME}",
                        "log_stream_name": "syslog"
                    },
                    {
                        "file_path": "/home/*/.MathWorks/mwrefarch/mwrefarch.log",
                        "log_group_name": "${CLOUD_LOG_NAME}",
                        "log_stream_name": "mwrefarch"
                    }
                ]
            }
        }
    }
}
EOF

    # In this command:
    #     -a fetch-config causes the agent to load the latest version of the CloudWatch agent configuration file;
    #     -m tells the agent the host is on ec2;
    #     -s starts the agent;
    #     -c points to the configuration file
    /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -s -c file:/opt/aws/amazon-cloudwatch-agent/bin/config.json
    systemctl enable amazon-cloudwatch-agent
fi
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/startup/80_warmup-matlab-pre-R2022a.sh">
#!/usr/bin/env bash
#
# Copyright 2023-2024 The MathWorks, Inc.

# Print commands for logging purposes, including timestamps.
PS4='+ [\d \t] '
set -x

if [[ -n ${MATLAB_ROOT} ]]; then
    /usr/bin/parallel -j64 -m --nice 10 --arg-file /usr/local/etc/msa/msa.ini /bin/cat "{}" >/dev/null 2>&1
    echo 'Warm up done.'
fi

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/startup/60_setup-matlab-proxy.sh">
#!/usr/bin/env bash
#
# Copyright 2024 The MathWorks, Inc.

# Print commands for logging purposes.
set -x

matlabProxyFiles="/opt/mathworks/matlab-proxy"

# generate a SSL ceritificate for matlab-proxy to use
certFile="/etc/ssl/certs/matlab-proxy_certificate.pem"
keyFile="/etc/ssl/certs/matlab-proxy_private-key.pem"

# If either file does not exist
if [[ ! -f $certFile || ! -f $keyFile ]]; then
    rm -f $certFile
    rm -f $keyFile

    # Since one or both files were missing or have been removed, generate new ones
    python3 $matlabProxyFiles/generate-certificate.py
    mv $matlabProxyFiles/certificate.pem $certFile
    mv $matlabProxyFiles/private_key.pem $keyFile
fi

# set the password for matlab-proxy to use token-authentication
if [[ -n $PASSWORD ]]; then
    launchFile="$matlabProxyFiles/launch-matlab-proxy.sh"
    passwordDec="\$(echo '$PASSWORD' | base64 -d)"
    sed -i "s/# export MWI_AUTH_TOKEN=/export MWI_AUTH_TOKEN=$passwordDec/g" "$launchFile"
fi

# starting the service that runs matlab-proxy
if [[ ${ENABLE_MATLAB_PROXY} == Yes ]]; then
    systemctl enable matlab-proxy.service
    systemctl start matlab-proxy.service
fi

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/startup/99_run-optional-user-command.sh">
#!/bin/bash
#
# Copyright 2023-2024 The MathWorks, Inc.

PS4='+ [\d \t] '
set -x

echo "Optional user command - script started."

# Check whether the value of the parameter optional user command is empty.
if [[ -z "${OPTIONAL_USER_COMMAND}" ]]
then
    echo "No optional user command was passed."
else
    echo "The passed string is an inline shell command."
    eval "${OPTIONAL_USER_COMMAND}"
fi

echo "Optional user command - script completed."

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/startup/70_setup-matlab.sh">
#!/usr/bin/env bash
#
# Copyright 2023-2024 The MathWorks, Inc.

# Print commands for logging purposes.
set -x

MLM_DEF_FILE=/etc/profile.d/mlm_def.sh

if [[ -n ${MLM_LICENSE_FILE} ]]; then
    echo "License MATLAB using Network License Manager"
    sed -i "s|^#export MLM_LICENSE_FILE=.*|export MLM_LICENSE_FILE='${MLM_LICENSE_FILE}'|" ${MLM_DEF_FILE}
else
    echo "License MATLAB using Online Licensing"
fi

# Setup MATLAB licensing in non-login shells
if [[ -z ${USERNAME} ]]; then
    USERNAME=ubuntu
fi

cat >> "/home/${USERNAME}/.bashrc" << EOF
# Setup MATLAB Licensing
. ${MLM_DEF_FILE}
EOF

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/startup/.env">
# startup/.env: sourced by bash(1) at launch of the EC2 instance
# in user data

MATLAB_ROOT=/usr/local/matlab

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/startup/00_check-profile.sh">
#!/usr/bin/env bash
# This script checks if an instance profile has been attached to this instance. This needs to be run before any AWS API calls that would require IAM permissions for the instance.
# Copyright 2023 The MathWorks Inc.

response=""
until [ ! -z "$response" ]; do
    # Keep querying IMDS till a valid Instance profile ARN is obtained
    response=$(curl -s http://169.254.169.254/latest/meta-data/iam/info | grep InstanceProfileArn)
    sleep 2
done
echo "Found attached instance profile: ${response}"
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/startup/50_setup-nicedcv.sh">
#!/usr/bin/env bash
#
# Copyright 2023-2024 The MathWorks, Inc.

# Print commands for logging purposes.
set -x

if [[ ${ACCESS_PROTOCOL} == 'NICE DCV' ]]; then
    systemctl set-default graphical.target
    systemctl isolate graphical.target

    systemctl enable dcvserver
    systemctl start dcvserver
fi

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/startup/20_setup-machine.sh">
#!/usr/bin/env bash
#
# Copyright 2023-2024 The MathWorks, Inc.

# Print commands for logging purposes.
set -x

if [[ -z ${USERNAME} ]]; then
    USERNAME=ubuntu
fi

if [[ -z ${GROUPNAME} ]]; then
    GROUPNAME=ubuntu
fi

# Set password for user
if [[ -n ${PASSWORD} ]]; then
    echo ${USERNAME}:"$(echo "${PASSWORD}" | base64 -d)" | chpasswd
fi

# Disable gnome setup window
echo "yes" >> /home/${USERNAME}/.config/gnome-initial-setup-done

# Start the fabric manager server for p4d instances
TOKEN=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 120")
INSTANCE_TYPE=$(curl -s -H "X-aws-ec2-metadata-token: ${TOKEN}" 169.254.169.254/latest/meta-data/instance-type)
if [[ ${INSTANCE_TYPE} == p4d* ]] ; then
    systemctl enable nvidia-fabricmanager
    systemctl start nvidia-fabricmanager
fi

# Enable all gpus
if [[ -d /proc/driver/nvidia/gpus ]]; then
    if [[ ${INSTANCE_TYPE} != p2* ]] ; then
        # Only for cards with compute capabilities greater than 3.0
        nvidia-xconfig --enable-all-gpus --preserve-busid
    fi
fi

chown -R ${USERNAME}:${GROUPNAME} /home/${USERNAME}/Desktop

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/startup/80_warmup-matlab.sh">
#!/usr/bin/env bash
#
# Copyright 2023-2024 The MathWorks, Inc.

# Print commands for logging purposes, including timestamps.
PS4='+ [\d \t] '
set -x

if [[ -n ${MATLAB_ROOT} ]]; then
    "${MATLAB_ROOT}/bin/glnxa64/MATLABStartupAccelerator" 64 "${MATLAB_ROOT}" /usr/local/etc/msa/msa.ini /var/log/msa.log
    echo 'Warm up done.'
fi

touch "${MATLAB_ROOT}/toolbox/local/toolbox_cache-glnxa64.xml"

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/startup/40_setup-rdp.sh">
#!/usr/bin/env bash
#
# Copyright 2023-2024 The MathWorks, Inc.

# Print commands for logging purposes.
set -x

if [[ ${ACCESS_PROTOCOL} == RDP ]]; then
    systemctl enable xrdp
    systemctl start xrdp
fi

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/startup/10_setup-disks.sh">
#!/usr/bin/env bash
#
# Copyright 2023-2024 The MathWorks, Inc.

# Print commands for logging purposes, including timestamps.
PS4='+ [\d \t] '
set -x

# Make EBS volumes available (including NVMe instance store volumes)
# https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-using-volumes.html

FSTYPE=xfs

i=0
for DISK in $(lsblk -dpn -o NAME); do

    echo "${DISK}"
    # Find disks with no file system
    if [[ $(file -bs "${DISK}") == 'data' ]]; then

        echo "Create file system"
        mkfs -t ${FSTYPE} "${DISK}"
        partprobe "${DISK}"

        MOUNTPOINT=/data${i}
        i=$((i+1))
        echo "Mount at ${MOUNTPOINT}"
        mkdir -p ${MOUNTPOINT}
        mount "${DISK}" ${MOUNTPOINT}
        chmod 1777 ${MOUNTPOINT}

        echo "Mount after reboot"
        UUID=$(blkid -o value -s UUID "${DISK}")
        echo "UUID=${UUID} ${MOUNTPOINT} ${FSTYPE} defaults,nofail 0 2" >> /etc/fstab

    fi
done

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/release-config/R2024b.pkrvars.hcl">
# Copyright 2024 The MathWorks, Inc.

// Use this Packer configuration file to build AMI with R2024b MATLAB installed.
// For more information on these variables, see /packer/v1/build-matlab-ami.pkr.hcl.
// Source for NVIDIA CUDA toolkit: https://developer.nvidia.com/cuda-downloads?target_os=Linux&target_arch=x86_64&Distribution=Ubuntu&target_version=24.04&target_type=runfile_local

RELEASE       = "R2024b"
BASE_AMI_NAME = "ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*"
STARTUP_SCRIPTS = [
  ".env",
  "10_setup-disks.sh",
  "20_setup-machine.sh",
  "30_setup-logging.sh",
  "40_setup-rdp.sh",
  "50_setup-nicedcv.sh",
  "60_setup-matlab-proxy.sh",
  "70_setup-matlab.sh",
  "80_warmup-matlab.sh",
  "85_warmup-mathworks-service-host.sh",
  "99_run-optional-user-command.sh"
]
RUNTIME_SCRIPTS = [
  "swap-desktop-solution.sh",
  "launch-matlab-proxy.sh",
  "generate-certificate.py"
]
BUILD_SCRIPTS = [
  "install-startup-scripts.sh",
  "install-swap-desktop-solution.sh",
  "install-dependencies.sh",
  "install-matlab-proxy.sh",
  "install-matlab-dependencies-ubuntu.sh",
  "install-ubuntu-desktop.sh",
  "install-mate.sh",
  "install-matlab.sh",
  "install-support-packages.sh",
  "setup-startup-accelerator.sh",
  "install-fabric-manager-ubuntu.sh",
  "generate-toolbox-cache.sh",
  "cleanup.sh"
]
PRODUCTS                = "5G_Toolbox AUTOSAR_Blockset Aerospace_Blockset Aerospace_Toolbox Antenna_Toolbox Audio_Toolbox Automated_Driving_Toolbox Bioinformatics_Toolbox Bluetooth_Toolbox C2000_Microcontroller_Blockset Communications_Toolbox Computer_Vision_Toolbox Control_System_Toolbox Curve_Fitting_Toolbox DDS_Blockset DSP_HDL_Toolbox DSP_System_Toolbox Database_Toolbox Datafeed_Toolbox Deep_Learning_HDL_Toolbox Deep_Learning_Toolbox Econometrics_Toolbox Embedded_Coder Filter_Design_HDL_Coder Financial_Instruments_Toolbox Financial_Toolbox Fixed-Point_Designer Fuzzy_Logic_Toolbox GPU_Coder Global_Optimization_Toolbox HDL_Coder HDL_Verifier Image_Acquisition_Toolbox Image_Processing_Toolbox Industrial_Communication_Toolbox Instrument_Control_Toolbox LTE_Toolbox Lidar_Toolbox MATLAB MATLAB_Coder MATLAB_Compiler MATLAB_Compiler_SDK MATLAB_Report_Generator MATLAB_Test Mapping_Toolbox Medical_Imaging_Toolbox Mixed-Signal_Blockset Model_Predictive_Control_Toolbox Motor_Control_Blockset Navigation_Toolbox Optimization_Toolbox Parallel_Computing_Toolbox Partial_Differential_Equation_Toolbox Phased_Array_System_Toolbox Powertrain_Blockset Predictive_Maintenance_Toolbox RF_Blockset RF_PCB_Toolbox RF_Toolbox ROS_Toolbox Radar_Toolbox Reinforcement_Learning_Toolbox Requirements_Toolbox Risk_Management_Toolbox Robotics_System_Toolbox Robust_Control_Toolbox Satellite_Communications_Toolbox Sensor_Fusion_and_Tracking_Toolbox SerDes_Toolbox Signal_Integrity_Toolbox Signal_Processing_Toolbox SimBiology SimEvents Simscape Simscape_Battery Simscape_Driveline Simscape_Electrical Simscape_Fluids Simscape_Multibody Simulink Simulink_3D_Animation Simulink_Check Simulink_Coder Simulink_Compiler Simulink_Control_Design Simulink_Coverage Simulink_Design_Optimization Simulink_Design_Verifier Simulink_Desktop_Real-Time Simulink_Fault_Analyzer Simulink_PLC_Coder Simulink_Real-Time Simulink_Report_Generator Simulink_Test SoC_Blockset Stateflow Statistics_and_Machine_Learning_Toolbox Symbolic_Math_Toolbox System_Composer System_Identification_Toolbox Text_Analytics_Toolbox UAV_Toolbox Vehicle_Dynamics_Blockset Vehicle_Network_Toolbox Vision_HDL_Toolbox WLAN_Toolbox Wavelet_Toolbox Wireless_HDL_Toolbox Wireless_Testbench"
SPKGS                   = "Deep_Learning_Toolbox_Model_for_AlexNet_Network Deep_Learning_Toolbox_Model_for_EfficientNet-b0_Network Deep_Learning_Toolbox_Model_for_GoogLeNet_Network Deep_Learning_Toolbox_Model_for_ResNet-101_Network Deep_Learning_Toolbox_Model_for_ResNet-18_Network Deep_Learning_Toolbox_Model_for_ResNet-50_Network Deep_Learning_Toolbox_Model_for_Inception-ResNet-v2_Network Deep_Learning_Toolbox_Model_for_Inception-v3_Network Deep_Learning_Toolbox_Model_for_DenseNet-201_Network Deep_Learning_Toolbox_Model_for_Xception_Network Deep_Learning_Toolbox_Model_for_MobileNet-v2_Network Deep_Learning_Toolbox_Model_for_Places365-GoogLeNet_Network Deep_Learning_Toolbox_Model_for_NASNet-Large_Network Deep_Learning_Toolbox_Model_for_NASNet-Mobile_Network Deep_Learning_Toolbox_Model_for_ShuffleNet_Network Deep_Learning_Toolbox_Model_for_DarkNet-19_Network Deep_Learning_Toolbox_Model_for_DarkNet-53_Network Deep_Learning_Toolbox_Model_for_VGG-16_Network Deep_Learning_Toolbox_Model_for_VGG-19_Network"
NVIDIA_CUDA_TOOLKIT     = "https://developer.download.nvidia.com/compute/cuda/12.2.2/local_installers/cuda_12.2.2_535.104.05_linux.run"
NVIDIA_DRIVER_VERSION   = "535"
NVIDIA_CUDA_KEYRING_URL = "https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.0-1_all.deb"
DCV_INSTALLER_URL       = "https://d1uj6qtbmh3dt5.cloudfront.net/2023.0/Servers/nice-dcv-2023.0-15065-ubuntu2204-x86_64.tgz"

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/release-config/R2020a.pkrvars.hcl">
# Copyright 2023-2024 The MathWorks, Inc.

// Use this Packer configuration file to build AMI with R2020a MATLAB installed.
// For more information on these variables, see /packer/v1/build-matlab-ami.pkr.hcl.
RELEASE       = "R2020a"
BASE_AMI_NAME = "ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-*"
STARTUP_SCRIPTS = [
  ".env",
  "10_setup-disks.sh",
  "20_setup-machine.sh",
  "30_setup-logging.sh",
  "40_setup-rdp.sh",
  "50_setup-nicedcv.sh",
  "70_setup-matlab.sh",
  "99_run-optional-user-command.sh"
]
RUNTIME_SCRIPTS = [
  "swap-desktop-solution.sh"
]
BUILD_SCRIPTS = [
  "install-startup-scripts.sh",
  "install-swap-desktop-solution.sh",
  "install-dependencies.sh",
  "install-ubuntu-desktop.sh",
  "install-mate.sh",
  "install-matlab.sh",
  "install-support-packages.sh",
  "install-fabric-manager-ubuntu.sh",
  "cleanup.sh"
]
PRODUCTS                = "5G_Toolbox Antenna_Toolbox Aerospace_Blockset Mixed-Signal_Blockset Phased_Array_System_Toolbox AUTOSAR_Blockset Aerospace_Toolbox Audio_Toolbox Bioinformatics_Toolbox Curve_Fitting_Toolbox Communications_Toolbox MATLAB_Compiler Control_System_Toolbox Simulink_Coverage Database_Toolbox Datafeed_Toolbox Parallel_Computing_Toolbox Automated_Driving_Toolbox DSP_System_Toolbox Simulink_Design_Verifier Embedded_Coder HDL_Verifier Econometrics_Toolbox Filter_Design_HDL_Coder Financial_Toolbox Fuzzy_Logic_Toolbox GPU_Coder Global_Optimization_Toolbox HDL_Coder SoC_Blockset Image_Acquisition_Toolbox Instrument_Control_Toolbox System_Identification_Toolbox Image_Processing_Toolbox Financial_Instruments_Toolbox Simscape_Driveline Wireless_HDL_Toolbox LTE_Toolbox MATLAB_Coder Mapping_Toolbox MATLAB_Compiler_SDK MATLAB Model_Predictive_Control_Toolbox MATLAB_Report_Generator Simscape_Multibody Motor_Control_Blockset MATLAB_Web_App_Server Deep_Learning_Toolbox Navigation_Toolbox Optimization_Toolbox Partial_Differential_Equation_Toolbox Simulink_PLC_Coder Predictive_Maintenance_Toolbox Fixed-Point_Designer MATLAB_Production_Server Simscape_Electrical Powertrain_Blockset RF_Blockset Robust_Control_Toolbox RF_Toolbox Risk_Management_Toolbox Reinforcement_Learning_Toolbox Robotics_System_Toolbox Simulink_Requirements ROS_Toolbox Simulink_Coder SimBiology Simulink_Control_Design SimEvents Stateflow Signal_Processing_Toolbox Simscape_Fluids Simulink_Compiler Simulink Symbolic_Math_Toolbox Simulink_Design_Optimization Simulink_Report_Generator Simscape Statistics_and_Machine_Learning_Toolbox SerDes_Toolbox Simulink_Test Text_Analytics_Toolbox Sensor_Fusion_and_Tracking_Toolbox Trading_Toolbox Vehicle_Dynamics_Blockset Vehicle_Network_Toolbox Computer_Vision_Toolbox Simulink_3D_Animation Vision_HDL_Toolbox Simulink_Check Wavelet_Toolbox WLAN_Toolbox System_Composer"
SPKGS                   = "Deep_Learning_Toolbox_Model_for_AlexNet_Network Deep_Learning_Toolbox_Model_for_GoogLeNet_Network Deep_Learning_Toolbox_Model_for_ResNet-101_Network Deep_Learning_Toolbox_Model_for_ResNet-18_Network Deep_Learning_Toolbox_Model_for_ResNet-50_Network Deep_Learning_Toolbox_Model_for_Inception-ResNet-v2_Network Deep_Learning_Toolbox_Model_for_Inception-v3_Network Deep_Learning_Toolbox_Model_for_DenseNet-201_Network Deep_Learning_Toolbox_Model_for_Xception_Network Deep_Learning_Toolbox_Model_for_MobileNet-v2_Network Deep_Learning_Toolbox_Model_for_Places365-GoogLeNet_Network Deep_Learning_Toolbox_Model_for_NASNet-Large_Network Deep_Learning_Toolbox_Model_for_NASNet-Mobile_Network Deep_Learning_Toolbox_Model_for_ShuffleNet_Network Deep_Learning_Toolbox_Model_for_DarkNet-19_Network Deep_Learning_Toolbox_Model_for_DarkNet-53_Network Deep_Learning_Toolbox_Model_for_VGG-16_Network Deep_Learning_Toolbox_Model_for_VGG-19_Network"
NVIDIA_CUDA_TOOLKIT     = ""
NVIDIA_DRIVER_VERSION   = ""
NVIDIA_CUDA_KEYRING_URL = "https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-keyring_1.0-1_all.deb"
DCV_INSTALLER_URL       = "https://d1uj6qtbmh3dt5.cloudfront.net/2022.2/Servers/nice-dcv-2022.2-13907-ubuntu2004-x86_64.tgz"

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/release-config/R2022b.pkrvars.hcl">
# Copyright 2023-2024 The MathWorks, Inc.

// Use this Packer configuration file to build AMI with R2022b MATLAB installed.
// For more information on these variables, see /packer/v1/build-matlab-ami.pkr.hcl.
RELEASE       = "R2022b"
BASE_AMI_NAME = "ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*"
STARTUP_SCRIPTS = [
  ".env",
  "10_setup-disks.sh",
  "20_setup-machine.sh",
  "30_setup-logging.sh",
  "40_setup-rdp.sh",
  "50_setup-nicedcv.sh",
  "60_setup-matlab-proxy.sh",
  "70_setup-matlab.sh",
  "80_warmup-matlab.sh",
  "99_run-optional-user-command.sh"
]
RUNTIME_SCRIPTS = [
  "swap-desktop-solution.sh",
  "launch-matlab-proxy.sh",
  "generate-certificate.py"
]
BUILD_SCRIPTS = [
  "install-startup-scripts.sh",
  "install-swap-desktop-solution.sh",
  "install-dependencies.sh",
  "install-matlab-proxy.sh",
  "install-matlab-dependencies-ubuntu.sh",
  "install-ubuntu-desktop.sh",
  "install-mate.sh",
  "install-matlab.sh",
  "install-support-packages.sh",
  "setup-startup-accelerator.sh",
  "install-fabric-manager-ubuntu.sh",
  "generate-toolbox-cache.sh",
  "cleanup.sh"
]
PRODUCTS                = "5G_Toolbox Antenna_Toolbox Aerospace_Blockset Mixed-Signal_Blockset Phased_Array_System_Toolbox AUTOSAR_Blockset Aerospace_Toolbox Audio_Toolbox Bioinformatics_Toolbox Bluetooth_Toolbox Simscape_Battery Curve_Fitting_Toolbox Communications_Toolbox MATLAB_Compiler Control_System_Toolbox Simulink_Coverage Database_Toolbox DDS_Blockset Datafeed_Toolbox Deep_Learning_HDL_Toolbox Parallel_Computing_Toolbox Automated_Driving_Toolbox DSP_System_Toolbox Simulink_Design_Verifier Medical_Imaging_Toolbox Embedded_Coder HDL_Verifier Econometrics_Toolbox Filter_Design_HDL_Coder Financial_Toolbox Fuzzy_Logic_Toolbox GPU_Coder Global_Optimization_Toolbox HDL_Coder DSP_HDL_Toolbox SoC_Blockset Image_Acquisition_Toolbox Instrument_Control_Toolbox System_Identification_Toolbox Image_Processing_Toolbox Financial_Instruments_Toolbox Simscape_Driveline Wireless_HDL_Toolbox Lidar_Toolbox LTE_Toolbox MATLAB_Coder Mapping_Toolbox MATLAB_Compiler_SDK MATLAB Model_Predictive_Control_Toolbox MATLAB_Report_Generator Simscape_Multibody Motor_Control_Blockset MATLAB_Web_App_Server Deep_Learning_Toolbox Navigation_Toolbox Optimization_Toolbox Industrial_Communication_Toolbox Partial_Differential_Equation_Toolbox Simulink_PLC_Coder Predictive_Maintenance_Toolbox Fixed-Point_Designer MATLAB_Production_Server Simscape_Electrical Powertrain_Blockset Radar_Toolbox RF_Blockset Robust_Control_Toolbox RF_Toolbox Risk_Management_Toolbox Reinforcement_Learning_Toolbox Robotics_System_Toolbox RF_PCB_Toolbox Requirements_Toolbox ROS_Toolbox Simulink_Coder SimBiology Simulink_Control_Design SimEvents Stateflow Signal_Processing_Toolbox Simscape_Fluids Satellite_Communications_Toolbox Simulink_Compiler Simulink Symbolic_Math_Toolbox Simulink_Design_Optimization Signal_Integrity_Toolbox Simulink_Report_Generator Simscape Statistics_and_Machine_Learning_Toolbox SerDes_Toolbox Simulink_Test Text_Analytics_Toolbox Sensor_Fusion_and_Tracking_Toolbox UAV_Toolbox Vehicle_Dynamics_Blockset Vehicle_Network_Toolbox Computer_Vision_Toolbox Simulink_3D_Animation Vision_HDL_Toolbox Simulink_Check Wavelet_Toolbox Wireless_Testbench WLAN_Toolbox Simulink_Real-Time System_Composer"
SPKGS                   = "Deep_Learning_Toolbox_Model_for_AlexNet_Network Deep_Learning_Toolbox_Model_for_EfficientNet-b0_Network Deep_Learning_Toolbox_Model_for_GoogLeNet_Network Deep_Learning_Toolbox_Model_for_ResNet-101_Network Deep_Learning_Toolbox_Model_for_ResNet-18_Network Deep_Learning_Toolbox_Model_for_ResNet-50_Network Deep_Learning_Toolbox_Model_for_Inception-ResNet-v2_Network Deep_Learning_Toolbox_Model_for_Inception-v3_Network Deep_Learning_Toolbox_Model_for_DenseNet-201_Network Deep_Learning_Toolbox_Model_for_Xception_Network Deep_Learning_Toolbox_Model_for_MobileNet-v2_Network Deep_Learning_Toolbox_Model_for_Places365-GoogLeNet_Network Deep_Learning_Toolbox_Model_for_NASNet-Large_Network Deep_Learning_Toolbox_Model_for_NASNet-Mobile_Network Deep_Learning_Toolbox_Model_for_ShuffleNet_Network Deep_Learning_Toolbox_Model_for_DarkNet-19_Network Deep_Learning_Toolbox_Model_for_DarkNet-53_Network Deep_Learning_Toolbox_Model_for_VGG-16_Network Deep_Learning_Toolbox_Model_for_VGG-19_Network"
NVIDIA_CUDA_TOOLKIT     = "https://developer.download.nvidia.com/compute/cuda/12.2.2/local_installers/cuda_12.2.2_535.104.05_linux.run"
NVIDIA_DRIVER_VERSION   = "535"
NVIDIA_CUDA_KEYRING_URL = "https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.0-1_all.deb"
DCV_INSTALLER_URL       = "https://d1uj6qtbmh3dt5.cloudfront.net/2023.0/Servers/nice-dcv-2023.0-15065-ubuntu2204-x86_64.tgz"
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/release-config/R2024a.pkrvars.hcl">
# Copyright 2023-2024 The MathWorks, Inc.

// Use this Packer configuration file to build AMI with R2024a MATLAB installed.
// For more information on these variables, see /packer/v1/build-matlab-ami.pkr.hcl.
RELEASE       = "R2024a"
BASE_AMI_NAME = "ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*"
STARTUP_SCRIPTS = [
  ".env",
  "10_setup-disks.sh",
  "20_setup-machine.sh",
  "30_setup-logging.sh",
  "40_setup-rdp.sh",
  "50_setup-nicedcv.sh",
  "60_setup-matlab-proxy.sh",
  "70_setup-matlab.sh",
  "80_warmup-matlab.sh",
  "85_warmup-mathworks-service-host.sh",
  "99_run-optional-user-command.sh"
]
RUNTIME_SCRIPTS = [
  "swap-desktop-solution.sh",
  "launch-matlab-proxy.sh",
  "generate-certificate.py"
]
BUILD_SCRIPTS = [
  "install-startup-scripts.sh",
  "install-swap-desktop-solution.sh",
  "install-dependencies.sh",
  "install-matlab-proxy.sh",
  "install-matlab-dependencies-ubuntu.sh",
  "install-ubuntu-desktop.sh",
  "install-mate.sh",
  "install-matlab.sh",
  "install-support-packages.sh",
  "setup-startup-accelerator.sh",
  "install-fabric-manager-ubuntu.sh",
  "generate-toolbox-cache.sh",
  "cleanup.sh"
]
PRODUCTS                = "5G_Toolbox AUTOSAR_Blockset Aerospace_Blockset Aerospace_Toolbox Antenna_Toolbox Audio_Toolbox Automated_Driving_Toolbox Bioinformatics_Toolbox Bluetooth_Toolbox C2000_Microcontroller_Blockset Communications_Toolbox Computer_Vision_Toolbox Control_System_Toolbox Curve_Fitting_Toolbox DDS_Blockset DSP_HDL_Toolbox DSP_System_Toolbox Database_Toolbox Datafeed_Toolbox Deep_Learning_HDL_Toolbox Deep_Learning_Toolbox Econometrics_Toolbox Embedded_Coder Filter_Design_HDL_Coder Financial_Instruments_Toolbox Financial_Toolbox Fixed-Point_Designer Fuzzy_Logic_Toolbox GPU_Coder Global_Optimization_Toolbox HDL_Coder HDL_Verifier Image_Acquisition_Toolbox Image_Processing_Toolbox Industrial_Communication_Toolbox Instrument_Control_Toolbox LTE_Toolbox Lidar_Toolbox MATLAB MATLAB_Coder MATLAB_Compiler MATLAB_Compiler_SDK MATLAB_Production_Server MATLAB_Report_Generator MATLAB_Test MATLAB_Web_App_Server Mapping_Toolbox Medical_Imaging_Toolbox Mixed-Signal_Blockset Model_Predictive_Control_Toolbox Motor_Control_Blockset Navigation_Toolbox Optimization_Toolbox Parallel_Computing_Toolbox Partial_Differential_Equation_Toolbox Phased_Array_System_Toolbox Powertrain_Blockset Predictive_Maintenance_Toolbox RF_Blockset RF_PCB_Toolbox RF_Toolbox ROS_Toolbox Radar_Toolbox Reinforcement_Learning_Toolbox Requirements_Toolbox Risk_Management_Toolbox Robotics_System_Toolbox Robust_Control_Toolbox Satellite_Communications_Toolbox Sensor_Fusion_and_Tracking_Toolbox SerDes_Toolbox Signal_Integrity_Toolbox Signal_Processing_Toolbox SimBiology SimEvents Simscape Simscape_Battery Simscape_Driveline Simscape_Electrical Simscape_Fluids Simscape_Multibody Simulink Simulink_3D_Animation Simulink_Check Simulink_Coder Simulink_Compiler Simulink_Control_Design Simulink_Coverage Simulink_Design_Optimization Simulink_Design_Verifier Simulink_Desktop_Real-Time Simulink_Fault_Analyzer Simulink_PLC_Coder Simulink_Real-Time Simulink_Report_Generator Simulink_Test SoC_Blockset Stateflow Statistics_and_Machine_Learning_Toolbox Symbolic_Math_Toolbox System_Composer System_Identification_Toolbox Text_Analytics_Toolbox UAV_Toolbox Vehicle_Dynamics_Blockset Vehicle_Network_Toolbox Vision_HDL_Toolbox WLAN_Toolbox Wavelet_Toolbox Wireless_HDL_Toolbox Wireless_Testbench"
SPKGS                   = "Deep_Learning_Toolbox_Model_for_AlexNet_Network Deep_Learning_Toolbox_Model_for_EfficientNet-b0_Network Deep_Learning_Toolbox_Model_for_GoogLeNet_Network Deep_Learning_Toolbox_Model_for_ResNet-101_Network Deep_Learning_Toolbox_Model_for_ResNet-18_Network Deep_Learning_Toolbox_Model_for_ResNet-50_Network Deep_Learning_Toolbox_Model_for_Inception-ResNet-v2_Network Deep_Learning_Toolbox_Model_for_Inception-v3_Network Deep_Learning_Toolbox_Model_for_DenseNet-201_Network Deep_Learning_Toolbox_Model_for_Xception_Network Deep_Learning_Toolbox_Model_for_MobileNet-v2_Network Deep_Learning_Toolbox_Model_for_Places365-GoogLeNet_Network Deep_Learning_Toolbox_Model_for_NASNet-Large_Network Deep_Learning_Toolbox_Model_for_NASNet-Mobile_Network Deep_Learning_Toolbox_Model_for_ShuffleNet_Network Deep_Learning_Toolbox_Model_for_DarkNet-19_Network Deep_Learning_Toolbox_Model_for_DarkNet-53_Network Deep_Learning_Toolbox_Model_for_VGG-16_Network Deep_Learning_Toolbox_Model_for_VGG-19_Network"
NVIDIA_CUDA_TOOLKIT     = "https://developer.download.nvidia.com/compute/cuda/12.2.2/local_installers/cuda_12.2.2_535.104.05_linux.run"
NVIDIA_DRIVER_VERSION   = "535"
NVIDIA_CUDA_KEYRING_URL = "https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.0-1_all.deb"
DCV_INSTALLER_URL       = "https://d1uj6qtbmh3dt5.cloudfront.net/2023.0/Servers/nice-dcv-2023.0-15065-ubuntu2204-x86_64.tgz"

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/release-config/R2021b.pkrvars.hcl">
# Copyright 2023-2024 The MathWorks, Inc.

// Use this Packer configuration file to build AMI with R2021b MATLAB installed.
// For more information on these variables, see /packer/v1/build-matlab-ami.pkr.hcl.
RELEASE       = "R2021b"
BASE_AMI_NAME = "ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-*"
STARTUP_SCRIPTS = [
  ".env",
  "10_setup-disks.sh",
  "20_setup-machine.sh",
  "30_setup-logging.sh",
  "40_setup-rdp.sh",
  "50_setup-nicedcv.sh",
  "70_setup-matlab.sh",
  "80_warmup-matlab-pre-R2022a.sh",
  "99_run-optional-user-command.sh"
]
RUNTIME_SCRIPTS = [
  "swap-desktop-solution.sh"
]
BUILD_SCRIPTS = [
  "install-startup-scripts.sh",
  "install-swap-desktop-solution.sh",
  "install-dependencies.sh",
  "install-matlab-dependencies-ubuntu.sh",
  "install-ubuntu-desktop.sh",
  "install-mate.sh",
  "install-matlab.sh",
  "install-support-packages.sh",
  "setup-startup-accelerator.sh",
  "install-glibc-ubuntu2004.sh",
  "install-fabric-manager-ubuntu.sh",
  "generate-toolbox-cache.sh",
  "cleanup.sh"
]
PRODUCTS                = "5G_Toolbox Antenna_Toolbox Aerospace_Blockset Mixed-Signal_Blockset Phased_Array_System_Toolbox AUTOSAR_Blockset Aerospace_Toolbox Audio_Toolbox Bioinformatics_Toolbox Curve_Fitting_Toolbox Communications_Toolbox MATLAB_Compiler Control_System_Toolbox Simulink_Coverage Database_Toolbox DDS_Blockset Datafeed_Toolbox Deep_Learning_HDL_Toolbox Parallel_Computing_Toolbox Automated_Driving_Toolbox DSP_System_Toolbox Simulink_Design_Verifier Embedded_Coder HDL_Verifier Econometrics_Toolbox Filter_Design_HDL_Coder Financial_Toolbox Fuzzy_Logic_Toolbox GPU_Coder Global_Optimization_Toolbox HDL_Coder SoC_Blockset Image_Acquisition_Toolbox Instrument_Control_Toolbox System_Identification_Toolbox Image_Processing_Toolbox Financial_Instruments_Toolbox Simscape_Driveline Wireless_HDL_Toolbox Lidar_Toolbox LTE_Toolbox MATLAB_Coder Mapping_Toolbox MATLAB_Compiler_SDK MATLAB Model_Predictive_Control_Toolbox MATLAB_Report_Generator Simscape_Multibody Motor_Control_Blockset MATLAB_Web_App_Server Deep_Learning_Toolbox Navigation_Toolbox Optimization_Toolbox Partial_Differential_Equation_Toolbox Simulink_PLC_Coder Predictive_Maintenance_Toolbox Fixed-Point_Designer MATLAB_Production_Server Simscape_Electrical Powertrain_Blockset Radar_Toolbox RF_Blockset Robust_Control_Toolbox RF_Toolbox Risk_Management_Toolbox Reinforcement_Learning_Toolbox Robotics_System_Toolbox RF_PCB_Toolbox Simulink_Requirements ROS_Toolbox Simulink_Coder SimBiology Simulink_Control_Design SimEvents Stateflow Signal_Processing_Toolbox Simscape_Fluids Satellite_Communications_Toolbox Simulink_Compiler Simulink Symbolic_Math_Toolbox Simulink_Design_Optimization Signal_Integrity_Toolbox Simulink_Report_Generator Simscape Statistics_and_Machine_Learning_Toolbox SerDes_Toolbox Simulink_Test Text_Analytics_Toolbox Sensor_Fusion_and_Tracking_Toolbox UAV_Toolbox Vehicle_Dynamics_Blockset Vehicle_Network_Toolbox Computer_Vision_Toolbox Simulink_3D_Animation Vision_HDL_Toolbox Simulink_Check Wavelet_Toolbox WLAN_Toolbox System_Composer "
SPKGS                   = "Deep_Learning_Toolbox_Model_for_AlexNet_Network Deep_Learning_Toolbox_Model_for_EfficientNet-b0_Network Deep_Learning_Toolbox_Model_for_GoogLeNet_Network Deep_Learning_Toolbox_Model_for_ResNet-101_Network Deep_Learning_Toolbox_Model_for_ResNet-18_Network Deep_Learning_Toolbox_Model_for_ResNet-50_Network Deep_Learning_Toolbox_Model_for_Inception-ResNet-v2_Network Deep_Learning_Toolbox_Model_for_Inception-v3_Network Deep_Learning_Toolbox_Model_for_DenseNet-201_Network Deep_Learning_Toolbox_Model_for_Xception_Network Deep_Learning_Toolbox_Model_for_MobileNet-v2_Network Deep_Learning_Toolbox_Model_for_Places365-GoogLeNet_Network Deep_Learning_Toolbox_Model_for_NASNet-Large_Network Deep_Learning_Toolbox_Model_for_NASNet-Mobile_Network Deep_Learning_Toolbox_Model_for_ShuffleNet_Network Deep_Learning_Toolbox_Model_for_DarkNet-19_Network Deep_Learning_Toolbox_Model_for_DarkNet-53_Network Deep_Learning_Toolbox_Model_for_VGG-16_Network Deep_Learning_Toolbox_Model_for_VGG-19_Network"
NVIDIA_CUDA_TOOLKIT     = ""
NVIDIA_DRIVER_VERSION   = ""
NVIDIA_CUDA_KEYRING_URL = "https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-keyring_1.0-1_all.deb"
DCV_INSTALLER_URL       = "https://d1uj6qtbmh3dt5.cloudfront.net/2022.2/Servers/nice-dcv-2022.2-13907-ubuntu2004-x86_64.tgz"

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/release-config/R2023a.pkrvars.hcl">
# Copyright 2023-2024 The MathWorks, Inc.

// Use this Packer configuration file to build AMI with R2023a MATLAB installed.
// For more information on these variables, see /packer/v1/build-matlab-ami.pkr.hcl.
RELEASE       = "R2023a"
BASE_AMI_NAME = "ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*"
STARTUP_SCRIPTS = [
  ".env",
  "10_setup-disks.sh",
  "20_setup-machine.sh",
  "30_setup-logging.sh",
  "40_setup-rdp.sh",
  "50_setup-nicedcv.sh",
  "60_setup-matlab-proxy.sh",
  "70_setup-matlab.sh",
  "80_warmup-matlab.sh",
  "85_warmup-mathworks-service-host.sh",
  "99_run-optional-user-command.sh"
]
RUNTIME_SCRIPTS = [
  "swap-desktop-solution.sh",
  "launch-matlab-proxy.sh",
  "generate-certificate.py"
]
BUILD_SCRIPTS = [
  "install-startup-scripts.sh",
  "install-swap-desktop-solution.sh",
  "install-dependencies.sh",
  "install-matlab-proxy.sh",
  "install-matlab-dependencies-ubuntu.sh",
  "install-ubuntu-desktop.sh",
  "install-mate.sh",
  "install-matlab.sh",
  "install-support-packages.sh",
  "setup-startup-accelerator.sh",
  "install-fabric-manager-ubuntu.sh",
  "generate-toolbox-cache.sh",
  "cleanup.sh"
]
PRODUCTS                = "5G_Toolbox Antenna_Toolbox Aerospace_Blockset Mixed-Signal_Blockset Phased_Array_System_Toolbox AUTOSAR_Blockset Aerospace_Toolbox Audio_Toolbox Bioinformatics_Toolbox Bluetooth_Toolbox Simscape_Battery C2000_Microcontroller_Blockset Curve_Fitting_Toolbox Communications_Toolbox MATLAB_Compiler Control_System_Toolbox Simulink_Coverage Database_Toolbox DDS_Blockset Datafeed_Toolbox Deep_Learning_HDL_Toolbox Parallel_Computing_Toolbox Automated_Driving_Toolbox DSP_System_Toolbox Simulink_Design_Verifier Medical_Imaging_Toolbox Embedded_Coder HDL_Verifier Econometrics_Toolbox Filter_Design_HDL_Coder Financial_Toolbox Fuzzy_Logic_Toolbox GPU_Coder Global_Optimization_Toolbox HDL_Coder DSP_HDL_Toolbox SoC_Blockset Image_Acquisition_Toolbox Instrument_Control_Toolbox System_Identification_Toolbox Image_Processing_Toolbox Financial_Instruments_Toolbox Simscape_Driveline Wireless_HDL_Toolbox Lidar_Toolbox LTE_Toolbox MATLAB_Coder Mapping_Toolbox MATLAB_Compiler_SDK MATLAB Model_Predictive_Control_Toolbox MATLAB_Report_Generator Simscape_Multibody Motor_Control_Blockset MATLAB_Web_App_Server Deep_Learning_Toolbox Navigation_Toolbox Optimization_Toolbox Industrial_Communication_Toolbox Partial_Differential_Equation_Toolbox Simulink_PLC_Coder Predictive_Maintenance_Toolbox Fixed-Point_Designer MATLAB_Production_Server Simscape_Electrical Powertrain_Blockset Radar_Toolbox RF_Blockset Robust_Control_Toolbox RF_Toolbox Risk_Management_Toolbox Reinforcement_Learning_Toolbox Robotics_System_Toolbox RF_PCB_Toolbox Requirements_Toolbox ROS_Toolbox Simulink_Coder SimBiology Simulink_Control_Design SimEvents Stateflow Signal_Processing_Toolbox Simscape_Fluids Satellite_Communications_Toolbox Simulink_Compiler Simulink Symbolic_Math_Toolbox Simulink_Design_Optimization Signal_Integrity_Toolbox Simulink_Report_Generator Simscape Statistics_and_Machine_Learning_Toolbox SerDes_Toolbox Simulink_Test Text_Analytics_Toolbox MATLAB_Test Sensor_Fusion_and_Tracking_Toolbox UAV_Toolbox Vehicle_Dynamics_Blockset Vehicle_Network_Toolbox Computer_Vision_Toolbox Simulink_3D_Animation Vision_HDL_Toolbox Simulink_Check Wavelet_Toolbox Wireless_Testbench WLAN_Toolbox Simulink_Real-Time System_Composer"
SPKGS                   = "Deep_Learning_Toolbox_Model_for_AlexNet_Network Deep_Learning_Toolbox_Model_for_EfficientNet-b0_Network Deep_Learning_Toolbox_Model_for_GoogLeNet_Network Deep_Learning_Toolbox_Model_for_ResNet-101_Network Deep_Learning_Toolbox_Model_for_ResNet-18_Network Deep_Learning_Toolbox_Model_for_ResNet-50_Network Deep_Learning_Toolbox_Model_for_Inception-ResNet-v2_Network Deep_Learning_Toolbox_Model_for_Inception-v3_Network Deep_Learning_Toolbox_Model_for_DenseNet-201_Network Deep_Learning_Toolbox_Model_for_Xception_Network Deep_Learning_Toolbox_Model_for_MobileNet-v2_Network Deep_Learning_Toolbox_Model_for_Places365-GoogLeNet_Network Deep_Learning_Toolbox_Model_for_NASNet-Large_Network Deep_Learning_Toolbox_Model_for_NASNet-Mobile_Network Deep_Learning_Toolbox_Model_for_ShuffleNet_Network Deep_Learning_Toolbox_Model_for_DarkNet-19_Network Deep_Learning_Toolbox_Model_for_DarkNet-53_Network Deep_Learning_Toolbox_Model_for_VGG-16_Network Deep_Learning_Toolbox_Model_for_VGG-19_Network"
NVIDIA_CUDA_TOOLKIT     = "https://developer.download.nvidia.com/compute/cuda/12.2.2/local_installers/cuda_12.2.2_535.104.05_linux.run"
NVIDIA_DRIVER_VERSION   = "535"
NVIDIA_CUDA_KEYRING_URL = "https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.0-1_all.deb"
DCV_INSTALLER_URL       = "https://d1uj6qtbmh3dt5.cloudfront.net/2023.0/Servers/nice-dcv-2023.0-15065-ubuntu2204-x86_64.tgz"

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/release-config/R2025a.pkrvars.hcl">
# Copyright 2025 The MathWorks, Inc.

// Use this Packer configuration file to build AMI with R2025a MATLAB installed.
// For more information on these variables, see /packer/v1/build-matlab-ami.pkr.hcl.
// Source for NVIDIA CUDA toolkit: https://developer.nvidia.com/cuda-downloads?target_os=Linux&target_arch=x86_64&Distribution=Ubuntu&target_version=24.04&target_type=runfile_local

RELEASE       = "R2025a"
BASE_AMI_NAME = "ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*"
STARTUP_SCRIPTS = [
  ".env",
  "10_setup-disks.sh",
  "20_setup-machine.sh",
  "30_setup-logging.sh",
  "40_setup-rdp.sh",
  "50_setup-nicedcv.sh",
  "60_setup-matlab-proxy.sh",
  "70_setup-matlab.sh",
  "80_warmup-matlab.sh",
  "85_warmup-mathworks-service-host.sh",
  "99_run-optional-user-command.sh"
]
RUNTIME_SCRIPTS = [
  "swap-desktop-solution.sh",
  "launch-matlab-proxy.sh",
  "generate-certificate.py"
]
BUILD_SCRIPTS = [
  "install-startup-scripts.sh",
  "install-swap-desktop-solution.sh",
  "install-dependencies.sh",
  "install-matlab-proxy.sh",
  "install-matlab-dependencies-ubuntu.sh",
  "install-ubuntu-desktop.sh",
  "install-mate.sh",
  "install-matlab.sh",
  "install-support-packages.sh",
  "setup-startup-accelerator.sh",
  "install-fabric-manager-ubuntu.sh",
  "generate-toolbox-cache.sh",
  "cleanup.sh"
]
PRODUCTS                = "5G_Toolbox AUTOSAR_Blockset Aerospace_Blockset Aerospace_Toolbox Antenna_Toolbox Audio_Toolbox Automated_Driving_Toolbox Bioinformatics_Toolbox Bluetooth_Toolbox C2000_Microcontroller_Blockset Communications_Toolbox Computer_Vision_Toolbox Control_System_Toolbox Curve_Fitting_Toolbox DDS_Blockset DSP_HDL_Toolbox DSP_System_Toolbox Database_Toolbox Datafeed_Toolbox Deep_Learning_HDL_Toolbox Deep_Learning_Toolbox Econometrics_Toolbox Embedded_Coder Financial_Instruments_Toolbox Financial_Toolbox Fixed-Point_Designer Fuzzy_Logic_Toolbox GPU_Coder Global_Optimization_Toolbox HDL_Coder HDL_Verifier Image_Acquisition_Toolbox Image_Processing_Toolbox Industrial_Communication_Toolbox Instrument_Control_Toolbox LTE_Toolbox Lidar_Toolbox MATLAB MATLAB_Coder MATLAB_Compiler MATLAB_Compiler_SDK MATLAB_Report_Generator MATLAB_Test Mapping_Toolbox Medical_Imaging_Toolbox Mixed-Signal_Blockset Model_Predictive_Control_Toolbox Motor_Control_Blockset Navigation_Toolbox Optimization_Toolbox Parallel_Computing_Toolbox Partial_Differential_Equation_Toolbox Phased_Array_System_Toolbox Powertrain_Blockset Predictive_Maintenance_Toolbox RF_Blockset RF_PCB_Toolbox RF_Toolbox ROS_Toolbox Radar_Toolbox Reinforcement_Learning_Toolbox Requirements_Toolbox Risk_Management_Toolbox Robotics_System_Toolbox Robust_Control_Toolbox Satellite_Communications_Toolbox Sensor_Fusion_and_Tracking_Toolbox SerDes_Toolbox Signal_Integrity_Toolbox Signal_Processing_Toolbox SimBiology SimEvents Simscape Simscape_Battery Simscape_Driveline Simscape_Electrical Simscape_Fluids Simscape_Multibody Simulink Simulink_3D_Animation Simulink_Check Simulink_Coder Simulink_Compiler Simulink_Control_Design Simulink_Coverage Simulink_Design_Optimization Simulink_Design_Verifier Simulink_Desktop_Real-Time Simulink_Fault_Analyzer Simulink_PLC_Coder Simulink_Real-Time Simulink_Report_Generator Simulink_Test SoC_Blockset Stateflow Statistics_and_Machine_Learning_Toolbox Symbolic_Math_Toolbox System_Composer System_Identification_Toolbox Text_Analytics_Toolbox UAV_Toolbox Vehicle_Dynamics_Blockset Vehicle_Network_Toolbox Vision_HDL_Toolbox WLAN_Toolbox Wavelet_Toolbox Wireless_HDL_Toolbox Wireless_Testbench"
SPKGS                   = "Deep_Learning_Toolbox_Model_for_AlexNet_Network Deep_Learning_Toolbox_Model_for_EfficientNet-b0_Network Deep_Learning_Toolbox_Model_for_GoogLeNet_Network Deep_Learning_Toolbox_Model_for_ResNet-101_Network Deep_Learning_Toolbox_Model_for_ResNet-18_Network Deep_Learning_Toolbox_Model_for_ResNet-50_Network Deep_Learning_Toolbox_Model_for_Inception-ResNet-v2_Network Deep_Learning_Toolbox_Model_for_Inception-v3_Network Deep_Learning_Toolbox_Model_for_DenseNet-201_Network Deep_Learning_Toolbox_Model_for_Xception_Network Deep_Learning_Toolbox_Model_for_MobileNet-v2_Network Deep_Learning_Toolbox_Model_for_Places365-GoogLeNet_Network Deep_Learning_Toolbox_Model_for_NASNet-Large_Network Deep_Learning_Toolbox_Model_for_NASNet-Mobile_Network Deep_Learning_Toolbox_Model_for_ShuffleNet_Network Deep_Learning_Toolbox_Model_for_DarkNet-19_Network Deep_Learning_Toolbox_Model_for_DarkNet-53_Network Deep_Learning_Toolbox_Model_for_VGG-16_Network Deep_Learning_Toolbox_Model_for_VGG-19_Network"
NVIDIA_CUDA_TOOLKIT     = "https://developer.download.nvidia.com/compute/cuda/12.2.2/local_installers/cuda_12.2.2_535.104.05_linux.run"
NVIDIA_DRIVER_VERSION   = "535"
NVIDIA_CUDA_KEYRING_URL = "https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.0-1_all.deb"
DCV_INSTALLER_URL       = "https://d1uj6qtbmh3dt5.cloudfront.net/2024.0/Servers/nice-dcv-2024.0-19030-ubuntu2204-x86_64.tgz"

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/release-config/R2022a.pkrvars.hcl">
# Copyright 2023-2024 The MathWorks, Inc.

// Use this Packer configuration file to build AMI with R2022a MATLAB installed.
// For more information on these variables, see /packer/v1/build-matlab-ami.pkr.hcl.
RELEASE       = "R2022a"
BASE_AMI_NAME = "ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-*"
STARTUP_SCRIPTS = [
  ".env",
  "10_setup-disks.sh",
  "20_setup-machine.sh",
  "30_setup-logging.sh",
  "40_setup-rdp.sh",
  "50_setup-nicedcv.sh",
  "70_setup-matlab.sh",
  "80_warmup-matlab.sh",
  "99_run-optional-user-command.sh"
]

RUNTIME_SCRIPTS = [
  "swap-desktop-solution.sh"
]
BUILD_SCRIPTS = [
  "install-startup-scripts.sh",
  "install-swap-desktop-solution.sh",
  "install-dependencies.sh",
  "install-matlab-dependencies-ubuntu.sh",
  "install-ubuntu-desktop.sh",
  "install-mate.sh",
  "install-matlab.sh",
  "install-support-packages.sh",
  "install-glibc-ubuntu2004.sh",
  "setup-startup-accelerator.sh",
  "install-fabric-manager-ubuntu.sh",
  "generate-toolbox-cache.sh",
  "cleanup.sh"
]
PRODUCTS                = "5G_Toolbox Antenna_Toolbox Aerospace_Blockset Mixed-Signal_Blockset Phased_Array_System_Toolbox AUTOSAR_Blockset Aerospace_Toolbox Audio_Toolbox Bioinformatics_Toolbox Bluetooth_Toolbox Curve_Fitting_Toolbox Communications_Toolbox MATLAB_Compiler Control_System_Toolbox Simulink_Coverage Database_Toolbox DDS_Blockset Datafeed_Toolbox Deep_Learning_HDL_Toolbox Parallel_Computing_Toolbox Automated_Driving_Toolbox DSP_System_Toolbox Simulink_Design_Verifier Embedded_Coder HDL_Verifier Econometrics_Toolbox Filter_Design_HDL_Coder Financial_Toolbox Fuzzy_Logic_Toolbox GPU_Coder Global_Optimization_Toolbox HDL_Coder DSP_HDL_Toolbox SoC_Blockset Image_Acquisition_Toolbox Instrument_Control_Toolbox System_Identification_Toolbox Image_Processing_Toolbox Financial_Instruments_Toolbox Simscape_Driveline Wireless_HDL_Toolbox Lidar_Toolbox LTE_Toolbox MATLAB_Coder Mapping_Toolbox MATLAB_Compiler_SDK MATLAB Model_Predictive_Control_Toolbox MATLAB_Report_Generator Simscape_Multibody Motor_Control_Blockset MATLAB_Web_App_Server Deep_Learning_Toolbox Navigation_Toolbox Optimization_Toolbox Industrial_Communication_Toolbox Partial_Differential_Equation_Toolbox Simulink_PLC_Coder Predictive_Maintenance_Toolbox Fixed-Point_Designer MATLAB_Production_Server Simscape_Electrical Powertrain_Blockset Radar_Toolbox RF_Blockset Robust_Control_Toolbox RF_Toolbox Risk_Management_Toolbox Reinforcement_Learning_Toolbox Robotics_System_Toolbox RF_PCB_Toolbox Requirements_Toolbox ROS_Toolbox Simulink_Coder SimBiology Simulink_Control_Design SimEvents Stateflow Signal_Processing_Toolbox Simscape_Fluids Satellite_Communications_Toolbox Simulink_Compiler Simulink Symbolic_Math_Toolbox Simulink_Design_Optimization Signal_Integrity_Toolbox Simulink_Report_Generator Simscape Statistics_and_Machine_Learning_Toolbox SerDes_Toolbox Simulink_Test Text_Analytics_Toolbox Sensor_Fusion_and_Tracking_Toolbox UAV_Toolbox Vehicle_Dynamics_Blockset Vehicle_Network_Toolbox Computer_Vision_Toolbox Simulink_3D_Animation Vision_HDL_Toolbox Simulink_Check Wavelet_Toolbox Wireless_Testbench WLAN_Toolbox Simulink_Real-Time System_Composer"
SPKGS                   = "Deep_Learning_Toolbox_Model_for_AlexNet_Network Deep_Learning_Toolbox_Model_for_EfficientNet-b0_Network Deep_Learning_Toolbox_Model_for_GoogLeNet_Network Deep_Learning_Toolbox_Model_for_ResNet-101_Network Deep_Learning_Toolbox_Model_for_ResNet-18_Network Deep_Learning_Toolbox_Model_for_ResNet-50_Network Deep_Learning_Toolbox_Model_for_Inception-ResNet-v2_Network Deep_Learning_Toolbox_Model_for_Inception-v3_Network Deep_Learning_Toolbox_Model_for_DenseNet-201_Network Deep_Learning_Toolbox_Model_for_Xception_Network Deep_Learning_Toolbox_Model_for_MobileNet-v2_Network Deep_Learning_Toolbox_Model_for_Places365-GoogLeNet_Network Deep_Learning_Toolbox_Model_for_NASNet-Large_Network Deep_Learning_Toolbox_Model_for_NASNet-Mobile_Network Deep_Learning_Toolbox_Model_for_ShuffleNet_Network Deep_Learning_Toolbox_Model_for_DarkNet-19_Network Deep_Learning_Toolbox_Model_for_DarkNet-53_Network Deep_Learning_Toolbox_Model_for_VGG-16_Network Deep_Learning_Toolbox_Model_for_VGG-19_Network"
NVIDIA_CUDA_TOOLKIT     = "https://developer.download.nvidia.com/compute/cuda/11.7.1/local_installers/cuda_11.7.1_515.65.01_linux.run"
NVIDIA_DRIVER_VERSION   = "515"
NVIDIA_CUDA_KEYRING_URL = "https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-keyring_1.0-1_all.deb"
DCV_INSTALLER_URL       = "https://d1uj6qtbmh3dt5.cloudfront.net/2022.2/Servers/nice-dcv-2022.2-13907-ubuntu2004-x86_64.tgz"

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/release-config/R2023b.pkrvars.hcl">
# Copyright 2023-2024 The MathWorks, Inc.

// Use this Packer configuration file to build AMI with R2023b MATLAB installed.
// For more information on these variables, see /packer/v1/build-matlab-ami.pkr.hcl.
RELEASE       = "R2023b"
BASE_AMI_NAME = "ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*"
STARTUP_SCRIPTS = [
  ".env",
  "10_setup-disks.sh",
  "20_setup-machine.sh",
  "30_setup-logging.sh",
  "40_setup-rdp.sh",
  "50_setup-nicedcv.sh",
  "60_setup-matlab-proxy.sh",
  "70_setup-matlab.sh",
  "80_warmup-matlab.sh",
  "85_warmup-mathworks-service-host.sh",
  "99_run-optional-user-command.sh"
]
RUNTIME_SCRIPTS = [
  "swap-desktop-solution.sh",
  "launch-matlab-proxy.sh",
  "generate-certificate.py"
]
BUILD_SCRIPTS = [
  "install-startup-scripts.sh",
  "install-swap-desktop-solution.sh",
  "install-dependencies.sh",
  "install-matlab-proxy.sh",
  "install-matlab-dependencies-ubuntu.sh",
  "install-ubuntu-desktop.sh",
  "install-mate.sh",
  "install-matlab.sh",
  "install-support-packages.sh",
  "setup-startup-accelerator.sh",
  "install-fabric-manager-ubuntu.sh",
  "generate-toolbox-cache.sh",
  "cleanup.sh"
]
PRODUCTS                = "5G_Toolbox AUTOSAR_Blockset Aerospace_Blockset Aerospace_Toolbox Antenna_Toolbox Audio_Toolbox Automated_Driving_Toolbox Bioinformatics_Toolbox Bluetooth_Toolbox C2000_Microcontroller_Blockset Communications_Toolbox Computer_Vision_Toolbox Control_System_Toolbox Curve_Fitting_Toolbox DDS_Blockset DSP_HDL_Toolbox DSP_System_Toolbox Database_Toolbox Datafeed_Toolbox Deep_Learning_HDL_Toolbox Deep_Learning_Toolbox Econometrics_Toolbox Embedded_Coder Filter_Design_HDL_Coder Financial_Instruments_Toolbox Financial_Toolbox Fixed-Point_Designer Fuzzy_Logic_Toolbox GPU_Coder Global_Optimization_Toolbox HDL_Coder HDL_Verifier Image_Acquisition_Toolbox Image_Processing_Toolbox Industrial_Communication_Toolbox Instrument_Control_Toolbox LTE_Toolbox Lidar_Toolbox MATLAB MATLAB_Coder MATLAB_Compiler MATLAB_Compiler_SDK MATLAB_Production_Server MATLAB_Report_Generator MATLAB_Test MATLAB_Web_App_Server Mapping_Toolbox Medical_Imaging_Toolbox Mixed-Signal_Blockset Model_Predictive_Control_Toolbox Motor_Control_Blockset Navigation_Toolbox Optimization_Toolbox Parallel_Computing_Toolbox Partial_Differential_Equation_Toolbox Phased_Array_System_Toolbox Powertrain_Blockset Predictive_Maintenance_Toolbox RF_Blockset RF_PCB_Toolbox RF_Toolbox ROS_Toolbox Radar_Toolbox Reinforcement_Learning_Toolbox Requirements_Toolbox Risk_Management_Toolbox Robotics_System_Toolbox Robust_Control_Toolbox Satellite_Communications_Toolbox Sensor_Fusion_and_Tracking_Toolbox SerDes_Toolbox Signal_Integrity_Toolbox Signal_Processing_Toolbox SimBiology SimEvents Simscape Simscape_Battery Simscape_Driveline Simscape_Electrical Simscape_Fluids Simscape_Multibody Simulink Simulink_3D_Animation Simulink_Check Simulink_Coder Simulink_Compiler Simulink_Control_Design Simulink_Coverage Simulink_Design_Optimization Simulink_Design_Verifier Simulink_Desktop_Real-Time Simulink_Fault_Analyzer Simulink_PLC_Coder Simulink_Real-Time Simulink_Report_Generator Simulink_Test SoC_Blockset Stateflow Statistics_and_Machine_Learning_Toolbox Symbolic_Math_Toolbox System_Composer System_Identification_Toolbox Text_Analytics_Toolbox UAV_Toolbox Vehicle_Dynamics_Blockset Vehicle_Network_Toolbox Vision_HDL_Toolbox WLAN_Toolbox Wavelet_Toolbox Wireless_HDL_Toolbox Wireless_Testbench"
SPKGS                   = "Deep_Learning_Toolbox_Model_for_AlexNet_Network Deep_Learning_Toolbox_Model_for_EfficientNet-b0_Network Deep_Learning_Toolbox_Model_for_GoogLeNet_Network Deep_Learning_Toolbox_Model_for_ResNet-101_Network Deep_Learning_Toolbox_Model_for_ResNet-18_Network Deep_Learning_Toolbox_Model_for_ResNet-50_Network Deep_Learning_Toolbox_Model_for_Inception-ResNet-v2_Network Deep_Learning_Toolbox_Model_for_Inception-v3_Network Deep_Learning_Toolbox_Model_for_DenseNet-201_Network Deep_Learning_Toolbox_Model_for_Xception_Network Deep_Learning_Toolbox_Model_for_MobileNet-v2_Network Deep_Learning_Toolbox_Model_for_Places365-GoogLeNet_Network Deep_Learning_Toolbox_Model_for_NASNet-Large_Network Deep_Learning_Toolbox_Model_for_NASNet-Mobile_Network Deep_Learning_Toolbox_Model_for_ShuffleNet_Network Deep_Learning_Toolbox_Model_for_DarkNet-19_Network Deep_Learning_Toolbox_Model_for_DarkNet-53_Network Deep_Learning_Toolbox_Model_for_VGG-16_Network Deep_Learning_Toolbox_Model_for_VGG-19_Network"
NVIDIA_CUDA_TOOLKIT     = "https://developer.download.nvidia.com/compute/cuda/12.2.2/local_installers/cuda_12.2.2_535.104.05_linux.run"
NVIDIA_DRIVER_VERSION   = "535"
NVIDIA_CUDA_KEYRING_URL = "https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.0-1_all.deb"
DCV_INSTALLER_URL       = "https://d1uj6qtbmh3dt5.cloudfront.net/2023.0/Servers/nice-dcv-2023.0-15065-ubuntu2204-x86_64.tgz"

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/release-config/R2020b.pkrvars.hcl">
# Copyright 2023-2024 The MathWorks, Inc.

// Use this Packer configuration file to build AMI with R2020b MATLAB installed.
// For more information on these variables, see /packer/v1/build-matlab-ami.pkr.hcl.
RELEASE       = "R2020b"
BASE_AMI_NAME = "ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-*"
STARTUP_SCRIPTS = [
  ".env",
  "10_setup-disks.sh",
  "20_setup-machine.sh",
  "30_setup-logging.sh",
  "40_setup-rdp.sh",
  "50_setup-nicedcv.sh",
  "70_setup-matlab.sh",
  "99_run-optional-user-command.sh"
]
RUNTIME_SCRIPTS = [
  "swap-desktop-solution.sh"
]
BUILD_SCRIPTS = [
  "install-startup-scripts.sh",
  "install-swap-desktop-solution.sh",
  "install-dependencies.sh",
  "install-matlab-dependencies-ubuntu.sh",
  "install-ubuntu-desktop.sh",
  "install-mate.sh",
  "install-matlab.sh",
  "install-support-packages.sh",
  "install-fabric-manager-ubuntu.sh",
  "cleanup.sh"
]
PRODUCTS                = "5G_Toolbox Antenna_Toolbox Aerospace_Blockset Mixed-Signal_Blockset Phased_Array_System_Toolbox AUTOSAR_Blockset Aerospace_Toolbox Audio_Toolbox Bioinformatics_Toolbox Curve_Fitting_Toolbox Communications_Toolbox MATLAB_Compiler Control_System_Toolbox Simulink_Coverage Database_Toolbox Datafeed_Toolbox Deep_Learning_HDL_Toolbox Parallel_Computing_Toolbox Automated_Driving_Toolbox DSP_System_Toolbox Simulink_Design_Verifier Embedded_Coder HDL_Verifier Econometrics_Toolbox Filter_Design_HDL_Coder Financial_Toolbox Fuzzy_Logic_Toolbox GPU_Coder Global_Optimization_Toolbox HDL_Coder SoC_Blockset Image_Acquisition_Toolbox Instrument_Control_Toolbox System_Identification_Toolbox Image_Processing_Toolbox Financial_Instruments_Toolbox Simscape_Driveline Wireless_HDL_Toolbox Lidar_Toolbox LTE_Toolbox MATLAB_Coder Mapping_Toolbox MATLAB_Compiler_SDK MATLAB Model_Predictive_Control_Toolbox MATLAB_Report_Generator Simscape_Multibody Motor_Control_Blockset MATLAB_Web_App_Server Deep_Learning_Toolbox Navigation_Toolbox Optimization_Toolbox Partial_Differential_Equation_Toolbox Simulink_PLC_Coder Predictive_Maintenance_Toolbox Fixed-Point_Designer MATLAB_Production_Server Simscape_Electrical Powertrain_Blockset Radar_Toolbox RF_Blockset Robust_Control_Toolbox RF_Toolbox Risk_Management_Toolbox Reinforcement_Learning_Toolbox Robotics_System_Toolbox Simulink_Requirements ROS_Toolbox Simulink_Coder SimBiology Simulink_Control_Design SimEvents Stateflow Signal_Processing_Toolbox Simscape_Fluids Simulink_Compiler Simulink Symbolic_Math_Toolbox Simulink_Design_Optimization Simulink_Report_Generator Simscape Statistics_and_Machine_Learning_Toolbox SerDes_Toolbox Simulink_Test Text_Analytics_Toolbox Sensor_Fusion_and_Tracking_Toolbox Trading_Toolbox UAV_Toolbox Vehicle_Dynamics_Blockset Vehicle_Network_Toolbox Computer_Vision_Toolbox Simulink_3D_Animation Vision_HDL_Toolbox Simulink_Check Wavelet_Toolbox WLAN_Toolbox System_Composer"
SPKGS                   = "Deep_Learning_Toolbox_Model_for_AlexNet_Network Deep_Learning_Toolbox_Model_for_GoogLeNet_Network Deep_Learning_Toolbox_Model_for_ResNet-101_Network Deep_Learning_Toolbox_Model_for_ResNet-18_Network Deep_Learning_Toolbox_Model_for_ResNet-50_Network Deep_Learning_Toolbox_Model_for_Inception-ResNet-v2_Network Deep_Learning_Toolbox_Model_for_Inception-v3_Network Deep_Learning_Toolbox_Model_for_DenseNet-201_Network Deep_Learning_Toolbox_Model_for_Xception_Network Deep_Learning_Toolbox_Model_for_MobileNet-v2_Network Deep_Learning_Toolbox_Model_for_Places365-GoogLeNet_Network Deep_Learning_Toolbox_Model_for_NASNet-Large_Network Deep_Learning_Toolbox_Model_for_NASNet-Mobile_Network Deep_Learning_Toolbox_Model_for_ShuffleNet_Network Deep_Learning_Toolbox_Model_for_DarkNet-19_Network Deep_Learning_Toolbox_Model_for_DarkNet-53_Network Deep_Learning_Toolbox_Model_for_VGG-16_Network Deep_Learning_Toolbox_Model_for_VGG-19_Network"
NVIDIA_CUDA_TOOLKIT     = ""
NVIDIA_DRIVER_VERSION   = ""
NVIDIA_CUDA_KEYRING_URL = "https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-keyring_1.0-1_all.deb"
DCV_INSTALLER_URL       = "https://d1uj6qtbmh3dt5.cloudfront.net/2022.2/Servers/nice-dcv-2022.2-13907-ubuntu2004-x86_64.tgz"

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/release-config/R2021a.pkrvars.hcl">
# Copyright 2023-2024 The MathWorks, Inc.

// Use this Packer configuration file to build AMI with R2021a MATLAB installed.
// For more information on these variables, see /packer/v1/build-matlab-ami.pkr.hcl.
RELEASE       = "R2021a"
BASE_AMI_NAME = "ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-*"
STARTUP_SCRIPTS = [
  ".env",
  "10_setup-disks.sh",
  "20_setup-machine.sh",
  "30_setup-logging.sh",
  "40_setup-rdp.sh",
  "50_setup-nicedcv.sh",
  "70_setup-matlab.sh",
  "99_run-optional-user-command.sh"
]
RUNTIME_SCRIPTS = [
  "swap-desktop-solution.sh"
]
BUILD_SCRIPTS = [
  "install-startup-scripts.sh",
  "install-swap-desktop-solution.sh",
  "install-dependencies.sh",
  "install-matlab-dependencies-ubuntu.sh",
  "install-ubuntu-desktop.sh",
  "install-mate.sh",
  "install-matlab.sh",
  "install-support-packages.sh",
  "install-fabric-manager-ubuntu.sh",
  "cleanup.sh"
]
PRODUCTS                = "5G_Toolbox Antenna_Toolbox Aerospace_Blockset Mixed-Signal_Blockset Phased_Array_System_Toolbox AUTOSAR_Blockset Aerospace_Toolbox Audio_Toolbox Bioinformatics_Toolbox Curve_Fitting_Toolbox Communications_Toolbox MATLAB_Compiler Control_System_Toolbox Simulink_Coverage Database_Toolbox DDS_Blockset Datafeed_Toolbox Deep_Learning_HDL_Toolbox Parallel_Computing_Toolbox Automated_Driving_Toolbox DSP_System_Toolbox Simulink_Design_Verifier Embedded_Coder HDL_Verifier Econometrics_Toolbox Filter_Design_HDL_Coder Financial_Toolbox Fuzzy_Logic_Toolbox GPU_Coder Global_Optimization_Toolbox HDL_Coder SoC_Blockset Image_Acquisition_Toolbox Instrument_Control_Toolbox System_Identification_Toolbox Image_Processing_Toolbox Financial_Instruments_Toolbox Simscape_Driveline Wireless_HDL_Toolbox Lidar_Toolbox LTE_Toolbox MATLAB_Coder Mapping_Toolbox MATLAB_Compiler_SDK MATLAB Model_Predictive_Control_Toolbox MATLAB_Report_Generator Simscape_Multibody Motor_Control_Blockset MATLAB_Web_App_Server Deep_Learning_Toolbox Navigation_Toolbox Optimization_Toolbox Partial_Differential_Equation_Toolbox Simulink_PLC_Coder Predictive_Maintenance_Toolbox Fixed-Point_Designer MATLAB_Production_Server Simscape_Electrical Powertrain_Blockset Radar_Toolbox RF_Blockset Robust_Control_Toolbox RF_Toolbox Risk_Management_Toolbox Reinforcement_Learning_Toolbox Robotics_System_Toolbox Simulink_Requirements ROS_Toolbox Simulink_Coder SimBiology Simulink_Control_Design SimEvents Stateflow Signal_Processing_Toolbox Simscape_Fluids Satellite_Communications_Toolbox Simulink_Compiler Simulink Symbolic_Math_Toolbox Simulink_Design_Optimization Simulink_Report_Generator Simscape Statistics_and_Machine_Learning_Toolbox SerDes_Toolbox Simulink_Test Text_Analytics_Toolbox Sensor_Fusion_and_Tracking_Toolbox UAV_Toolbox Vehicle_Dynamics_Blockset Vehicle_Network_Toolbox Computer_Vision_Toolbox Simulink_3D_Animation Vision_HDL_Toolbox Simulink_Check Wavelet_Toolbox WLAN_Toolbox System_Composer"
SPKGS                   = "Deep_Learning_Toolbox_Model_for_AlexNet_Network Deep_Learning_Toolbox_Model_for_GoogLeNet_Network Deep_Learning_Toolbox_Model_for_ResNet-101_Network Deep_Learning_Toolbox_Model_for_ResNet-18_Network Deep_Learning_Toolbox_Model_for_ResNet-50_Network Deep_Learning_Toolbox_Model_for_Inception-ResNet-v2_Network Deep_Learning_Toolbox_Model_for_Inception-v3_Network Deep_Learning_Toolbox_Model_for_DenseNet-201_Network Deep_Learning_Toolbox_Model_for_Xception_Network Deep_Learning_Toolbox_Model_for_MobileNet-v2_Network Deep_Learning_Toolbox_Model_for_Places365-GoogLeNet_Network Deep_Learning_Toolbox_Model_for_NASNet-Large_Network Deep_Learning_Toolbox_Model_for_NASNet-Mobile_Network Deep_Learning_Toolbox_Model_for_ShuffleNet_Network Deep_Learning_Toolbox_Model_for_DarkNet-19_Network Deep_Learning_Toolbox_Model_for_DarkNet-53_Network Deep_Learning_Toolbox_Model_for_VGG-16_Network Deep_Learning_Toolbox_Model_for_VGG-19_Network"
NVIDIA_CUDA_TOOLKIT     = ""
NVIDIA_DRIVER_VERSION   = ""
NVIDIA_CUDA_KEYRING_URL = "https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-keyring_1.0-1_all.deb"
DCV_INSTALLER_URL       = "https://d1uj6qtbmh3dt5.cloudfront.net/2022.2/Servers/nice-dcv-2022.2-13907-ubuntu2004-x86_64.tgz"

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/src/metatemplate.json">
{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Mappings": {
    "RegionMap": {
      "us-east-1": {
        "AMI": "ami-06554a9c16731eeb8"
      },
      "us-east-2": {
        "AMI": "ami-040d3396a95f96a53"
      },
      "us-west-1": {
        "AMI": "ami-008fa692586b3a464"
      },
      "us-west-2": {
        "AMI": "ami-0d36511676e466738"
      },
      "ca-central-1": {
        "AMI": "ami-076bccca90d726a8a"
      },
      "eu-central-1": {
        "AMI": "ami-0a0d9afe6067c43a7"
      },
      "eu-west-1": {
        "AMI": "ami-0f67bd11ca9761a60"
      },
      "eu-west-2": {
        "AMI": "ami-0b06db3d5a4316ec1"
      },
      "eu-west-3": {
        "AMI": "ami-0926d9cdd6dfae3d5"
      },
      "eu-north-1": {
        "AMI": "ami-0f28478b04fdc4018"
      },
      "sa-east-1": {
        "AMI": "ami-08a999de3522e24db"
      },
      "me-south-1": {
        "AMI": "ami-0858e50e785ef6f2f"
      },
      "ap-east-1": {
        "AMI": "ami-06e8e5a7300b3aab4"
      },
      "ap-south-1": {
        "AMI": "ami-008ce8a1c0d6e4482"
      },
      "ap-northeast-1": {
        "AMI": "ami-0afb5eb6c649b1a34"
      },
      "ap-northeast-2": {
        "AMI": "ami-015a345dd9eb5f0c5"
      },
      "ap-southeast-1": {
        "AMI": "ami-065781ef522f1ec89"
      },
      "ap-southeast-2": {
        "AMI": "ami-0bbbc1a62bf9f4480"
      }
    }
  },
  "Resources": {
    "PredefinedRole": {
      "Type": "AWS::IAM::Role",
      "Condition": "UsePredefinedRole",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "ec2.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/MW/",
        "ManagedPolicyArns": {
          "Fn::If": [
            "UseAdditionalPolicies",
            {
              "Fn::Split": [
                ";",
                {
                  "Ref": "AdditionalIamPolicies"
                }
              ]
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "Policies": [
          {
            "Fn::If": [
              "UseCloudWatch",
              {
                "PolicyName": "cloudwatch-access-policy",
                "PolicyDocument": {
                  "Version": "2012-10-17",
                  "Statement": [
                    {
                      "Effect": "Allow",
                      "Action": [
                        "logs:CreateLogStream",
                        "logs:DescribeLogStreams",
                        "logs:PutLogEvents"
                      ],
                      "Resource": {
                        "Fn::Sub": [
                          "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:${LogGroupName}:*",
                          {
                            "LogGroupName": {
                              "Ref": "MWLogLocation"
                            }
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          },
          {
            "PolicyName": "dcv-access-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "s3:GetObject",
                  "Resource": {
                    "Fn::Sub": "arn:${AWS::Partition}:s3:::dcv-license.${AWS::Region}/*"
                  }
                }
              ]
            }
          },
          {
            "PolicyName": "ssm-access-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "ssm:DescribeAssociation",
                    "ssm:GetDeployablePatchSnapshotForInstance",
                    "ssm:GetDocument",
                    "ssm:DescribeDocument",
                    "ssm:GetManifest",
                    "ssm:GetParameter",
                    "ssm:GetParameters",
                    "ssm:ListAssociations",
                    "ssm:ListInstanceAssociations",
                    "ssm:PutInventory",
                    "ssm:PutComplianceItems",
                    "ssm:PutConfigurePackageResult",
                    "ssm:UpdateAssociationStatus",
                    "ssm:UpdateInstanceAssociationStatus",
                    "ssm:UpdateInstanceInformation"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ssmmessages:CreateControlChannel",
                    "ssmmessages:CreateDataChannel",
                    "ssmmessages:OpenControlChannel",
                    "ssmmessages:OpenDataChannel"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ec2messages:AcknowledgeMessage",
                    "ec2messages:DeleteMessage",
                    "ec2messages:FailMessage",
                    "ec2messages:GetEndpoint",
                    "ec2messages:GetMessages",
                    "ec2messages:SendReply"
                  ],
                  "Resource": "*"
                }
              ]
            }
          },
          {
            "PolicyName": "describe-tags-policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "ec2:DescribeTags",
                  "Resource": "*"
                }
              ]
            }
          }
        ]
      }
    },
    "MATLABInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/MW/",
        "Roles": [
          {
            "Fn::If": [
              "UsePredefinedRole",
              {
                "Ref": "PredefinedRole"
              },
              {
                "Ref": "CustomIamRole"
              }
            ]
          }
        ]
      }
    },
    "EC2AutoShutdown": {
      "Type": "AWS::CloudFormation::Stack",
      "DeletionPolicy": "Delete",
      "UpdateReplacePolicy": "Delete",
      "Properties": {
        "TemplateURL": "https://mathworks-reference-architectures-templates.s3.amazonaws.com/ec2-shutdown-lambda/v1/0/1/ec2-shutdown-lambda.yml",
        "Parameters": {
          "EC2InstanceId": {
            "Ref": "MATLABEC2Instance"
          },
          "MathWorksProductId": "MathWorks-MATLAB-Linux",
          "ShutdownBehaviour": {
            "Ref": "AutoShutdown"
          },
          "TagToMonitor": "mw-autoshutdown",
          "AutoShutdownLambdaLogRetentionInDays": 1
        }
      }
    },
    "MWSecurityGroup": {
      "Type": "AWS::CloudFormation::Stack",
      "DeletionPolicy": "Delete",
      "UpdateReplacePolicy": "Delete",
      "Properties": {
        "TemplateURL": "https://mathworks-reference-architectures-templates.s3.amazonaws.com/security-group/v2/0/0/security-group.yml",
        "Parameters": {
          "VpcId": {
            "Ref": "VPC"
          },
          "CidrRanges": {
            "Ref": "ClientIPAddress"
          },
          "SSHAccess": "Yes",
          "RDPAccess": "Yes",
          "NICEDCVAccess": "Yes",
          "MATLABProxyAccess": "Yes"
        }
      }
    },
    "MWLogLocation": {
      "Type": "AWS::Logs::LogGroup",
      "Condition": "UseCloudWatch"
    },
    "MATLABEC2Instance": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "ImageId": {
          "Fn::If": [
            "UseCustomAMI",
            {
              "Ref": "CustomAmiId"
            },
            {
              "Fn::FindInMap": [
                "RegionMap",
                {
                  "Ref": "AWS::Region"
                },
                "AMI"
              ]
            }
          ]
        },
        "KeyName": {
          "Ref": "SSHKeyName"
        },
        "SecurityGroupIds": [
          {
            "Fn::GetAtt": [
              "MWSecurityGroup",
              "Outputs.SecurityGroupId"
            ]
          },
          {
            "Fn::If": [
              "AddSG",
              {
                "Ref": "AdditionalSecurityGroup"
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          }
        ],
        "SubnetId": {
          "Ref": "Subnet"
        },
        "InstanceType": {
          "Ref": "InstanceType"
        },
        "IamInstanceProfile": {
          "Ref": "MATLABInstanceProfile"
        },
        "EbsOptimized": "true",
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "VolumeSize": {
                "Ref": "RootVolumeSize"
              }
            }
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Ref": "InstanceName"
            }
          },
          {
            "Key": "mw-ProductID",
            "Value": "MathWorks-MATLAB-Linux"
          },
          {
            "Key": "mw-StackName",
            "Value": {
              "Ref": "AWS::StackName"
            }
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "\n",
              [
                "#!/bin/bash",
                "",
                "# Copyright 2022 The MathWorks, Inc.",
                "",
                "STARTUP_FOLDER=/opt/mathworks/startup",
                "# Load startup variables",
                "if [[ -r ${STARTUP_FOLDER}/.env ]]; then",
                "    set -o allexport",
                "    source ${STARTUP_FOLDER}/.env",
                "    set +o allexport",
                "fi",
                "",
                "# Define startup parameters",
                {
                  "Fn::Sub": [
                    "export PASSWORD=${PasswordBase64}",
                    {
                      "PasswordBase64": {
                        "Fn::Base64": {
                          "Ref": "Password"
                        }
                      }
                    }
                  ]
                },
                {
                  "Fn::Sub": "export MLM_LICENSE_FILE=${LicenseManager}"
                },
                {
                  "Fn::Sub": [
                    "export CLOUD_LOG_NAME=${LogGroupName}",
                    {
                      "LogGroupName": {
                        "Fn::If": [
                          "UseCloudWatch",
                          {
                            "Ref": "MWLogLocation"
                          },
                          ""
                        ]
                      }
                    }
                  ]
                },
                {
                  "Fn::Sub": "export ACCESS_PROTOCOL='${AccessProtocol}'"
                },
                {
                  "Fn::Sub": "export ENABLE_MATLAB_PROXY='${EnableMATLABProxy}'"
                },
                {
                  "Fn::Sub": "export OPTIONAL_USER_COMMAND='${OptionalUserCommand}'"
                },
                "",
                "# Run startup scripts",
                "mkdir -p /var/log/mathworks",
                "run-parts --exit-on-error --verbose --regex '^[0-9]+_.+$' ${STARTUP_FOLDER} >> /var/log/mathworks/startup.log 2>&1",
                "",
                "# Signal the status from cfn-init",
                {
                  "Fn::Sub": "/opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --region ${AWS::Region} --resource MATLABEC2Instance"
                }
              ]
            ]
          }
        }
      },
      "CreationPolicy": {
        "ResourceSignal": {
          "Timeout": "PT15M"
        }
      }
    },
    "ElasticIP": {
      "Type": "AWS::EC2::EIP",
      "Condition": "UseElasticIPAddress",
      "Properties": {
        "InstanceId": {
          "Ref": "MATLABEC2Instance"
        },
        "Domain": "vpc"
      }
    },
    "document": {
      "Type": "AWS::SSM::Document",
      "Condition": "UsePredefinedRole",
      "Properties": {
        "DocumentType": "Command",
        "Content": {
          "schemaVersion": "2.2",
          "description": "Run a script on Linux instances.",
          "parameters": {
            "commands": {
              "type": "String",
              "description": "Command to run on EC2 instance",
              "default": "echo 'Hello World'"
            }
          },
          "mainSteps": [
            {
              "action": "aws:runShellScript",
              "name": "runCommands",
              "inputs": {
                "timeoutSeconds": "60",
                "runCommand": [
                  "{{ commands }}"
                ]
              }
            }
          ]
        }
      }
    }
  },
  "Parameters": {
    "InstanceType": {
      "Description": "AWS instance type to use for MATLAB. See https://aws.amazon.com/ec2/instance-types for a list of instance types.",
      "Default": "m5.xlarge",
      "Type": "String"
    },
    "InstanceName": {
      "Description": "Name for the MATLAB virtual machine",
      "Default": "MATLAB Desktop",
      "Type": "String"
    },
    "AccessProtocol": {
      "Description": "Access protocol to connect to this instance",
      "Default": "RDP",
      "Type": "String",
      "AllowedValues": [
        "NICE DCV",
        "RDP"
      ]
    },
    "EnableMATLABProxy": {
      "Description": "Option that enables access to MATLAB on your cloud instance within a browser. Opening MATLAB in a browser opens a separate MATLAB session to your Remote Desktop Protocol (RDP) session or NICE DCV session.",
      "Default": "Yes",
      "Type": "String",
      "AllowedValues": [
        "Yes",
        "No"
      ]
    },
    "UseElasticIpAddress": {
      "Description": "Flag indicating whether you want to keep the same public IP address for the instance",
      "Default": "No",
      "Type": "String",
      "AllowedValues": [
        "Yes",
        "No"
      ]
    },
    "RootVolumeSize": {
      "Description": "Size in GB of the root volume",
      "Default": "128",
      "Type": "Number",
      "MinValue": "128",
      "MaxValue": "1024",
      "ConstraintDescription": "Size must be between 128 and 1024GB"
    },
    "CustomIamRole": {
      "Description": "Name of a custom IAM Role to associate with this instance. If not specified, a predefined role is used. If specified, features requiring special permissions will be unavailable (NICE DCV, CloudWatch, IAM Policies).",
      "Default": "",
      "Type": "String"
    },
    "AdditionalIamPolicies": {
      "Description": "Semicolon-delimited list of IAM Policy ARNs to add to the predefined role. This option cannot be used with a custom IAM Role.",
      "Default": "",
      "Type": "String",
      "AllowedPattern": "^(arn:[^:;]+:iam::[^:;]+:policy/[^:;]+(;arn:[^:;]+:iam::[^:;]+:policy/[^:;]+)*)?$",
      "ConstraintDescription": "If specified, must be a semicolon (;) delimited list of ARNs (arn:<partition>:iam::<account-id>:policy/<resource-id>)."
    },
    "VPC": {
      "Description": "ID of an existing VPC in which to deploy this stack",
      "Type": "AWS::EC2::VPC::Id",
      "ConstraintDescription": "Must be the ID of an existing VPC.",
      "AllowedPattern": ".+"
    },
    "Subnet": {
      "Description": "ID of an existing subnet. To access the instance from anywhere, ensure that your subnet auto-assigns public IP addresses and is connected to the internet.",
      "Type": "AWS::EC2::Subnet::Id",
      "ConstraintDescription": "Must be the ID of an existing Subnet within the chosen VPC.",
      "AllowedPattern": ".+"
    },
    "SSHKeyName": {
      "Description": "Name of an existing EC2 KeyPair to allow SSH access to all the instances. See https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html for details on creating these.",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "ConstraintDescription": "Must be the name of an existing EC2 KeyPair.",
      "AllowedPattern": ".+"
    },
    "ClientIPAddress": {
      "Description": "Comma-separated list of IP address ranges that will be allowed to connect to this instance. Each IP CIDR should be formatted as <ip_address>/<mask>. The mask determines the number of IP addresses to include. A mask of 32 is a single IP address. Example of allowed values: 10.0.0.1/32 or 10.0.0.0/16,192.34.56.78/32. This calculator can be used to build a specific range: https://www.ipaddressguide.com/cidr. You may need to contact your IT administrator to determine which address is appropriate.",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "189",
      "AllowedPattern": "^((\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2}))(,((\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2}))){0,9}$",
      "ConstraintDescription": "Must be a comma-separated list of valid IP CIDR ranges of the form x.x.x.x/x. A maximum of 10 such IP CIDRs are allowed in the list."
    },
    "Password": {
      "NoEcho": "true",
      "Description": "Password for the \"ubuntu\" user. You also need to enter this as an authentication token to access MATLAB on your cloud instance within a browser.",
      "Type": "String",
      "ConstraintDescription": "Must have a minimum of 14 characters, 1 uppercase letter, 1 lowercase letter, 1 number, and 1 special character",
      "AllowedPattern": "^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[^a-zA-Z0-9]).{14,}$"
    },
    "ConfirmPassword": {
      "NoEcho": "true",
      "Description": "Confirm Password",
      "Type": "String"
    },
    "LicenseManager": {
      "Description": "Optional License Manager for MATLAB, specified as a string in the form <port>@<hostname>. If not specified, use online licensing. If specified, the network license manager (NLM) must be accessible from the specified VPC and subnets. To use the private hostname of the NLM hub instead of the public hostname, specify the security group ID of the NLM hub in the AdditionalSecurityGroup parameter. For more information, see https://github.com/mathworks-ref-arch/license-manager-for-matlab-on-aws.",
      "Type": "String",
      "Default": "",
      "AllowedPattern": "([0-9]+@[a-zA-Z0-9.\\-]+)?",
      "ConstraintDescription": "If specified, must be in the form <port>@<hostname>"
    },
    "EnableCloudWatch": {
      "Description": "Flag indicating whether cloudwatch logging for the MATLAB instance is enabled.",
      "Type": "String",
      "AllowedValues": [
        "Yes",
        "No"
      ],
      "Default": "No"
    },
    "AutoShutdown": {
      "Description": "Choose whether you want to enable autoshutdown for your instance after a certain number of hours",
      "Type": "String",
      "AllowedValues": [
        "Never",
        "After 1 hour",
        "After 2 hours",
        "After 3 hours",
        "After 4 hours",
        "After 5 hours",
        "After 6 hours",
        "After 7 hours",
        "After 8 hours",
        "After 9 hours",
        "After 10 hours",
        "After 11 hours",
        "After 12 hours",
        "After 13 hours",
        "After 14 hours",
        "After 15 hours",
        "After 16 hours",
        "After 17 hours",
        "After 18 hours",
        "After 19 hours",
        "After 20 hours",
        "After 21 hours",
        "After 22 hours",
        "After 23 hours",
        "After 24 hours"
      ],
      "Default": "Never"
    },
    "AdditionalSecurityGroup": {
      "Description": "ID of an additional (optional) Security Group for the instances to be placed in. Often the License Manager for MATLAB's Security Group.",
      "Type": "String",
      "Default": ""
    },
    "CustomAmiId": {
      "Default": "",
      "Description": "ID of a custom Amazon Machine Image (AMI) in the target region (optional). If the build has been customized then the resulting machine image may no longer be compatible with the provided CloudFormation template. Compatability can in some cases be restored by making corresponding modifications to the CloudFormation template. The ID should start with 'ami-'.",
      "Type": "String"
    },
    "OptionalUserCommand": {
      "Description": "Provide an optional inline shell command to run on machine launch. For example, to set an environment variable CLOUD=AWS, use this command excluding the angle brackets: <echo -e \"export CLOUD=AWS\" | tee -a /etc/profile.d/setenvvar.sh && source /etc/profile>. To run an external script, use this command excluding the angle brackets: <wget -O /tmp/my-script.sh \"https://www.example.com/script.sh\" && bash /tmp/my-script.sh>. Find the logs at '/var/log/mathworks/startup.log'.",
      "Type": "String",
      "Default": ""
    }
  },
  "Rules": {
    "matchPasswords": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "Password"
              },
              {
                "Ref": "ConfirmPassword"
              }
            ]
          },
          "AssertDescription": "Passwords do not match"
        }
      ]
    },
    "SubnetInVPC": {
      "Assertions": [
        {
          "Assert": {
            "Fn::EachMemberEquals": [
              {
                "Fn::ValueOfAll": [
                  "AWS::EC2::Subnet::Id",
                  "VpcId"
                ]
              },
              {
                "Ref": "VPC"
              }
            ]
          },
          "AssertDescription": "Subnet must exist in the VPC you have selected"
        }
      ]
    },
    "NoAdditionalPoliciesOnCustomRole": {
      "RuleCondition": {
        "Fn::Not": [
          {
            "Fn::Equals": [
              {
                "Ref": "CustomIamRole"
              },
              ""
            ]
          }
        ]
      },
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "AdditionalIamPolicies"
              },
              ""
            ]
          },
          "AssertDescription": "You cannot add IAM Policies when using a custom IAM Role."
        }
      ]
    },
    "MultipleRolesMustNotExist": {
      "RuleCondition": {
        "Fn::Not": [
          {
            "Fn::Equals": [
              {
                "Ref": "CustomIamRole"
              },
              ""
            ]
          }
        ]
      },
      "Assertions": [
        {
          "Assert": {
            "Fn::Equals": [
              {
                "Ref": "EnableCloudWatch"
              },
              "No"
            ]
          },
          "AssertDescription": "You cannot use CloudWatch when using a custom IAM role. The deployment will create an IAM role which you can later modify with additional policies if needed."
        },
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Equals": [
                  {
                    "Ref": "AccessProtocol"
                  },
                  "NICE DCV"
                ]
              }
            ]
          },
          "AssertDescription": "You cannot use NICE DCV when using a custom IAM role. The deployment will create an IAM role which you can later modify with additional policies if needed."
        }
      ]
    }
  },
  "Conditions": {
    "UsePredefinedRole": {
      "Fn::Equals": [
        {
          "Ref": "CustomIamRole"
        },
        ""
      ]
    },
    "UseAdditionalPolicies": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalIamPolicies"
            },
            ""
          ]
        }
      ]
    },
    "UseCloudWatch": {
      "Fn::Equals": [
        {
          "Ref": "EnableCloudWatch"
        },
        "Yes"
      ]
    },
    "UseNICEDCV": {
      "Fn::Equals": [
        {
          "Ref": "AccessProtocol"
        },
        "NICE DCV"
      ]
    },
    "UseXRDP": {
      "Fn::Equals": [
        {
          "Ref": "AccessProtocol"
        },
        "RDP"
      ]
    },
    "UseMATLABProxy": {
      "Fn::Equals": [
        {
          "Ref": "EnableMATLABProxy"
        },
        "Yes"
      ]
    },
    "UseElasticIPAddress": {
      "Fn::Equals": [
        {
          "Ref": "UseElasticIpAddress"
        },
        "Yes"
      ]
    },
    "UseCustomAMI": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "CustomAmiId"
            },
            ""
          ]
        }
      ]
    },
    "AddSG": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AdditionalSecurityGroup"
            },
            ""
          ]
        }
      ]
    }
  },
  "Outputs": {
    "CloudWatchLogs": {
      "Condition": "UseCloudWatch",
      "Description": "The cloudwatch logs containing logging information about the MATLAB instance",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://console.aws.amazon.com/cloudwatch/home?region=",
            {
              "Ref": "AWS::Region"
            },
            "#logsV2:log-groups/log-group/",
            {
              "Ref": "MWLogLocation"
            }
          ]
        ]
      }
    },
    "NiceDCVConnection": {
      "Condition": "UseNICEDCV",
      "Description": "Public url of the newly created EC2 instance to connect to the session via NICE DCV",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://",
            {
              "Fn::GetAtt": [
                "MATLABEC2Instance",
                "PublicDnsName"
              ]
            },
            ":8443/#console"
          ]
        ]
      }
    },
    "RDPConnection": {
      "Condition": "UseXRDP",
      "Description": "Public DNSName of the newly created EC2 instance",
      "Value": {
        "Fn::GetAtt": [
          "MATLABEC2Instance",
          "PublicDnsName"
        ]
      }
    },
    "BrowserConnection": {
      "Condition": "UseMATLABProxy",
      "Description": "URL to connect to and open MATLAB in a browser.",
      "Value": {
        "Fn::Sub": "https://${MATLABEC2Instance.PublicDnsName}:8123"
      }
    }
  },
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "EC2 Instance"
          },
          "Parameters": [
            "InstanceName",
            "InstanceType",
            "RootVolumeSize",
            "CustomIamRole",
            "AdditionalIamPolicies"
          ]
        },
        {
          "Label": {
            "default": "Remote Access"
          },
          "Parameters": [
            "AccessProtocol",
            "EnableMATLABProxy",
            "UseElasticIpAddress",
            "ClientIPAddress",
            "SSHKeyName",
            "Password",
            "ConfirmPassword"
          ]
        },
        {
          "Label": {
            "default": "Network Configuration"
          },
          "Parameters": [
            "VPC",
            "Subnet",
            "AdditionalSecurityGroup"
          ]
        },
        {
          "Label": {
            "default": "License Configuration"
          },
          "Parameters": [
            "LicenseManager"
          ]
        },
        {
          "Label": {
            "default": "Logging Configuration"
          },
          "Parameters": [
            "EnableCloudWatch"
          ]
        },
        {
          "Label": {
            "default": "Autoshutdown Configuration"
          },
          "Parameters": [
            "AutoShutdown"
          ]
        },
        {
          "Label": {
            "default": "Custom AMI"
          },
          "Parameters": [
            "CustomAmiId"
          ]
        },
        {
          "Label": {
            "default": "Optional User Command"
          },
          "Parameters": [
            "OptionalUserCommand"
          ]
        }
      ],
      "ParameterLabels": {
        "ClientIPAddress": {
          "default": "Allow connections from"
        },
        "UseElasticIpAddress": {
          "default": "Keep public ip the same"
        },
        "InstanceType": {
          "default": "AWS EC2 Instance type"
        },
        "InstanceName": {
          "default": "Instance Name"
        },
        "RootVolumeSize": {
          "default": "Storage Size (GiB)"
        },
        "CustomIamRole": {
          "default": "Custom IAM Role (Optional)"
        },
        "AdditionalIamPolicies": {
          "default": "Additional IAM Policies (Optional)"
        },
        "VPC": {
          "default": "VPC to deploy this stack to"
        },
        "Subnet": {
          "default": "Subnet"
        },
        "Password": {
          "default": "Remote password"
        },
        "ConfirmPassword": {
          "default": "Confirm remote password"
        },
        "SSHKeyName": {
          "default": "SSH Key Pair"
        },
        "EnableMATLABProxy": {
          "default": "Enable browser access for MATLAB"
        },
        "LicenseManager": {
          "default": "License Manager for MATLAB connection string"
        },
        "AdditionalSecurityGroup": {
          "default": "Additional security group to place instances in"
        },
        "EnableCloudWatch": {
          "default": "Configure cloudwatch logging for the MATLAB instance"
        },
        "AccessProtocol": {
          "default": "Remote access protocol"
        },
        "CustomAmiId": {
          "default": "Custom AMI ID (Optional)"
        },
        "OptionalUserCommand": {
          "default": "Optional user inline command"
        }
      }
    }
  }
}
</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/runtime/generate-certificate.py">
# Copyright 2024 The MathWorks, Inc.

import os
from cryptography import x509
from cryptography.hazmat.backends import default_backend
from cryptography.hazmat.primitives import hashes
from cryptography.hazmat.primitives.asymmetric import rsa
from cryptography.hazmat.primitives import serialization
import datetime

if __name__ == "__main__":
    # Get the directory path of the script
    script_dir = os.path.dirname(os.path.abspath(__file__))

    # Generate a private key
    private_key = rsa.generate_private_key(
        public_exponent=65537,
        key_size=2048,
        backend=default_backend()
    )

    # Create a self-signed certificate
    subject = issuer = x509.Name([
        x509.NameAttribute(x509.oid.NameOID.COUNTRY_NAME, u"US"),
        x509.NameAttribute(x509.oid.NameOID.STATE_OR_PROVINCE_NAME, u"Massachusetts"),
        x509.NameAttribute(x509.oid.NameOID.LOCALITY_NAME, u"Natick"),
        x509.NameAttribute(x509.oid.NameOID.ORGANIZATION_NAME, u"MathWorks"),
        x509.NameAttribute(x509.oid.NameOID.COMMON_NAME, u"mathworks.com"),
    ])

    cert = x509.CertificateBuilder().subject_name(
        subject
    ).issuer_name(
        issuer
    ).public_key(
        private_key.public_key()
    ).serial_number(
        x509.random_serial_number()
    ).not_valid_before(
        datetime.datetime.utcnow()
    ).not_valid_after(
        datetime.datetime.utcnow() + datetime.timedelta(days=365)
    ).sign(private_key, hashes.SHA256(), default_backend())

    # Save the private key and certificate to files in the script directory
    private_key_path = os.path.join(script_dir, "private_key.pem")
    certificate_path = os.path.join(script_dir, "certificate.pem")

    with open(private_key_path, "wb") as f:
        f.write(private_key.private_bytes(
            encoding=serialization.Encoding.PEM,
            format=serialization.PrivateFormat.PKCS8,
            encryption_algorithm=serialization.NoEncryption()
        ))

    with open(certificate_path, "wb") as f:
        f.write(cert.public_bytes(serialization.Encoding.PEM))

    # Print the paths of the generated files
    print("Private key saved to:", private_key_path)
    print("Certificate saved to:", certificate_path)

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/runtime/swap-desktop-solution.sh">
#!/bin/bash
#
# Copyright 2023-2024 The MathWorks, Inc.

# Set up log file
swap_desktop_log="/var/log/mathworks/swap_desktop_solution.log"
sudo touch "$swap_desktop_log"
sudo chown "$USER" "$swap_desktop_log"

# Print commands for logging purposes, including timestamps.
exec 1>>"$swap_desktop_log" 2>&1
set -x
PS4='+ [\d \t] '

REMOTE_DESKTOP_SOLUTION=$1

function cleanup_xrdp_session {
  # Kill desktop session from previous xrdp run
  xrdp_desktop_pid=$(ps aux | grep Xorg | awk '/xrdp\/xorg\.conf/ {print $2}')
  if [ ! -z "$xrdp_desktop_pid" ] ; then
    sudo kill -9 "$xrdp_desktop_pid"
  fi
}

function init_dcv_desktop {
  sudo systemctl set-default graphical.target
  sudo systemctl isolate multi-user.target
  sudo systemctl isolate graphical.target
}

function init_dcv {
  token=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 120")
  instance_type=$(curl -s -H "X-aws-ec2-metadata-token: ${token}" 169.254.169.254/latest/meta-data/instance-type)
  # Check if gpu doesn't exist
  nvidia-smi > /dev/null 2>&1
  gpu_exists=$?
  if [ $gpu_exists -ne 0 ] ; then
    init_dcv_desktop
  elif [ "$instance_type" == "p2.xlarge" ] ; then
    sudo sed -i '/\[display\]/ a grabber-target=\"system\"' /etc/dcv/dcv.conf
    sudo nvidia-xconfig --enable-all-gpus --preserve-busid --use-display-device=none
    init_dcv_desktop
  else
    sudo nvidia-xconfig --enable-all-gpus --preserve-busid
    init_dcv_desktop
  fi
}

if [[ $REMOTE_DESKTOP_SOLUTION == "rdp" ]] ; then
  # If xrdp is already running, exit
  xrdp_status=$(systemctl is-active xrdp)
  if [[ $xrdp_status == "active" ]]; then
    exit 0
  fi

  sudo systemctl stop lightdm
  cleanup_xrdp_session

  # Stop and disable dcvserver
  sudo systemctl stop dcvserver
  sudo systemctl disable dcvserver

  # Enable and start xrdp
  sudo systemctl enable xrdp
  sudo systemctl start xrdp

else
  # If dcvserver is already running, exit
  dcv_status=$(systemctl is-active dcvserver)
  if [[ $dcv_status == "active" ]]; then
    exit 0
  fi

  # Stop and disable dcvserver
  cleanup_xrdp_session
  sudo systemctl stop xrdp
  sudo systemctl disable xrdp

  sudo systemctl start lightdm

  # If dcvserver is already running, exit
  dcv_status=$(systemctl is-active dcvserver)
  if [[ $dcv_status == "inactive" ]]; then
    init_dcv
    sudo systemctl enable dcvserver
    sudo systemctl start dcvserver
  fi
fi

</file>

<file path="/home/epatel/code/matlab-on-aws-pvt/packer/v1/runtime/launch-matlab-proxy.sh">
#!/usr/bin/env bash

set -x
echo "Starting matlab-proxy-app"
export PATH=${PATH}:/home/ubuntu/.local/bin

export MWI_APP_PORT=8123
export MWI_SSL_CERT_FILE=/etc/ssl/certs/matlab-proxy_certificate.pem
export MWI_SSL_KEY_FILE=/etc/ssl/certs/matlab-proxy_private-key.pem
export MWI_ENABLE_TOKEN_AUTH=true
# this line exists to set the auth token for matlab-proxy using string replacement
# it is commented only because we prefer not having the env variable over unsetting it
# you should not need to modify this line
# export MWI_AUTH_TOKEN=
export MWI_PROCESS_START_TIMEOUT=300

matlab-proxy-app

</file>
