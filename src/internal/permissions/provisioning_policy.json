{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "CloudFormationCreate",
            "Effect": "Allow",
            "Action": [
                "cloudformation:CreateStack"
            ],
            "Resource": [
                "arn:<<AWS_PARTITION>>:cloudformation:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:stack/<<RESOURCE_NAMING_PREFIX>>*"
            ],
            "Condition": {
                "StringLike": {
                    "cloudformation:TemplateUrl": [
                        "https://mathworks-reference-architectures-templates.s3.amazonaws.com/*",
                        "https://matlab-on-aws.s3.amazonaws.com/*"
                    ]
                }
            }
        },
        {
            "Sid": "CloudformationActionsFromCloudFormation",
            "Effect": "Allow",
            "Action": [
                "cloudformation:DeleteStack",
                "cloudformation:DescribeStackEvents",
                "cloudformation:DescribeStacks"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:cloudformation:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:stack/<<RESOURCE_NAMING_PREFIX>>*"
        },
        {
            "Sid": "CloudformationActionsFromCloudFormation2",
            "Effect": "Allow",
            "Action": [
                "cloudformation:*ChangeSet*",
                "cloudformation:GetStackPolicy",
                "cloudformation:GetTemplate",
                "cloudformation:GetTemplateSummary",
                "cloudformation:ListStackResources"
            ],
            "Resource": [
                "arn:<<AWS_PARTITION>>:cloudformation:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:stack/<<RESOURCE_NAMING_PREFIX>>*",
                "arn:<<AWS_PARTITION>>:cloudformation:<<AWS_REGION>>:aws:transform/*"
            ]
        },
        {
            "Sid": "MultipleServicesActionsFromCloudFormation",
            "Effect": "Allow",
            "Action": [
                "ec2:AllocateAddress",
                "ec2:AssociateAddress",
                "ec2:AuthorizeSecurityGroupIngress",
                "ec2:CreateSecurityGroup",
                "ec2:CreateTags",
                "ec2:DeleteSecurityGroup",
                "ec2:DescribeAddresses",
                "ec2:DescribeInstanceAttribute",
                "ec2:DescribeInstanceCreditSpecifications",
                "ec2:DescribeInstances",
                "ec2:DescribeKeyPairs",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DescribeSecurityGroupRules",
                "ec2:DescribeSecurityGroups",
                "ec2:DescribeSubnets",
                "ec2:DescribeVolumes",
                "ec2:DescribeVpcs",
                "ec2:DisassociateAddress",
                "ec2:ReleaseAddress",
                "ec2:RevokeSecurityGroupIngress",
                "ec2:RunInstances",
                "ec2:TerminateInstances",
                "logs:DescribeLogGroups",
                "logs:ListTagsForResource",
                "ssm:ListAssociations",
                "ssm:ListTagsForResource"
            ],
            "Resource": "*",
            "Condition": {
                "StringEquals": {
                    "aws:CalledViaFirst": [
                        "cloudformation.<<AWS_URL_SUFFIX>>"
                    ]
                }
            }
        },
        {
            "Sid": "EventsActionsFromCloudFormation",
            "Effect": "Allow",
            "Action": [
                "events:DeleteRule",
                "events:DescribeRule",
                "events:ListTargetsByRule",
                "events:PutRule",
                "events:PutTargets",
                "events:RemoveTargets"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:events:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:rule/<<RESOURCE_NAMING_PREFIX>>*",
            "Condition": {
                "StringEquals": {
                    "aws:CalledViaFirst": [
                        "cloudformation.<<AWS_URL_SUFFIX>>"
                    ]
                }
            }
        },
        {
            "Sid": "IamActionsFromCloudFormation",
            "Effect": "Allow",
            "Action": [
                "iam:AttachRolePolicy",
                "iam:CreateRole",
                "iam:DeleteRole",
                "iam:DeleteRolePolicy",
                "iam:DetachRolePolicy",
                "iam:GetRole",
                "iam:GetRolePolicy",
                "iam:ListAttachedRolePolicies",
                "iam:ListRolePolicies",
                "iam:PassRole",
                "iam:PutRolePolicy",
                "iam:TagRole"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:iam::<<AWS_ACCOUNT_ID>>:role/MW/<<RESOURCE_NAMING_PREFIX>>*",
            "Condition": {
                "StringEquals": {
                    "aws:CalledViaFirst": [
                        "cloudformation.<<AWS_URL_SUFFIX>>"
                    ]
                }
            }
        },
        {
            "Sid": "IamActionsFromCloudFormation2",
            "Effect": "Allow",
            "Action": [
                "iam:AddRoleToInstanceProfile",
                "iam:CreateInstanceProfile",
                "iam:DeleteInstanceProfile",
                "iam:GetInstanceProfile",
                "iam:RemoveRoleFromInstanceProfile"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:iam::<<AWS_ACCOUNT_ID>>:instance-profile/MW/<<RESOURCE_NAMING_PREFIX>>*",
            "Condition": {
                "StringEquals": {
                    "aws:CalledViaFirst": [
                        "cloudformation.<<AWS_URL_SUFFIX>>"
                    ]
                }
            }
        },
        {
            "Sid": "LambdaActionsFromCloudFormation",
            "Effect": "Allow",
            "Action": [
                "lambda:AddPermission",
                "lambda:CreateFunction",
                "lambda:DeleteFunction",
                "lambda:GetFunction",
                "lambda:GetFunctionCodeSigningConfig",
                "lambda:GetFunctionRecursionConfig",
                "lambda:GetPolicy",
                "lambda:GetRuntimeManagementConfig",
                "lambda:InvokeFunction",
                "lambda:RemovePermission",
                "lambda:TagResource"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:lambda:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:function:<<RESOURCE_NAMING_PREFIX>>*",
            "Condition": {
                "StringEquals": {
                    "aws:CalledViaFirst": [
                        "cloudformation.<<AWS_URL_SUFFIX>>"
                    ]
                }
            }
        },
        {
            "Sid": "LogsActionsFromCloudFormation",
            "Effect": "Allow",
            "Action": [
                "logs:CreateLogGroup",
                "logs:DeleteLogGroup"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:logs:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:log-group:<<RESOURCE_NAMING_PREFIX>>*",
            "Condition": {
                "StringEquals": {
                    "aws:CalledViaFirst": [
                        "cloudformation.<<AWS_URL_SUFFIX>>"
                    ]
                }
            }
        },
        {
            "Sid": "LogsActionsFromCloudFormation2",
            "Effect": "Allow",
            "Action": [
                "logs:CreateLogGroup",
                "logs:DeleteLogGroup",
                "logs:PutRetentionPolicy"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:logs:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:log-group:/aws/lambda/<<RESOURCE_NAMING_PREFIX>>*",
            "Condition": {
                "StringEquals": {
                    "aws:CalledViaFirst": [
                        "cloudformation.<<AWS_URL_SUFFIX>>"
                    ]
                }
            }
        },
        {
            "Sid": "SsmActionsFromCloudFormation",
            "Effect": "Allow",
            "Action": [
                "ssm:AddTagsToResource",
                "ssm:CreateDocument",
                "ssm:DeleteDocument",
                "ssm:DescribeDocument",
                "ssm:GetDocument"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:ssm:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:document/<<RESOURCE_NAMING_PREFIX>>*",
            "Condition": {
                "StringEquals": {
                    "aws:CalledViaFirst": [
                        "cloudformation.<<AWS_URL_SUFFIX>>"
                    ]
                }
            }
        },
        {
            "Sid": "EC2StopStart",
            "Effect": "Allow",
            "Action": [
                "ec2:StartInstances",
                "ec2:StopInstances"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:ec2:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:instance/*",
            "Condition": {
                "StringEquals": {
                    "aws:ResourceTag/mw-ProductID": "MathWorks-MATLAB-Linux"
                },
                "StringLike": {
                    "aws:ResourceTag/mw-StackName": "<<RESOURCE_NAMING_PREFIX>>*"
                }
            }
        },
        {
            "Sid": "ReadOnlyActionsForSmoothConsoleExperience",
            "Effect": "Allow",
            "Action": [
                "cloudformation:GetTemplateSummary",
                "cloudformation:ListStacks",
                "ec2:DescribeInstances",
                "ec2:DescribeKeyPairs",
                "ec2:DescribeSubnets",
                "ec2:DescribeVpcs",
                "logs:DescribeLogGroups",
                "ssm:DescribeInstanceInformation",
                "ssm:GetConnectionStatus"
            ],
            "Resource": "*"
        },
        {
            "Sid": "EC2KeyPairWriteAccess",
            "Effect": "Allow",
            "Action": [
                "ec2:CreateKeyPair",
                "ec2:DeleteKeyPair"
            ],
            "Resource": "arn:<<AWS_PARTITION>>:ec2:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:key-pair/<<RESOURCE_NAMING_PREFIX>>*"
        },
        {
            "Sid": "CloudWatchLogsReadOnlyAccess",
            "Effect": "Allow",
            "Action": [
                "logs:DescribeLogStreams",
                "logs:GetLogEvents"
            ],
            "Resource": [
                "arn:<<AWS_PARTITION>>:logs:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:log-group:/aws/lambda/<<RESOURCE_NAMING_PREFIX>>*",
                "arn:<<AWS_PARTITION>>:logs:<<AWS_REGION>>:<<AWS_ACCOUNT_ID>>:log-group:<<RESOURCE_NAMING_PREFIX>>*"
            ]
        }
    ]
}